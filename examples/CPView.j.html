<div class="highlight"><pre><span style="color: #408080; font-style: italic">/*</span>
<span style="color: #408080; font-style: italic"> * CPView.j</span>
<span style="color: #408080; font-style: italic"> * AppKit</span>
<span style="color: #408080; font-style: italic"> *</span>
<span style="color: #408080; font-style: italic"> * Created by Francisco Tolmasky.</span>
<span style="color: #408080; font-style: italic"> * Copyright 2008, 280 North, Inc.</span>
<span style="color: #408080; font-style: italic"> *</span>
<span style="color: #408080; font-style: italic"> * This library is free software; you can redistribute it and/or</span>
<span style="color: #408080; font-style: italic"> * modify it under the terms of the GNU Lesser General Public</span>
<span style="color: #408080; font-style: italic"> * License as published by the Free Software Foundation; either</span>
<span style="color: #408080; font-style: italic"> * version 2.1 of the License, or (at your option) any later version.</span>
<span style="color: #408080; font-style: italic"> *</span>
<span style="color: #408080; font-style: italic"> * This library is distributed in the hope that it will be useful,</span>
<span style="color: #408080; font-style: italic"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span style="color: #408080; font-style: italic"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<span style="color: #408080; font-style: italic"> * Lesser General Public License for more details.</span>
<span style="color: #408080; font-style: italic"> *</span>
<span style="color: #408080; font-style: italic"> * You should have received a copy of the GNU Lesser General Public</span>
<span style="color: #408080; font-style: italic"> * License along with this library; if not, write to the Free Software</span>
<span style="color: #408080; font-style: italic"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA</span>
<span style="color: #408080; font-style: italic"> */</span>

<span style="color: #BC7A00">@import</span> <span style="color: #BA2121">&lt;Foundation/CPArray.j&gt;</span>
<span style="color: #BC7A00">@import</span> <span style="color: #BA2121">&lt;Foundation/CPObjJRuntime.j&gt;</span>

<span style="color: #BC7A00">@import</span> <span style="color: #BA2121">&quot;CGAffineTransform.j&quot;</span>
<span style="color: #BC7A00">@import</span> <span style="color: #BA2121">&quot;CGGeometry.j&quot;</span>

<span style="color: #BC7A00">@import</span> <span style="color: #BA2121">&quot;CPColor.j&quot;</span>
<span style="color: #BC7A00">@import</span> <span style="color: #BA2121">&quot;CPGeometry.j&quot;</span>
<span style="color: #BC7A00">@import</span> <span style="color: #BA2121">&quot;CPGraphicsContext.j&quot;</span>
<span style="color: #BC7A00">@import</span> <span style="color: #BA2121">&quot;CPResponder.j&quot;</span>
<span style="color: #BC7A00">@import</span> <span style="color: #BA2121">&quot;CPTheme.j&quot;</span>
<span style="color: #BC7A00">@import</span> <span style="color: #BA2121">&quot;_CPDisplayServer.j&quot;</span>


<span style="color: #BC7A00">#include</span> <span style="color: #BA2121">&quot;Platform/Platform.h&quot;</span>
<span style="color: #BC7A00">#include</span> <span style="color: #BA2121">&quot;CoreGraphics/CGAffineTransform.h&quot;</span>
<span style="color: #BC7A00">#include</span> <span style="color: #BA2121">&quot;CoreGraphics/CGGeometry.h&quot;</span>
<span style="color: #BC7A00">#include</span> <span style="color: #BA2121">&quot;Platform/DOM/CPDOMDisplayServer.h&quot;</span>

<span style="color: #408080; font-style: italic">/*</span>
<span style="color: #408080; font-style: italic">    @global</span>
<span style="color: #408080; font-style: italic">    @group CPViewAutoresizingMasks</span>
<span style="color: #408080; font-style: italic">    The default resizingMask, the view will not resize or reposition itself.</span>
<span style="color: #408080; font-style: italic">*/</span>
CPViewNotSizable    <span style="color: #666666">=</span> <span style="color: #666666">0</span>;
<span style="color: #408080; font-style: italic">/*</span>
<span style="color: #408080; font-style: italic">    @global</span>
<span style="color: #408080; font-style: italic">    @group CPViewAutoresizingMasks</span>
<span style="color: #408080; font-style: italic">    Allow for flexible space on the left hand side of the view.</span>
<span style="color: #408080; font-style: italic">*/</span>
CPViewMinXMargin    <span style="color: #666666">=</span> <span style="color: #666666">1</span>;
<span style="color: #408080; font-style: italic">/*</span>
<span style="color: #408080; font-style: italic">    @global</span>
<span style="color: #408080; font-style: italic">    @group CPViewAutoresizingMasks</span>
<span style="color: #408080; font-style: italic">    The view should grow and shrink horizontally with its parent view.</span>
<span style="color: #408080; font-style: italic">*/</span>
CPViewWidthSizable  <span style="color: #666666">=</span> <span style="color: #666666">2</span>;
<span style="color: #408080; font-style: italic">/*</span>
<span style="color: #408080; font-style: italic">    @global</span>
<span style="color: #408080; font-style: italic">    @group CPViewAutoresizingMasks</span>
<span style="color: #408080; font-style: italic">    Allow for flexible space to the right hand side of the view.</span>
<span style="color: #408080; font-style: italic">*/</span>
CPViewMaxXMargin    <span style="color: #666666">=</span> <span style="color: #666666">4</span>;
<span style="color: #408080; font-style: italic">/*</span>
<span style="color: #408080; font-style: italic">    @global</span>
<span style="color: #408080; font-style: italic">    @group CPViewAutoresizingMasks</span>
<span style="color: #408080; font-style: italic">    Allow for flexible space above the view.</span>
<span style="color: #408080; font-style: italic">*/</span>
CPViewMinYMargin    <span style="color: #666666">=</span> <span style="color: #666666">8</span>;
<span style="color: #408080; font-style: italic">/*</span>
<span style="color: #408080; font-style: italic">    @global</span>
<span style="color: #408080; font-style: italic">    @group CPViewAutoresizingMasks</span>
<span style="color: #408080; font-style: italic">    The view should grow and shrink vertically with its parent view.</span>
<span style="color: #408080; font-style: italic">*/</span>
CPViewHeightSizable <span style="color: #666666">=</span> <span style="color: #666666">16</span>;
<span style="color: #408080; font-style: italic">/*</span>
<span style="color: #408080; font-style: italic">    @global</span>
<span style="color: #408080; font-style: italic">    @group CPViewAutoresizingMasks</span>
<span style="color: #408080; font-style: italic">    Allow for flexible space below the view.</span>
<span style="color: #408080; font-style: italic">*/</span>
CPViewMaxYMargin    <span style="color: #666666">=</span> <span style="color: #666666">32</span>;

CPViewBoundsDidChangeNotification   <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewBoundsDidChangeNotification&quot;</span>;
CPViewFrameDidChangeNotification    <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewFrameDidChangeNotification&quot;</span>;

<span style="color: #008000; font-weight: bold">var</span> CachedNotificationCenter    <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">nil</span>,
    CachedThemeAttributes       <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">nil</span>;<span style="color: #BC7A00"></span>

<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
<span style="color: #008000; font-weight: bold">var</span> DOMElementPrototype         <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">nil</span>,
    
    BackgroundTrivialColor              <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
    BackgroundVerticalThreePartImage    <span style="color: #666666">=</span> <span style="color: #666666">1</span>,
    BackgroundHorizontalThreePartImage  <span style="color: #666666">=</span> <span style="color: #666666">2</span>,
    BackgroundNinePartImage             <span style="color: #666666">=</span> <span style="color: #666666">3</span>;<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>

<span style="color: #008000; font-weight: bold">var</span> CPViewFlags                     <span style="color: #666666">=</span> { },
    CPViewHasCustomDrawRect         <span style="color: #666666">=</span> <span style="color: #666666">1</span> <span style="color: #666666">&lt;&lt;</span> <span style="color: #666666">0</span>,
    CPViewHasCustomLayoutSubviews   <span style="color: #666666">=</span> <span style="color: #666666">1</span> <span style="color: #666666">&lt;&lt;</span> <span style="color: #666666">1</span>;

<span style="color: #408080; font-style: italic">/*! </span>
<span style="color: #408080; font-style: italic">    @ingroup appkit</span>
<span style="color: #408080; font-style: italic">    @class CPView</span>

<span style="color: #408080; font-style: italic">    &lt;p&gt;CPView is a class which provides facilities for drawing</span>
<span style="color: #408080; font-style: italic">    in a window and receiving events. It is the superclass of many of the visual</span>
<span style="color: #408080; font-style: italic">    elements of the GUI.&lt;/p&gt;</span>

<span style="color: #408080; font-style: italic">    &lt;p&gt;In order to display itself, a view must be placed in a window (represented by an</span>
<span style="color: #408080; font-style: italic">    CPWindow object). Within the window is a hierarchy of CPViews,</span>
<span style="color: #408080; font-style: italic">    headed by the window&#39;s content view. Every other view in a window is a descendant</span>
<span style="color: #408080; font-style: italic">    of this view.&lt;/p&gt;</span>

<span style="color: #408080; font-style: italic">    &lt;p&gt;Subclasses can override \c -drawRect: in order to implement their</span>
<span style="color: #408080; font-style: italic">    appearance. Other methods of CPView and CPResponder can</span>
<span style="color: #408080; font-style: italic">    also be overridden to handle user generated events.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">CPView</span> <span style="color: #666666">:</span> <span style="color: #0000FF; font-weight: bold">CPResponder</span>
{
    CPWindow            _window;
    
    CPView              _superview;
    CPArray             _subviews;
    
    CPGraphicsContext   _graphicsContext;
    
    <span style="color: #B00040">int</span>                 _tag;
    
    CGRect              _frame;
    CGRect              _bounds;
    CGAffineTransform   _boundsTransform;
    CGAffineTransform   _inverseBoundsTransform;
    
    CPSet               _registeredDraggedTypes;
    CPArray             _registeredDraggedTypesArray;
    
    <span style="color: #B00040">BOOL</span>                _isHidden;
    <span style="color: #B00040">BOOL</span>                _hitTests;
    
    <span style="color: #B00040">BOOL</span>                _postsFrameChangedNotifications;
    <span style="color: #B00040">BOOL</span>                _postsBoundsChangedNotifications;
    <span style="color: #B00040">BOOL</span>                _inhibitFrameAndBoundsChangedNotifications;<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">    </span>
<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
    DOMElement          _DOMElement;
    DOMElement          _DOMContentsElement;
    
    CPArray             _DOMImageParts;
    CPArray             _DOMImageSizes;
    
    <span style="color: #B00040">unsigned</span>            _backgroundType;<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>

    CGRect              _dirtyRect;

    <span style="color: #B00040">float</span>               _opacity;
    CPColor             _backgroundColor;

    <span style="color: #B00040">BOOL</span>                _autoresizesSubviews;
    <span style="color: #B00040">unsigned</span>            _autoresizingMask;
    
    CALayer             _layer;
    <span style="color: #B00040">BOOL</span>                _wantsLayer;
    
    <span style="color: #408080; font-style: italic">// Full Screen State</span>
    <span style="color: #B00040">BOOL</span>                _isInFullScreenMode;
    
    _CPViewFullScreenModeState  _fullScreenModeState;
    
    <span style="color: #408080; font-style: italic">// Layout Support</span>
    <span style="color: #B00040">BOOL</span>                _needsLayout;
    JSObject            _ephemeralSubviews;
    
    <span style="color: #408080; font-style: italic">// Theming Support</span>
    CPTheme             _theme;
    JSObject            _themeAttributes;
    <span style="color: #B00040">unsigned</span>            _themeState;

    JSObject            _ephemeralSubviewsForNames;
    CPSet               _ephereralSubviews;

    <span style="color: #408080; font-style: italic">// Key View Support</span>
    CPView              _nextKeyView;
    CPView              _previousKeyView;

    <span style="color: #B00040">unsigned</span>            _viewClassFlags;
}

<span style="color: #408080; font-style: italic">/*</span>
<span style="color: #408080; font-style: italic">    Private method for Objective-J.</span>
<span style="color: #408080; font-style: italic">    @ignore</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">+</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">initialize</span>
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span> <span style="color: #666666">!==</span> [CPView class])
        <span style="color: #008000; font-weight: bold">return</span>;<span style="color: #BC7A00"></span>

<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
    DOMElementPrototype <span style="color: #666666">=</span>  <span style="color: #008000">document</span>.<span style="color: #0000FF">createElement</span>(<span style="color: #BA2121">&quot;div&quot;</span>);
    
    <span style="color: #008000; font-weight: bold">var</span> style <span style="color: #666666">=</span> DOMElementPrototype.style;
    
    style.overflow <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;hidden&quot;</span>;
    style.position <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;absolute&quot;</span>;
    style.visibility <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;visible&quot;</span>;
    style.zIndex <span style="color: #666666">=</span> <span style="color: #666666">0</span>;<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>

    CachedNotificationCenter <span style="color: #666666">=</span> [CPNotificationCenter defaultCenter];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setupViewFlags</span>
{
    <span style="color: #008000; font-weight: bold">var</span> theClass <span style="color: #666666">=</span> [<span style="color: #008000">self</span> class],
        classUID <span style="color: #666666">=</span> [theClass UID];

    <span style="color: #008000; font-weight: bold">if</span> (CPViewFlags[classUID] <span style="color: #666666">===</span> <span style="color: #008000; font-weight: bold">undefined</span>)
    {
        <span style="color: #008000; font-weight: bold">var</span> flags <span style="color: #666666">=</span> <span style="color: #666666">0</span>;

        <span style="color: #008000; font-weight: bold">if</span> ([theClass instanceMethodForSelector<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">@selector</span>(drawRect<span style="color: #666666">:</span>)] <span style="color: #666666">!==</span> [CPView instanceMethodForSelector<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">@selector</span>(drawRect<span style="color: #666666">:</span>)])
            flags <span style="color: #666666">|=</span> CPViewHasCustomDrawRect;

        <span style="color: #008000; font-weight: bold">if</span> ([theClass instanceMethodForSelector<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">@selector</span>(layoutSubviews)] <span style="color: #666666">!==</span> [CPView instanceMethodForSelector<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">@selector</span>(layoutSubviews)])
            flags <span style="color: #666666">|=</span> CPViewHasCustomLayoutSubviews;

        CPViewFlags[classUID] <span style="color: #666666">=</span> flags;
    }

    _viewClassFlags <span style="color: #666666">=</span> CPViewFlags[classUID];
}

<span style="color: #666666">+</span> (<span style="color: #B00040">CPSet</span>)<span style="color: #0000FF">keyPathsForValuesAffectingFrame</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [CPSet setWithObjects<span style="color: #666666">:</span><span style="color: #BA2121">@&quot;frameOrigin&quot;</span>, <span style="color: #BA2121">@&quot;frameSize&quot;</span>];
}

<span style="color: #666666">+</span> (<span style="color: #B00040">CPSet</span>)<span style="color: #0000FF">keyPathsForValuesAffectingBounds</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [CPSet setWithObjects<span style="color: #666666">:</span><span style="color: #BA2121">@&quot;boundsOrigin&quot;</span>, <span style="color: #BA2121">@&quot;boundsSize&quot;</span>];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">init</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> initWithFrame<span style="color: #666666">:</span><span style="color: #0000FF">CGRectMakeZero</span>()];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Initializes the receiver for usage with the specified bounding rectangle</span>
<span style="color: #408080; font-style: italic">    @return the initialized view</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithFrame:</span>(<span style="color: #B00040">CGRect</span>)aFrame
{
    <span style="color: #008000">self</span> <span style="color: #666666">=</span> [<span style="color: #008000">super</span> init];
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span>)
    {
        <span style="color: #008000; font-weight: bold">var</span> width <span style="color: #666666">=</span> <span style="color: #0000FF">_CGRectGetWidth</span>(aFrame),
            height <span style="color: #666666">=</span> <span style="color: #0000FF">_CGRectGetHeight</span>(aFrame);
        
        _subviews <span style="color: #666666">=</span> [];
        _registeredDraggedTypes <span style="color: #666666">=</span> [CPSet set];
        _registeredDraggedTypesArray <span style="color: #666666">=</span> [];

        _tag <span style="color: #666666">=</span> <span style="color: #666666">-1</span>;

        _frame <span style="color: #666666">=</span> <span style="color: #0000FF">_CGRectMakeCopy</span>(aFrame);
        _bounds <span style="color: #666666">=</span> <span style="color: #0000FF">_CGRectMake</span>(<span style="color: #666666">0.0</span>, <span style="color: #666666">0.0</span>, width, height);

        _autoresizingMask <span style="color: #666666">=</span> CPViewNotSizable;
        _autoresizesSubviews <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">YES</span>;
    
        _opacity <span style="color: #666666">=</span> <span style="color: #666666">1.0</span>;
        _isHidden <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">NO</span>;
        _hitTests <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">YES</span>;<span style="color: #BC7A00"></span>

<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
        _DOMElement <span style="color: #666666">=</span> DOMElementPrototype.<span style="color: #0000FF">cloneNode</span>(<span style="color: #008000; font-weight: bold">false</span>);

        <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftTop</span>(_DOMElement, <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #0000FF">_CGRectGetMinX</span>(aFrame), <span style="color: #0000FF">_CGRectGetMinY</span>(aFrame));
        <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMElement, width, height);
        
        _DOMImageParts <span style="color: #666666">=</span> [];
        _DOMImageSizes <span style="color: #666666">=</span> [];<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>
        
        _theme <span style="color: #666666">=</span> [CPTheme defaultTheme];
        _themeState <span style="color: #666666">=</span> CPThemeStateNormal;

        [<span style="color: #008000">self</span> setupViewFlags];

        [<span style="color: #008000">self</span> _loadThemeAttributes];
    }
    
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the container view of the receiver</span>
<span style="color: #408080; font-style: italic">    @return the receiver&#39;s containing view</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPView</span>)<span style="color: #0000FF">superview</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _superview;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns an array of all the views contained as direct children of the receiver</span>
<span style="color: #408080; font-style: italic">    @return an array of CPViews</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">subviews</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [_subviews copy];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the window containing this receiver</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPWindow</span>)<span style="color: #0000FF">window</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _window;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Makes the argument a subview of the receiver.</span>
<span style="color: #408080; font-style: italic">    @param aSubview the CPView to make a subview</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">addSubview:</span>(<span style="color: #B00040">CPView</span>)aSubview
{
    [<span style="color: #008000">self</span> _insertSubview<span style="color: #666666">:</span>aSubview atIndex<span style="color: #666666">:</span>CPNotFound];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Makes \c aSubview a subview of the receiver. It is positioned relative to \c anotherView</span>
<span style="color: #408080; font-style: italic">    @param aSubview the view to add as a subview</span>
<span style="color: #408080; font-style: italic">    @param anOrderingMode specifies \c aSubview&#39;s ordering relative to \c anotherView</span>
<span style="color: #408080; font-style: italic">    @param anotherView \c aSubview will be positioned relative to this argument</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">addSubview:</span>(<span style="color: #B00040">CPView</span>)aSubview <span style="color: #0000FF">positioned:</span>(<span style="color: #B00040">CPWindowOrderingMode</span>)anOrderingMode <span style="color: #0000FF">relativeTo:</span>(<span style="color: #B00040">CPView</span>)anotherView
{
    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> anotherView <span style="color: #666666">?</span> [_subviews indexOfObjectIdenticalTo<span style="color: #666666">:</span>anotherView] <span style="color: #666666">:</span> CPNotFound;
    
    <span style="color: #408080; font-style: italic">// In other words, if no view, then either all the way at the bottom or all the way at the top.</span>
    <span style="color: #008000; font-weight: bold">if</span> (index <span style="color: #666666">===</span> CPNotFound)
        index <span style="color: #666666">=</span> (anOrderingMode <span style="color: #666666">===</span> CPWindowAbove) <span style="color: #666666">?</span> [_subviews count] <span style="color: #666666">:</span> <span style="color: #666666">0</span>;
    
    <span style="color: #408080; font-style: italic">// else, if we have a view, above if above.</span>
    <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (anOrderingMode <span style="color: #666666">===</span> CPWindowAbove)
        <span style="color: #666666">++</span>index;
        
    [<span style="color: #008000">self</span> _insertSubview<span style="color: #666666">:</span>aSubview atIndex<span style="color: #666666">:</span>index];
}

<span style="color: #408080; font-style: italic">/* @ignore */</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">_insertSubview:</span>(<span style="color: #B00040">CPView</span>)aSubview <span style="color: #0000FF">atIndex:</span>(<span style="color: #B00040">int</span>)anIndex
{
    <span style="color: #408080; font-style: italic">// We will have to adjust the z-index of all views starting at this index.</span>
    <span style="color: #008000; font-weight: bold">var</span> count <span style="color: #666666">=</span> _subviews.length;

    <span style="color: #408080; font-style: italic">// dirty the key view loop, in case the window wants to auto recalculate it</span>
    [[<span style="color: #008000">self</span> <span style="color: #008000">window</span>] _dirtyKeyViewLoop];

    <span style="color: #408080; font-style: italic">// If this is already one of our subviews, remove it.</span>
    <span style="color: #008000; font-weight: bold">if</span> (aSubview._superview <span style="color: #666666">==</span> <span style="color: #008000">self</span>)
    {
        <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> [_subviews indexOfObjectIdenticalTo<span style="color: #666666">:</span>aSubview];
        
        <span style="color: #408080; font-style: italic">// FIXME: should this be anIndex &gt;= count? (last one)</span>
        <span style="color: #008000; font-weight: bold">if</span> (index <span style="color: #666666">===</span> anIndex <span style="color: #666666">||</span> index <span style="color: #666666">===</span> count <span style="color: #666666">-</span> <span style="color: #666666">1</span> <span style="color: #666666">&amp;&amp;</span> anIndex <span style="color: #666666">===</span> count)
            <span style="color: #008000; font-weight: bold">return</span>;
        
        [_subviews removeObjectAtIndex<span style="color: #666666">:</span>index];<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">        </span>
<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
        <span style="color: #0000FF">CPDOMDisplayServerRemoveChild</span>(_DOMElement, aSubview._DOMElement);<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>

        <span style="color: #008000; font-weight: bold">if</span> (anIndex <span style="color: #666666">&gt;</span> index)
            <span style="color: #666666">--</span>anIndex;
        
        <span style="color: #408080; font-style: italic">//We&#39;ve effectively made the subviews array shorter, so represent that.</span>
        <span style="color: #666666">--</span>count;
    }
    <span style="color: #008000; font-weight: bold">else</span>
    {
        <span style="color: #408080; font-style: italic">// Remove the view from its previous superview.</span>
        [aSubview removeFromSuperview];

        <span style="color: #408080; font-style: italic">// Set the subview&#39;s window to our own. </span>
        [aSubview _setWindow<span style="color: #666666">:</span>_window];

        <span style="color: #408080; font-style: italic">// Notify the subview that it will be moving.</span>
        [aSubview viewWillMoveToSuperview<span style="color: #666666">:</span><span style="color: #008000">self</span>];
    
        <span style="color: #408080; font-style: italic">// Set ourselves as the superview.</span>
        aSubview._superview <span style="color: #666666">=</span> <span style="color: #008000">self</span>;
    }
    
    <span style="color: #008000; font-weight: bold">if</span> (anIndex <span style="color: #666666">===</span> CPNotFound <span style="color: #666666">||</span> anIndex <span style="color: #666666">&gt;=</span> count)
    {
        _subviews.<span style="color: #0000FF">push</span>(aSubview);<span style="color: #BC7A00"></span>

<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
        <span style="color: #408080; font-style: italic">// Attach the actual node.</span>
        <span style="color: #0000FF">CPDOMDisplayServerAppendChild</span>(_DOMElement, aSubview._DOMElement);<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>
    }
    <span style="color: #008000; font-weight: bold">else</span>
    {
        _subviews.<span style="color: #0000FF">splice</span>(anIndex, <span style="color: #666666">0</span>, aSubview);<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">    </span>
<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
        <span style="color: #408080; font-style: italic">// Attach the actual node.</span>
        <span style="color: #0000FF">CPDOMDisplayServerInsertBefore</span>(_DOMElement, aSubview._DOMElement, _subviews[anIndex <span style="color: #666666">+</span> <span style="color: #666666">1</span>]._DOMElement);<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>
    }
    
    [aSubview setNextResponder<span style="color: #666666">:</span><span style="color: #008000">self</span>];
    [aSubview viewDidMoveToSuperview];
    
    [<span style="color: #008000">self</span> didAddSubview<span style="color: #666666">:</span>aSubview];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Called when the receiver has added \c aSubview to it&#39;s child views.</span>
<span style="color: #408080; font-style: italic">    @param aSubview the view that was added</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">didAddSubview:</span>(<span style="color: #B00040">CPView</span>)aSubview
{
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Removes the receiver from it&#39;s container view and window.</span>
<span style="color: #408080; font-style: italic">    Does nothing if there&#39;s no container view.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">removeFromSuperview</span>
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_superview)
        <span style="color: #008000; font-weight: bold">return</span>;

    <span style="color: #408080; font-style: italic">// dirty the key view loop, in case the window wants to auto recalculate it</span>
    [[<span style="color: #008000">self</span> <span style="color: #008000">window</span>] _dirtyKeyViewLoop];

    [_superview willRemoveSubview<span style="color: #666666">:</span><span style="color: #008000">self</span>];
    
    [_superview._subviews removeObject<span style="color: #666666">:</span><span style="color: #008000">self</span>];<span style="color: #BC7A00"></span>

<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
        <span style="color: #0000FF">CPDOMDisplayServerRemoveChild</span>(_superview._DOMElement, _DOMElement);<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>
    _superview <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">nil</span>;
    
    [<span style="color: #008000">self</span> _setWindow<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">nil</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Replaces the specified child view with another view</span>
<span style="color: #408080; font-style: italic">    @param aSubview the view to replace</span>
<span style="color: #408080; font-style: italic">    @param aView the replacement view</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">replaceSubview:</span>(<span style="color: #B00040">CPView</span>)aSubview <span style="color: #0000FF">with:</span>(<span style="color: #B00040">CPView</span>)aView
{
    <span style="color: #008000; font-weight: bold">if</span> (aSubview._superview <span style="color: #666666">!=</span> <span style="color: #008000">self</span>)
        <span style="color: #008000; font-weight: bold">return</span>;
    
    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> [_subviews indexOfObjectIdenticalTo<span style="color: #666666">:</span>aSubview];
    
    [aSubview removeFromSuperview];
    
    [<span style="color: #008000">self</span> _insertSubview<span style="color: #666666">:</span>aView atIndex<span style="color: #666666">:</span>index];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setSubviews:</span>(<span style="color: #B00040">CPArray</span>)newSubviews
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>newSubviews)
        [CPException raise<span style="color: #666666">:</span>CPInvalidArgumentException reason<span style="color: #666666">:</span><span style="color: #BA2121">&quot;newSubviews cannot be nil in -[CPView setSubviews:]&quot;</span>];

    <span style="color: #408080; font-style: italic">// Trivial Case 0: Same array somehow</span>
    <span style="color: #008000; font-weight: bold">if</span> ([_subviews isEqual<span style="color: #666666">:</span>newSubviews])
        <span style="color: #008000; font-weight: bold">return</span>;

    <span style="color: #408080; font-style: italic">// Trivial Case 1: No current subviews, simply add all new subviews.</span>
    <span style="color: #008000; font-weight: bold">if</span> ([_subviews count] <span style="color: #666666">===</span> <span style="color: #666666">0</span>)
    {
        <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
            count <span style="color: #666666">=</span> [newSubviews count];

        <span style="color: #008000; font-weight: bold">for</span> (; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index)
            [<span style="color: #008000">self</span> addSubview<span style="color: #666666">:</span>newSubviews[index]];

        <span style="color: #008000; font-weight: bold">return</span>;
    }

    <span style="color: #408080; font-style: italic">// Trivial Case 2: No new subviews, simply remove all current subviews.</span>
    <span style="color: #008000; font-weight: bold">if</span> ([newSubviews count] <span style="color: #666666">===</span> <span style="color: #666666">0</span>)
    {
        <span style="color: #008000; font-weight: bold">var</span> count <span style="color: #666666">=</span> [_subviews count];

        <span style="color: #008000; font-weight: bold">while</span> (count<span style="color: #666666">--</span>)
            [_subviews[count] removeFromSuperview];

        <span style="color: #008000; font-weight: bold">return</span>;
    }

    <span style="color: #408080; font-style: italic">// Find out the views that were removed.</span>
    <span style="color: #008000; font-weight: bold">var</span> removedSubviews <span style="color: #666666">=</span> [CPMutableSet setWithArray<span style="color: #666666">:</span>_subviews];

    [removedSubviews removeObjectsInArray<span style="color: #666666">:</span>newSubviews];
    [removedSubviews makeObjectsPerformSelector<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">@selector</span>(removeFromSuperview)];

    <span style="color: #408080; font-style: italic">// Find out which views need to be added.</span>
    <span style="color: #008000; font-weight: bold">var</span> addedSubviews <span style="color: #666666">=</span> [CPMutableSet setWithArray<span style="color: #666666">:</span>newSubviews];

    [addedSubviews removeObjectsInArray<span style="color: #666666">:</span>_subviews];

    <span style="color: #008000; font-weight: bold">var</span> addedSubview <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">nil</span>,
        addedSubviewEnumerator <span style="color: #666666">=</span> [addedSubviews objectEnumerator];

    <span style="color: #008000; font-weight: bold">while</span> (addedSubview <span style="color: #666666">=</span> [addedSubviewEnumerator nextObject])
        [<span style="color: #008000">self</span> addSubview<span style="color: #666666">:</span>addedSubview];

    <span style="color: #408080; font-style: italic">// If the order is fine, no need to reorder.</span>
    <span style="color: #008000; font-weight: bold">if</span> ([_subviews isEqual<span style="color: #666666">:</span>newSubviews])
        <span style="color: #008000; font-weight: bold">return</span>;

    _subviews <span style="color: #666666">=</span> [newSubviews copy];

    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
        count <span style="color: #666666">=</span> [_subviews count];

    <span style="color: #008000; font-weight: bold">for</span> (; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index)
    {
        <span style="color: #008000; font-weight: bold">var</span> subview <span style="color: #666666">=</span> _subviews[index];

        <span style="color: #0000FF">CPDOMDisplayServerRemoveChild</span>(_DOMElement, subview._DOMElement);
        <span style="color: #0000FF">CPDOMDisplayServerAppendChild</span>(_DOMElement, subview._DOMElement);
    }
}

<span style="color: #408080; font-style: italic">/* @ignore */</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">_setWindow:</span>(<span style="color: #B00040">CPWindow</span>)aWindow
{
    <span style="color: #008000; font-weight: bold">if</span> (_window <span style="color: #666666">===</span> aWindow)
        <span style="color: #008000; font-weight: bold">return</span>;
    
    [[<span style="color: #008000">self</span> <span style="color: #008000">window</span>] _dirtyKeyViewLoop];

    <span style="color: #408080; font-style: italic">// Clear out first responder if we&#39;re the first responder and leaving.</span>
    <span style="color: #008000; font-weight: bold">if</span> ([_window firstResponder] <span style="color: #666666">===</span> <span style="color: #008000">self</span>)
        [_window makeFirstResponder<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">nil</span>];

    <span style="color: #408080; font-style: italic">// Notify the view and its subviews</span>
    [<span style="color: #008000">self</span> viewWillMoveToWindow<span style="color: #666666">:</span>aWindow];

    <span style="color: #408080; font-style: italic">// Unregister the drag events from the current window and register</span>
    <span style="color: #408080; font-style: italic">// them in the new window.</span>
    <span style="color: #008000; font-weight: bold">if</span> (_registeredDraggedTypes)
    {
        [_window _noteUnregisteredDraggedTypes<span style="color: #666666">:</span>_registeredDraggedTypes];
        [aWindow _noteRegisteredDraggedTypes<span style="color: #666666">:</span>_registeredDraggedTypes];
    }

    _window <span style="color: #666666">=</span> aWindow;

    <span style="color: #008000; font-weight: bold">var</span> count <span style="color: #666666">=</span> [_subviews count];

    <span style="color: #008000; font-weight: bold">while</span> (count<span style="color: #666666">--</span>)
        [_subviews[count] _setWindow<span style="color: #666666">:</span>aWindow];
    
    [<span style="color: #008000">self</span> viewDidMoveToWindow];

    [[<span style="color: #008000">self</span> <span style="color: #008000">window</span>] _dirtyKeyViewLoop];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns \c YES if the receiver is, or is a descendant of, \c aView.</span>
<span style="color: #408080; font-style: italic">    @param aView the view to test for ancestry</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">isDescendantOf:</span>(<span style="color: #B00040">CPView</span>)aView
{
    <span style="color: #008000; font-weight: bold">var</span> view <span style="color: #666666">=</span> <span style="color: #008000">self</span>;
    
    <span style="color: #008000; font-weight: bold">do</span>
    {
        <span style="color: #008000; font-weight: bold">if</span> (view <span style="color: #666666">==</span> aView)
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">YES</span>;
    } <span style="color: #008000; font-weight: bold">while</span>(view <span style="color: #666666">=</span> [view superview])
    
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">NO</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Called when the receiver&#39;s superview has changed.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">viewDidMoveToSuperview</span>
{
<span style="color: #408080; font-style: italic">//    if (_graphicsContext)</span>
        [<span style="color: #008000">self</span> setNeedsDisplay<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">YES</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Called when the receiver has been moved to a new CPWindow.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">viewDidMoveToWindow</span>
{
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Called when the receiver is about to be moved to a new view.</span>
<span style="color: #408080; font-style: italic">    @param aView the view to which the receiver will be moved</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">viewWillMoveToSuperview:</span>(<span style="color: #B00040">CPView</span>)aView
{
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Called when the receiver is about to be moved to a new window.</span>
<span style="color: #408080; font-style: italic">    @param aWindow the window to which the receiver will be moved.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">viewWillMoveToWindow:</span>(<span style="color: #B00040">CPWindow</span>)aWindow
{
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Called when the receiver is about to be remove one of its subviews.</span>
<span style="color: #408080; font-style: italic">    @param aView the view that will be removed</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">willRemoveSubview:</span>(<span style="color: #B00040">CPView</span>)aView
{
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the menu item containing the receiver or one of its ancestor views.</span>
<span style="color: #408080; font-style: italic">    @return a menu item, or \c nil if the view or one of its ancestors wasn&#39;t found</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPMenuItem</span>)<span style="color: #0000FF">enclosingMenuItem</span>
{
    <span style="color: #008000; font-weight: bold">var</span> view <span style="color: #666666">=</span> <span style="color: #008000">self</span>;
    
    <span style="color: #008000; font-weight: bold">while</span> (view <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>[view isKindOfClass<span style="color: #666666">:</span>[_CPMenuItemView class]])
        view <span style="color: #666666">=</span> [view superview];
    
    <span style="color: #008000; font-weight: bold">if</span> (view)
        <span style="color: #008000; font-weight: bold">return</span> view._menuItem;
    
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;
<span style="color: #408080; font-style: italic">/*    var view = self,</span>
<span style="color: #408080; font-style: italic">        enclosingMenuItem = _enclosingMenuItem;</span>
<span style="color: #408080; font-style: italic">    </span>
<span style="color: #408080; font-style: italic">    while (!enclosingMenuItem &amp;&amp; (view = view._enclosingMenuItem))</span>
<span style="color: #408080; font-style: italic">        view = [view superview];</span>
<span style="color: #408080; font-style: italic">    </span>
<span style="color: #408080; font-style: italic">    return enclosingMenuItem;*/</span>
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setTag:</span>(<span style="color: #B00040">CPInteger</span>)aTag
{
    _tag <span style="color: #666666">=</span> aTag;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPInteger</span>)<span style="color: #0000FF">tag</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _tag;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">viewWithTag:</span>(<span style="color: #B00040">CPInteger</span>)aTag
{
    <span style="color: #008000; font-weight: bold">if</span> ([<span style="color: #008000">self</span> tag] <span style="color: #666666">==</span> aTag)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;

    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
        count <span style="color: #666666">=</span> _subviews.length;

    <span style="color: #008000; font-weight: bold">for</span> (; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index)
    {
        <span style="color: #008000; font-weight: bold">var</span> view <span style="color: #666666">=</span> [_subviews[index] viewWithTag<span style="color: #666666">:</span>aTag];

        <span style="color: #008000; font-weight: bold">if</span> (view)
            <span style="color: #008000; font-weight: bold">return</span> view;
    }

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns whether the view is flipped.</span>
<span style="color: #408080; font-style: italic">    @return \c YES if the view is flipped. \c NO, otherwise.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">isFlipped</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">YES</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets the frame size of the receiver to the dimensions and origin of the provided rectangle in the coordinate system</span>
<span style="color: #408080; font-style: italic">    of the superview. The method also posts an CPViewFrameDidChangeNotification to the notification</span>
<span style="color: #408080; font-style: italic">    center if the receiver is configured to do so. If the frame is the same as the current frame, the method simply</span>
<span style="color: #408080; font-style: italic">    returns (and no notificaion is posted).</span>
<span style="color: #408080; font-style: italic">    @param aFrame the rectangle specifying the new origin and size  of the receiver</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setFrame:</span>(<span style="color: #B00040">CGRect</span>)aFrame
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #0000FF">_CGRectEqualToRect</span>(_frame, aFrame))
        <span style="color: #008000; font-weight: bold">return</span>;
        
    _inhibitFrameAndBoundsChangedNotifications <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">YES</span>;
    
    [<span style="color: #008000">self</span> setFrameOrigin<span style="color: #666666">:</span>aFrame.origin];
    [<span style="color: #008000">self</span> setFrameSize<span style="color: #666666">:</span>aFrame.size];

    _inhibitFrameAndBoundsChangedNotifications <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">NO</span>;

    <span style="color: #008000; font-weight: bold">if</span> (_postsFrameChangedNotifications)
        [CachedNotificationCenter postNotificationName<span style="color: #666666">:</span>CPViewFrameDidChangeNotification object<span style="color: #666666">:</span><span style="color: #008000">self</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the receiver&#39;s frame.</span>
<span style="color: #408080; font-style: italic">    @return a copy of the receiver&#39;s frame</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CGRect</span>)<span style="color: #0000FF">frame</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">_CGRectMakeCopy</span>(_frame);
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CGPoint</span>)<span style="color: #0000FF">frameOrigin</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">_CGPointMakeCopy</span>(_frame.origin);
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CGSize</span>)<span style="color: #0000FF">frameSize</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">_CGSizeMakeCopy</span>(_frame.size);
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Moves the center of the receiver&#39;s frame to the provided point. The point is defined in the superview&#39;s coordinate system. </span>
<span style="color: #408080; font-style: italic">    The method posts a CPViewFrameDidChangeNotification to the default notification center if the receiver </span>
<span style="color: #408080; font-style: italic">    is configured to do so. If the specified origin is the same as the frame&#39;s current origin, the method will </span>
<span style="color: #408080; font-style: italic">    simply return (and no notification will be posted).</span>
<span style="color: #408080; font-style: italic">    @param aPoint the new origin point</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setCenter:</span>(<span style="color: #B00040">CGPoint</span>)aPoint
{
    [<span style="color: #008000">self</span> setFrameOrigin<span style="color: #666666">:</span><span style="color: #0000FF">CGPointMake</span>(aPoint.x <span style="color: #666666">-</span> _frame.size.width <span style="color: #666666">/</span> <span style="color: #666666">2.0</span>, aPoint.y <span style="color: #666666">-</span> _frame.size.height <span style="color: #666666">/</span> <span style="color: #666666">2.0</span>)]; 
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the center of the receiver&#39;s frame to the provided point. The point is defined in the superview&#39;s coordinate system. </span>
<span style="color: #408080; font-style: italic">    @return CGPoint the center point of the receiver&#39;s frame</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CGPoint</span>)<span style="color: #0000FF">center</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">CGPointMake</span>(_frame.size.width <span style="color: #666666">/</span> <span style="color: #666666">2.0</span> <span style="color: #666666">+</span> _frame.origin.x, _frame.size.height <span style="color: #666666">/</span> <span style="color: #666666">2.0</span> <span style="color: #666666">+</span> _frame.origin.y);
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets the receiver&#39;s frame origin to the provided point. The point is defined in the superview&#39;s coordinate system. </span>
<span style="color: #408080; font-style: italic">    The method posts a CPViewFrameDidChangeNotification to the default notification center if the receiver </span>
<span style="color: #408080; font-style: italic">    is configured to do so. If the specified origin is the same as the frame&#39;s current origin, the method will </span>
<span style="color: #408080; font-style: italic">    simply return (and no notification will be posted).</span>
<span style="color: #408080; font-style: italic">    @param aPoint the new origin point</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setFrameOrigin:</span>(<span style="color: #B00040">CGPoint</span>)aPoint
{
    <span style="color: #008000; font-weight: bold">var</span> origin <span style="color: #666666">=</span> _frame.origin;
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>aPoint <span style="color: #666666">||</span> <span style="color: #0000FF">_CGPointEqualToPoint</span>(origin, aPoint))
        <span style="color: #008000; font-weight: bold">return</span>;

    origin.x <span style="color: #666666">=</span> aPoint.x;
    origin.y <span style="color: #666666">=</span> aPoint.y;

    <span style="color: #008000; font-weight: bold">if</span> (_postsFrameChangedNotifications <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>_inhibitFrameAndBoundsChangedNotifications)
        [CachedNotificationCenter postNotificationName<span style="color: #666666">:</span>CPViewFrameDidChangeNotification object<span style="color: #666666">:</span><span style="color: #008000">self</span>];<span style="color: #BC7A00"></span>

<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
    <span style="color: #008000; font-weight: bold">var</span> transform <span style="color: #666666">=</span> _superview <span style="color: #666666">?</span> _superview._boundsTransform <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">NULL</span>;

    <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftTop</span>(_DOMElement, transform, origin.x, origin.y);<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets the receiver&#39;s frame size. If \c aSize is the same as the frame&#39;s current dimensions, this</span>
<span style="color: #408080; font-style: italic">    method simply returns. The method posts a CPViewFrameDidChangeNotification to the</span>
<span style="color: #408080; font-style: italic">    default notification center if the receiver is configured to do so.</span>
<span style="color: #408080; font-style: italic">    @param aSize the new size for the frame</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setFrameSize:</span>(<span style="color: #B00040">CGSize</span>)aSize
{
    <span style="color: #008000; font-weight: bold">var</span> size <span style="color: #666666">=</span> _frame.size;
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>aSize <span style="color: #666666">||</span> <span style="color: #0000FF">_CGSizeEqualToSize</span>(size, aSize))
        <span style="color: #008000; font-weight: bold">return</span>;

    <span style="color: #008000; font-weight: bold">var</span> oldSize <span style="color: #666666">=</span> <span style="color: #0000FF">_CGSizeMakeCopy</span>(size);

    size.width <span style="color: #666666">=</span> aSize.width;
    size.height <span style="color: #666666">=</span> aSize.height;

    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000; font-weight: bold">YES</span>)
    {
        _bounds.size.width <span style="color: #666666">=</span> aSize.width;
        _bounds.size.height <span style="color: #666666">=</span> aSize.height;
    }

    <span style="color: #008000; font-weight: bold">if</span> (_layer)
        [_layer _owningViewBoundsChanged];

    <span style="color: #008000; font-weight: bold">if</span> (_autoresizesSubviews)
        [<span style="color: #008000">self</span> resizeSubviewsWithOldSize<span style="color: #666666">:</span>oldSize];
    
    [<span style="color: #008000">self</span> setNeedsLayout];
    [<span style="color: #008000">self</span> setNeedsDisplay<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">YES</span>];<span style="color: #BC7A00"></span>

<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
    <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMElement, size.width, size.height);

    <span style="color: #008000; font-weight: bold">if</span> (_DOMContentsElement)
    {
        <span style="color: #0000FF">CPDOMDisplayServerSetSize</span>(_DOMContentsElement, size.width, size.height);
        <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMContentsElement, size.width, size.height);
    }

    <span style="color: #008000; font-weight: bold">if</span> (_backgroundType <span style="color: #666666">!==</span> BackgroundTrivialColor)
    {
        <span style="color: #008000; font-weight: bold">var</span> images <span style="color: #666666">=</span> [[_backgroundColor patternImage] imageSlices];

        <span style="color: #008000; font-weight: bold">if</span> (_backgroundType <span style="color: #666666">===</span> BackgroundVerticalThreePartImage)
        {
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">1</span>], size.width, size.height <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">0</span>].height <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">2</span>].height);
        }

        <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (_backgroundType <span style="color: #666666">===</span> BackgroundHorizontalThreePartImage)
        {
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">1</span>], size.width <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">0</span>].width <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">2</span>].width, size.height);
        }

        <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (_backgroundType <span style="color: #666666">===</span> BackgroundNinePartImage)
        {
            <span style="color: #008000; font-weight: bold">var</span> width <span style="color: #666666">=</span> size.width <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">0</span>].width <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">2</span>].width,
                height <span style="color: #666666">=</span> size.height <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">0</span>].height <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">6</span>].height;

            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">1</span>], width, _DOMImageSizes[<span style="color: #666666">0</span>].height);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">3</span>], _DOMImageSizes[<span style="color: #666666">3</span>].width, height);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">4</span>], width, height);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">5</span>], _DOMImageSizes[<span style="color: #666666">5</span>].width, height);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">7</span>], width, _DOMImageSizes[<span style="color: #666666">7</span>].height);
        }
    }<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>

    <span style="color: #008000; font-weight: bold">if</span> (_postsFrameChangedNotifications <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>_inhibitFrameAndBoundsChangedNotifications)
        [CachedNotificationCenter postNotificationName<span style="color: #666666">:</span>CPViewFrameDidChangeNotification object<span style="color: #666666">:</span><span style="color: #008000">self</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets the receiver&#39;s bounds. The bounds define the size and location of the receiver inside it&#39;s frame. Posts a </span>
<span style="color: #408080; font-style: italic">    CPViewBoundsDidChangeNotification to the default notification center if the receiver is configured to do so.</span>
<span style="color: #408080; font-style: italic">    @param bounds the new bounds</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setBounds:</span>(<span style="color: #B00040">CGRect</span>)bounds
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #0000FF">_CGRectEqualToRect</span>(_bounds, bounds))
        <span style="color: #008000; font-weight: bold">return</span>;
        
    _inhibitFrameAndBoundsChangedNotifications <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">YES</span>;
    
    [<span style="color: #008000">self</span> setBoundsOrigin<span style="color: #666666">:</span>bounds.origin];
    [<span style="color: #008000">self</span> setBoundsSize<span style="color: #666666">:</span>bounds.size];

    _inhibitFrameAndBoundsChangedNotifications <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">NO</span>;

    <span style="color: #008000; font-weight: bold">if</span> (_postsBoundsChangedNotifications)
        [CachedNotificationCenter postNotificationName<span style="color: #666666">:</span>CPViewBoundsDidChangeNotification object<span style="color: #666666">:</span><span style="color: #008000">self</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the receiver&#39;s bounds. The bounds define the size</span>
<span style="color: #408080; font-style: italic">    and location of the receiver inside its frame.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CGRect</span>)<span style="color: #0000FF">bounds</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">_CGRectMakeCopy</span>(_bounds);
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CGPoint</span>)<span style="color: #0000FF">boundsOrigin</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">_CGPointMakeCopy</span>(_bounds.origin);
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CGSize</span>)<span style="color: #0000FF">boundsSize</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">_CGSizeMakeCopy</span>(_bounds.size);
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets the location of the receiver inside its frame. The method</span>
<span style="color: #408080; font-style: italic">    posts a CPViewBoundsDidChangeNotification to the</span>
<span style="color: #408080; font-style: italic">    default notification center if the receiver is configured to do so.</span>
<span style="color: #408080; font-style: italic">    @param aPoint the new location for the receiver</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setBoundsOrigin:</span>(<span style="color: #B00040">CGPoint</span>)aPoint
{
    <span style="color: #008000; font-weight: bold">var</span> origin <span style="color: #666666">=</span> _bounds.origin;
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #0000FF">_CGPointEqualToPoint</span>(origin, aPoint))
        <span style="color: #008000; font-weight: bold">return</span>;
        
    origin.x <span style="color: #666666">=</span> aPoint.x;
    origin.y <span style="color: #666666">=</span> aPoint.y;
    
    <span style="color: #008000; font-weight: bold">if</span> (origin.x <span style="color: #666666">!=</span> <span style="color: #666666">0</span> <span style="color: #666666">||</span> origin.y <span style="color: #666666">!=</span> <span style="color: #666666">0</span>)
    {
        _boundsTransform <span style="color: #666666">=</span> <span style="color: #0000FF">_CGAffineTransformMakeTranslation</span>(<span style="color: #666666">-</span>origin.x, <span style="color: #666666">-</span>origin.y);
        _inverseBoundsTransform <span style="color: #666666">=</span> <span style="color: #0000FF">CGAffineTransformInvert</span>(_boundsTransform);
    }
    <span style="color: #008000; font-weight: bold">else</span>
    {
        _boundsTransform <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">nil</span>;
        _inverseBoundsTransform <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">nil</span>;
    }<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">    </span>
<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> _subviews.length;
    
    <span style="color: #008000; font-weight: bold">while</span> (index<span style="color: #666666">--</span>)
    {
        <span style="color: #008000; font-weight: bold">var</span> view <span style="color: #666666">=</span> _subviews[index],
            origin <span style="color: #666666">=</span> view._frame.origin;
        
        <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftTop</span>(view._DOMElement, _boundsTransform, origin.x, origin.y);
    }<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>
    
    <span style="color: #008000; font-weight: bold">if</span> (_postsBoundsChangedNotifications <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>_inhibitFrameAndBoundsChangedNotifications)
        [CachedNotificationCenter postNotificationName<span style="color: #666666">:</span>CPViewBoundsDidChangeNotification object<span style="color: #666666">:</span><span style="color: #008000">self</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets the receiver&#39;s size inside its frame. The method posts a</span>
<span style="color: #408080; font-style: italic">    CPViewBoundsDidChangeNotification to the default</span>
<span style="color: #408080; font-style: italic">    notification center if the receiver is configured to do so.</span>
<span style="color: #408080; font-style: italic">    @param aSize the new size for the receiver</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setBoundsSize:</span>(<span style="color: #B00040">CGSize</span>)aSize
{
    <span style="color: #008000; font-weight: bold">var</span> size <span style="color: #666666">=</span> _bounds.size;
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #0000FF">_CGSizeEqualToSize</span>(size, aSize))
        <span style="color: #008000; font-weight: bold">return</span>;

    <span style="color: #008000; font-weight: bold">var</span> frameSize <span style="color: #666666">=</span> _frame.size;

    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span><span style="color: #0000FF">_CGSizeEqualToSize</span>(size, frameSize))
    {
        <span style="color: #008000; font-weight: bold">var</span> origin <span style="color: #666666">=</span> _bounds.origin;
        
        origin.x <span style="color: #666666">/=</span> size.width <span style="color: #666666">/</span> frameSize.width;
        origin.y <span style="color: #666666">/=</span> size.height <span style="color: #666666">/</span> frameSize.height;
    }
    
    size.width <span style="color: #666666">=</span> aSize.width;
    size.height <span style="color: #666666">=</span> aSize.height;
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span><span style="color: #0000FF">_CGSizeEqualToSize</span>(size, frameSize))
    {
        <span style="color: #008000; font-weight: bold">var</span> origin <span style="color: #666666">=</span> _bounds.origin;
        
        origin.x <span style="color: #666666">*=</span> size.width <span style="color: #666666">/</span> frameSize.width;
        origin.y <span style="color: #666666">*=</span> size.height <span style="color: #666666">/</span> frameSize.height;
    }
    
    <span style="color: #008000; font-weight: bold">if</span> (_postsBoundsChangedNotifications <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>_inhibitFrameAndBoundsChangedNotifications)
        [CachedNotificationCenter postNotificationName<span style="color: #666666">:</span>CPViewBoundsDidChangeNotification object<span style="color: #666666">:</span><span style="color: #008000">self</span>];
}


<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Notifies subviews that the superview changed size.</span>
<span style="color: #408080; font-style: italic">    @param aSize the size of the old superview</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">resizeWithOldSuperviewSize:</span>(<span style="color: #B00040">CGSize</span>)aSize
{
    <span style="color: #008000; font-weight: bold">var</span> mask <span style="color: #666666">=</span> [<span style="color: #008000">self</span> autoresizingMask];
    
    <span style="color: #008000; font-weight: bold">if</span>(mask <span style="color: #666666">==</span> CPViewNotSizable)
        <span style="color: #008000; font-weight: bold">return</span>;

    <span style="color: #008000; font-weight: bold">var</span> frame <span style="color: #666666">=</span> _superview._frame,
        newFrame <span style="color: #666666">=</span> <span style="color: #0000FF">_CGRectMakeCopy</span>(_frame),
        dX <span style="color: #666666">=</span> (<span style="color: #0000FF">_CGRectGetWidth</span>(frame) <span style="color: #666666">-</span> aSize.width) <span style="color: #666666">/</span>
            (((mask <span style="color: #666666">&amp;</span> CPViewMinXMargin) <span style="color: #666666">?</span> <span style="color: #666666">1</span> <span style="color: #666666">:</span> <span style="color: #666666">0</span>) <span style="color: #666666">+</span> (mask <span style="color: #666666">&amp;</span> CPViewWidthSizable <span style="color: #666666">?</span> <span style="color: #666666">1</span> <span style="color: #666666">:</span> <span style="color: #666666">0</span>) <span style="color: #666666">+</span> (mask <span style="color: #666666">&amp;</span> CPViewMaxXMargin <span style="color: #666666">?</span> <span style="color: #666666">1</span> <span style="color: #666666">:</span> <span style="color: #666666">0</span>)),
        dY <span style="color: #666666">=</span> (<span style="color: #0000FF">_CGRectGetHeight</span>(frame) <span style="color: #666666">-</span> aSize.height) <span style="color: #666666">/</span>
            ((mask <span style="color: #666666">&amp;</span> CPViewMinYMargin <span style="color: #666666">?</span> <span style="color: #666666">1</span> <span style="color: #666666">:</span> <span style="color: #666666">0</span>) <span style="color: #666666">+</span> (mask <span style="color: #666666">&amp;</span> CPViewHeightSizable <span style="color: #666666">?</span> <span style="color: #666666">1</span> <span style="color: #666666">:</span> <span style="color: #666666">0</span>) <span style="color: #666666">+</span> (mask <span style="color: #666666">&amp;</span> CPViewMaxYMargin <span style="color: #666666">?</span> <span style="color: #666666">1</span> <span style="color: #666666">:</span> <span style="color: #666666">0</span>));

    <span style="color: #008000; font-weight: bold">if</span> (mask <span style="color: #666666">&amp;</span> CPViewMinXMargin)
        newFrame.origin.x <span style="color: #666666">+=</span> dX;
    <span style="color: #008000; font-weight: bold">if</span> (mask <span style="color: #666666">&amp;</span> CPViewWidthSizable)
        newFrame.size.width <span style="color: #666666">+=</span> dX;
    
    <span style="color: #008000; font-weight: bold">if</span> (mask <span style="color: #666666">&amp;</span> CPViewMinYMargin)
        newFrame.origin.y <span style="color: #666666">+=</span> dY;
    <span style="color: #008000; font-weight: bold">if</span> (mask <span style="color: #666666">&amp;</span> CPViewHeightSizable)
        newFrame.size.height <span style="color: #666666">+=</span> dY;

    [<span style="color: #008000">self</span> setFrame<span style="color: #666666">:</span>newFrame];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Initiates \c -superviewSizeChanged: messages to subviews.</span>
<span style="color: #408080; font-style: italic">    @param aSize the size for the subviews</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #008000; font-weight: bold">void</span>)resizeSubviewsWithOldSize<span style="color: #666666">:</span>(CGSize)aSize
{
    <span style="color: #008000; font-weight: bold">var</span> count <span style="color: #666666">=</span> _subviews.length;
    
    <span style="color: #008000; font-weight: bold">while</span> (count<span style="color: #666666">--</span>)
        [_subviews[count] resizeWithOldSuperviewSize<span style="color: #666666">:</span>aSize];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Specifies whether the receiver view should automatically resize its</span>
<span style="color: #408080; font-style: italic">    subviews when its \c -setFrameSize: method receives a change.</span>
<span style="color: #408080; font-style: italic">    @param aFlag If \c YES, then subviews will automatically be resized</span>
<span style="color: #408080; font-style: italic">    when this view is resized. \c NO means the views will not</span>
<span style="color: #408080; font-style: italic">    be resized automatically.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setAutoresizesSubviews:</span>(<span style="color: #B00040">BOOL</span>)aFlag
{
    _autoresizesSubviews <span style="color: #666666">=</span> <span style="color: #666666">!!</span>aFlag;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Reports whether the receiver automatically resizes its subviews when its frame size changes.</span>
<span style="color: #408080; font-style: italic">    @return \c YES means it resizes its subviews on a frame size change.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">autoresizesSubviews</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _autoresizesSubviews;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Determines automatic resizing behavior.</span>
<span style="color: #408080; font-style: italic">    @param aMask a bit mask with options</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setAutoresizingMask:</span>(<span style="color: #B00040">unsigned</span>)aMask
{
    _autoresizingMask <span style="color: #666666">=</span> aMask;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the bit mask options for resizing behavior</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">unsigned</span>)<span style="color: #0000FF">autoresizingMask</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _autoresizingMask;
}

<span style="color: #408080; font-style: italic">// Fullscreen Mode</span>

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Puts the receiver into full screen mode.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">enterFullScreenMode</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> enterFullScreenMode<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">nil</span> withOptions<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">nil</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Puts the receiver into full screen mode.</span>
<span style="color: #408080; font-style: italic">    @param aScreen the that should be used</span>
<span style="color: #408080; font-style: italic">    @param options configuration options</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">enterFullScreenMode:</span>(<span style="color: #B00040">CPScreen</span>)aScreen <span style="color: #0000FF">withOptions:</span>(<span style="color: #B00040">CPDictionary</span>)options
{
    _fullScreenModeState <span style="color: #666666">=</span> <span style="color: #0000FF">_CPViewFullScreenModeStateMake</span>(<span style="color: #008000">self</span>);
    
    <span style="color: #008000; font-weight: bold">var</span> fullScreenWindow <span style="color: #666666">=</span> [[CPWindow alloc] initWithContentRect<span style="color: #666666">:</span>[[CPPlatformWindow primaryPlatformWindow] contentBounds] styleMask<span style="color: #666666">:</span>CPBorderlessWindowMask];
    
    [fullScreenWindow setLevel<span style="color: #666666">:</span>CPScreenSaverWindowLevel];
    [fullScreenWindow setAutoresizingMask<span style="color: #666666">:</span>CPViewWidthSizable <span style="color: #666666">|</span> CPViewHeightSizable];
    
    <span style="color: #008000; font-weight: bold">var</span> contentView <span style="color: #666666">=</span> [fullScreenWindow contentView];
    
    [contentView setBackgroundColor<span style="color: #666666">:</span>[CPColor blackColor]];
    [contentView addSubview<span style="color: #666666">:</span><span style="color: #008000">self</span>];

    [<span style="color: #008000">self</span> setAutoresizingMask<span style="color: #666666">:</span>CPViewWidthSizable <span style="color: #666666">|</span> CPViewHeightSizable];
    [<span style="color: #008000">self</span> setFrame<span style="color: #666666">:</span><span style="color: #0000FF">CGRectMakeCopy</span>([contentView bounds])];

    [fullScreenWindow makeKeyAndOrderFront<span style="color: #666666">:</span><span style="color: #008000">self</span>];
    
    [fullScreenWindow makeFirstResponder<span style="color: #666666">:</span><span style="color: #008000">self</span>];
    
    _isInFullScreenMode <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">YES</span>;
    
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">YES</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    The receiver should exit full screen mode.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">exitFullScreenMode</span>
{
    [<span style="color: #008000">self</span> exitFullScreenModeWithOptions<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">nil</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    The receiver should exit full screen mode.</span>
<span style="color: #408080; font-style: italic">    @param options configurations options</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">exitFullScreenModeWithOptions:</span>(<span style="color: #B00040">CPDictionary</span>)options
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_isInFullScreenMode)
        <span style="color: #008000; font-weight: bold">return</span>;

    _isInFullScreenMode <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">NO</span>;

    [<span style="color: #008000">self</span> setFrame<span style="color: #666666">:</span>_fullScreenModeState.frame];
    [<span style="color: #008000">self</span> setAutoresizingMask<span style="color: #666666">:</span>_fullScreenModeState.autoresizingMask];
    [_fullScreenModeState.superview _insertSubview<span style="color: #666666">:</span><span style="color: #008000">self</span> atIndex<span style="color: #666666">:</span>_fullScreenModeState.index];
    
    [[<span style="color: #008000">self</span> <span style="color: #008000">window</span>] orderOut<span style="color: #666666">:</span><span style="color: #008000">self</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns \c YES if the receiver is currently in full screen mode.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">isInFullScreenMode</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _isInFullScreenMode;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets whether the receiver should be hidden.</span>
<span style="color: #408080; font-style: italic">    @param aFlag \c YES makes the receiver hidden.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setHidden:</span>(<span style="color: #B00040">BOOL</span>)aFlag
{
    aFlag <span style="color: #666666">=</span> <span style="color: #666666">!!</span>aFlag;

    <span style="color: #008000; font-weight: bold">if</span>(_isHidden <span style="color: #666666">===</span> aFlag)
        <span style="color: #008000; font-weight: bold">return</span>;

<span style="color: #408080; font-style: italic">//  FIXME: Should we return to visibility?  This breaks in FireFox, Opera, and IE.</span>
<span style="color: #408080; font-style: italic">//    _DOMElement.style.visibility = (_isHidden = aFlag) ? &quot;hidden&quot; : &quot;visible&quot;;</span>
    _isHidden <span style="color: #666666">=</span> aFlag;<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
    _DOMElement.style.display <span style="color: #666666">=</span> _isHidden <span style="color: #666666">?</span> <span style="color: #BA2121">&quot;none&quot;</span> <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;block&quot;</span>;<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>

    <span style="color: #008000; font-weight: bold">if</span> (aFlag)
    {
        <span style="color: #008000; font-weight: bold">var</span> view <span style="color: #666666">=</span> [_window firstResponder];

        <span style="color: #008000; font-weight: bold">if</span> ([view isKindOfClass<span style="color: #666666">:</span>[CPView class]])
        {
            <span style="color: #008000; font-weight: bold">do</span> 
            {
               <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span> <span style="color: #666666">==</span> view)
               {
                  [_window makeFirstResponder<span style="color: #666666">:</span>[<span style="color: #008000">self</span> nextValidKeyView]];
                  <span style="color: #008000; font-weight: bold">break</span>;
               }   
            } 
            <span style="color: #008000; font-weight: bold">while</span> (view <span style="color: #666666">=</span> [view superview]);
        }
    }
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns \c YES if the receiver is hidden.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">isHidden</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _isHidden;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets the opacity of the receiver. The value must be in the range of 0.0 to 1.0, where 0.0 is </span>
<span style="color: #408080; font-style: italic">    completely transparent and 1.0 is completely opaque.</span>
<span style="color: #408080; font-style: italic">    @param anAlphaValue an alpha value ranging from 0.0 to 1.0.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setAlphaValue:</span>(<span style="color: #B00040">float</span>)anAlphaValue
{
    <span style="color: #008000; font-weight: bold">if</span> (_opacity <span style="color: #666666">==</span> anAlphaValue)
        <span style="color: #008000; font-weight: bold">return</span>;
    
    _opacity <span style="color: #666666">=</span> anAlphaValue;<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">    </span>
<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #0000FF">CPFeatureIsCompatible</span>(CPOpacityRequiresFilterFeature))
    {
        <span style="color: #008000; font-weight: bold">if</span> (anAlphaValue <span style="color: #666666">==</span> <span style="color: #666666">1.0</span>)
            <span style="color: #008000; font-weight: bold">try</span> { _DOMElement.style.<span style="color: #0000FF">removeAttribute</span>(<span style="color: #BA2121">&quot;filter&quot;</span>) } <span style="color: #008000; font-weight: bold">catch</span> (anException) { }
        <span style="color: #008000; font-weight: bold">else</span>
            _DOMElement.style.filter <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;alpha(opacity=&quot;</span> <span style="color: #666666">+</span> anAlphaValue <span style="color: #666666">*</span> <span style="color: #666666">100</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;)&quot;</span>;
    }
    <span style="color: #008000; font-weight: bold">else</span>
        _DOMElement.style.opacity <span style="color: #666666">=</span> anAlphaValue;<span style="color: #BC7A00"></span>

<span style="color: #BC7A00">#endif</span>
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the alpha value of the receiver. Ranges from 0.0 to</span>
<span style="color: #408080; font-style: italic">    1.0, where 0.0 is completely transparent and 1.0 is completely opaque.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">float</span>)<span style="color: #0000FF">alphaValue</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _opacity;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns \c YES if the receiver is hidden, or one</span>
<span style="color: #408080; font-style: italic">    of it&#39;s ancestor views is hidden. \c NO, otherwise.</span>
<span style="color: #408080; font-style: italic">*/</span>   
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">isHiddenOrHasHiddenAncestor</span>
{
    <span style="color: #008000; font-weight: bold">var</span> view <span style="color: #666666">=</span> <span style="color: #008000">self</span>;
    
    <span style="color: #008000; font-weight: bold">while</span> (view <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>[view isHidden])
        view <span style="color: #666666">=</span> [view superview];
    
    <span style="color: #008000; font-weight: bold">return</span> view <span style="color: #666666">!==</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns whether the receiver should be sent a \c -mouseDown: message for \c anEvent.&lt;br/&gt;</span>
<span style="color: #408080; font-style: italic">    Returns \c YES by default.</span>
<span style="color: #408080; font-style: italic">    @return \c YES, if the view object accepts first mouse-down event. \c NO, otherwise.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #408080; font-style: italic">//FIXME: should be NO by default? </span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">acceptsFirstMouse:</span>(<span style="color: #B00040">CPEvent</span>)anEvent
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">YES</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns whether or not the view responds to hit tests.</span>
<span style="color: #408080; font-style: italic">    @return \c YES if this view listens to \c -hitTest messages, \c NO otherwise.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">hitTests</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _hitTests;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Set whether or not the view should respond to hit tests.</span>
<span style="color: #408080; font-style: italic">    @param shouldHitTest should be \c YES if this view should respond to hit tests, \c NO otherwise.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setHitTests:</span>(<span style="color: #B00040">BOOL</span>)shouldHitTest
{
    _hitTests <span style="color: #666666">=</span> <span style="color: #666666">!!</span>shouldHitTest;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Tests whether a point is contained within this view, or one of its subviews.</span>
<span style="color: #408080; font-style: italic">    @param aPoint the point to test</span>
<span style="color: #408080; font-style: italic">    @return returns the containing view, or nil if the point is not contained</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPView</span>)<span style="color: #0000FF">hitTest:</span>(<span style="color: #B00040">CPPoint</span>)aPoint
{
    <span style="color: #008000; font-weight: bold">if</span>(_isHidden <span style="color: #666666">||</span> <span style="color: #666666">!</span>_hitTests <span style="color: #666666">||</span> <span style="color: #666666">!</span><span style="color: #0000FF">CPRectContainsPoint</span>(_frame, aPoint))
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;
    
    <span style="color: #008000; font-weight: bold">var</span> view <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">nil</span>,
        i <span style="color: #666666">=</span> _subviews.length,
        adjustedPoint <span style="color: #666666">=</span> <span style="color: #0000FF">_CGPointMake</span>(aPoint.x <span style="color: #666666">-</span> <span style="color: #0000FF">_CGRectGetMinX</span>(_frame), aPoint.y <span style="color: #666666">-</span> <span style="color: #0000FF">_CGRectGetMinY</span>(_frame));

    <span style="color: #008000; font-weight: bold">if</span> (_inverseBoundsTransform)
        adjustedPoint <span style="color: #666666">=</span> <span style="color: #0000FF">_CGPointApplyAffineTransform</span>(adjustedPoint, _inverseBoundsTransform);

    <span style="color: #008000; font-weight: bold">while</span> (i<span style="color: #666666">--</span>)
        <span style="color: #008000; font-weight: bold">if</span> (view <span style="color: #666666">=</span> [_subviews[i] hitTest<span style="color: #666666">:</span>adjustedPoint])
            <span style="color: #008000; font-weight: bold">return</span> view;

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns \c YES if mouse events aren&#39;t needed by the receiver and can be sent to the superview. The</span>
<span style="color: #408080; font-style: italic">    default implementation returns \c NO if the view is opaque.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">mouseDownCanMoveWindow</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">!</span>[<span style="color: #008000">self</span> isOpaque];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">mouseDown:</span>(<span style="color: #B00040">CPEvent</span>)anEvent
{
    <span style="color: #008000; font-weight: bold">if</span> ([<span style="color: #008000">self</span> mouseDownCanMoveWindow])
        [<span style="color: #008000">super</span> mouseDown<span style="color: #666666">:</span>anEvent];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets the background color of the receiver.</span>
<span style="color: #408080; font-style: italic">    @param aColor the new color for the receiver&#39;s background</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setBackgroundColor:</span>(<span style="color: #B00040">CPColor</span>)aColor
{
    <span style="color: #008000; font-weight: bold">if</span> (_backgroundColor <span style="color: #666666">==</span> aColor)
        <span style="color: #008000; font-weight: bold">return</span>;
    
    _backgroundColor <span style="color: #666666">=</span> aColor;<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">    </span>
<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
    <span style="color: #008000; font-weight: bold">var</span> patternImage <span style="color: #666666">=</span> [_backgroundColor patternImage],
        amount <span style="color: #666666">=</span> <span style="color: #666666">0</span>;
    
    <span style="color: #008000; font-weight: bold">if</span> ([patternImage isThreePartImage])
    {
        _backgroundType <span style="color: #666666">=</span> [patternImage isVertical] <span style="color: #666666">?</span> BackgroundVerticalThreePartImage <span style="color: #666666">:</span> BackgroundHorizontalThreePartImage;
        
        amount <span style="color: #666666">=</span> <span style="color: #666666">3</span> <span style="color: #666666">-</span> _DOMImageParts.length;
    }
    <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> ([patternImage isNinePartImage])
    {
        _backgroundType <span style="color: #666666">=</span> BackgroundNinePartImage;
        
        amount <span style="color: #666666">=</span> <span style="color: #666666">9</span> <span style="color: #666666">-</span> _DOMImageParts.length;   
    }
    <span style="color: #008000; font-weight: bold">else</span>
    {
        _backgroundType <span style="color: #666666">=</span> BackgroundTrivialColor;

        amount <span style="color: #666666">=</span> <span style="color: #666666">0</span> <span style="color: #666666">-</span> _DOMImageParts.length;
    }

    <span style="color: #008000; font-weight: bold">if</span> (amount <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span>)
        <span style="color: #008000; font-weight: bold">while</span> (amount<span style="color: #666666">--</span>)
        {
            <span style="color: #008000; font-weight: bold">var</span> DOMElement <span style="color: #666666">=</span> DOMElementPrototype.<span style="color: #0000FF">cloneNode</span>(<span style="color: #008000; font-weight: bold">false</span>);
            
            DOMElement.style.zIndex <span style="color: #666666">=</span> <span style="color: #666666">-1000</span>;
            
            _DOMImageParts.<span style="color: #0000FF">push</span>(DOMElement);
            _DOMElement.<span style="color: #0000FF">appendChild</span>(DOMElement);
        }
    <span style="color: #008000; font-weight: bold">else</span>
    {
        amount <span style="color: #666666">=</span> <span style="color: #666666">-</span>amount;
        
        <span style="color: #008000; font-weight: bold">while</span> (amount<span style="color: #666666">--</span>)
            _DOMElement.<span style="color: #0000FF">removeChild</span>(_DOMImageParts.<span style="color: #0000FF">pop</span>());
    }
    
    <span style="color: #008000; font-weight: bold">if</span> (_backgroundType <span style="color: #666666">==</span> BackgroundTrivialColor)
    
        <span style="color: #408080; font-style: italic">// Opera doesn&#39;t like DOM properties set to nil.</span>
        <span style="color: #408080; font-style: italic">// https://trac.280north.com/ticket/7</span>
        _DOMElement.style.background <span style="color: #666666">=</span> _backgroundColor <span style="color: #666666">?</span> [_backgroundColor cssString] <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>;
    
    <span style="color: #008000; font-weight: bold">else</span>
    {
        <span style="color: #008000; font-weight: bold">var</span> slices <span style="color: #666666">=</span> [patternImage imageSlices],
            count <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">MIN</span>(_DOMImageParts.length, slices.length),
            frameSize <span style="color: #666666">=</span> _frame.size;

        <span style="color: #008000; font-weight: bold">while</span> (count<span style="color: #666666">--</span>)
        {
            <span style="color: #008000; font-weight: bold">var</span> image <span style="color: #666666">=</span> slices[count],
                size <span style="color: #666666">=</span> _DOMImageSizes[count] <span style="color: #666666">=</span> image <span style="color: #666666">?</span> [image size] <span style="color: #666666">:</span> <span style="color: #0000FF">_CGSizeMakeZero</span>();
            
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[count], size.width, size.height);

            _DOMImageParts[count].style.background <span style="color: #666666">=</span> image <span style="color: #666666">?</span> <span style="color: #BA2121">&quot;url(</span><span style="color: #BB6622; font-weight: bold">\&quot;</span><span style="color: #BA2121">&quot;</span> <span style="color: #666666">+</span> [image filename] <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\&quot;</span><span style="color: #BA2121">)&quot;</span> <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>;
        }
        
        <span style="color: #008000; font-weight: bold">if</span> (_backgroundType <span style="color: #666666">==</span> BackgroundNinePartImage)
        {
            <span style="color: #008000; font-weight: bold">var</span> width <span style="color: #666666">=</span> frameSize.width <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">0</span>].width <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">2</span>].width,
                height <span style="color: #666666">=</span> frameSize.height <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">0</span>].height <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">6</span>].height;
            
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">1</span>], width, _DOMImageSizes[<span style="color: #666666">0</span>].height);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">3</span>], _DOMImageSizes[<span style="color: #666666">3</span>].width, height);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">4</span>], width, height);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">5</span>], _DOMImageSizes[<span style="color: #666666">5</span>].width, height);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">7</span>], width, _DOMImageSizes[<span style="color: #666666">7</span>].height);
                
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftTop</span>(_DOMImageParts[<span style="color: #666666">0</span>], <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #666666">0.0</span>, <span style="color: #666666">0.0</span>);            
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftTop</span>(_DOMImageParts[<span style="color: #666666">1</span>], <span style="color: #008000; font-weight: bold">NULL</span>, _DOMImageSizes[<span style="color: #666666">0</span>].width, <span style="color: #666666">0.0</span>);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleRightTop</span>(_DOMImageParts[<span style="color: #666666">2</span>], <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #666666">0.0</span>, <span style="color: #666666">0.0</span>);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftTop</span>(_DOMImageParts[<span style="color: #666666">3</span>], <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #666666">0.0</span>, _DOMImageSizes[<span style="color: #666666">1</span>].height);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftTop</span>(_DOMImageParts[<span style="color: #666666">4</span>], <span style="color: #008000; font-weight: bold">NULL</span>, _DOMImageSizes[<span style="color: #666666">0</span>].width, _DOMImageSizes[<span style="color: #666666">0</span>].height);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleRightTop</span>(_DOMImageParts[<span style="color: #666666">5</span>], <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #666666">0.0</span>, _DOMImageSizes[<span style="color: #666666">1</span>].height);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftBottom</span>(_DOMImageParts[<span style="color: #666666">6</span>], <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #666666">0.0</span>, <span style="color: #666666">0.0</span>);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftBottom</span>(_DOMImageParts[<span style="color: #666666">7</span>], <span style="color: #008000; font-weight: bold">NULL</span>, _DOMImageSizes[<span style="color: #666666">6</span>].width, <span style="color: #666666">0.0</span>);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleRightBottom</span>(_DOMImageParts[<span style="color: #666666">8</span>], <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #666666">0.0</span>, <span style="color: #666666">0.0</span>);      
        }
        <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (_backgroundType <span style="color: #666666">==</span> BackgroundVerticalThreePartImage)
        {    
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">1</span>], frameSize.width, frameSize.height <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">0</span>].height <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">2</span>].height);
            
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftTop</span>(_DOMImageParts[<span style="color: #666666">0</span>], <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #666666">0.0</span>, <span style="color: #666666">0.0</span>);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftTop</span>(_DOMImageParts[<span style="color: #666666">1</span>], <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #666666">0.0</span>, _DOMImageSizes[<span style="color: #666666">0</span>].height);        
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftBottom</span>(_DOMImageParts[<span style="color: #666666">2</span>], <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #666666">0.0</span>, <span style="color: #666666">0.0</span>);
        }
        <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (_backgroundType <span style="color: #666666">==</span> BackgroundHorizontalThreePartImage)
        {
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMImageParts[<span style="color: #666666">1</span>], frameSize.width <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">0</span>].width <span style="color: #666666">-</span> _DOMImageSizes[<span style="color: #666666">2</span>].width, frameSize.height);
        
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftTop</span>(_DOMImageParts[<span style="color: #666666">0</span>], <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #666666">0.0</span>, <span style="color: #666666">0.0</span>);
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftTop</span>(_DOMImageParts[<span style="color: #666666">1</span>], <span style="color: #008000; font-weight: bold">NULL</span>, _DOMImageSizes[<span style="color: #666666">0</span>].width, <span style="color: #666666">0.0</span>);        
            <span style="color: #0000FF">CPDOMDisplayServerSetStyleRightTop</span>(_DOMImageParts[<span style="color: #666666">2</span>], <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #666666">0.0</span>, <span style="color: #666666">0.0</span>);
        }
    }<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the background color of the receiver</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPColor</span>)<span style="color: #0000FF">backgroundColor</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _backgroundColor;
}

<span style="color: #408080; font-style: italic">// Converting Coordinates</span>
<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Converts \c aPoint from the coordinate space of \c aView to the coordinate space of the receiver.</span>
<span style="color: #408080; font-style: italic">    @param aPoint the point to convert</span>
<span style="color: #408080; font-style: italic">    @param aView the view space to convert from</span>
<span style="color: #408080; font-style: italic">    @return the converted point</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CGPoint</span>)<span style="color: #0000FF">convertPoint:</span>(<span style="color: #B00040">CGPoint</span>)aPoint <span style="color: #0000FF">fromView:</span>(<span style="color: #B00040">CPView</span>)aView
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">CGPointApplyAffineTransform</span>(aPoint, <span style="color: #0000FF">_CPViewGetTransform</span>(aView, <span style="color: #008000">self</span>));
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Converts \c aPoint from the receiver&#39;s coordinate space to the coordinate space of \c aView.</span>
<span style="color: #408080; font-style: italic">    @param aPoint the point to convert</span>
<span style="color: #408080; font-style: italic">    @param aView the coordinate space to which the point will be converted</span>
<span style="color: #408080; font-style: italic">    @return the converted point</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CGPoint</span>)<span style="color: #0000FF">convertPoint:</span>(<span style="color: #B00040">CGPoint</span>)aPoint <span style="color: #0000FF">toView:</span>(<span style="color: #B00040">CPView</span>)aView
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">CGPointApplyAffineTransform</span>(aPoint, <span style="color: #0000FF">_CPViewGetTransform</span>(<span style="color: #008000">self</span>, aView));
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Convert&#39;s \c aSize from \c aView&#39;s coordinate space to the receiver&#39;s coordinate space.</span>
<span style="color: #408080; font-style: italic">    @param aSize the size to convert</span>
<span style="color: #408080; font-style: italic">    @param aView the coordinate space to convert from</span>
<span style="color: #408080; font-style: italic">    @return the converted size</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CGSize</span>)<span style="color: #0000FF">convertSize:</span>(<span style="color: #B00040">CGSize</span>)aSize <span style="color: #0000FF">fromView:</span>(<span style="color: #B00040">CPView</span>)aView
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">CGSizeApplyAffineTransform</span>(aSize, <span style="color: #0000FF">_CPViewGetTransform</span>(aView, <span style="color: #008000">self</span>));
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Convert&#39;s \c aSize from the receiver&#39;s coordinate space to \c aView&#39;s coordinate space.</span>
<span style="color: #408080; font-style: italic">    @param aSize the size to convert</span>
<span style="color: #408080; font-style: italic">    @param the coordinate space to which the size will be converted</span>
<span style="color: #408080; font-style: italic">    @return the converted size</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CGSize</span>)<span style="color: #0000FF">convertSize:</span>(<span style="color: #B00040">CGSize</span>)aSize <span style="color: #0000FF">toView:</span>(<span style="color: #B00040">CPView</span>)aView
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">CGSizeApplyAffineTransform</span>(aSize, <span style="color: #0000FF">_CPViewGetTransform</span>(<span style="color: #008000">self</span>, aView));
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Converts \c aRect from \c aView&#39;s coordinate space to the receiver&#39;s space.</span>
<span style="color: #408080; font-style: italic">    @param aRect the rectangle to convert</span>
<span style="color: #408080; font-style: italic">    @param aView the coordinate space from which to convert</span>
<span style="color: #408080; font-style: italic">    @return the converted rectangle</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CGRect</span>)<span style="color: #0000FF">convertRect:</span>(<span style="color: #B00040">CGRect</span>)aRect <span style="color: #0000FF">fromView:</span>(<span style="color: #B00040">CPView</span>)aView
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">CGRectApplyAffineTransform</span>(aRect, <span style="color: #0000FF">_CPViewGetTransform</span>(aView, <span style="color: #008000">self</span>));
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Converts \c aRect from the receiver&#39;s coordinate space to \c aView&#39;s coordinate space.</span>
<span style="color: #408080; font-style: italic">    @param aRect the rectangle to convert</span>
<span style="color: #408080; font-style: italic">    @param aView the coordinate space to which the rectangle will be converted</span>
<span style="color: #408080; font-style: italic">    @return the converted rectangle</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CGRect</span>)<span style="color: #0000FF">convertRect:</span>(<span style="color: #B00040">CGRect</span>)aRect <span style="color: #0000FF">toView:</span>(<span style="color: #B00040">CPView</span>)aView
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">CGRectApplyAffineTransform</span>(aRect, <span style="color: #0000FF">_CPViewGetTransform</span>(<span style="color: #008000">self</span>, aView));
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets whether the receiver posts a CPViewFrameDidChangeNotification notification</span>
<span style="color: #408080; font-style: italic">    to the default notification center when its frame is changed. The default is \c NO.</span>
<span style="color: #408080; font-style: italic">    Methods that could cause a frame change notification are:</span>
<span style="color: #408080; font-style: italic">&lt;pre&gt;</span>
<span style="color: #408080; font-style: italic">setFrame:</span>
<span style="color: #408080; font-style: italic">setFrameSize:</span>
<span style="color: #408080; font-style: italic">setFrameOrigin:</span>
<span style="color: #408080; font-style: italic">&lt;/pre&gt;</span>
<span style="color: #408080; font-style: italic">    @param shouldPostFrameChangedNotifications \c YES makes the receiver post</span>
<span style="color: #408080; font-style: italic">    notifications on frame changes (size or origin)</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setPostsFrameChangedNotifications:</span>(<span style="color: #B00040">BOOL</span>)shouldPostFrameChangedNotifications
{
    shouldPostFrameChangedNotifications <span style="color: #666666">=</span> <span style="color: #666666">!!</span>shouldPostFrameChangedNotifications;

    <span style="color: #008000; font-weight: bold">if</span> (_postsFrameChangedNotifications <span style="color: #666666">===</span> shouldPostFrameChangedNotifications)
        <span style="color: #008000; font-weight: bold">return</span>;

    _postsFrameChangedNotifications <span style="color: #666666">=</span> shouldPostFrameChangedNotifications;

    <span style="color: #008000; font-weight: bold">if</span> (_postsFrameChangedNotifications)
        [CachedNotificationCenter postNotificationName<span style="color: #666666">:</span>CPViewFrameDidChangeNotification object<span style="color: #666666">:</span><span style="color: #008000">self</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns \c YES if the receiver posts a CPViewFrameDidChangeNotification if its frame is changed.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">postsFrameChangedNotifications</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _postsFrameChangedNotifications;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets whether the receiver posts a CPViewBoundsDidChangeNotification notification</span>
<span style="color: #408080; font-style: italic">    to the default notification center when its bounds is changed. The default is \c NO.</span>
<span style="color: #408080; font-style: italic">    Methods that could cause a bounds change notification are:</span>
<span style="color: #408080; font-style: italic">&lt;pre&gt;</span>
<span style="color: #408080; font-style: italic">setBounds:</span>
<span style="color: #408080; font-style: italic">setBoundsSize:</span>
<span style="color: #408080; font-style: italic">setBoundsOrigin:</span>
<span style="color: #408080; font-style: italic">&lt;/pre&gt;</span>
<span style="color: #408080; font-style: italic">    @param shouldPostBoundsChangedNotifications \c YES makes the receiver post</span>
<span style="color: #408080; font-style: italic">    notifications on bounds changes</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setPostsBoundsChangedNotifications:</span>(<span style="color: #B00040">BOOL</span>)shouldPostBoundsChangedNotifications
{
    shouldPostBoundsChangedNotifications <span style="color: #666666">=</span> <span style="color: #666666">!!</span>shouldPostBoundsChangedNotifications;

    <span style="color: #008000; font-weight: bold">if</span> (_postsBoundsChangedNotifications <span style="color: #666666">===</span> shouldPostBoundsChangedNotifications)
        <span style="color: #008000; font-weight: bold">return</span>;

    _postsBoundsChangedNotifications <span style="color: #666666">=</span> shouldPostBoundsChangedNotifications;

    <span style="color: #008000; font-weight: bold">if</span> (_postsBoundsChangedNotifications)
        [CachedNotificationCenter postNotificationName<span style="color: #666666">:</span>CPViewBoundsDidChangeNotification object<span style="color: #666666">:</span><span style="color: #008000">self</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns \c YES if the receiver posts a</span>
<span style="color: #408080; font-style: italic">    CPViewBoundsDidChangeNotification when its</span>
<span style="color: #408080; font-style: italic">    bounds is changed.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">postsBoundsChangedNotifications</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _postsBoundsChangedNotifications;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Initiates a drag operation from the receiver to another view that accepts dragged data.</span>
<span style="color: #408080; font-style: italic">    @param anImage the image to be dragged</span>
<span style="color: #408080; font-style: italic">    @param aLocation the lower-left corner coordinate of \c anImage</span>
<span style="color: #408080; font-style: italic">    @param mouseOffset the distance from the \c -mouseDown: location and the current location</span>
<span style="color: #408080; font-style: italic">    @param anEvent the \c -mouseDown: that triggered the drag</span>
<span style="color: #408080; font-style: italic">    @param aPastebaord the pasteboard that holds the drag data</span>
<span style="color: #408080; font-style: italic">    @param aSourceObject the drag operation controller</span>
<span style="color: #408080; font-style: italic">    @param slideBack Whether the image should &#39;slide back&#39; if the drag is rejected</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">dragImage:</span>(<span style="color: #B00040">CPImage</span>)anImage <span style="color: #0000FF">at:</span>(<span style="color: #B00040">CGPoint</span>)aLocation <span style="color: #0000FF">offset:</span>(<span style="color: #B00040">CGSize</span>)mouseOffset <span style="color: #0000FF">event:</span>(<span style="color: #B00040">CPEvent</span>)anEvent <span style="color: #0000FF">pasteboard:</span>(<span style="color: #B00040">CPPasteboard</span>)aPasteboard <span style="color: #0000FF">source:</span>(<span style="color: #B00040">id</span>)aSourceObject <span style="color: #0000FF">slideBack:</span>(<span style="color: #B00040">BOOL</span>)slideBack
{
    [_window dragImage<span style="color: #666666">:</span>anImage at<span style="color: #666666">:</span>[<span style="color: #008000">self</span> convertPoint<span style="color: #666666">:</span>aLocation toView<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">nil</span>] offset<span style="color: #666666">:</span>mouseOffset event<span style="color: #666666">:</span>anEvent pasteboard<span style="color: #666666">:</span>aPasteboard source<span style="color: #666666">:</span>aSourceObject slideBack<span style="color: #666666">:</span>slideBack];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Initiates a drag operation from the receiver to another view that accepts dragged data.</span>
<span style="color: #408080; font-style: italic">    @param aView the view to be dragged</span>
<span style="color: #408080; font-style: italic">    @param aLocation the top-left corner coordinate of \c aView</span>
<span style="color: #408080; font-style: italic">    @param mouseOffset the distance from the \c -mouseDown: location and the current location</span>
<span style="color: #408080; font-style: italic">    @param anEvent the \c -mouseDown: that triggered the drag</span>
<span style="color: #408080; font-style: italic">    @param aPastebaord the pasteboard that holds the drag data</span>
<span style="color: #408080; font-style: italic">    @param aSourceObject the drag operation controller</span>
<span style="color: #408080; font-style: italic">    @param slideBack Whether the view should &#39;slide back&#39; if the drag is rejected</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">dragView:</span>(<span style="color: #B00040">CPView</span>)aView <span style="color: #0000FF">at:</span>(<span style="color: #B00040">CPPoint</span>)aLocation <span style="color: #0000FF">offset:</span>(<span style="color: #B00040">CPSize</span>)mouseOffset <span style="color: #0000FF">event:</span>(<span style="color: #B00040">CPEvent</span>)anEvent <span style="color: #0000FF">pasteboard:</span>(<span style="color: #B00040">CPPasteboard</span>)aPasteboard <span style="color: #0000FF">source:</span>(<span style="color: #B00040">id</span>)aSourceObject <span style="color: #0000FF">slideBack:</span>(<span style="color: #B00040">BOOL</span>)slideBack
{
    [_window dragView<span style="color: #666666">:</span>aView at<span style="color: #666666">:</span>[<span style="color: #008000">self</span> convertPoint<span style="color: #666666">:</span>aLocation toView<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">nil</span>] offset<span style="color: #666666">:</span>mouseOffset event<span style="color: #666666">:</span>anEvent pasteboard<span style="color: #666666">:</span>aPasteboard source<span style="color: #666666">:</span>aSourceObject slideBack<span style="color: #666666">:</span>slideBack];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets the receiver&#39;s list of acceptable data types for a dragging operation.</span>
<span style="color: #408080; font-style: italic">    @param pasteboardTypes an array of CPPasteboards</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">registerForDraggedTypes:</span>(<span style="color: #B00040">CPArray</span>)pasteboardTypes
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>pasteboardTypes <span style="color: #666666">||</span> <span style="color: #666666">!</span>[pasteboardTypes count])
        <span style="color: #008000; font-weight: bold">return</span>;

    <span style="color: #008000; font-weight: bold">var</span> theWindow <span style="color: #666666">=</span> [<span style="color: #008000">self</span> <span style="color: #008000">window</span>];

    [theWindow _noteUnregisteredDraggedTypes<span style="color: #666666">:</span>_registeredDraggedTypes];
    [_registeredDraggedTypes addObjectsFromArray<span style="color: #666666">:</span>pasteboardTypes]
    [theWindow _noteRegisteredDraggedTypes<span style="color: #666666">:</span>_registeredDraggedTypes];

    _registeredDraggedTypesArray <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns an array of all types the receiver accepts for dragging operations.</span>
<span style="color: #408080; font-style: italic">    @return an array of CPPasteBoards</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">registeredDraggedTypes</span>
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_registeredDraggedTypesArray)
        _registeredDraggedTypesArray <span style="color: #666666">=</span> [_registeredDraggedTypes allObjects];

    <span style="color: #008000; font-weight: bold">return</span> _registeredDraggedTypesArray;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Resets the array of acceptable data types for a dragging operation.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">unregisterDraggedTypes</span>
{
    [[<span style="color: #008000">self</span> <span style="color: #008000">window</span>] _noteUnregisteredDraggedTypes<span style="color: #666666">:</span>_registeredDraggedTypes];

    _registeredDraggedTypes <span style="color: #666666">=</span> [CPSet set];
    _registeredDraggedTypesArray <span style="color: #666666">=</span> [];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Draws the receiver into \c aRect. This method should be overridden by subclasses.</span>
<span style="color: #408080; font-style: italic">    @param aRect the area that should be drawn into</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">drawRect:</span>(<span style="color: #B00040">CPRect</span>)aRect
{

}

<span style="color: #408080; font-style: italic">// Displaying</span>

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Marks the entire view as dirty, and needing a redraw.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setNeedsDisplay:</span>(<span style="color: #B00040">BOOL</span>)aFlag
{
    <span style="color: #008000; font-weight: bold">if</span> (aFlag)
        [<span style="color: #008000">self</span> setNeedsDisplayInRect<span style="color: #666666">:</span>[<span style="color: #008000">self</span> bounds]];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Marks the area denoted by \c aRect as dirty, and initiates a redraw on it.</span>
<span style="color: #408080; font-style: italic">    @param aRect the area that needs to be redrawn</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setNeedsDisplayInRect:</span>(<span style="color: #B00040">CPRect</span>)aRect
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>(_viewClassFlags <span style="color: #666666">&amp;</span> CPViewHasCustomDrawRect))
        <span style="color: #008000; font-weight: bold">return</span>;

    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #0000FF">_CGRectIsEmpty</span>(aRect))
        <span style="color: #008000; font-weight: bold">return</span>;

    <span style="color: #008000; font-weight: bold">if</span> (_dirtyRect <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span><span style="color: #0000FF">_CGRectIsEmpty</span>(_dirtyRect))
        _dirtyRect <span style="color: #666666">=</span> <span style="color: #0000FF">CGRectUnion</span>(aRect, _dirtyRect);
    <span style="color: #008000; font-weight: bold">else</span>
        _dirtyRect <span style="color: #666666">=</span> <span style="color: #0000FF">_CGRectMakeCopy</span>(aRect);

    <span style="color: #0000FF">_CPDisplayServerAddDisplayObject</span>(<span style="color: #008000">self</span>);
}

<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">needsDisplay</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _dirtyRect <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span><span style="color: #0000FF">_CGRectIsEmpty</span>(_dirtyRect);
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Displays the receiver and any of its subviews that need to be displayed.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">displayIfNeeded</span>
{
    <span style="color: #008000; font-weight: bold">if</span> ([<span style="color: #008000">self</span> needsDisplay])
        [<span style="color: #008000">self</span> displayRect<span style="color: #666666">:</span>_dirtyRect];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Draws the entire area of the receiver as defined by its \c -bounds.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">display</span>
{
    [<span style="color: #008000">self</span> displayRect<span style="color: #666666">:</span>[<span style="color: #008000">self</span> visibleRect]];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">displayIfNeededInRect:</span>(<span style="color: #B00040">CGRect</span>)aRect
{
    <span style="color: #008000; font-weight: bold">if</span> ([<span style="color: #008000">self</span> needsDisplay])
        [<span style="color: #008000">self</span> displayRect<span style="color: #666666">:</span>aRect];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Draws the receiver into the area defined by \c aRect.</span>
<span style="color: #408080; font-style: italic">    @param aRect the area to be drawn</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">displayRect:</span>(<span style="color: #B00040">CPRect</span>)aRect
{
    [<span style="color: #008000">self</span> viewWillDraw];
    
    [<span style="color: #008000">self</span> displayRectIgnoringOpacity<span style="color: #666666">:</span>aRect inContext<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">nil</span>];
    
    _dirtyRect <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">NULL</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">displayRectIgnoringOpacity:</span>(<span style="color: #B00040">CGRect</span>)aRect <span style="color: #0000FF">inContext:</span>(<span style="color: #B00040">CPGraphicsContext</span>)aGraphicsContext
{
    [<span style="color: #008000">self</span> lockFocus];
    
    <span style="color: #0000FF">CGContextClearRect</span>([[CPGraphicsContext currentContext] graphicsPort], aRect);
    
    [<span style="color: #008000">self</span> drawRect<span style="color: #666666">:</span>aRect];
    [<span style="color: #008000">self</span> unlockFocus];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">viewWillDraw</span>
{
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Locks focus on the receiver, so drawing commands apply to it.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">lockFocus</span>
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_graphicsContext)
    {
        <span style="color: #008000; font-weight: bold">var</span> graphicsPort <span style="color: #666666">=</span> <span style="color: #0000FF">CGBitmapGraphicsContextCreate</span>();
        
        _DOMContentsElement <span style="color: #666666">=</span> graphicsPort.DOMElement;
        
        _DOMContentsElement.style.zIndex <span style="color: #666666">=</span> <span style="color: #666666">-100</span>;

        _DOMContentsElement.style.overflow <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;hidden&quot;</span>;
        _DOMContentsElement.style.position <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;absolute&quot;</span>;
        _DOMContentsElement.style.visibility <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;visible&quot;</span>;
        
        _DOMContentsElement.width <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">ROUND</span>(<span style="color: #0000FF">_CGRectGetWidth</span>(_frame));
        _DOMContentsElement.height <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">ROUND</span>(<span style="color: #0000FF">_CGRectGetHeight</span>(_frame));
        
        _DOMContentsElement.style.top <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;0px&quot;</span>;
        _DOMContentsElement.style.left <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;0px&quot;</span>;
        _DOMContentsElement.style.width <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">ROUND</span>(<span style="color: #0000FF">_CGRectGetWidth</span>(_frame)) <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;px&quot;</span>;
        _DOMContentsElement.style.height <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">ROUND</span>(<span style="color: #0000FF">_CGRectGetHeight</span>(_frame)) <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;px&quot;</span>;

        <span style="color: #0000FF">CPDOMDisplayServerAppendChild</span>(_DOMElement, _DOMContentsElement);
        
        _graphicsContext <span style="color: #666666">=</span> [CPGraphicsContext graphicsContextWithGraphicsPort<span style="color: #666666">:</span>graphicsPort flipped<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">YES</span>];
    }
    
    [CPGraphicsContext setCurrentContext<span style="color: #666666">:</span>_graphicsContext];
    
    <span style="color: #0000FF">CGContextSaveGState</span>([_graphicsContext graphicsPort]);
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Takes focus away from the receiver, and restores it to the previous view.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">unlockFocus</span>
{
    <span style="color: #0000FF">CGContextRestoreGState</span>([_graphicsContext graphicsPort]);
    
    [CPGraphicsContext setCurrentContext<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">nil</span>];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setNeedsLayout</span>
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>(_viewClassFlags <span style="color: #666666">&amp;</span> CPViewHasCustomLayoutSubviews))
        <span style="color: #008000; font-weight: bold">return</span>;

    _needsLayout <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">YES</span>;

    <span style="color: #0000FF">_CPDisplayServerAddLayoutObject</span>(<span style="color: #008000">self</span>);
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">layoutIfNeeded</span>
{
    <span style="color: #008000; font-weight: bold">if</span> (_needsLayout)
    {
        _needsLayout <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">NO</span>;
    
        [<span style="color: #008000">self</span> layoutSubviews];
    }
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">layoutSubviews</span>
{
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns whether the receiver is completely opaque. By default, returns \c NO.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">isOpaque</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">NO</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the rectangle of the receiver not clipped by its superview.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CGRect</span>)<span style="color: #0000FF">visibleRect</span>
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_superview)
        <span style="color: #008000; font-weight: bold">return</span> _bounds;
    
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">CGRectIntersection</span>([<span style="color: #008000">self</span> convertRect<span style="color: #666666">:</span>[_superview visibleRect] fromView<span style="color: #666666">:</span>_superview], _bounds);
}

<span style="color: #408080; font-style: italic">// Scrolling</span>
<span style="color: #408080; font-style: italic">/* @ignore */</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPScrollView</span>)<span style="color: #0000FF">_enclosingClipView</span>
{
    <span style="color: #008000; font-weight: bold">var</span> superview <span style="color: #666666">=</span> _superview,
        clipViewClass <span style="color: #666666">=</span> [CPClipView class];

    <span style="color: #008000; font-weight: bold">while</span>(superview <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>[superview isKindOfClass<span style="color: #666666">:</span>clipViewClass]) 
        superview <span style="color: #666666">=</span> superview._superview;

    <span style="color: #008000; font-weight: bold">return</span> superview;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Changes the receiver&#39;s frame origin to a &#39;constrained&#39; \c aPoint.</span>
<span style="color: #408080; font-style: italic">    @param aPoint the proposed frame origin</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">scrollPoint:</span>(<span style="color: #B00040">CGPoint</span>)aPoint
{
    <span style="color: #008000; font-weight: bold">var</span> clipView <span style="color: #666666">=</span> [<span style="color: #008000">self</span> _enclosingClipView];
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>clipView)
        <span style="color: #008000; font-weight: bold">return</span>;
    
    [clipView scrollToPoint<span style="color: #666666">:</span>[<span style="color: #008000">self</span> convertPoint<span style="color: #666666">:</span>aPoint toView<span style="color: #666666">:</span>clipView]];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Scrolls the nearest ancestor CPClipView a minimum amount so \c aRect can become visible.</span>
<span style="color: #408080; font-style: italic">    @param aRect the area to become visible</span>
<span style="color: #408080; font-style: italic">    @return &lt;codeYES if any scrolling occurred, \c NO otherwise.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">scrollRectToVisible:</span>(<span style="color: #B00040">CGRect</span>)aRect
{
    <span style="color: #008000; font-weight: bold">var</span> visibleRect <span style="color: #666666">=</span> [<span style="color: #008000">self</span> visibleRect];
    
    <span style="color: #408080; font-style: italic">// Make sure we have a rect that exists.</span>
    aRect <span style="color: #666666">=</span> <span style="color: #0000FF">CGRectIntersection</span>(aRect, _bounds);
    
    <span style="color: #408080; font-style: italic">// If aRect is empty or is already visible then no scrolling required.</span>
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #0000FF">_CGRectIsEmpty</span>(aRect) <span style="color: #666666">||</span> <span style="color: #0000FF">CGRectContainsRect</span>(visibleRect, aRect))
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">NO</span>;

    <span style="color: #008000; font-weight: bold">var</span> enclosingClipView <span style="color: #666666">=</span> [<span style="color: #008000">self</span> _enclosingClipView];
    
    <span style="color: #408080; font-style: italic">// If we&#39;re not in a clip view, then there isn&#39;t much we can do.</span>
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>enclosingClipView)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">NO</span>;
    
    <span style="color: #008000; font-weight: bold">var</span> scrollPoint <span style="color: #666666">=</span> <span style="color: #0000FF">_CGPointMakeCopy</span>(visibleRect.origin);
            
    <span style="color: #408080; font-style: italic">// One of the following has to be true since our current visible rect didn&#39;t contain aRect.</span>
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #0000FF">_CGRectGetMinX</span>(aRect) <span style="color: #666666">&lt;=</span> <span style="color: #0000FF">_CGRectGetMinX</span>(visibleRect))
        scrollPoint.x <span style="color: #666666">=</span> <span style="color: #0000FF">_CGRectGetMinX</span>(aRect);
    <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #0000FF">_CGRectGetMaxX</span>(aRect) <span style="color: #666666">&gt;</span> <span style="color: #0000FF">_CGRectGetMaxX</span>(visibleRect))
        scrollPoint.x <span style="color: #666666">+=</span> <span style="color: #0000FF">_CGRectGetMaxX</span>(aRect) <span style="color: #666666">-</span> <span style="color: #0000FF">_CGRectGetMaxX</span>(visibleRect);
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #0000FF">_CGRectGetMinY</span>(aRect) <span style="color: #666666">&lt;=</span> <span style="color: #0000FF">_CGRectGetMinY</span>(visibleRect))
        scrollPoint.y <span style="color: #666666">=</span> <span style="color: #0000FF">CGRectGetMinY</span>(aRect);
    <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #0000FF">_CGRectGetMaxY</span>(aRect) <span style="color: #666666">&gt;</span> <span style="color: #0000FF">_CGRectGetMaxY</span>(visibleRect))
        scrollPoint.y <span style="color: #666666">+=</span> <span style="color: #0000FF">_CGRectGetMaxY</span>(aRect) <span style="color: #666666">-</span> <span style="color: #0000FF">_CGRectGetMaxY</span>(visibleRect);
    
    [enclosingClipView scrollToPoint<span style="color: #666666">:</span><span style="color: #0000FF">CGPointMake</span>(scrollPoint.x, scrollPoint.y)];
    
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">YES</span>;
}

<span style="color: #408080; font-style: italic">/*</span>
<span style="color: #408080; font-style: italic">    FIXME Not yet implemented</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">autoscroll:</span>(<span style="color: #B00040">CPEvent</span>)anEvent
{
    <span style="color: #008000; font-weight: bold">return</span> [[<span style="color: #008000">self</span> superview] autoscroll<span style="color: #666666">:</span>anEvent];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Subclasses can override this to modify the visible rectangle after a</span>
<span style="color: #408080; font-style: italic">    scrolling operation. The default implementation simply returns the provided rectangle.</span>
<span style="color: #408080; font-style: italic">    @param proposedVisibleRect the rectangle to alter</span>
<span style="color: #408080; font-style: italic">    @return the same adjusted rectangle</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CGRect</span>)<span style="color: #0000FF">adjustScroll:</span>(<span style="color: #B00040">CGRect</span>)proposedVisibleRect
{
    <span style="color: #008000; font-weight: bold">return</span> proposedVisibleRect;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Should be overridden by subclasses.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">scrollRect:</span>(<span style="color: #B00040">CGRect</span>)aRect <span style="color: #0000FF">by:</span>(<span style="color: #B00040">float</span>)anAmount
{

}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the CPScrollView containing the receiver.</span>
<span style="color: #408080; font-style: italic">    @return the CPScrollView containing the receiver.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPScrollView</span>)<span style="color: #0000FF">enclosingScrollView</span>
{
    <span style="color: #008000; font-weight: bold">var</span> superview <span style="color: #666666">=</span> _superview,
        scrollViewClass <span style="color: #666666">=</span> [CPScrollView class];

    <span style="color: #008000; font-weight: bold">while</span>(superview <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>[superview isKindOfClass<span style="color: #666666">:</span>scrollViewClass]) 
        superview <span style="color: #666666">=</span> superview._superview;

    <span style="color: #008000; font-weight: bold">return</span> superview;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Scrolls the clip view to a specified point</span>
<span style="color: #408080; font-style: italic">    @param the clip view to scoll</span>
<span style="color: #408080; font-style: italic">    @param the point to scroll to</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">scrollClipView:</span>(<span style="color: #B00040">CPClipView</span>)aClipView <span style="color: #0000FF">toPoint:</span>(<span style="color: #B00040">CGPoint</span>)aPoint
{
    [aClipView scrollToPoint<span style="color: #666666">:</span>aPoint];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Notifies the receiver (superview of a CPClipView)</span>
<span style="color: #408080; font-style: italic">    that the clip view bounds or the document view bounds have changed.</span>
<span style="color: #408080; font-style: italic">    @param aClipView the clip view of the superview being notified</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">reflectScrolledClipView:</span>(<span style="color: #B00040">CPClipView</span>)aClipView
{
}

<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">CPView</span> (<span style="color: #A0A000">KeyView</span>)

<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">performKeyEquivalent:</span>(<span style="color: #B00040">CPEvent</span>)anEvent
{
    <span style="color: #008000; font-weight: bold">var</span> count <span style="color: #666666">=</span> [_subviews count];

    <span style="color: #408080; font-style: italic">// Is reverse iteration correct here? It matches the other (correct) code like hit testing.</span>
    <span style="color: #008000; font-weight: bold">while</span> (count<span style="color: #666666">--</span>)
        <span style="color: #008000; font-weight: bold">if</span> ([_subviews[count] performKeyEquivalent<span style="color: #666666">:</span>anEvent])
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">YES</span>;

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">NO</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">canBecomeKeyView</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> acceptsFirstResponder] <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>[<span style="color: #008000">self</span> isHiddenOrHasHiddenAncestor];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPView</span>)<span style="color: #0000FF">nextKeyView</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _nextKeyView;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPView</span>)<span style="color: #0000FF">nextValidKeyView</span>
{
    <span style="color: #008000; font-weight: bold">var</span> result <span style="color: #666666">=</span> [<span style="color: #008000">self</span> nextKeyView];

    <span style="color: #008000; font-weight: bold">while</span> (result <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>[result canBecomeKeyView])
        result <span style="color: #666666">=</span> [result nextKeyView];

    <span style="color: #008000; font-weight: bold">return</span> result;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPView</span>)<span style="color: #0000FF">previousKeyView</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _previousKeyView;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPView</span>)<span style="color: #0000FF">previousValidKeyView</span>
{
    <span style="color: #008000; font-weight: bold">var</span> result <span style="color: #666666">=</span> [<span style="color: #008000">self</span> previousKeyView];

    <span style="color: #008000; font-weight: bold">while</span> (result <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>[result canBecomeKeyView])
        result <span style="color: #666666">=</span> [result previousKeyView];

    <span style="color: #008000; font-weight: bold">return</span> result;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">_setPreviousKeyView:</span>(<span style="color: #B00040">CPView</span>)previous
{
    _previousKeyView <span style="color: #666666">=</span> previous;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setNextKeyView:</span>(<span style="color: #B00040">CPView</span>)next
{
    _nextKeyView <span style="color: #666666">=</span> next;
    [_nextKeyView _setPreviousKeyView<span style="color: #666666">:</span><span style="color: #008000">self</span>];
}

<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">CPView</span> (<span style="color: #A0A000">CoreAnimationAdditions</span>)

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets the core animation layer to be used by this receiver.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setLayer:</span>(<span style="color: #B00040">CALayer</span>)aLayer
{
    <span style="color: #008000; font-weight: bold">if</span> (_layer <span style="color: #666666">==</span> aLayer)
        <span style="color: #008000; font-weight: bold">return</span>;
    
    <span style="color: #008000; font-weight: bold">if</span> (_layer)
    {
        _layer._owningView <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">nil</span>;<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
        _DOMElement.<span style="color: #0000FF">removeChild</span>(_layer._DOMElement);<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>
    }
    
    _layer <span style="color: #666666">=</span> aLayer;
    
    <span style="color: #008000; font-weight: bold">if</span> (_layer)
    {
        <span style="color: #008000; font-weight: bold">var</span> bounds <span style="color: #666666">=</span> <span style="color: #0000FF">CGRectMakeCopy</span>([<span style="color: #008000">self</span> bounds]);
        
        [_layer _setOwningView<span style="color: #666666">:</span><span style="color: #008000">self</span>];<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">        </span>
<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
        _layer._DOMElement.style.zIndex <span style="color: #666666">=</span> <span style="color: #666666">100</span>;
        
        _DOMElement.<span style="color: #0000FF">appendChild</span>(_layer._DOMElement);<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>
    }
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the core animation layer used by the receiver.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CALayer</span>)<span style="color: #0000FF">layer</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _layer;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets whether the receiver wants a core animation layer.</span>
<span style="color: #408080; font-style: italic">    @param \c YES means the receiver wants a layer.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setWantsLayer:</span>(<span style="color: #B00040">BOOL</span>)aFlag
{
    _wantsLayer <span style="color: #666666">=</span> <span style="color: #666666">!!</span>aFlag;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns \c YES if the receiver uses a CALayer</span>
<span style="color: #408080; font-style: italic">    @returns \c YES if the receiver uses a CALayer</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">wantsLayer</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _wantsLayer;
}

<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">CPView</span> (<span style="color: #A0A000">Theming</span>)<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#pragma mark Theme States</span>

<span style="color: #666666">-</span> (<span style="color: #B00040">unsigned</span>)<span style="color: #0000FF">themeState</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _themeState;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">hasThemeState:</span>(<span style="color: #B00040">CPThemeState</span>)aState
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">!!</span>(_themeState <span style="color: #666666">&amp;</span> ((<span style="color: #008000; font-weight: bold">typeof</span> aState <span style="color: #666666">===</span> <span style="color: #BA2121">&quot;string&quot;</span>) <span style="color: #666666">?</span> <span style="color: #0000FF">CPThemeState</span>(aState) <span style="color: #666666">:</span> aState));
}

<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">setThemeState:</span>(<span style="color: #B00040">CPThemeState</span>)aState
{
    <span style="color: #008000; font-weight: bold">var</span> newState <span style="color: #666666">=</span> (<span style="color: #008000; font-weight: bold">typeof</span> aState <span style="color: #666666">===</span> <span style="color: #BA2121">&quot;string&quot;</span>) <span style="color: #666666">?</span> <span style="color: #0000FF">CPThemeState</span>(aState) <span style="color: #666666">:</span> aState;

    <span style="color: #008000; font-weight: bold">if</span> (_themeState <span style="color: #666666">&amp;</span> newState)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">NO</span>;

    _themeState <span style="color: #666666">|=</span> newState;

    [<span style="color: #008000">self</span> setNeedsLayout];
    [<span style="color: #008000">self</span> setNeedsDisplay<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">YES</span>];

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">YES</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">unsetThemeState:</span>(<span style="color: #B00040">CPThemeState</span>)aState
{
    <span style="color: #008000; font-weight: bold">var</span> newState <span style="color: #666666">=</span> ((<span style="color: #008000; font-weight: bold">typeof</span> aState <span style="color: #666666">===</span> <span style="color: #BA2121">&quot;string&quot;</span>) <span style="color: #666666">?</span> <span style="color: #0000FF">CPThemeState</span>(aState) <span style="color: #666666">:</span> aState);

    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>(_themeState <span style="color: #666666">&amp;</span> newState))
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">NO</span>;

    _themeState <span style="color: #666666">&amp;=</span> <span style="color: #666666">~</span>newState;

    [<span style="color: #008000">self</span> setNeedsLayout];
    [<span style="color: #008000">self</span> setNeedsDisplay<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">YES</span>];

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">YES</span>;
}<span style="color: #BC7A00"></span>

<span style="color: #BC7A00">#pragma mark Theme Attributes</span>

<span style="color: #666666">+</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">themeClass</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #666666">+</span> (<span style="color: #B00040">CPDictionary</span>)<span style="color: #0000FF">themeAttributes</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #666666">+</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">_themeAttributes</span>
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>CachedThemeAttributes)
        CachedThemeAttributes <span style="color: #666666">=</span> {};

    <span style="color: #008000; font-weight: bold">var</span> theClass <span style="color: #666666">=</span> [<span style="color: #008000">self</span> class],
        CPViewClass <span style="color: #666666">=</span> [CPView class],
        attributes <span style="color: #666666">=</span> [];

    <span style="color: #008000; font-weight: bold">for</span> (; theClass <span style="color: #666666">&amp;&amp;</span> theClass <span style="color: #666666">!==</span> CPViewClass; theClass <span style="color: #666666">=</span> [theClass superclass])
    {
        <span style="color: #008000; font-weight: bold">var</span> cachedAttributes <span style="color: #666666">=</span> CachedThemeAttributes[<span style="color: #0000FF">class_getName</span>(theClass)];

        <span style="color: #008000; font-weight: bold">if</span> (cachedAttributes)
        {
            attributes <span style="color: #666666">=</span> attributes.length <span style="color: #666666">?</span> attributes.<span style="color: #0000FF">concat</span>(cachedAttributes) <span style="color: #666666">:</span> attributes;
            CachedThemeAttributes[[<span style="color: #008000">self</span> className]] <span style="color: #666666">=</span> attributes;

            <span style="color: #008000; font-weight: bold">break</span>;
        }

        <span style="color: #008000; font-weight: bold">var</span> attributeDictionary <span style="color: #666666">=</span> [theClass themeAttributes];
        
        <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>attributeDictionary)
            <span style="color: #008000; font-weight: bold">continue</span>;

        <span style="color: #008000; font-weight: bold">var</span> attributeKeys <span style="color: #666666">=</span> [attributeDictionary allKeys],
            attributeCount <span style="color: #666666">=</span> attributeKeys.length;

        <span style="color: #008000; font-weight: bold">while</span> (attributeCount<span style="color: #666666">--</span>)
        {
            <span style="color: #008000; font-weight: bold">var</span> attributeName <span style="color: #666666">=</span> attributeKeys[attributeCount];

            attributes.<span style="color: #0000FF">push</span>([attributeDictionary objectForKey<span style="color: #666666">:</span>attributeName]);
            attributes.<span style="color: #0000FF">push</span>(attributeName);
        }
    }

    <span style="color: #008000; font-weight: bold">return</span> attributes;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">_loadThemeAttributes</span>
{
    <span style="color: #008000; font-weight: bold">var</span> theClass <span style="color: #666666">=</span> [<span style="color: #008000">self</span> class],
        attributes <span style="color: #666666">=</span> [theClass _themeAttributes],
        count <span style="color: #666666">=</span> attributes.length;

    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>count)
        <span style="color: #008000; font-weight: bold">return</span>;

    <span style="color: #008000; font-weight: bold">var</span> theme <span style="color: #666666">=</span> [<span style="color: #008000">self</span> theme],
        themeClass <span style="color: #666666">=</span> [theClass themeClass];

    _themeAttributes <span style="color: #666666">=</span> {};
    
    <span style="color: #008000; font-weight: bold">while</span> (count<span style="color: #666666">--</span>)
    {
        <span style="color: #008000; font-weight: bold">var</span> attributeName <span style="color: #666666">=</span> attributes[count<span style="color: #666666">--</span>],
            attribute <span style="color: #666666">=</span> [[_CPThemeAttribute alloc] initWithName<span style="color: #666666">:</span>attributeName defaultValue<span style="color: #666666">:</span>attributes[count]];

        [attribute setParentAttribute<span style="color: #666666">:</span>[theme _attributeWithName<span style="color: #666666">:</span>attributeName forClass<span style="color: #666666">:</span>themeClass]];
        
        _themeAttributes[attributeName] <span style="color: #666666">=</span> attribute;
    }
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setTheme:</span>(<span style="color: #B00040">CPTheme</span>)aTheme
{
    <span style="color: #008000; font-weight: bold">if</span> (_theme <span style="color: #666666">===</span> aTheme)
        <span style="color: #008000; font-weight: bold">return</span>;
    
    _theme <span style="color: #666666">=</span> aTheme;
        
    [<span style="color: #008000">self</span> viewDidChangeTheme];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPTheme</span>)<span style="color: #0000FF">theme</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _theme;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">viewDidChangeTheme</span>
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_themeAttributes)
        <span style="color: #008000; font-weight: bold">return</span>;

    <span style="color: #008000; font-weight: bold">var</span> theme <span style="color: #666666">=</span> [<span style="color: #008000">self</span> theme],
        themeClass <span style="color: #666666">=</span> [[<span style="color: #008000">self</span> class] themeClass];

    <span style="color: #008000; font-weight: bold">for</span> (<span style="color: #008000; font-weight: bold">var</span> attributeName <span style="color: #008000; font-weight: bold">in</span> _themeAttributes)
        <span style="color: #008000; font-weight: bold">if</span> (_themeAttributes.<span style="color: #0000FF">hasOwnProperty</span>(attributeName))
            [_themeAttributes[attributeName] setParentAttribute<span style="color: #666666">:</span>[theme _attributeWithName<span style="color: #666666">:</span>attributeName forClass<span style="color: #666666">:</span>themeClass]];

    [<span style="color: #008000">self</span> setNeedsLayout];
    [<span style="color: #008000">self</span> setNeedsDisplay<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">YES</span>];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPDictionary</span>)<span style="color: #0000FF">_themeAttributeDictionary</span>
{
    <span style="color: #008000; font-weight: bold">var</span> dictionary <span style="color: #666666">=</span> [CPDictionary dictionary];

    <span style="color: #008000; font-weight: bold">if</span> (_themeAttributes)
    {
        <span style="color: #008000; font-weight: bold">var</span> theme <span style="color: #666666">=</span> [<span style="color: #008000">self</span> theme];

        <span style="color: #008000; font-weight: bold">for</span> (<span style="color: #008000; font-weight: bold">var</span> attributeName <span style="color: #008000; font-weight: bold">in</span> _themeAttributes)
            <span style="color: #008000; font-weight: bold">if</span> (_themeAttributes.<span style="color: #0000FF">hasOwnProperty</span>(attributeName))
                [dictionary setObject<span style="color: #666666">:</span>_themeAttributes[attributeName] forKey<span style="color: #666666">:</span>attributeName];
    }

    <span style="color: #008000; font-weight: bold">return</span> dictionary;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setValue:</span>(<span style="color: #B00040">id</span>)aValue <span style="color: #0000FF">forThemeAttribute:</span>(<span style="color: #B00040">CPString</span>)aName <span style="color: #0000FF">inState:</span>(<span style="color: #B00040">CPThemeState</span>)aState
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_themeAttributes <span style="color: #666666">||</span> <span style="color: #666666">!</span>_themeAttributes[aName])
        [CPException raise<span style="color: #666666">:</span>CPInvalidArgumentException reason<span style="color: #666666">:</span>[<span style="color: #008000">self</span> className] <span style="color: #666666">+</span> <span style="color: #BA2121">&quot; does not contain theme attribute &#39;&quot;</span> <span style="color: #666666">+</span> aName <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&#39;&quot;</span>];

    <span style="color: #008000; font-weight: bold">var</span> currentValue <span style="color: #666666">=</span> [<span style="color: #008000">self</span> currentValueForThemeAttribute<span style="color: #666666">:</span>aName];

    [_themeAttributes[aName] setValue<span style="color: #666666">:</span>aValue forState<span style="color: #666666">:</span>aState];

    <span style="color: #008000; font-weight: bold">if</span> ([<span style="color: #008000">self</span> currentValueForThemeAttribute<span style="color: #666666">:</span>aName] <span style="color: #666666">===</span> currentValue)
        <span style="color: #008000; font-weight: bold">return</span>;

    [<span style="color: #008000">self</span> setNeedsDisplay<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">YES</span>];
    [<span style="color: #008000">self</span> setNeedsLayout];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setValue:</span>(<span style="color: #B00040">id</span>)aValue <span style="color: #0000FF">forThemeAttribute:</span>(<span style="color: #B00040">CPString</span>)aName
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_themeAttributes <span style="color: #666666">||</span> <span style="color: #666666">!</span>_themeAttributes[aName])
        [CPException raise<span style="color: #666666">:</span>CPInvalidArgumentException reason<span style="color: #666666">:</span>[<span style="color: #008000">self</span> className] <span style="color: #666666">+</span> <span style="color: #BA2121">&quot; does not contain theme attribute &#39;&quot;</span> <span style="color: #666666">+</span> aName <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&#39;&quot;</span>];

    <span style="color: #008000; font-weight: bold">var</span> currentValue <span style="color: #666666">=</span> [<span style="color: #008000">self</span> currentValueForThemeAttribute<span style="color: #666666">:</span>aName];

    [_themeAttributes[aName] setValue<span style="color: #666666">:</span>aValue];

    <span style="color: #008000; font-weight: bold">if</span> ([<span style="color: #008000">self</span> currentValueForThemeAttribute<span style="color: #666666">:</span>aName] <span style="color: #666666">===</span> currentValue)
        <span style="color: #008000; font-weight: bold">return</span>;

    [<span style="color: #008000">self</span> setNeedsDisplay<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">YES</span>];
    [<span style="color: #008000">self</span> setNeedsLayout];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">valueForThemeAttribute:</span>(<span style="color: #B00040">CPString</span>)aName <span style="color: #0000FF">inState:</span>(<span style="color: #B00040">CPThemeState</span>)aState
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_themeAttributes <span style="color: #666666">||</span> <span style="color: #666666">!</span>_themeAttributes[aName])
        [CPException raise<span style="color: #666666">:</span>CPInvalidArgumentException reason<span style="color: #666666">:</span>[<span style="color: #008000">self</span> className] <span style="color: #666666">+</span> <span style="color: #BA2121">&quot; does not contain theme attribute &#39;&quot;</span> <span style="color: #666666">+</span> aName <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&#39;&quot;</span>];

    <span style="color: #008000; font-weight: bold">return</span> [_themeAttributes[aName] valueForState<span style="color: #666666">:</span>aState];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">valueForThemeAttribute:</span>(<span style="color: #B00040">CPString</span>)aName
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_themeAttributes <span style="color: #666666">||</span> <span style="color: #666666">!</span>_themeAttributes[aName])
        [CPException raise<span style="color: #666666">:</span>CPInvalidArgumentException reason<span style="color: #666666">:</span>[<span style="color: #008000">self</span> className] <span style="color: #666666">+</span> <span style="color: #BA2121">&quot; does not contain theme attribute &#39;&quot;</span> <span style="color: #666666">+</span> aName <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&#39;&quot;</span>];

    <span style="color: #008000; font-weight: bold">return</span> [_themeAttributes[aName] value];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">currentValueForThemeAttribute:</span>(<span style="color: #B00040">CPString</span>)aName
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_themeAttributes <span style="color: #666666">||</span> <span style="color: #666666">!</span>_themeAttributes[aName])
        [CPException raise<span style="color: #666666">:</span>CPInvalidArgumentException reason<span style="color: #666666">:</span>[<span style="color: #008000">self</span> className] <span style="color: #666666">+</span> <span style="color: #BA2121">&quot; does not contain theme attribute &#39;&quot;</span> <span style="color: #666666">+</span> aName <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&#39;&quot;</span>];

    <span style="color: #008000; font-weight: bold">return</span> [_themeAttributes[aName] valueForState<span style="color: #666666">:</span>_themeState];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPView</span>)<span style="color: #0000FF">createEphemeralSubviewNamed:</span>(<span style="color: #B00040">CPString</span>)aViewName
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CGRect</span>)<span style="color: #0000FF">rectForEphemeralSubviewNamed:</span>(<span style="color: #B00040">CPString</span>)aViewName
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">_CGRectMakeZero</span>();
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPView</span>)<span style="color: #0000FF">layoutEphemeralSubviewNamed:</span>(<span style="color: #B00040">CPString</span>)aViewName 
                           <span style="color: #0000FF">positioned:</span>(<span style="color: #B00040">CPWindowOrderingMode</span>)anOrderingMode
      <span style="color: #0000FF">relativeToEphemeralSubviewNamed:</span>(<span style="color: #B00040">CPString</span>)relativeToViewName
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_ephemeralSubviewsForNames)
    {
        _ephemeralSubviewsForNames <span style="color: #666666">=</span> {};
        _ephemeralSubviews <span style="color: #666666">=</span> [CPSet set];
    }

    <span style="color: #008000; font-weight: bold">var</span> frame <span style="color: #666666">=</span> [<span style="color: #008000">self</span> rectForEphemeralSubviewNamed<span style="color: #666666">:</span>aViewName];

    <span style="color: #008000; font-weight: bold">if</span> (frame <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span><span style="color: #0000FF">_CGRectIsEmpty</span>(frame))
    {
        <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_ephemeralSubviewsForNames[aViewName])
        {
            _ephemeralSubviewsForNames[aViewName] <span style="color: #666666">=</span> [<span style="color: #008000">self</span> createEphemeralSubviewNamed<span style="color: #666666">:</span>aViewName];

            [_ephemeralSubviews addObject<span style="color: #666666">:</span>_ephemeralSubviewsForNames[aViewName]];

            <span style="color: #008000; font-weight: bold">if</span> (_ephemeralSubviewsForNames[aViewName])
                [<span style="color: #008000">self</span> addSubview<span style="color: #666666">:</span>_ephemeralSubviewsForNames[aViewName] positioned<span style="color: #666666">:</span>anOrderingMode relativeTo<span style="color: #666666">:</span>_ephemeralSubviewsForNames[relativeToViewName]];
        }

        <span style="color: #008000; font-weight: bold">if</span> (_ephemeralSubviewsForNames[aViewName])
            [_ephemeralSubviewsForNames[aViewName] setFrame<span style="color: #666666">:</span>frame];
    }
    <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (_ephemeralSubviewsForNames[aViewName])
    {
        [_ephemeralSubviewsForNames[aViewName] removeFromSuperview];

        [_ephemeralSubviews removeObject<span style="color: #666666">:</span>_ephemeralSubviewsForNames[aViewName]];
        <span style="color: #008000; font-weight: bold">delete</span> _ephemeralSubviewsForNames[aViewName];
    }

    <span style="color: #008000; font-weight: bold">return</span> _ephemeralSubviewsForNames[aViewName];
}

<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #008000; font-weight: bold">var</span> CPViewAutoresizingMaskKey       <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewAutoresizingMask&quot;</span>,
    CPViewAutoresizesSubviewsKey    <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewAutoresizesSubviews&quot;</span>,
    CPViewBackgroundColorKey        <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewBackgroundColor&quot;</span>,
    CPViewBoundsKey                 <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewBoundsKey&quot;</span>,
    CPViewFrameKey                  <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewFrameKey&quot;</span>,
    CPViewHitTestsKey               <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewHitTestsKey&quot;</span>,
    CPViewIsHiddenKey               <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewIsHiddenKey&quot;</span>,
    CPViewOpacityKey                <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewOpacityKey&quot;</span>,
    CPViewSubviewsKey               <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewSubviewsKey&quot;</span>,
    CPViewSuperviewKey              <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewSuperviewKey&quot;</span>,
    CPViewTagKey                    <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewTagKey&quot;</span>,
    CPViewThemeStateKey             <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewThemeStateKey&quot;</span>,
    CPViewWindowKey                 <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewWindowKey&quot;</span>,
    CPViewNextKeyViewKey            <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewNextKeyViewKey&quot;</span>,
    CPViewPreviousKeyViewKey        <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPViewPreviousKeyViewKey&quot;</span>;

<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">CPView</span> (<span style="color: #A0A000">CPCoding</span>)

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Initializes the view from an archive.</span>
<span style="color: #408080; font-style: italic">    @param aCoder the coder from which to initialize</span>
<span style="color: #408080; font-style: italic">    @return the initialized view</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithCoder:</span>(<span style="color: #B00040">CPCoder</span>)aCoder
{
    <span style="color: #408080; font-style: italic">// We create the DOMElement &quot;early&quot; because there is a chance that we </span>
    <span style="color: #408080; font-style: italic">// will decode our superview before we are done decoding, at which point </span>
    <span style="color: #408080; font-style: italic">// we have to have an element to place in the tree.  Perhaps there is </span>
    <span style="color: #408080; font-style: italic">// a more &quot;elegant&quot; way to do this...?</span>
<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
    _DOMElement <span style="color: #666666">=</span> DOMElementPrototype.<span style="color: #0000FF">cloneNode</span>(<span style="color: #008000; font-weight: bold">false</span>);<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>

    <span style="color: #408080; font-style: italic">// Also decode these &quot;early&quot;.</span>
    _frame <span style="color: #666666">=</span> [aCoder decodeRectForKey<span style="color: #666666">:</span>CPViewFrameKey];
    _bounds <span style="color: #666666">=</span> [aCoder decodeRectForKey<span style="color: #666666">:</span>CPViewBoundsKey];

    <span style="color: #008000">self</span> <span style="color: #666666">=</span> [<span style="color: #008000">super</span> initWithCoder<span style="color: #666666">:</span>aCoder];
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span>)
    {
        <span style="color: #408080; font-style: italic">// We have to manually check because it may be 0, so we can&#39;t use ||</span>
        _tag <span style="color: #666666">=</span> [aCoder containsValueForKey<span style="color: #666666">:</span>CPViewTagKey] <span style="color: #666666">?</span> [aCoder decodeIntForKey<span style="color: #666666">:</span>CPViewTagKey] <span style="color: #666666">:</span> <span style="color: #666666">-1</span>;
        
        _window <span style="color: #666666">=</span> [aCoder decodeObjectForKey<span style="color: #666666">:</span>CPViewWindowKey];
        _subviews <span style="color: #666666">=</span> [aCoder decodeObjectForKey<span style="color: #666666">:</span>CPViewSubviewsKey] <span style="color: #666666">||</span> [];
        _superview <span style="color: #666666">=</span> [aCoder decodeObjectForKey<span style="color: #666666">:</span>CPViewSuperviewKey];
        
        <span style="color: #408080; font-style: italic">// FIXME: Should we encode/decode this?</span>
        _registeredDraggedTypes <span style="color: #666666">=</span> [CPSet set];
        _registeredDraggedTypesArray <span style="color: #666666">=</span> [];

        _autoresizingMask <span style="color: #666666">=</span> [aCoder decodeIntForKey<span style="color: #666666">:</span>CPViewAutoresizingMaskKey] <span style="color: #666666">||</span> CPViewNotSizable;
        _autoresizesSubviews <span style="color: #666666">=</span> <span style="color: #666666">!</span>[aCoder containsValueForKey<span style="color: #666666">:</span>CPViewAutoresizesSubviewsKey] <span style="color: #666666">||</span> [aCoder decodeBoolForKey<span style="color: #666666">:</span>CPViewAutoresizesSubviewsKey];

        _hitTests <span style="color: #666666">=</span> <span style="color: #666666">!</span>[aCoder containsValueForKey<span style="color: #666666">:</span>CPViewHitTestsKey] <span style="color: #666666">||</span> [aCoder decodeObjectForKey<span style="color: #666666">:</span>CPViewHitTestsKey];
    
        <span style="color: #408080; font-style: italic">// DOM SETUP</span>
<span style="color: #BC7A00">#if PLATFORM(DOM)</span>
        _DOMImageParts <span style="color: #666666">=</span> [];
        _DOMImageSizes <span style="color: #666666">=</span> [];

        <span style="color: #0000FF">CPDOMDisplayServerSetStyleLeftTop</span>(_DOMElement, <span style="color: #008000; font-weight: bold">NULL</span>, <span style="color: #0000FF">_CGRectGetMinX</span>(_frame), <span style="color: #0000FF">_CGRectGetMinY</span>(_frame));
        <span style="color: #0000FF">CPDOMDisplayServerSetStyleSize</span>(_DOMElement, <span style="color: #0000FF">_CGRectGetWidth</span>(_frame), <span style="color: #0000FF">_CGRectGetHeight</span>(_frame));
        
        <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
            count <span style="color: #666666">=</span> _subviews.length;
    
        <span style="color: #008000; font-weight: bold">for</span> (; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index)
        {
            <span style="color: #0000FF">CPDOMDisplayServerAppendChild</span>(_DOMElement, _subviews[index]._DOMElement);
            <span style="color: #408080; font-style: italic">//_subviews[index]._superview = self;</span>
        }<span style="color: #BC7A00"></span>
<span style="color: #BC7A00">#endif</span>

        <span style="color: #008000; font-weight: bold">if</span> ([aCoder containsValueForKey<span style="color: #666666">:</span>CPViewIsHiddenKey])
            [<span style="color: #008000">self</span> setHidden<span style="color: #666666">:</span>[aCoder decodeBoolForKey<span style="color: #666666">:</span>CPViewIsHiddenKey]];
        <span style="color: #008000; font-weight: bold">else</span>
            _isHidden <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">NO</span>;

        <span style="color: #008000; font-weight: bold">if</span> ([aCoder containsValueForKey<span style="color: #666666">:</span>CPViewOpacityKey])
            [<span style="color: #008000">self</span> setAlphaValue<span style="color: #666666">:</span>[aCoder decodeIntForKey<span style="color: #666666">:</span>CPViewOpacityKey]];
        <span style="color: #008000; font-weight: bold">else</span>
            _opacity <span style="color: #666666">=</span> <span style="color: #666666">1.0</span>;

        [<span style="color: #008000">self</span> setBackgroundColor<span style="color: #666666">:</span>[aCoder decodeObjectForKey<span style="color: #666666">:</span>CPViewBackgroundColorKey]];

        [<span style="color: #008000">self</span> setupViewFlags];

        _theme <span style="color: #666666">=</span> [CPTheme defaultTheme];
        _themeState <span style="color: #666666">=</span> <span style="color: #0000FF">CPThemeState</span>([aCoder decodeIntForKey<span style="color: #666666">:</span>CPViewThemeStateKey]);
        _themeAttributes <span style="color: #666666">=</span> {};

        <span style="color: #008000; font-weight: bold">var</span> theClass <span style="color: #666666">=</span> [<span style="color: #008000">self</span> class],
            themeClass <span style="color: #666666">=</span> [theClass themeClass],
            attributes <span style="color: #666666">=</span> [theClass _themeAttributes],
            count <span style="color: #666666">=</span> attributes.length;

        <span style="color: #008000; font-weight: bold">while</span> (count<span style="color: #666666">--</span>)
        {
            <span style="color: #008000; font-weight: bold">var</span> attributeName <span style="color: #666666">=</span> attributes[count<span style="color: #666666">--</span>];

            _themeAttributes[attributeName] <span style="color: #666666">=</span> <span style="color: #0000FF">CPThemeAttributeDecode</span>(aCoder, attributeName, attributes[count], _theme, themeClass);
        }

        [<span style="color: #008000">self</span> setNeedsDisplay<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">YES</span>];
        [<span style="color: #008000">self</span> setNeedsLayout];
    }

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Archives the view to a coder.</span>
<span style="color: #408080; font-style: italic">    @param aCoder the object into which the view&#39;s data will be archived.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">encodeWithCoder:</span>(<span style="color: #B00040">CPCoder</span>)aCoder
{
    [<span style="color: #008000">super</span> encodeWithCoder<span style="color: #666666">:</span>aCoder];
    
    <span style="color: #008000; font-weight: bold">if</span> (_tag <span style="color: #666666">!==</span> <span style="color: #666666">-1</span>)
        [aCoder encodeInt<span style="color: #666666">:</span>_tag forKey<span style="color: #666666">:</span>CPViewTagKey];

    [aCoder encodeRect<span style="color: #666666">:</span>_frame forKey<span style="color: #666666">:</span>CPViewFrameKey];
    [aCoder encodeRect<span style="color: #666666">:</span>_bounds forKey<span style="color: #666666">:</span>CPViewBoundsKey];

    <span style="color: #408080; font-style: italic">// This will come out nil on the other side with decodeObjectForKey:</span>
    <span style="color: #008000; font-weight: bold">if</span> (_window <span style="color: #666666">!==</span> <span style="color: #008000; font-weight: bold">nil</span>)
        [aCoder encodeConditionalObject<span style="color: #666666">:</span>_window forKey<span style="color: #666666">:</span>CPViewWindowKey];

    <span style="color: #008000; font-weight: bold">var</span> count <span style="color: #666666">=</span> [_subviews count],
        encodedSubviews <span style="color: #666666">=</span> _subviews;

    <span style="color: #008000; font-weight: bold">if</span> (count <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span> <span style="color: #666666">&amp;&amp;</span> [_ephemeralSubviews count] <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span>)
    {
        encodedSubviews <span style="color: #666666">=</span> [encodedSubviews copy];

        <span style="color: #008000; font-weight: bold">while</span> (count<span style="color: #666666">--</span>)
            <span style="color: #008000; font-weight: bold">if</span> ([_ephemeralSubviews containsObject<span style="color: #666666">:</span>encodedSubviews[count]])
                encodedSubviews.<span style="color: #0000FF">splice</span>(count, <span style="color: #666666">1</span>);
    }

    <span style="color: #008000; font-weight: bold">if</span> (encodedSubviews.length <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span>)
        [aCoder encodeObject<span style="color: #666666">:</span>encodedSubviews forKey<span style="color: #666666">:</span>CPViewSubviewsKey];

    <span style="color: #408080; font-style: italic">// This will come out nil on the other side with decodeObjectForKey:</span>
    <span style="color: #008000; font-weight: bold">if</span> (_superview <span style="color: #666666">!==</span> <span style="color: #008000; font-weight: bold">nil</span>)
        [aCoder encodeConditionalObject<span style="color: #666666">:</span>_superview forKey<span style="color: #666666">:</span>CPViewSuperviewKey];

    <span style="color: #008000; font-weight: bold">if</span> (_autoresizingMask <span style="color: #666666">!==</span> CPViewNotSizable)
        [aCoder encodeInt<span style="color: #666666">:</span>_autoresizingMask forKey<span style="color: #666666">:</span>CPViewAutoresizingMaskKey];

    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>_autoresizesSubviews)
        [aCoder encodeBool<span style="color: #666666">:</span>_autoresizesSubviews forKey<span style="color: #666666">:</span>CPViewAutoresizesSubviewsKey];

    <span style="color: #008000; font-weight: bold">if</span> (_backgroundColor <span style="color: #666666">!==</span> <span style="color: #008000; font-weight: bold">nil</span>)
        [aCoder encodeObject<span style="color: #666666">:</span>_backgroundColor forKey<span style="color: #666666">:</span>CPViewBackgroundColorKey];

    <span style="color: #008000; font-weight: bold">if</span> (_hitTests <span style="color: #666666">!==</span> <span style="color: #008000; font-weight: bold">YES</span>)
        [aCoder encodeBool<span style="color: #666666">:</span>_hitTests forKey<span style="color: #666666">:</span>CPViewHitTestsKey];

    <span style="color: #008000; font-weight: bold">if</span> (_opacity <span style="color: #666666">!==</span> <span style="color: #666666">1.0</span>)
        [aCoder encodeFloat<span style="color: #666666">:</span>_opacity forKey<span style="color: #666666">:</span>CPViewOpacityKey];

    <span style="color: #008000; font-weight: bold">if</span> (_isHidden)
        [aCoder encodeBool<span style="color: #666666">:</span>_isHidden forKey<span style="color: #666666">:</span>CPViewIsHiddenKey];

    <span style="color: #008000; font-weight: bold">var</span> nextKeyView <span style="color: #666666">=</span> [<span style="color: #008000">self</span> nextKeyView];

    <span style="color: #008000; font-weight: bold">if</span> (nextKeyView <span style="color: #666666">!==</span> <span style="color: #008000; font-weight: bold">nil</span>)
        [aCoder encodeConditionalObject<span style="color: #666666">:</span>nextKeyView forKey<span style="color: #666666">:</span>CPViewNextKeyViewKey];

    <span style="color: #008000; font-weight: bold">var</span> previousKeyView <span style="color: #666666">=</span> [<span style="color: #008000">self</span> previousKeyView];

    <span style="color: #008000; font-weight: bold">if</span> (previousKeyView <span style="color: #666666">!==</span> <span style="color: #008000; font-weight: bold">nil</span>)
        [aCoder encodeConditionalObject<span style="color: #666666">:</span>previousKeyView forKey<span style="color: #666666">:</span>CPViewPreviousKeyViewKey];

    [aCoder encodeInt<span style="color: #666666">:</span><span style="color: #0000FF">CPThemeStateName</span>(_themeState) forKey<span style="color: #666666">:</span>CPViewThemeStateKey];

    <span style="color: #008000; font-weight: bold">for</span> (<span style="color: #008000; font-weight: bold">var</span> attributeName <span style="color: #008000; font-weight: bold">in</span> _themeAttributes)
        <span style="color: #008000; font-weight: bold">if</span> (_themeAttributes.<span style="color: #0000FF">hasOwnProperty</span>(attributeName))
            <span style="color: #0000FF">CPThemeAttributeEncode</span>(aCoder, _themeAttributes[attributeName]);
}

<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #008000; font-weight: bold">var</span> _CPViewFullScreenModeStateMake <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">function</span>(aView)
{
    <span style="color: #008000; font-weight: bold">var</span> superview <span style="color: #666666">=</span> aView._superview;
    
    <span style="color: #008000; font-weight: bold">return</span> { autoresizingMask<span style="color: #666666">:</span>aView._autoresizingMask, frame<span style="color: #666666">:</span><span style="color: #0000FF">CGRectMakeCopy</span>(aView._frame), index<span style="color: #666666">:</span>(superview <span style="color: #666666">?</span> [superview._subviews indexOfObjectIdenticalTo<span style="color: #666666">:</span>aView] <span style="color: #666666">:</span> <span style="color: #666666">0</span>), superview<span style="color: #666666">:</span>superview };
}

<span style="color: #008000; font-weight: bold">var</span> _CPViewGetTransform <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">function</span>(<span style="color: #408080; font-style: italic">/*CPView*/</span> fromView, <span style="color: #408080; font-style: italic">/*CPView */</span> toView)
{
    <span style="color: #008000; font-weight: bold">var</span> transform <span style="color: #666666">=</span> <span style="color: #0000FF">CGAffineTransformMakeIdentity</span>(),
        sameWindow <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">YES</span>,
        fromWindow <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">nil</span>,
        toWindow <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">nil</span>;
    
    <span style="color: #008000; font-weight: bold">if</span> (fromView)
    {
        <span style="color: #008000; font-weight: bold">var</span> view <span style="color: #666666">=</span> fromView;
        
        <span style="color: #408080; font-style: italic">// FIXME: This doesn&#39;t handle the case when the outside views are equal.</span>
        <span style="color: #408080; font-style: italic">// If we have a fromView, &quot;climb up&quot; the view tree until </span>
        <span style="color: #408080; font-style: italic">// we hit the root node or we hit the toLayer.</span>
        <span style="color: #008000; font-weight: bold">while</span> (view <span style="color: #666666">&amp;&amp;</span> view <span style="color: #666666">!=</span> toView)
        {
            <span style="color: #008000; font-weight: bold">var</span> frame <span style="color: #666666">=</span> view._frame;
            
            transform.tx <span style="color: #666666">+=</span> <span style="color: #0000FF">_CGRectGetMinX</span>(frame);
            transform.ty <span style="color: #666666">+=</span> <span style="color: #0000FF">_CGRectGetMinY</span>(frame);
            
            <span style="color: #008000; font-weight: bold">if</span> (view._boundsTransform)
            {
                <span style="color: #0000FF">_CGAffineTransformConcatTo</span>(transform, view._boundsTransform, transform);
            }
            
            view <span style="color: #666666">=</span> view._superview;
        }
        
        <span style="color: #408080; font-style: italic">// If we hit toView, then we&#39;re done.</span>
        <span style="color: #008000; font-weight: bold">if</span> (view <span style="color: #666666">===</span> toView)
            <span style="color: #008000; font-weight: bold">return</span> transform;
        
        <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (fromView <span style="color: #666666">&amp;&amp;</span> toView)
        {
            fromWindow <span style="color: #666666">=</span> [fromView <span style="color: #008000">window</span>];
            toWindow <span style="color: #666666">=</span> [toView <span style="color: #008000">window</span>];
            
            <span style="color: #008000; font-weight: bold">if</span> (fromWindow <span style="color: #666666">&amp;&amp;</span> toWindow <span style="color: #666666">&amp;&amp;</span> fromWindow <span style="color: #666666">!==</span> toWindow)
            {
                sameWindow <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">NO</span>;
                
                <span style="color: #008000; font-weight: bold">var</span> frame <span style="color: #666666">=</span> [fromWindow frame];
                
                transform.tx <span style="color: #666666">+=</span> <span style="color: #0000FF">_CGRectGetMinX</span>(frame);
                transform.ty <span style="color: #666666">+=</span> <span style="color: #0000FF">_CGRectGetMinY</span>(frame);
            }
        }
    }
    
    <span style="color: #408080; font-style: italic">// FIXME: For now we can do things this way, but eventually we need to do them the &quot;hard&quot; way.</span>
    <span style="color: #008000; font-weight: bold">var</span> view <span style="color: #666666">=</span> toView;
    
    <span style="color: #008000; font-weight: bold">while</span> (view)
    {
        <span style="color: #008000; font-weight: bold">var</span> frame <span style="color: #666666">=</span> view._frame;
            
        transform.tx <span style="color: #666666">-=</span> <span style="color: #0000FF">_CGRectGetMinX</span>(frame);
        transform.ty <span style="color: #666666">-=</span> <span style="color: #0000FF">_CGRectGetMinY</span>(frame);
        
        <span style="color: #008000; font-weight: bold">if</span> (view._boundsTransform)
        {
            <span style="color: #0000FF">_CGAffineTransformConcatTo</span>(transform, view._inverseBoundsTransform, transform);
        }
        
        view <span style="color: #666666">=</span> view._superview;
    }
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>sameWindow)
    {
        <span style="color: #008000; font-weight: bold">var</span> frame <span style="color: #666666">=</span> [toWindow frame];
            
        transform.tx <span style="color: #666666">-=</span> <span style="color: #0000FF">_CGRectGetMinX</span>(frame);
        transform.ty <span style="color: #666666">-=</span> <span style="color: #0000FF">_CGRectGetMinY</span>(frame);
    }
<span style="color: #408080; font-style: italic">/*    var views = [],</span>
<span style="color: #408080; font-style: italic">        view = toView;</span>
<span style="color: #408080; font-style: italic">    </span>
<span style="color: #408080; font-style: italic">    while (view)</span>
<span style="color: #408080; font-style: italic">    {</span>
<span style="color: #408080; font-style: italic">        views.push(view);</span>
<span style="color: #408080; font-style: italic">        view = view._superview;</span>
<span style="color: #408080; font-style: italic">    }</span>
<span style="color: #408080; font-style: italic">    </span>
<span style="color: #408080; font-style: italic">    var index = views.length;</span>
<span style="color: #408080; font-style: italic">    </span>
<span style="color: #408080; font-style: italic">    while (index--)</span>
<span style="color: #408080; font-style: italic">    {</span>
<span style="color: #408080; font-style: italic">        var frame = views[index]._frame;</span>
<span style="color: #408080; font-style: italic">            </span>
<span style="color: #408080; font-style: italic">        transform.tx -= _CGRectGetMinX(frame);</span>
<span style="color: #408080; font-style: italic">        transform.ty -= _CGRectGetMinY(frame);</span>
<span style="color: #408080; font-style: italic">    }*/</span>
    
    <span style="color: #008000; font-weight: bold">return</span> transform;
}
</pre></div>
