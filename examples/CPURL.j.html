<div class="highlight"><pre><span style="color: #BC7A00">@import</span> <span style="color: #BA2121">&lt;Foundation/CPObject.j&gt;</span>

CPURLNameKey                        <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLNameKey&quot;</span>;
CPURLLocalizedNameKey               <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLLocalizedNameKey&quot;</span>;
CPURLIsRegularFileKey               <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLIsRegularFileKey&quot;</span>;
CPURLIsDirectoryKey                 <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLIsDirectoryKey&quot;</span>;
CPURLIsSymbolicLinkKey              <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLIsSymbolicLinkKey&quot;</span>;
CPURLIsVolumeKey                    <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLIsVolumeKey&quot;</span>;
CPURLIsPackageKey                   <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLIsPackageKey&quot;</span>;
CPURLIsSystemImmutableKey           <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLIsSystemImmutableKey&quot;</span>;
CPURLIsUserImmutableKey             <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLIsUserImmutableKey&quot;</span>;
CPURLIsHiddenKey                    <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLIsHiddenKey&quot;</span>;
CPURLHasHiddenExtensionKey          <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLHasHiddenExtensionKey&quot;</span>;
CPURLCreationDateKey                <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLCreationDateKey&quot;</span>;
CPURLContentAccessDateKey           <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLContentAccessDateKey&quot;</span>;
CPURLContentModificationDateKey     <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLContentModificationDateKey&quot;</span>;
CPURLAttributeModificationDateKey   <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLAttributeModificationDateKey&quot;</span>;
CPURLLinkCountKey                   <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLLinkCountKey&quot;</span>;
CPURLParentDirectoryURLKey          <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLParentDirectoryURLKey&quot;</span>;
CPURLVolumeURLKey                   <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLTypeIdentifierKey&quot;</span>;
CPURLTypeIdentifierKey              <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLTypeIdentifierKey&quot;</span>;
CPURLLocalizedTypeDescriptionKey    <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLLocalizedTypeDescriptionKey&quot;</span>;
CPURLLabelNumberKey                 <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLLabelNumberKey&quot;</span>;
CPURLLabelColorKey                  <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLLabelColorKey&quot;</span>;
CPURLLocalizedLabelKey              <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLLocalizedLabelKey&quot;</span>;
CPURLEffectiveIconKey               <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLEffectiveIconKey&quot;</span>;
CPURLCustomIconKey                  <span style="color: #666666">=</span> <span style="color: #BA2121">@&quot;CPURLCustomIconKey&quot;</span>;

<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">CPURL</span> <span style="color: #666666">:</span> <span style="color: #0000FF; font-weight: bold">CPObject</span>
{
    CPURL       _base <span style="color: #008000; font-weight: bold">@accessors</span>(readonly, property<span style="color: #666666">=</span>baseURL);
    CPString    _relative <span style="color: #008000; font-weight: bold">@accessors</span>(readonly, property<span style="color: #666666">=</span>relativeString);

    CPDictionary    _resourceValues;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithScheme:</span>(<span style="color: #B00040">CPString</span>)scheme <span style="color: #0000FF">host:</span>(<span style="color: #B00040">CPString</span>)host <span style="color: #0000FF">path:</span>(<span style="color: #B00040">CPString</span>)path
{
    <span style="color: #008000; font-weight: bold">var</span> uri <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">URI</span>();
    uri.scheme <span style="color: #666666">=</span> scheme;
    uri.authority <span style="color: #666666">=</span> host;
    uri.path <span style="color: #666666">=</span> path;
    [<span style="color: #008000">self</span> initWithString<span style="color: #666666">:</span>uri.<span style="color: #0000FF">toString</span>()];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithString:</span>(<span style="color: #B00040">CPString</span>)URLString
{
    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> initWithString<span style="color: #666666">:</span>URLString relativeToURL<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">nil</span>];
}

<span style="color: #666666">+</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">URLWithString:</span>(<span style="color: #B00040">CPString</span>)URLString
{
    <span style="color: #008000; font-weight: bold">return</span> [[<span style="color: #008000">self</span> alloc] initWithString<span style="color: #666666">:</span>URLString];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithString:</span>(<span style="color: #B00040">CPString</span>)URLString <span style="color: #0000FF">relativeToURL:</span>(<span style="color: #B00040">CPURL</span>)baseURL
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>URI_RE.<span style="color: #0000FF">test</span>(URLString))
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span>)
    {
        _base <span style="color: #666666">=</span> baseURL;
        _relative <span style="color: #666666">=</span> URLString;
        _resourceValues <span style="color: #666666">=</span> [CPDictionary dictionary];
    }

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #666666">+</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">URLWithString:</span>(<span style="color: #B00040">CPString</span>)URLString <span style="color: #0000FF">relativeToURL:</span>(<span style="color: #B00040">CPURL</span>)baseURL
{
    <span style="color: #008000; font-weight: bold">return</span> [[<span style="color: #008000">self</span> alloc] initWithString<span style="color: #666666">:</span>URLString relativeToURL<span style="color: #666666">:</span>baseURL];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPURL</span>)<span style="color: #0000FF">absoluteURL</span>
{
    <span style="color: #008000; font-weight: bold">var</span> absStr <span style="color: #666666">=</span> [<span style="color: #008000">self</span> absoluteString];
    
    <span style="color: #008000; font-weight: bold">if</span> (absStr <span style="color: #666666">!==</span> _relative)
        <span style="color: #008000; font-weight: bold">return</span> [[CPURL alloc] initWithString<span style="color: #666666">:</span>absStr];
    
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">absoluteString</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">resolve</span>([_base absoluteString] <span style="color: #666666">||</span> <span style="color: #BA2121">&quot;&quot;</span>, _relative);
}

<span style="color: #408080; font-style: italic">// if absolute, returns same as absoluteString</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">relativeString</span>
{
    <span style="color: #008000; font-weight: bold">return</span> _relative;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">path</span>
{
    <span style="color: #008000; font-weight: bold">var</span> str <span style="color: #666666">=</span> [<span style="color: #008000">self</span> absoluteString];
    <span style="color: #008000; font-weight: bold">return</span> URI_RE.<span style="color: #0000FF">test</span>(str) <span style="color: #666666">?</span> (<span style="color: #0000FF">parse</span>(str).path <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">nil</span>) <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #408080; font-style: italic">// if absolute, returns the same as path</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">relativePath</span>
{
    <span style="color: #008000; font-weight: bold">return</span> URI_RE.<span style="color: #0000FF">test</span>(_relative) <span style="color: #666666">?</span> (<span style="color: #0000FF">parse</span>(_relative).path <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">nil</span>) <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">nil</span>;
}


<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">scheme</span>
{
    <span style="color: #008000; font-weight: bold">var</span> str <span style="color: #666666">=</span> [<span style="color: #008000">self</span> absoluteString];
    <span style="color: #008000; font-weight: bold">return</span> URI_RE.<span style="color: #0000FF">test</span>(str) <span style="color: #666666">?</span> (<span style="color: #0000FF">parse</span>(str).protocol <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">nil</span>) <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">user</span>
{
    <span style="color: #008000; font-weight: bold">var</span> str <span style="color: #666666">=</span> [<span style="color: #008000">self</span> absoluteString];
    <span style="color: #008000; font-weight: bold">return</span> URI_RE.<span style="color: #0000FF">test</span>(str) <span style="color: #666666">?</span> (<span style="color: #0000FF">parse</span>(str).user <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">nil</span>) <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">password</span>
{
    <span style="color: #008000; font-weight: bold">var</span> str <span style="color: #666666">=</span> [<span style="color: #008000">self</span> absoluteString];
    <span style="color: #008000; font-weight: bold">return</span> URI_RE.<span style="color: #0000FF">test</span>(str) <span style="color: #666666">?</span> (<span style="color: #0000FF">parse</span>(str).password <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">nil</span>) <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">host</span>
{
    <span style="color: #008000; font-weight: bold">var</span> str <span style="color: #666666">=</span> [<span style="color: #008000">self</span> absoluteString];
    <span style="color: #008000; font-weight: bold">return</span> URI_RE.<span style="color: #0000FF">test</span>(str) <span style="color: #666666">?</span> (<span style="color: #0000FF">parse</span>(str).domain <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">nil</span>) <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">port</span>
{
    <span style="color: #008000; font-weight: bold">var</span> str <span style="color: #666666">=</span> [<span style="color: #008000">self</span> absoluteString];
    <span style="color: #008000; font-weight: bold">if</span> (URI_RE.<span style="color: #0000FF">test</span>(str)) {
        <span style="color: #008000; font-weight: bold">var</span> port <span style="color: #666666">=</span> <span style="color: #0000FF">parse</span>(str).port;
        <span style="color: #008000; font-weight: bold">if</span> (port)
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">parseInt</span>(port, <span style="color: #666666">10</span>);
    }
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">parameterString</span>
{
    <span style="color: #008000; font-weight: bold">var</span> str <span style="color: #666666">=</span> [<span style="color: #008000">self</span> absoluteString];
    <span style="color: #008000; font-weight: bold">return</span> URI_RE.<span style="color: #0000FF">test</span>(str) <span style="color: #666666">?</span> (<span style="color: #0000FF">parse</span>(str).query <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">nil</span>) <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">fragment</span>
{
    <span style="color: #008000; font-weight: bold">var</span> str <span style="color: #666666">=</span> [<span style="color: #008000">self</span> absoluteString];
    <span style="color: #008000; font-weight: bold">return</span> URI_RE.<span style="color: #0000FF">test</span>(str) <span style="color: #666666">?</span> (<span style="color: #0000FF">parse</span>(str).anchor <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">nil</span>) <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">isEqual:</span>(<span style="color: #B00040">id</span>)anObject
{
    <span style="color: #408080; font-style: italic">// Is checking if baseURL isEqual correct? Does &quot;identical&quot; mean same object or equivalent values?</span>
    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> relativeString] <span style="color: #666666">===</span> [anObject relativeString] <span style="color: #666666">&amp;&amp;</span>
        ([<span style="color: #008000">self</span> baseURL] <span style="color: #666666">===</span> [anObject baseURL] <span style="color: #666666">||</span> [[<span style="color: #008000">self</span> baseURL] isEqual<span style="color: #666666">:</span>[anObject baseURL]]);
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">lastPathComponent</span>
{
    <span style="color: #008000; font-weight: bold">var</span> path <span style="color: #666666">=</span> [<span style="color: #008000">self</span> path];
    <span style="color: #008000; font-weight: bold">return</span> path <span style="color: #666666">?</span> path.<span style="color: #0000FF">split</span>(<span style="color: #BA2121">&quot;/&quot;</span>).<span style="color: #0000FF">pop</span>() <span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">pathExtension</span>
{
    <span style="color: #008000; font-weight: bold">var</span> path <span style="color: #666666">=</span> [<span style="color: #008000">self</span> path],
        ext <span style="color: #666666">=</span> path.<span style="color: #0000FF">match</span>(<span style="color: #BB6688">/\.(\w+)$/</span>);
    <span style="color: #008000; font-weight: bold">return</span> ext <span style="color: #666666">?</span> ext[<span style="color: #666666">1</span>] <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPURL</span>)<span style="color: #0000FF">standardizedURL</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [CPURL URLWithString<span style="color: #666666">:</span><span style="color: #0000FF">format</span>(<span style="color: #0000FF">parse</span>(_relative)) relativeToURL<span style="color: #666666">:</span>_base];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">isFileURL</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> scheme] <span style="color: #666666">===</span> <span style="color: #BA2121">&quot;file&quot;</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">description</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> absoluteString];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">resourceValueForKey:</span>(<span style="color: #B00040">CPString</span>)aKey
{
    <span style="color: #008000; font-weight: bold">return</span> [_resourceValues objectForKey<span style="color: #666666">:</span>aKey];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">setResourceValue:</span>(<span style="color: #B00040">id</span>)anObject <span style="color: #0000FF">forKey:</span>(<span style="color: #B00040">CPString</span>)aKey
{
    [_resourceValues setObject<span style="color: #666666">:</span>anObject forKey<span style="color: #666666">:</span>aKey];
}

<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">CPURL</span> (<span style="color: #A0A000">CPCoding</span>)

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithCoder:</span>(<span style="color: #B00040">CPCoder</span>)aCoder
{
    _base <span style="color: #666666">=</span> [aCoder decodeObjectForKey<span style="color: #666666">:</span><span style="color: #BA2121">&quot;CPURLBaseKey&quot;</span>];
    _relative <span style="color: #666666">=</span> [aCoder decodeObjectForKey<span style="color: #666666">:</span><span style="color: #BA2121">&quot;CPURLRelativeKey&quot;</span>];
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">encodeWithCoder:</span>(<span style="color: #B00040">CPCoder</span>)aCoder
{
    [aCoder encodeObject<span style="color: #666666">:</span>_base forKey<span style="color: #666666">:</span><span style="color: #BA2121">&quot;CPURLBaseKey&quot;</span>];
    [aCoder encodeObject<span style="color: #666666">:</span>_relative forKey<span style="color: #666666">:</span><span style="color: #BA2121">&quot;CPURLRelativeKey&quot;</span>];
}

<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #408080; font-style: italic">// original code: http://code.google.com/p/js-uri/</span>

<span style="color: #408080; font-style: italic">// Based on the regex in RFC2396 Appendix B.</span>
<span style="color: #008000; font-weight: bold">var</span> URI_RE <span style="color: #666666">=</span> <span style="color: #BB6688">/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/</span>;

<span style="color: #408080; font-style: italic">/**</span>
<span style="color: #408080; font-style: italic"> * Uniform Resource Identifier (URI) - RFC3986</span>
<span style="color: #408080; font-style: italic"> */</span>
<span style="color: #008000; font-weight: bold">var</span> URI <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">function</span>(str) {
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>str) str <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>;
    <span style="color: #008000; font-weight: bold">var</span> result <span style="color: #666666">=</span> str.<span style="color: #0000FF">match</span>(URI_RE);
    <span style="color: #008000">this</span>.scheme <span style="color: #666666">=</span> result[<span style="color: #666666">1</span>] <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">null</span>;
    <span style="color: #008000">this</span>.authority <span style="color: #666666">=</span> result[<span style="color: #666666">2</span>] <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">null</span>;
    <span style="color: #008000">this</span>.path <span style="color: #666666">=</span> result[<span style="color: #666666">3</span>] <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">null</span>;
    <span style="color: #008000">this</span>.query <span style="color: #666666">=</span> result[<span style="color: #666666">4</span>] <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">null</span>;
    <span style="color: #008000">this</span>.fragment <span style="color: #666666">=</span> result[<span style="color: #666666">5</span>] <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">null</span>;
}

<span style="color: #408080; font-style: italic">/**</span>
<span style="color: #408080; font-style: italic"> * Convert the URI to a String.</span>
<span style="color: #408080; font-style: italic"> */</span>
URI.<span style="color: #008000; font-weight: bold">prototype</span>.toString <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">function</span> () {
    <span style="color: #008000; font-weight: bold">var</span> str <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>;
 
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">this</span>.scheme)
        str <span style="color: #666666">+=</span> <span style="color: #008000">this</span>.scheme <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;:&quot;</span>;

    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">this</span>.authority)
        str <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;//&quot;</span> <span style="color: #666666">+</span> <span style="color: #008000">this</span>.authority;

    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">this</span>.path)
        str <span style="color: #666666">+=</span> <span style="color: #008000">this</span>.path;

    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">this</span>.query)
        str <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;?&quot;</span> <span style="color: #666666">+</span> <span style="color: #008000">this</span>.query;

    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">this</span>.fragment)
        str <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;#&quot;</span> <span style="color: #666666">+</span> <span style="color: #008000">this</span>.fragment;
 
    <span style="color: #008000; font-weight: bold">return</span> str;
}

<span style="color: #008000; font-weight: bold">var</span> parse <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">function</span>(uri) {
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">URI</span>(uri);
}

<span style="color: #008000; font-weight: bold">var</span> unescape <span style="color: #666666">=</span>  <span style="color: #008000; font-weight: bold">function</span>(str, plus) {
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">decodeURI</span>(str).<span style="color: #0000FF">replace</span>(<span style="color: #BB6688">/\+/g</span>, <span style="color: #BA2121">&quot; &quot;</span>);
}

<span style="color: #008000; font-weight: bold">var</span> unescapeComponent <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">function</span>(str, plus) {
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">decodeURIComponent</span>(str).<span style="color: #0000FF">replace</span>(<span style="color: #BB6688">/\+/g</span>, <span style="color: #BA2121">&quot; &quot;</span>);
}

<span style="color: #408080; font-style: italic">// from Chiron&#39;s HTTP module:</span>

<span style="color: #408080; font-style: italic">/**** keys</span>
<span style="color: #408080; font-style: italic">    members of a parsed URI object.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">var</span> keys <span style="color: #666666">=</span> [
    <span style="color: #BA2121">&quot;url&quot;</span>,
    <span style="color: #BA2121">&quot;protocol&quot;</span>,
    <span style="color: #BA2121">&quot;authorityRoot&quot;</span>,
    <span style="color: #BA2121">&quot;authority&quot;</span>,
        <span style="color: #BA2121">&quot;userInfo&quot;</span>,
            <span style="color: #BA2121">&quot;user&quot;</span>,
            <span style="color: #BA2121">&quot;password&quot;</span>,
        <span style="color: #BA2121">&quot;domain&quot;</span>,
            <span style="color: #BA2121">&quot;domains&quot;</span>,
        <span style="color: #BA2121">&quot;port&quot;</span>,
    <span style="color: #BA2121">&quot;path&quot;</span>,
        <span style="color: #BA2121">&quot;root&quot;</span>,
        <span style="color: #BA2121">&quot;directory&quot;</span>,
            <span style="color: #BA2121">&quot;directories&quot;</span>,
        <span style="color: #BA2121">&quot;file&quot;</span>,
    <span style="color: #BA2121">&quot;query&quot;</span>,
    <span style="color: #BA2121">&quot;anchor&quot;</span>
];

<span style="color: #408080; font-style: italic">/**** expressionKeys</span>
<span style="color: #408080; font-style: italic">    members of a parsed URI object that you get</span>
<span style="color: #408080; font-style: italic">    from evaluting the strict regular expression.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">var</span> expressionKeys <span style="color: #666666">=</span> [
    <span style="color: #BA2121">&quot;url&quot;</span>,
    <span style="color: #BA2121">&quot;protocol&quot;</span>,
    <span style="color: #BA2121">&quot;authorityRoot&quot;</span>,
    <span style="color: #BA2121">&quot;authority&quot;</span>,
        <span style="color: #BA2121">&quot;userInfo&quot;</span>,
            <span style="color: #BA2121">&quot;user&quot;</span>,
            <span style="color: #BA2121">&quot;password&quot;</span>,
        <span style="color: #BA2121">&quot;domain&quot;</span>,
        <span style="color: #BA2121">&quot;port&quot;</span>,
    <span style="color: #BA2121">&quot;path&quot;</span>,
        <span style="color: #BA2121">&quot;root&quot;</span>,
        <span style="color: #BA2121">&quot;directory&quot;</span>,
        <span style="color: #BA2121">&quot;file&quot;</span>,
    <span style="color: #BA2121">&quot;query&quot;</span>,
    <span style="color: #BA2121">&quot;anchor&quot;</span>
];

<span style="color: #408080; font-style: italic">/**** strictExpression</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">var</span> strictExpression <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #008000">RegExp</span>( <span style="color: #408080; font-style: italic">/* url */</span>
    <span style="color: #BA2121">&quot;^&quot;</span> <span style="color: #666666">+</span>
    <span style="color: #BA2121">&quot;(?:&quot;</span> <span style="color: #666666">+</span>
        <span style="color: #BA2121">&quot;([^:/?#]+):&quot;</span> <span style="color: #666666">+</span> <span style="color: #408080; font-style: italic">/* protocol */</span>
    <span style="color: #BA2121">&quot;)?&quot;</span> <span style="color: #666666">+</span>
    <span style="color: #BA2121">&quot;(?:&quot;</span> <span style="color: #666666">+</span>
        <span style="color: #BA2121">&quot;(//)&quot;</span> <span style="color: #666666">+</span> <span style="color: #408080; font-style: italic">/* authorityRoot */</span>
        <span style="color: #BA2121">&quot;(&quot;</span> <span style="color: #666666">+</span> <span style="color: #408080; font-style: italic">/* authority */</span>
            <span style="color: #BA2121">&quot;(?:&quot;</span> <span style="color: #666666">+</span>
                <span style="color: #BA2121">&quot;(&quot;</span> <span style="color: #666666">+</span> <span style="color: #408080; font-style: italic">/* userInfo */</span>
                    <span style="color: #BA2121">&quot;([^:@]*)&quot;</span> <span style="color: #666666">+</span> <span style="color: #408080; font-style: italic">/* user */</span>
                    <span style="color: #BA2121">&quot;:?&quot;</span> <span style="color: #666666">+</span>
                    <span style="color: #BA2121">&quot;([^:@]*)&quot;</span> <span style="color: #666666">+</span> <span style="color: #408080; font-style: italic">/* password */</span>
                <span style="color: #BA2121">&quot;)?&quot;</span> <span style="color: #666666">+</span>
                <span style="color: #BA2121">&quot;@&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;)?&quot;</span> <span style="color: #666666">+</span>
            <span style="color: #BA2121">&quot;([^:/?#]*)&quot;</span> <span style="color: #666666">+</span> <span style="color: #408080; font-style: italic">/* domain */</span>
            <span style="color: #BA2121">&quot;(?::(</span><span style="color: #BB6622; font-weight: bold">\\</span><span style="color: #BA2121">d*))?&quot;</span> <span style="color: #666666">+</span> <span style="color: #408080; font-style: italic">/* port */</span>
        <span style="color: #BA2121">&quot;)&quot;</span> <span style="color: #666666">+</span>
    <span style="color: #BA2121">&quot;)?&quot;</span> <span style="color: #666666">+</span>
    <span style="color: #BA2121">&quot;(&quot;</span> <span style="color: #666666">+</span> <span style="color: #408080; font-style: italic">/* path */</span>
        <span style="color: #BA2121">&quot;(/?)&quot;</span> <span style="color: #666666">+</span> <span style="color: #408080; font-style: italic">/* root */</span>
        <span style="color: #BA2121">&quot;((?:[^?#/]*/)*)&quot;</span> <span style="color: #666666">+</span>
        <span style="color: #BA2121">&quot;([^?#]*)&quot;</span> <span style="color: #666666">+</span> <span style="color: #408080; font-style: italic">/* file */</span>
    <span style="color: #BA2121">&quot;)&quot;</span> <span style="color: #666666">+</span>
    <span style="color: #BA2121">&quot;(?:</span><span style="color: #BB6622; font-weight: bold">\\</span><span style="color: #BA2121">?([^#]*))?&quot;</span> <span style="color: #666666">+</span> <span style="color: #408080; font-style: italic">/* query */</span>
    <span style="color: #BA2121">&quot;(?:#(.*))?&quot;</span> <span style="color: #408080; font-style: italic">/*anchor */</span>
);

<span style="color: #408080; font-style: italic">/**** Parser</span>
<span style="color: #408080; font-style: italic">    returns a URI parser function given</span>
<span style="color: #408080; font-style: italic">    a regular expression that renders </span>
<span style="color: #408080; font-style: italic">    `expressionKeys` and returns an `Object`</span>
<span style="color: #408080; font-style: italic">    mapping all `keys` to values.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">var</span> Parser <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">function</span> (expression) {
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">function</span> (url) {
        <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000; font-weight: bold">typeof</span> url <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;undefined&quot;</span>)
            <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #008000">Error</span>(<span style="color: #BA2121">&quot;HttpError: URL is undefined&quot;</span>);
        <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000; font-weight: bold">typeof</span> url <span style="color: #666666">!=</span> <span style="color: #BA2121">&quot;string&quot;</span>) <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #008000">Object</span>(url);

        <span style="color: #008000; font-weight: bold">var</span> items <span style="color: #666666">=</span> {};
        <span style="color: #008000; font-weight: bold">var</span> parts <span style="color: #666666">=</span> expression.<span style="color: #0000FF">exec</span>(url);

        <span style="color: #008000; font-weight: bold">for</span> (<span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">0</span>; i <span style="color: #666666">&lt;</span> parts.length; i<span style="color: #666666">++</span>) {
            items[expressionKeys[i]] <span style="color: #666666">=</span> parts[i] <span style="color: #666666">?</span> parts[i] <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>;
        }

        items.root <span style="color: #666666">=</span> (items.root <span style="color: #666666">||</span> items.authorityRoot) <span style="color: #666666">?</span> <span style="color: #BA2121">&#39;/&#39;</span> <span style="color: #666666">:</span> <span style="color: #BA2121">&#39;&#39;</span>;

        items.directories <span style="color: #666666">=</span> items.directory.<span style="color: #0000FF">split</span>(<span style="color: #BA2121">&quot;/&quot;</span>);
        <span style="color: #008000; font-weight: bold">if</span> (items.directories[items.directories.length <span style="color: #666666">-</span> <span style="color: #666666">1</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;&quot;</span>) {
            items.directories.<span style="color: #0000FF">pop</span>();
        }

        <span style="color: #408080; font-style: italic">/* normalize */</span>
        <span style="color: #008000; font-weight: bold">var</span> directories <span style="color: #666666">=</span> [];
        <span style="color: #008000; font-weight: bold">for</span> (<span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">0</span>; i <span style="color: #666666">&lt;</span> items.directories.length; i<span style="color: #666666">++</span>) {
            <span style="color: #008000; font-weight: bold">var</span> directory <span style="color: #666666">=</span> items.directories[i];
            <span style="color: #008000; font-weight: bold">if</span> (directory <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;.&#39;</span>) {
            } <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (directory <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;..&#39;</span>) {
                <span style="color: #008000; font-weight: bold">if</span> (directories.length <span style="color: #666666">&amp;&amp;</span> directories[directories.length <span style="color: #666666">-</span> <span style="color: #666666">1</span>] <span style="color: #666666">!=</span> <span style="color: #BA2121">&#39;..&#39;</span>)
                    directories.<span style="color: #0000FF">pop</span>();
                <span style="color: #008000; font-weight: bold">else</span>
                    directories.<span style="color: #0000FF">push</span>(<span style="color: #BA2121">&#39;..&#39;</span>);
            } <span style="color: #008000; font-weight: bold">else</span> {
                directories.<span style="color: #0000FF">push</span>(directory);
            }
        }
        items.directories <span style="color: #666666">=</span> directories;

        items.domains <span style="color: #666666">=</span> items.domain.<span style="color: #0000FF">split</span>(<span style="color: #BA2121">&quot;.&quot;</span>);

        <span style="color: #008000; font-weight: bold">return</span> items;
    };
};

<span style="color: #408080; font-style: italic">/**** parse</span>
<span style="color: #408080; font-style: italic">    a strict URI parser.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">var</span> parse <span style="color: #666666">=</span> <span style="color: #0000FF">Parser</span>(strictExpression);

<span style="color: #408080; font-style: italic">/**** format</span>
<span style="color: #408080; font-style: italic">    accepts a parsed URI object and returns</span>
<span style="color: #408080; font-style: italic">    the corresponding string.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">var</span> format <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">function</span> (object) {
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000; font-weight: bold">typeof</span>(object) <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;undefined&#39;</span>)
        <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> <span style="color: #008000">Error</span>(<span style="color: #BA2121">&quot;UrlError: URL undefined for urls#format&quot;</span>);
    <span style="color: #008000; font-weight: bold">if</span> (object <span style="color: #008000; font-weight: bold">instanceof</span> <span style="color: #008000">String</span> <span style="color: #666666">||</span> <span style="color: #008000; font-weight: bold">typeof</span>(object) <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;string&#39;</span>)
        <span style="color: #008000; font-weight: bold">return</span> object;
    <span style="color: #008000; font-weight: bold">var</span> domain <span style="color: #666666">=</span>
        object.domains <span style="color: #666666">?</span>
        object.domains.<span style="color: #0000FF">join</span>(<span style="color: #BA2121">&quot;.&quot;</span>) <span style="color: #666666">:</span>
        object.domain;
    <span style="color: #008000; font-weight: bold">var</span> userInfo <span style="color: #666666">=</span> (
            object.user <span style="color: #666666">||</span>
            object.password 
        ) <span style="color: #666666">?</span>
        (
            (object.user <span style="color: #666666">||</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span> 
            (object.password <span style="color: #666666">?</span> <span style="color: #BA2121">&quot;:&quot;</span> <span style="color: #666666">+</span> object.password <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>) 
        ) <span style="color: #666666">:</span>
        object.userInfo;
    <span style="color: #008000; font-weight: bold">var</span> authority <span style="color: #666666">=</span> (
            userInfo <span style="color: #666666">||</span>
            domain <span style="color: #666666">||</span>
            object.port
        ) <span style="color: #666666">?</span> (
            (userInfo <span style="color: #666666">?</span> userInfo <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;@&quot;</span> <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span>
            (domain <span style="color: #666666">||</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span> 
            (object.port <span style="color: #666666">?</span> <span style="color: #BA2121">&quot;:&quot;</span> <span style="color: #666666">+</span> object.port <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>)
        ) <span style="color: #666666">:</span>
        object.authority;
    <span style="color: #008000; font-weight: bold">var</span> directory <span style="color: #666666">=</span>
        object.directories <span style="color: #666666">?</span>
        object.directories.<span style="color: #0000FF">join</span>(<span style="color: #BA2121">&quot;/&quot;</span>) <span style="color: #666666">:</span>
        object.directory;
    <span style="color: #008000; font-weight: bold">var</span> path <span style="color: #666666">=</span>
        directory <span style="color: #666666">||</span> object.file <span style="color: #666666">?</span>
        (
            (directory <span style="color: #666666">?</span> directory <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;/&quot;</span> <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span>
            (object.file <span style="color: #666666">||</span> <span style="color: #BA2121">&quot;&quot;</span>)
        ) <span style="color: #666666">:</span>
        object.path;
    <span style="color: #008000; font-weight: bold">return</span> (
        (object.protocol <span style="color: #666666">?</span> object.protocol <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;:&quot;</span> <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span>
        (authority <span style="color: #666666">?</span> <span style="color: #BA2121">&quot;//&quot;</span> <span style="color: #666666">+</span> authority <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span>
        (object.root <span style="color: #666666">||</span> (authority <span style="color: #666666">&amp;&amp;</span> path) <span style="color: #666666">?</span> <span style="color: #BA2121">&quot;/&quot;</span> <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span>
        (path <span style="color: #666666">?</span> path <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span>
        (object.query <span style="color: #666666">?</span> <span style="color: #BA2121">&quot;?&quot;</span> <span style="color: #666666">+</span> object.query <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #666666">+</span>
        (object.anchor <span style="color: #666666">?</span> <span style="color: #BA2121">&quot;#&quot;</span> <span style="color: #666666">+</span> object.anchor <span style="color: #666666">:</span> <span style="color: #BA2121">&quot;&quot;</span>)
    ) <span style="color: #666666">||</span> object.url <span style="color: #666666">||</span> <span style="color: #BA2121">&quot;&quot;</span>;
};

<span style="color: #408080; font-style: italic">/**** resolveObject</span>
<span style="color: #408080; font-style: italic">    returns an object representing a URL resolved from</span>
<span style="color: #408080; font-style: italic">    a relative location and a source location.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">var</span> resolveObject <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">function</span> (source, relative) {
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>source) 
        <span style="color: #008000; font-weight: bold">return</span> relative;

    source <span style="color: #666666">=</span> <span style="color: #0000FF">parse</span>(source);
    relative <span style="color: #666666">=</span> <span style="color: #0000FF">parse</span>(relative);

    <span style="color: #008000; font-weight: bold">if</span> (relative.url <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;&quot;</span>)
        <span style="color: #008000; font-weight: bold">return</span> source;

    <span style="color: #008000; font-weight: bold">delete</span> source.url;
    <span style="color: #008000; font-weight: bold">delete</span> source.authority;
    <span style="color: #008000; font-weight: bold">delete</span> source.domain;
    <span style="color: #008000; font-weight: bold">delete</span> source.userInfo;
    <span style="color: #008000; font-weight: bold">delete</span> source.path;
    <span style="color: #008000; font-weight: bold">delete</span> source.directory;

    <span style="color: #008000; font-weight: bold">if</span> (
        relative.protocol <span style="color: #666666">&amp;&amp;</span> relative.protocol <span style="color: #666666">!=</span> source.protocol <span style="color: #666666">||</span>
        relative.authority <span style="color: #666666">&amp;&amp;</span> relative.authority <span style="color: #666666">!=</span> source.authority
    ) {
        source <span style="color: #666666">=</span> relative;
    } <span style="color: #008000; font-weight: bold">else</span> {
        <span style="color: #008000; font-weight: bold">if</span> (relative.root) {
            source.directories <span style="color: #666666">=</span> relative.directories;
        } <span style="color: #008000; font-weight: bold">else</span> {

            <span style="color: #008000; font-weight: bold">var</span> directories <span style="color: #666666">=</span> relative.directories;
            <span style="color: #008000; font-weight: bold">for</span> (<span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">0</span>; i <span style="color: #666666">&lt;</span> directories.length; i<span style="color: #666666">++</span>) {
                <span style="color: #008000; font-weight: bold">var</span> directory <span style="color: #666666">=</span> directories[i];
                <span style="color: #008000; font-weight: bold">if</span> (directory <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;.&quot;</span>) {
                } <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (directory <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;..&quot;</span>) {
                    <span style="color: #008000; font-weight: bold">if</span> (source.directories.length) {
                        source.directories.<span style="color: #0000FF">pop</span>();
                    } <span style="color: #008000; font-weight: bold">else</span> {
                        source.directories.<span style="color: #0000FF">push</span>(<span style="color: #BA2121">&#39;..&#39;</span>);
                    }
                } <span style="color: #008000; font-weight: bold">else</span> {
                    source.directories.<span style="color: #0000FF">push</span>(directory);
                }
            }

            <span style="color: #008000; font-weight: bold">if</span> (relative.file <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;.&quot;</span>) {
                relative.file <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>;
            } <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (relative.file <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;..&quot;</span>) {
                source.directories.<span style="color: #0000FF">pop</span>();
                relative.file <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>;
            }
        }
    }

    <span style="color: #008000; font-weight: bold">if</span> (relative.root)
        source.root <span style="color: #666666">=</span> relative.root;
    <span style="color: #008000; font-weight: bold">if</span> (relative.protcol)
        source.protocol <span style="color: #666666">=</span> relative.protocol;
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>(<span style="color: #666666">!</span>relative.path <span style="color: #666666">&amp;&amp;</span> relative.anchor))
        source.file <span style="color: #666666">=</span> relative.file;
    source.query <span style="color: #666666">=</span> relative.query;
    source.anchor <span style="color: #666666">=</span> relative.anchor;

    <span style="color: #008000; font-weight: bold">return</span> source;
};

<span style="color: #408080; font-style: italic">/**** relativeObject</span>
<span style="color: #408080; font-style: italic">    returns an object representing a relative URL to</span>
<span style="color: #408080; font-style: italic">    a given target URL from a source URL.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">var</span> relativeObject <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">function</span> (source, target) {
    target <span style="color: #666666">=</span> <span style="color: #0000FF">parse</span>(target);
    source <span style="color: #666666">=</span> <span style="color: #0000FF">parse</span>(source);

    <span style="color: #008000; font-weight: bold">delete</span> target.url;

    <span style="color: #008000; font-weight: bold">if</span> (
        target.protocol <span style="color: #666666">==</span> source.protocol <span style="color: #666666">&amp;&amp;</span>
        target.authority <span style="color: #666666">==</span> source.authority
    ) {
        <span style="color: #008000; font-weight: bold">delete</span> target.protocol;
        <span style="color: #008000; font-weight: bold">delete</span> target.authority;
        <span style="color: #008000; font-weight: bold">delete</span> target.userInfo;
        <span style="color: #008000; font-weight: bold">delete</span> target.user;
        <span style="color: #008000; font-weight: bold">delete</span> target.password;
        <span style="color: #008000; font-weight: bold">delete</span> target.domain;
        <span style="color: #008000; font-weight: bold">delete</span> target.domains;
        <span style="color: #008000; font-weight: bold">delete</span> target.port;
        <span style="color: #008000; font-weight: bold">if</span> (
            <span style="color: #666666">!!</span>target.root <span style="color: #666666">==</span> <span style="color: #666666">!!</span>source.root <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>(
                target.root <span style="color: #666666">&amp;&amp;</span>
                target.directories[<span style="color: #666666">0</span>] <span style="color: #666666">!=</span> source.directories[<span style="color: #666666">0</span>]
            )
        ) {
            <span style="color: #008000; font-weight: bold">delete</span> target.path;
            <span style="color: #008000; font-weight: bold">delete</span> target.root;
            <span style="color: #008000; font-weight: bold">delete</span> target.directory;
            <span style="color: #008000; font-weight: bold">while</span> (
                source.directories.length <span style="color: #666666">&amp;&amp;</span>
                target.directories.length <span style="color: #666666">&amp;&amp;</span>
                target.directories[<span style="color: #666666">0</span>] <span style="color: #666666">==</span> source.directories[<span style="color: #666666">0</span>]
            ) {
                target.directories.<span style="color: #0000FF">shift</span>();
                source.directories.<span style="color: #0000FF">shift</span>();
            }
            <span style="color: #008000; font-weight: bold">while</span> (source.directories.length) {
                source.directories.<span style="color: #0000FF">shift</span>();
                target.directories.<span style="color: #0000FF">unshift</span>(<span style="color: #BA2121">&#39;..&#39;</span>);
            }

            <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>target.root <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>target.directories.length <span style="color: #666666">&amp;&amp;</span> <span style="color: #666666">!</span>target.file <span style="color: #666666">&amp;&amp;</span> source.file)
                target.directories.<span style="color: #0000FF">push</span>(<span style="color: #BA2121">&#39;.&#39;</span>);

            <span style="color: #008000; font-weight: bold">if</span> (source.file <span style="color: #666666">==</span> target.file)
                <span style="color: #008000; font-weight: bold">delete</span> target.file;
            <span style="color: #008000; font-weight: bold">if</span> (source.query <span style="color: #666666">==</span> target.query)
                <span style="color: #008000; font-weight: bold">delete</span> target.query;
            <span style="color: #008000; font-weight: bold">if</span> (source.anchor <span style="color: #666666">==</span> target.anchor)
                <span style="color: #008000; font-weight: bold">delete</span> target.anchor;
        }
    }

    <span style="color: #008000; font-weight: bold">return</span> target;
};

<span style="color: #408080; font-style: italic">/**** resolve</span>
<span style="color: #408080; font-style: italic">    returns a URL resovled to a relative URL from a source URL.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">var</span> resolve <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">function</span> (source, relative) {
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">format</span>(<span style="color: #0000FF">resolveObject</span>(source, relative));
};

<span style="color: #408080; font-style: italic">/**** relative</span>
<span style="color: #408080; font-style: italic">    returns a relative URL to a target from a source.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">var</span> relative <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">function</span> (source, target) {
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">format</span>(<span style="color: #0000FF">relativeObject</span>(source, target));
};
</pre></div>
