<div class="highlight"><pre><span style="color: #408080; font-style: italic">/*</span>
<span style="color: #408080; font-style: italic"> * CPArray.j</span>
<span style="color: #408080; font-style: italic"> * Foundation</span>
<span style="color: #408080; font-style: italic"> *</span>
<span style="color: #408080; font-style: italic"> * Created by Francisco Tolmasky.</span>
<span style="color: #408080; font-style: italic"> * Copyright 2008, 280 North, Inc.</span>
<span style="color: #408080; font-style: italic"> *</span>
<span style="color: #408080; font-style: italic"> * This library is free software; you can redistribute it and/or</span>
<span style="color: #408080; font-style: italic"> * modify it under the terms of the GNU Lesser General Public</span>
<span style="color: #408080; font-style: italic"> * License as published by the Free Software Foundation; either</span>
<span style="color: #408080; font-style: italic"> * version 2.1 of the License, or (at your option) any later version.</span>
<span style="color: #408080; font-style: italic"> *</span>
<span style="color: #408080; font-style: italic"> * This library is distributed in the hope that it will be useful,</span>
<span style="color: #408080; font-style: italic"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span style="color: #408080; font-style: italic"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<span style="color: #408080; font-style: italic"> * Lesser General Public License for more details.</span>
<span style="color: #408080; font-style: italic"> *</span>
<span style="color: #408080; font-style: italic"> * You should have received a copy of the GNU Lesser General Public</span>
<span style="color: #408080; font-style: italic"> * License along with this library; if not, write to the Free Software</span>
<span style="color: #408080; font-style: italic"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA</span>
<span style="color: #408080; font-style: italic"> */</span>

<span style="color: #BC7A00">@import &quot;CPObject.j&quot;</span>
<span style="color: #BC7A00">@import &quot;CPRange.j&quot;</span>
<span style="color: #BC7A00">@import &quot;CPEnumerator.j&quot;</span>
<span style="color: #BC7A00">@import &quot;CPSortDescriptor.j&quot;</span>
<span style="color: #BC7A00">@import &quot;CPException.j&quot;</span>


<span style="color: #408080; font-style: italic">/* @ignore */</span>
<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">_CPArrayEnumerator</span> <span style="color: #666666">:</span> <span style="color: #0000FF; font-weight: bold">CPEnumerator</span>
{
    CPArray _array;
    <span style="color: #B00040">int</span>     _index;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithArray:</span>(<span style="color: #B00040">CPArray</span>)anArray
{
    <span style="color: #008000">self</span> <span style="color: #666666">=</span> [<span style="color: #008000">super</span> init];
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span>)
    {
        _array <span style="color: #666666">=</span> anArray;
        _index <span style="color: #666666">=</span> <span style="color: #666666">-1</span>;
    }

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">nextObject</span>
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">++</span>_index <span style="color: #666666">&gt;=</span> [_array count])
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;

    <span style="color: #008000; font-weight: bold">return</span> [_array objectAtIndex<span style="color: #666666">:</span>_index];
}

<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #408080; font-style: italic">/* @ignore */</span>
<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">_CPReverseArrayEnumerator</span> <span style="color: #666666">:</span> <span style="color: #0000FF; font-weight: bold">CPEnumerator</span>
{
    CPArray _array;
    <span style="color: #B00040">int</span>     _index;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithArray:</span>(<span style="color: #B00040">CPArray</span>)anArray
{
    <span style="color: #008000">self</span> <span style="color: #666666">=</span> [<span style="color: #008000">super</span> init];
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span>)
    {
        _array <span style="color: #666666">=</span> anArray;
        _index <span style="color: #666666">=</span> [_array count];
    }
    
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">nextObject</span>
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">--</span>_index <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span>)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;

    <span style="color: #008000; font-weight: bold">return</span> [_array objectAtIndex<span style="color: #666666">:</span>_index];
}

<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #408080; font-style: italic">/*! </span>
<span style="color: #408080; font-style: italic">    @class CPArray</span>
<span style="color: #408080; font-style: italic">    @brief A mutable array backed by a JavaScript Array.</span>
<span style="color: #408080; font-style: italic">    @ingroup foundation</span>

<span style="color: #408080; font-style: italic">    A mutable array class backed by a JavaScript Array.</span>
<span style="color: #408080; font-style: italic">    There is also a CPMutableArray class,</span>
<span style="color: #408080; font-style: italic">    but it is just a child class of this class with an</span>
<span style="color: #408080; font-style: italic">    empty implementation. All mutable functionality is</span>
<span style="color: #408080; font-style: italic">    implemented directly in CPArray.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">CPArray</span> <span style="color: #666666">:</span> <span style="color: #0000FF; font-weight: bold">CPObject</span>

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns a new uninitialized CPArray.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">+</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">alloc</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns a new initialized CPArray.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">+</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">array</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [[<span style="color: #008000">self</span> alloc] init];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Creates a new array containing the objects in \c anArray.</span>
<span style="color: #408080; font-style: italic">    @param anArray Objects in this array will be added to the new array</span>
<span style="color: #408080; font-style: italic">    @return a new CPArray of the provided objects</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">+</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">arrayWithArray:</span>(<span style="color: #B00040">CPArray</span>)anArray
{
    <span style="color: #008000; font-weight: bold">return</span> [[<span style="color: #008000">self</span> alloc] initWithArray<span style="color: #666666">:</span>anArray];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Creates a new array with \c anObject in it.</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to be added to the array</span>
<span style="color: #408080; font-style: italic">    @return a new CPArray containing a single object</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">+</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">arrayWithObject:</span>(<span style="color: #B00040">id</span>)anObject
{
    <span style="color: #008000; font-weight: bold">return</span> [[<span style="color: #008000">self</span> alloc] initWithObjects<span style="color: #666666">:</span>anObject];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Creates a new CPArray containing all the objects passed as arguments to the method.</span>
<span style="color: #408080; font-style: italic">    @param anObject the objects that will be added to the new array</span>
<span style="color: #408080; font-style: italic">    @return a new CPArray containing the argument objects</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">+</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">arrayWithObjects:</span>(<span style="color: #B00040">id</span>)anObject<span style="border: 1px solid #FF0000">,</span> <span style="border: 1px solid #FF0000">...</span>
{
    <span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">2</span>,
        array <span style="color: #666666">=</span> [[<span style="color: #008000">self</span> alloc] init],
        argument;

    <span style="color: #008000; font-weight: bold">for</span>(; i <span style="color: #666666">&lt;</span> arguments.length <span style="color: #666666">&amp;&amp;</span> (argument <span style="color: #666666">=</span> arguments[i]) <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">nil</span>; <span style="color: #666666">++</span>i)
        array.push(argument);

    <span style="color: #008000; font-weight: bold">return</span> array;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Creates a CPArray from a JavaScript array of objects.</span>
<span style="color: #408080; font-style: italic">    @param objects the JavaScript Array</span>
<span style="color: #408080; font-style: italic">    @param aCount the number of objects in the JS Array</span>
<span style="color: #408080; font-style: italic">    @return a new CPArray containing the specified objects</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">+</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">arrayWithObjects:</span>(<span style="color: #B00040">id</span>)objects <span style="color: #0000FF">count:</span>(<span style="color: #B00040">unsigned</span>)aCount
{
    <span style="color: #008000; font-weight: bold">return</span> [[<span style="color: #008000">self</span> alloc] initWithObjects<span style="color: #666666">:</span>objects count<span style="color: #666666">:</span>aCount];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Initializes the CPArray.</span>
<span style="color: #408080; font-style: italic">    @return the initialized array</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">init</span>
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #408080; font-style: italic">// Creating an Array</span>
<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Creates a new CPArray from \c anArray.</span>
<span style="color: #408080; font-style: italic">    @param anArray objects in this array will be added to the new array</span>
<span style="color: #408080; font-style: italic">    @return a new CPArray containing the objects of \c anArray</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithArray:</span>(<span style="color: #B00040">CPArray</span>)anArray
{
    <span style="color: #008000">self</span> <span style="color: #666666">=</span> [<span style="color: #008000">super</span> init];
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span>)
        [<span style="color: #008000">self</span> setArray<span style="color: #666666">:</span>anArray];
    
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Initializes a the array with the contents of \c anArray</span>
<span style="color: #408080; font-style: italic">    and optionally performs a deep copy of the objects based on \c copyItems.</span>
<span style="color: #408080; font-style: italic">    @param anArray the array to copy the data from</span>
<span style="color: #408080; font-style: italic">    @param copyItems if \c YES, each object will be copied by having a \c -copy message sent to it, and the</span>
<span style="color: #408080; font-style: italic">    returned object will be added to the receiver. Otherwise, no copying will be performed.</span>
<span style="color: #408080; font-style: italic">    @return the initialized array of objects</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithArray:</span>(<span style="color: #B00040">CPArray</span>)anArray <span style="color: #0000FF">copyItems:</span>(<span style="color: #B00040">BOOL</span>)copyItems
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>copyItems)
        <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> initWithArray<span style="color: #666666">:</span>anArray];

    <span style="color: #008000">self</span> <span style="color: #666666">=</span> [<span style="color: #008000">super</span> init];
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span>)
    {
        <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
            count <span style="color: #666666">=</span> [anArray count];
            
        <span style="color: #008000; font-weight: bold">for</span>(; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>i)
        {
            <span style="color: #008000; font-weight: bold">if</span> (anArray[i].isa)
                <span style="color: #008000">self</span>[i] <span style="color: #666666">=</span> [anArray copy];
            <span style="color: #408080; font-style: italic">// Do a deep/shallow copy?</span>
            <span style="color: #008000; font-weight: bold">else</span>
                <span style="color: #008000">self</span>[i] <span style="color: #666666">=</span> anArray;
        }
    }
    
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    initializes an array with the contents of anArray</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithObjects:</span>(<span style="color: #B00040">Array</span>)anArray<span style="border: 1px solid #FF0000">,</span> <span style="border: 1px solid #FF0000">...</span>
{
    <span style="color: #408080; font-style: italic">// The arguments array contains self and _cmd, so the first object is at position 2.</span>
    <span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">2</span>,
        argument;
    
    <span style="color: #008000; font-weight: bold">for</span>(; i <span style="color: #666666">&lt;</span> arguments.length <span style="color: #666666">&amp;&amp;</span> (argument <span style="color: #666666">=</span> arguments[i]) <span style="color: #666666">!=</span> <span style="color: #008000; font-weight: bold">nil</span>; <span style="color: #666666">++</span>i)
        push(argument);

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>; 
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Initializes the array with a JavaScript array of objects.</span>
<span style="color: #408080; font-style: italic">    @param objects the array of objects to add to the receiver</span>
<span style="color: #408080; font-style: italic">    @param aCount the number of objects in \c objects</span>
<span style="color: #408080; font-style: italic">    @return the initialized CPArray</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithObjects:</span>(<span style="color: #B00040">id</span>)objects <span style="color: #0000FF">count:</span>(<span style="color: #B00040">unsigned</span>)aCount
{
    <span style="color: #008000">self</span> <span style="color: #666666">=</span> [<span style="color: #008000">super</span> init];
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span>)
    {
        <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>;
    
        <span style="color: #008000; font-weight: bold">for</span>(; index <span style="color: #666666">&lt;</span> aCount; <span style="color: #666666">++</span>index)
            push(objects[index]);
    }

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #408080; font-style: italic">// Querying an array</span>
<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns \c YES if the array contains \c anObject. Otherwise, it returns \c NO.</span>
<span style="color: #408080; font-style: italic">    @param anObject the method checks if this object is already in the array</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">containsObject:</span>(<span style="color: #B00040">id</span>)anObject
{
    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> indexOfObject<span style="color: #666666">:</span>anObject] <span style="color: #666666">!=</span> CPNotFound;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the number of elements in the array</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">int</span>)<span style="color: #0000FF">count</span>
{
    <span style="color: #008000; font-weight: bold">return</span> length;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the index of \c anObject in this array.</span>
<span style="color: #408080; font-style: italic">    If the object is \c nil or not in the array,</span>
<span style="color: #408080; font-style: italic">    returns \c CPNotFound. It first attempts to find</span>
<span style="color: #408080; font-style: italic">    a match using \c -isEqual:, then \c ==.</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to search for</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">int</span>)<span style="color: #0000FF">indexOfObject:</span>(<span style="color: #B00040">id</span>)anObject
{
    <span style="color: #008000; font-weight: bold">if</span> (anObject <span style="color: #666666">===</span> <span style="color: #008000; font-weight: bold">nil</span>)
        <span style="color: #008000; font-weight: bold">return</span> CPNotFound;
    
    <span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">0</span>, 
        count <span style="color: #666666">=</span> length;

    <span style="color: #408080; font-style: italic">// Only use -isEqual: if our object is a CPObject.</span>
    <span style="color: #008000; font-weight: bold">if</span> (anObject.isa)
    {
        <span style="color: #008000; font-weight: bold">for</span>(; i <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>i)
            <span style="color: #008000; font-weight: bold">if</span>([<span style="color: #008000">self</span>[i] isEqual<span style="color: #666666">:</span>anObject])
                <span style="color: #008000; font-weight: bold">return</span> i;
    }
    <span style="color: #408080; font-style: italic">// If indexOf exists, use it since it&#39;s probably </span>
    <span style="color: #408080; font-style: italic">// faster than anything we can implement.</span>
    <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span>.indexOf)
        <span style="color: #008000; font-weight: bold">return</span> indexOf(anObject);
    <span style="color: #408080; font-style: italic">// Last resort, do a straight forward linear O(N) search.</span>
    <span style="color: #008000; font-weight: bold">else</span>
        <span style="color: #008000; font-weight: bold">for</span>(; i <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>i)
            <span style="color: #008000; font-weight: bold">if</span>(<span style="color: #008000">self</span>[i] <span style="color: #666666">==</span> anObject)
                <span style="color: #008000; font-weight: bold">return</span> i;
    
    <span style="color: #008000; font-weight: bold">return</span> CPNotFound;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the index of \c anObject in the array</span>
<span style="color: #408080; font-style: italic">    within \c aRange. It first attempts to find</span>
<span style="color: #408080; font-style: italic">    a match using \c -isEqual:, then \c ==.</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to search for</span>
<span style="color: #408080; font-style: italic">    @param aRange the range to search within</span>
<span style="color: #408080; font-style: italic">    @return the index of the object, or \c CPNotFound if it was not found.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">int</span>)<span style="color: #0000FF">indexOfObject:</span>(<span style="color: #B00040">id</span>)anObject <span style="color: #0000FF">inRange:</span>(<span style="color: #B00040">CPRange</span>)aRange
{
    <span style="color: #008000; font-weight: bold">if</span> (anObject <span style="color: #666666">===</span> <span style="color: #008000; font-weight: bold">nil</span>)
        <span style="color: #008000; font-weight: bold">return</span> CPNotFound;
    
    <span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> aRange.location, 
        count <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">MIN</span>(CPMaxRange(aRange), length);
    
    <span style="color: #408080; font-style: italic">// Only use isEqual: if our object is a CPObject.</span>
    <span style="color: #008000; font-weight: bold">if</span> (anObject.isa)
    {
        <span style="color: #008000; font-weight: bold">for</span>(; i <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>i)
            <span style="color: #008000; font-weight: bold">if</span>([<span style="color: #008000">self</span>[i] isEqual<span style="color: #666666">:</span>anObject])
                <span style="color: #008000; font-weight: bold">return</span> i;
    }
    <span style="color: #408080; font-style: italic">// Last resort, do a straight forward linear O(N) search.</span>
    <span style="color: #008000; font-weight: bold">else</span>
        <span style="color: #008000; font-weight: bold">for</span>(; i <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>i)
            <span style="color: #008000; font-weight: bold">if</span>(<span style="color: #008000">self</span>[i] <span style="color: #666666">==</span> anObject)
                <span style="color: #008000; font-weight: bold">return</span> i;
    
    <span style="color: #008000; font-weight: bold">return</span> CPNotFound;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the index of \c anObject in the array. The test for equality is done using only \c ==.</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to search for</span>
<span style="color: #408080; font-style: italic">    @return the index of the object in the array. \c CPNotFound if the object is not in the array.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">int</span>)<span style="color: #0000FF">indexOfObjectIdenticalTo:</span>(<span style="color: #B00040">id</span>)anObject
{
    <span style="color: #008000; font-weight: bold">if</span> (anObject <span style="color: #666666">===</span> <span style="color: #008000; font-weight: bold">nil</span>)
        <span style="color: #008000; font-weight: bold">return</span> CPNotFound;
    
    <span style="color: #408080; font-style: italic">// If indexOf exists, use it since it&#39;s probably </span>
    <span style="color: #408080; font-style: italic">// faster than anything we can implement.</span>
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span>.indexOf)
        <span style="color: #008000; font-weight: bold">return</span> indexOf(anObject);
    
    <span style="color: #408080; font-style: italic">// Last resort, do a straight forward linear O(N) search.</span>
    <span style="color: #008000; font-weight: bold">else</span>
    {
        <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>, 
            count <span style="color: #666666">=</span> length;
        
        <span style="color: #008000; font-weight: bold">for</span>(; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index)
            <span style="color: #008000; font-weight: bold">if</span>(<span style="color: #008000">self</span>[index] <span style="color: #666666">===</span> anObject)
                <span style="color: #008000; font-weight: bold">return</span> index;
    }
    
    <span style="color: #008000; font-weight: bold">return</span> CPNotFound;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the index of \c anObject in the array</span>
<span style="color: #408080; font-style: italic">    within \c aRange. The test for equality is</span>
<span style="color: #408080; font-style: italic">    done using only \c ==.</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to search for</span>
<span style="color: #408080; font-style: italic">    @param aRange the range to search within</span>
<span style="color: #408080; font-style: italic">    @return the index of the object, or \c CPNotFound if it was not found.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">int</span>)<span style="color: #0000FF">indexOfObjectIdenticalTo:</span>(<span style="color: #B00040">id</span>)anObject <span style="color: #0000FF">inRange:</span>(<span style="color: #B00040">CPRange</span>)aRange
{
    <span style="color: #008000; font-weight: bold">if</span> (anObject <span style="color: #666666">===</span> <span style="color: #008000; font-weight: bold">nil</span>)
        <span style="color: #008000; font-weight: bold">return</span> CPNotFound;
    
    <span style="color: #408080; font-style: italic">// If indexOf exists, use it since it&#39;s probably </span>
    <span style="color: #408080; font-style: italic">// faster than anything we can implement.</span>
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span>.indexOf)
    {
        <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> indexOf(anObject, aRange.location);
        
        <span style="color: #008000; font-weight: bold">if</span> (CPLocationInRange(index, aRange))
            <span style="color: #008000; font-weight: bold">return</span> index;
    }
    
    <span style="color: #408080; font-style: italic">// Last resort, do a straight forward linear O(N) search.</span>
    <span style="color: #008000; font-weight: bold">else</span>
    {
        <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> aRange.location, 
            count <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">MIN</span>(CPMaxRange(aRange), length);
        
        <span style="color: #008000; font-weight: bold">for</span>(; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index)
            <span style="color: #008000; font-weight: bold">if</span>(<span style="color: #008000">self</span>[index] <span style="color: #666666">==</span> anObject)
                <span style="color: #008000; font-weight: bold">return</span> index;
    }
    
    <span style="color: #008000; font-weight: bold">return</span> CPNotFound;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the index of \c anObject in the array, which must be sorted in the same order as</span>
<span style="color: #408080; font-style: italic">    calling sortUsingSelector: with the selector passed to this method would result in. </span>
<span style="color: #408080; font-style: italic">    @param anObject the object to search for</span>
<span style="color: #408080; font-style: italic">    @param aSelector the comparison selector to call on each item in the list, the same</span>
<span style="color: #408080; font-style: italic">    selector should have been used to sort the array (or to maintain its sorted order).</span>
<span style="color: #408080; font-style: italic">    @return the index of the object, or \c CPNotFound if it was not found.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">unsigned</span>)<span style="color: #0000FF">indexOfObject:</span>(<span style="color: #B00040">id</span>)anObject <span style="color: #0000FF">sortedBySelector:</span>(<span style="color: #B00040">SEL</span>)aSelector
{
    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> indexOfObject<span style="color: #666666">:</span>anObject sortedByFunction<span style="color: #666666">:</span> <span style="color: #008000; font-weight: bold">function</span>(lhs, rhs) { objj_msgSend(lhs, aSelector, rhs); }];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the index of \c anObject in the array, which must be sorted in the same order as</span>
<span style="color: #408080; font-style: italic">    calling sortUsingFunction: with the selector passed to this method would result in. </span>
<span style="color: #408080; font-style: italic">    The function will be called like so:</span>
<span style="color: #408080; font-style: italic">    &lt;pre&gt;</span>
<span style="color: #408080; font-style: italic">    aFunction(anObject, currentObjectInArrayForComparison)</span>
<span style="color: #408080; font-style: italic">    &lt;/pre&gt;</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to search for</span>
<span style="color: #408080; font-style: italic">    @param aFunction the comparison function to call on each item in the array that we search. the same</span>
<span style="color: #408080; font-style: italic">    selector should have been used to sort the array (or to maintain its sorted order).</span>
<span style="color: #408080; font-style: italic">    @return the index of the object, or \c CPNotFound if it was not found.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">unsigned</span>)<span style="color: #0000FF">indexOfObject:</span>(<span style="color: #B00040">id</span>)anObject <span style="color: #0000FF">sortedByFunction:</span>(<span style="color: #B00040">Function</span>)aFunction
{
    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> indexOfObject<span style="color: #666666">:</span>anObject sortedByFunction<span style="color: #666666">:</span>aFunction context<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">nil</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the index of \c anObject in the array, which must be sorted in the same order as</span>
<span style="color: #408080; font-style: italic">    calling sortUsingFunction: with the selector passed to this method would result in. </span>
<span style="color: #408080; font-style: italic">    The function will be called like so:</span>
<span style="color: #408080; font-style: italic">    &lt;pre&gt;</span>
<span style="color: #408080; font-style: italic">    aFunction(anObject, currentObjectInArrayForComparison, context)</span>
<span style="color: #408080; font-style: italic">    &lt;/pre&gt;</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to search for</span>
<span style="color: #408080; font-style: italic">    @param aFunction the comparison function to call on each item in the array that we search. the same</span>
<span style="color: #408080; font-style: italic">    function should have been used to sort the array (or to maintain its sorted order).</span>
<span style="color: #408080; font-style: italic">    @param aContext a context object that will be passed to the sort function</span>
<span style="color: #408080; font-style: italic">    @return the index of the object, or \c CPNotFound if it was not found.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">unsigned</span>)<span style="color: #0000FF">indexOfObject:</span>(<span style="color: #B00040">id</span>)anObject <span style="color: #0000FF">sortedByFunction:</span>(<span style="color: #B00040">Function</span>)aFunction <span style="color: #0000FF">context:</span>(<span style="color: #B00040">id</span>)aContext
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>aFunction <span style="color: #666666">||</span> anObject <span style="color: #666666">===</span> <span style="color: #008000; font-weight: bold">undefined</span>)
        <span style="color: #008000; font-weight: bold">return</span> CPNotFound;

    <span style="color: #008000; font-weight: bold">var</span> mid, c, first <span style="color: #666666">=</span> <span style="color: #666666">0</span>, last <span style="color: #666666">=</span> length <span style="color: #666666">-</span> <span style="color: #666666">1</span>;
    <span style="color: #008000; font-weight: bold">while</span> (first <span style="color: #666666">&lt;=</span> last)
    {
        mid <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">FLOOR</span>((first <span style="color: #666666">+</span> last) <span style="color: #666666">/</span> <span style="color: #666666">2</span>);
          c <span style="color: #666666">=</span> aFunction(anObject, <span style="color: #008000">self</span>[mid], aContext);

        <span style="color: #008000; font-weight: bold">if</span> (c <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span>)
            first <span style="color: #666666">=</span> mid <span style="color: #666666">+</span> <span style="color: #666666">1</span>;
        <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span> (c <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span>)
            last <span style="color: #666666">=</span> mid <span style="color: #666666">-</span> <span style="color: #666666">1</span>;
        <span style="color: #008000; font-weight: bold">else</span>
        {
            <span style="color: #008000; font-weight: bold">while</span> (mid <span style="color: #666666">&lt;</span> length <span style="color: #666666">-</span> <span style="color: #666666">1</span> <span style="color: #666666">&amp;&amp;</span> aFunction(anObject, <span style="color: #008000">self</span>[mid<span style="color: #666666">+1</span>], aContext) <span style="color: #666666">==</span> CPOrderedSame)
                mid<span style="color: #666666">++</span>;

            <span style="color: #008000; font-weight: bold">return</span> mid;
        }
    }

    <span style="color: #008000; font-weight: bold">return</span> CPNotFound;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the index of \c anObject in the array, which must be sorted in the same order as</span>
<span style="color: #408080; font-style: italic">    calling sortUsingDescriptors: with the descriptors passed to this method would result in. </span>
<span style="color: #408080; font-style: italic">    @param anObject the object to search for</span>
<span style="color: #408080; font-style: italic">    @param descriptors the array of descriptors to use to compare each item in the array that we search. the same</span>
<span style="color: #408080; font-style: italic">    descriptors should have been used to sort the array (or to maintain its sorted order).</span>
<span style="color: #408080; font-style: italic">    @return the index of the object, or \c CPNotFound if it was not found.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">unsigned</span>)<span style="color: #0000FF">indexOfObject:</span>(<span style="color: #B00040">id</span>)anObject <span style="color: #0000FF">sortedByDescriptors:</span>(<span style="color: #B00040">CPArray</span>)descriptors
{
    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> indexOfObject<span style="color: #666666">:</span>anObject sortedByFunction<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">function</span>(lhs, rhs)
    {
        <span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
            count <span style="color: #666666">=</span> [descriptors count],
            result <span style="color: #666666">=</span> CPOrderedSame;

        <span style="color: #008000; font-weight: bold">while</span> (i <span style="color: #666666">&lt;</span> count)
            <span style="color: #008000; font-weight: bold">if</span>((result <span style="color: #666666">=</span> [descriptors[i<span style="color: #666666">++</span>] compareObject<span style="color: #666666">:</span>lhs withObject<span style="color: #666666">:</span>rhs]) <span style="color: #666666">!=</span> CPOrderedSame)
                <span style="color: #008000; font-weight: bold">return</span> result;

        <span style="color: #008000; font-weight: bold">return</span> result;
    }];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the last object in the array. If the array is empty, returns \c nil/</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">lastObject</span>
{
    <span style="color: #008000; font-weight: bold">var</span> count <span style="color: #666666">=</span> [<span style="color: #008000">self</span> count];
    
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>count) <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;
    
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>[count <span style="color: #666666">-</span> <span style="color: #666666">1</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the object at index \c anIndex.</span>
<span style="color: #408080; font-style: italic">    @throws CPRangeException if \c anIndex is out of bounds</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">objectAtIndex:</span>(<span style="color: #B00040">int</span>)anIndex
{
    <span style="color: #008000; font-weight: bold">if</span> (anIndex <span style="color: #666666">&gt;=</span> length <span style="color: #666666">||</span> anIndex <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span>)
        [CPException raise<span style="color: #666666">:</span>CPRangeException reason<span style="color: #666666">:</span><span style="color: #BA2121">@&quot;index (&quot;</span> <span style="color: #666666">+</span> anIndex <span style="color: #666666">+</span> <span style="color: #BA2121">@&quot;) beyond bounds (&quot;</span> <span style="color: #666666">+</span> length <span style="color: #666666">+</span> <span style="color: #BA2121">@&quot;)&quot;</span>];

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>[anIndex];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the objects at \c indexes in a new CPArray.</span>
<span style="color: #408080; font-style: italic">    @param indexes the set of indices</span>
<span style="color: #408080; font-style: italic">    @throws CPRangeException if any of the indices is greater than or equal to the length of the array</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">objectsAtIndexes:</span>(<span style="color: #B00040">CPIndexSet</span>)indexes
{
    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> CPNotFound,
        objects <span style="color: #666666">=</span> [];

    <span style="color: #008000; font-weight: bold">while</span>((index <span style="color: #666666">=</span> [indexes indexGreaterThanIndex<span style="color: #666666">:</span>index]) <span style="color: #666666">!==</span> CPNotFound)
        [objects addObject<span style="color: #666666">:</span>[<span style="color: #008000">self</span> objectAtIndex<span style="color: #666666">:</span>index]];

    <span style="color: #008000; font-weight: bold">return</span> objects;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns an enumerator describing the array sequentially</span>
<span style="color: #408080; font-style: italic">    from the first to the last element. You should not modify</span>
<span style="color: #408080; font-style: italic">    the array during enumeration.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPEnumerator</span>)<span style="color: #0000FF">objectEnumerator</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [[_CPArrayEnumerator alloc] initWithArray<span style="color: #666666">:</span><span style="color: #008000">self</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns an enumerator describing the array sequentially</span>
<span style="color: #408080; font-style: italic">    from the last to the first element. You should not modify</span>
<span style="color: #408080; font-style: italic">    the array during enumeration.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPEnumerator</span>)<span style="color: #0000FF">reverseObjectEnumerator</span>
{
    <span style="color: #008000; font-weight: bold">return</span> [[_CPReverseArrayEnumerator alloc] initWithArray<span style="color: #666666">:</span><span style="color: #008000">self</span>];
}

<span style="color: #408080; font-style: italic">// Sending messages to elements</span>
<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sends each element in the array a message.</span>
<span style="color: #408080; font-style: italic">    @param aSelector the selector of the message to send</span>
<span style="color: #408080; font-style: italic">    @throws CPInvalidArgumentException if \c aSelector is \c nil</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">makeObjectsPerformSelector:</span>(<span style="color: #B00040">SEL</span>)aSelector
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>aSelector)
        [CPException raise<span style="color: #666666">:</span>CPInvalidArgumentException reason<span style="color: #666666">:</span><span style="color: #BA2121">&quot;makeObjectsPerformSelector: &#39;aSelector&#39; can&#39;t be nil&quot;</span>];
    
    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>, 
        count <span style="color: #666666">=</span> length;
        
    <span style="color: #008000; font-weight: bold">for</span>(; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index)
        objj_msgSend(<span style="color: #008000">self</span>[index], aSelector);
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sends each element in the array a message with an argument.</span>
<span style="color: #408080; font-style: italic">    @param aSelector the selector of the message to send</span>
<span style="color: #408080; font-style: italic">    @param anObject the first argument of the message</span>
<span style="color: #408080; font-style: italic">    @throws CPInvalidArgumentException if \c aSelector is \c nil</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">makeObjectsPerformSelector:</span>(<span style="color: #B00040">SEL</span>)aSelector <span style="color: #0000FF">withObject:</span>(<span style="color: #B00040">id</span>)anObject
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>aSelector)
        [CPException raise<span style="color: #666666">:</span>CPInvalidArgumentException reason<span style="color: #666666">:</span><span style="color: #BA2121">&quot;makeObjectsPerformSelector:withObject &#39;aSelector&#39; can&#39;t be nil&quot;</span>];

    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>, 
        count <span style="color: #666666">=</span> length;
        
    <span style="color: #008000; font-weight: bold">for</span>(; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index) 
        objj_msgSend(<span style="color: #008000">self</span>[index], aSelector, anObject);
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">makeObjectsPerformSelector:</span>(<span style="color: #B00040">SEL</span>)aSelector <span style="color: #0000FF">withObjects:</span>(<span style="color: #B00040">CPArray</span>)objects
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>aSelector)
        [CPException raise<span style="color: #666666">:</span>CPInvalidArgumentException reason<span style="color: #666666">:</span><span style="color: #BA2121">&quot;makeObjectsPerformSelector:withObjects: &#39;aSelector&#39; can&#39;t be nil&quot;</span>];

    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
        count <span style="color: #666666">=</span> length,
        argumentsArray <span style="color: #666666">=</span> [<span style="color: #008000; font-weight: bold">nil</span>, aSelector].concat(objects <span style="color: #666666">||</span> []);

    <span style="color: #008000; font-weight: bold">for</span>(; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index)
    {
        argumentsArray[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span>[index];
        objj_msgSend.apply(<span style="color: #008000">this</span>, argumentsArray);
    }
}


<span style="color: #408080; font-style: italic">// Comparing arrays</span>
<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the first object found in the receiver (starting at index 0) which is present in the</span>
<span style="color: #408080; font-style: italic">    \c otherArray as determined by using the \c -containsObject: method.</span>
<span style="color: #408080; font-style: italic">    @return the first object found, or \c nil if no common object was found.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">firstObjectCommonWithArray:</span>(<span style="color: #B00040">CPArray</span>)anArray
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>[anArray count] <span style="color: #666666">||</span> <span style="color: #666666">!</span>[<span style="color: #008000">self</span> count])
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;
    
    <span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
        count <span style="color: #666666">=</span> [<span style="color: #008000">self</span> count];

    <span style="color: #008000; font-weight: bold">for</span>(; i <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>i)
        <span style="color: #008000; font-weight: bold">if</span>([anArray containsObject<span style="color: #666666">:</span><span style="color: #008000">self</span>[i]])
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>[i];

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">nil</span>;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns true if anArray contains exactly the same objects as the reciever.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">isEqualToArray:</span>(<span style="color: #B00040">id</span>)anArray
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span> <span style="color: #666666">===</span> anArray)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">YES</span>;
    
    <span style="color: #008000; font-weight: bold">if</span>(length <span style="color: #666666">!=</span> anArray.length)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">NO</span>;
    
    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
        count <span style="color: #666666">=</span> [<span style="color: #008000">self</span> count];
    
    <span style="color: #008000; font-weight: bold">for</span>(; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index)
    {
        <span style="color: #008000; font-weight: bold">var</span> lhs <span style="color: #666666">=</span> <span style="color: #008000">self</span>[index],
            rhs <span style="color: #666666">=</span> anArray[index];
        
        <span style="color: #408080; font-style: italic">// If they&#39;re not equal, and either doesn&#39;t have an isa, or they&#39;re !isEqual (not isEqual)</span>
        <span style="color: #008000; font-weight: bold">if</span> (lhs <span style="color: #666666">!==</span> rhs <span style="color: #666666">&amp;&amp;</span> (<span style="color: #666666">!</span>lhs.isa <span style="color: #666666">||</span> <span style="color: #666666">!</span>rhs.isa <span style="color: #666666">||</span> <span style="color: #666666">!</span>[lhs isEqual<span style="color: #666666">:</span>rhs]))
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">NO</span>;
    }
        
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">YES</span>;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">BOOL</span>)<span style="color: #0000FF">isEqual:</span>(<span style="color: #B00040">id</span>)anObject
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span> <span style="color: #666666">===</span> anObject)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">YES</span>;
    
    <span style="color: #008000; font-weight: bold">if</span>(<span style="color: #666666">!</span>[anObject isKindOfClass<span style="color: #666666">:</span>[CPArray class]])
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">NO</span>;

    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> isEqualToArray<span style="color: #666666">:</span>anObject];
}

<span style="color: #408080; font-style: italic">// Deriving new arrays</span>
<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns a copy of this array plus \c anObject inside the copy.</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to be added to the array copy</span>
<span style="color: #408080; font-style: italic">    @throws CPInvalidArgumentException if \c anObject is \c nil</span>
<span style="color: #408080; font-style: italic">    @return a new array that should be n+1 in size compared to the receiver.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">arrayByAddingObject:</span>(<span style="color: #B00040">id</span>)anObject
{
    <span style="color: #008000; font-weight: bold">if</span> (anObject <span style="color: #666666">===</span> <span style="color: #008000; font-weight: bold">nil</span> <span style="color: #666666">||</span> anObject <span style="color: #666666">===</span> <span style="color: #008000; font-weight: bold">undefined</span>)
        [CPException raise<span style="color: #666666">:</span>CPInvalidArgumentException
                    reason<span style="color: #666666">:</span><span style="color: #BA2121">&quot;arrayByAddingObject: object can&#39;t be nil&quot;</span>];

    <span style="color: #008000; font-weight: bold">var</span> array <span style="color: #666666">=</span> [<span style="color: #008000">self</span> copy];
    
    array.push(anObject);
    
    <span style="color: #008000; font-weight: bold">return</span> array;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns a new array which is the concatenation of \c self and otherArray (in this precise order).</span>
<span style="color: #408080; font-style: italic">    @param anArray the array that will be concatenated to the receiver&#39;s copy</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">arrayByAddingObjectsFromArray:</span>(<span style="color: #B00040">CPArray</span>)anArray
{
    <span style="color: #008000; font-weight: bold">return</span> slice(<span style="color: #666666">0</span>).concat(anArray);
}

<span style="color: #408080; font-style: italic">/*  </span>
<span style="color: #408080; font-style: italic">- (CPArray)filteredArrayUsingPredicate:(CPPredicate)aPredicate</span>
<span style="color: #408080; font-style: italic">{</span>
<span style="color: #408080; font-style: italic">    var i= 0, </span>
<span style="color: #408080; font-style: italic">        count = [self count],</span>
<span style="color: #408080; font-style: italic">        array = [CPArray array];</span>
<span style="color: #408080; font-style: italic">    </span>
<span style="color: #408080; font-style: italic">    for(; i&lt;count; ++i)</span>
<span style="color: #408080; font-style: italic">        if(aPredicate.evaluateWithObject(self[i]))</span>
<span style="color: #408080; font-style: italic">            array.push(self[i]);</span>
<span style="color: #408080; font-style: italic">    </span>
<span style="color: #408080; font-style: italic">    return array;</span>
<span style="color: #408080; font-style: italic">}</span>
<span style="color: #408080; font-style: italic">*/</span>

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns a subarray of the receiver containing the objects found in the specified range \c aRange.</span>
<span style="color: #408080; font-style: italic">    @param aRange the range of objects to be copied into the subarray</span>
<span style="color: #408080; font-style: italic">    @throws CPRangeException if the specified range exceeds the bounds of the array</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">subarrayWithRange:</span>(<span style="color: #B00040">CPRange</span>)aRange
{
    <span style="color: #008000; font-weight: bold">if</span> (aRange.location <span style="color: #666666">&lt;</span> <span style="color: #666666">0</span> <span style="color: #666666">||</span> CPMaxRange(aRange) <span style="color: #666666">&gt;</span> length)
        [CPException raise<span style="color: #666666">:</span>CPRangeException reason<span style="color: #666666">:</span><span style="color: #BA2121">&quot;subarrayWithRange: aRange out of bounds&quot;</span>];

    <span style="color: #008000; font-weight: bold">return</span> slice(aRange.location, CPMaxRange(aRange));
}

<span style="color: #408080; font-style: italic">// Sorting arrays</span>
<span style="color: #408080; font-style: italic">/*</span>
<span style="color: #408080; font-style: italic">    Not yet described.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">sortedArrayUsingDescriptors:</span>(<span style="color: #B00040">CPArray</span>)descriptors
{
    <span style="color: #008000; font-weight: bold">var</span> sorted <span style="color: #666666">=</span> [<span style="color: #008000">self</span> copy];
    
    [sorted sortUsingDescriptors<span style="color: #666666">:</span>descriptors];
    
    <span style="color: #008000; font-weight: bold">return</span> sorted;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Return a copy of the receiver sorted using the function passed into the first parameter.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">sortedArrayUsingFunction:</span>(<span style="color: #B00040">Function</span>)aFunction
{
    <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span> sortedArrayUsingFunction<span style="color: #666666">:</span>aFunction context<span style="color: #666666">:</span><span style="color: #008000; font-weight: bold">nil</span>];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns an array in which the objects are ordered according</span>
<span style="color: #408080; font-style: italic">    to a sort with \c aFunction. This invokes</span>
<span style="color: #408080; font-style: italic">    \c -sortUsingFunction:context.</span>
<span style="color: #408080; font-style: italic">    @param aFunction a JavaScript &#39;Function&#39; type that compares objects</span>
<span style="color: #408080; font-style: italic">    @param aContext context information</span>
<span style="color: #408080; font-style: italic">    @return a new sorted array</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">sortedArrayUsingFunction:</span>(<span style="color: #B00040">Function</span>)aFunction <span style="color: #0000FF">context:</span>(<span style="color: #B00040">id</span>)aContext
{
    <span style="color: #008000; font-weight: bold">var</span> sorted <span style="color: #666666">=</span> [<span style="color: #008000">self</span> copy];
    
    [sorted sortUsingFunction<span style="color: #666666">:</span>aFunction context<span style="color: #666666">:</span>aContext];
    
    <span style="color: #008000; font-weight: bold">return</span> sorted;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns a new array in which the objects are ordered according to a sort with \c aSelector.</span>
<span style="color: #408080; font-style: italic">    @param aSelector the selector that will perform object comparisons</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">sortedArrayUsingSelector:</span>(<span style="color: #B00040">SEL</span>)aSelector
{
    <span style="color: #008000; font-weight: bold">var</span> sorted <span style="color: #666666">=</span> [<span style="color: #008000">self</span> copy]
    
    [sorted sortUsingSelector<span style="color: #666666">:</span>aSelector];

    <span style="color: #008000; font-weight: bold">return</span> sorted;
}

<span style="color: #408080; font-style: italic">// Working with string elements</span>

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns a string formed by concatenating the objects in the</span>
<span style="color: #408080; font-style: italic">    receiver, with the specified separator string inserted between each part.</span>
<span style="color: #408080; font-style: italic">    If the element is a Objective-J object, then the \c -description</span>
<span style="color: #408080; font-style: italic">    of that object will be used, otherwise the default JavaScript representation will be used.</span>
<span style="color: #408080; font-style: italic">    @param aString the separator that will separate each object string</span>
<span style="color: #408080; font-style: italic">    @return the string representation of the array</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">componentsJoinedByString:</span>(<span style="color: #B00040">CPString</span>)aString
{
    <span style="color: #408080; font-style: italic">// Objective-J objects get &quot;description&quot; called on them automatically when coerced to strings</span>
    <span style="color: #408080; font-style: italic">// (see &quot;objj_object.prototype.toString&quot; at bottom of CPObject.j)</span>
    <span style="color: #008000; font-weight: bold">return</span> join(aString);
}

<span style="color: #408080; font-style: italic">// Creating a description of the array</span>

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns a human readable description of this array and it&#39;s elements.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPString</span>)<span style="color: #0000FF">description</span>
{
    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
        count <span style="color: #666666">=</span> [<span style="color: #008000">self</span> count],
        description <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;(&#39;</span>;

    <span style="color: #008000; font-weight: bold">for</span>(; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index)
    {
        <span style="color: #008000; font-weight: bold">if</span> (index <span style="color: #666666">===</span> <span style="color: #666666">0</span>)
            description <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39;\n&#39;</span>;

        <span style="color: #008000; font-weight: bold">var</span> object <span style="color: #666666">=</span> <span style="color: #008000">self</span>[index],
            objectDescription <span style="color: #666666">=</span> object <span style="color: #666666">&amp;&amp;</span> object.isa <span style="color: #666666">?</span> [object description] <span style="color: #666666">:</span> object <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&quot;</span>;

        description <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\t</span><span style="color: #BA2121">&quot;</span> <span style="color: #666666">+</span> objectDescription.split(<span style="color: #BA2121">&#39;\n&#39;</span>).join(<span style="color: #BA2121">&quot;</span><span style="color: #BB6622; font-weight: bold">\n\t</span><span style="color: #BA2121">&quot;</span>);

        <span style="color: #008000; font-weight: bold">if</span> (index <span style="color: #666666">!==</span> count <span style="color: #666666">-</span> <span style="color: #666666">1</span>)
            description <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;, &quot;</span>;

        description <span style="color: #666666">+=</span> <span style="color: #BA2121">&#39;\n&#39;</span>;
    }

    <span style="color: #008000; font-weight: bold">return</span> description <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;)&#39;</span>;
}

<span style="color: #408080; font-style: italic">// Collecting paths</span>
<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns a new array subset formed by selecting the elements that have</span>
<span style="color: #408080; font-style: italic">    filename extensions from \c filterTypes. Only elements</span>
<span style="color: #408080; font-style: italic">    that are of type CPString are candidates for inclusion in the returned array.</span>
<span style="color: #408080; font-style: italic">    @param filterTypes an array of CPString objects that contain file extensions (without the &#39;.&#39;)</span>
<span style="color: #408080; font-style: italic">    @return a new array with matching paths</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">pathsMatchingExtensions:</span>(<span style="color: #B00040">CPArray</span>)filterTypes
{
    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
        count <span style="color: #666666">=</span> [<span style="color: #008000">self</span> count],
        array <span style="color: #666666">=</span> [];
    
    <span style="color: #008000; font-weight: bold">for</span>(; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index)
        <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #008000">self</span>[index].isa <span style="color: #666666">&amp;&amp;</span> [<span style="color: #008000">self</span>[index] isKindOfClass<span style="color: #666666">:</span>[CPString class]] <span style="color: #666666">&amp;&amp;</span> [filterTypes containsObject<span style="color: #666666">:</span>[<span style="color: #008000">self</span>[index] pathExtension]])
            array.push(<span style="color: #008000">self</span>[index]);
    
    <span style="color: #008000; font-weight: bold">return</span> array;
}

<span style="color: #408080; font-style: italic">// Key value coding</span>
<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets the key-value for each element in the array.</span>
<span style="color: #408080; font-style: italic">    @param aValue the value for the coding</span>
<span style="color: #408080; font-style: italic">    @param aKey the key for the coding</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setValue:</span>(<span style="color: #B00040">id</span>)aValue <span style="color: #0000FF">forKey:</span>(<span style="color: #B00040">CPString</span>)aKey
{
    <span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
        count <span style="color: #666666">=</span> [<span style="color: #008000">self</span> count];
    
    <span style="color: #008000; font-weight: bold">for</span>(; i <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>i)
        [<span style="color: #008000">self</span>[i] setValue<span style="color: #666666">:</span>aValue forKey<span style="color: #666666">:</span>aKey];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Returns the value for \c aKey from each element in the array.</span>
<span style="color: #408080; font-style: italic">    @param aKey the key to return the value for</span>
<span style="color: #408080; font-style: italic">    @return an array of containing a value for each element in the array</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">valueForKey:</span>(<span style="color: #B00040">CPString</span>)aKey
{
    <span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
        count <span style="color: #666666">=</span> [<span style="color: #008000">self</span> count],
        array <span style="color: #666666">=</span> [];
    
    <span style="color: #008000; font-weight: bold">for</span>(; i <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>i)
        array.push([<span style="color: #008000">self</span>[i] valueForKey<span style="color: #666666">:</span>aKey]);
    
    <span style="color: #008000; font-weight: bold">return</span> array;
}

<span style="color: #408080; font-style: italic">// Copying arrays</span>

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Makes a copy of the receiver.</span>
<span style="color: #408080; font-style: italic">    @return a new CPArray copy</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">copy</span>
{
    <span style="color: #008000; font-weight: bold">return</span> slice(<span style="color: #666666">0</span>);
}
    
<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">CPArray</span>(<span style="color: #A0A000">CPMutableArray</span>)

<span style="color: #408080; font-style: italic">// Creating arrays</span>
<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Creates an array able to store at least  \c aCapacity</span>
<span style="color: #408080; font-style: italic">    items. Because CPArray is backed by JavaScript arrays,</span>
<span style="color: #408080; font-style: italic">    this method ends up simply returning a regular array.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">+</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">arrayWithCapacity:</span>(<span style="color: #B00040">unsigned</span>)aCapacity
{
    <span style="color: #008000; font-weight: bold">return</span> [[<span style="color: #008000">self</span> alloc] initWithCapacity<span style="color: #666666">:</span>aCapacity];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Initializes an array able to store at least \c aCapacity items. Because CPArray</span>
<span style="color: #408080; font-style: italic">    is backed by JavaScript arrays, this method ends up simply returning a regular array.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithCapacity:</span>(<span style="color: #B00040">unsigned</span>)aCapacity
{
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>;
}

<span style="color: #408080; font-style: italic">// Adding and replacing objects</span>
<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Adds \c anObject to the end of the array.</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to add to the array</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">addObject:</span>(<span style="color: #B00040">id</span>)anObject
{
    push(anObject);
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Adds the objects in \c anArray to the receiver array.</span>
<span style="color: #408080; font-style: italic">    @param anArray the array of objects to add to the end of the receiver</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">addObjectsFromArray:</span>(<span style="color: #B00040">CPArray</span>)anArray
{
    splice.apply(<span style="color: #008000">self</span>, [length, <span style="color: #666666">0</span>].concat(anArray));
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Inserts an object into the receiver at the specified location.</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to insert into the array</span>
<span style="color: #408080; font-style: italic">    @param anIndex the location to insert \c anObject at</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">insertObject:</span>(<span style="color: #B00040">id</span>)anObject <span style="color: #0000FF">atIndex:</span>(<span style="color: #B00040">int</span>)anIndex
{
    splice(anIndex, <span style="color: #666666">0</span>, anObject);
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Inserts the objects in the provided array into the receiver at the indexes specified.</span>
<span style="color: #408080; font-style: italic">    @param objects the objects to add to this array</span>
<span style="color: #408080; font-style: italic">    @param anIndexSet the indices for the objects</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">insertObjects:</span>(<span style="color: #B00040">CPArray</span>)objects <span style="color: #0000FF">atIndexes:</span>(<span style="color: #B00040">CPIndexSet</span>)indexes
{
    <span style="color: #008000; font-weight: bold">var</span> indexesCount <span style="color: #666666">=</span> [indexes count],
        objectsCount <span style="color: #666666">=</span> [objects count];
    
    <span style="color: #008000; font-weight: bold">if</span>(indexesCount <span style="color: #666666">!==</span> objectsCount)
        [CPException raise<span style="color: #666666">:</span>CPRangeException reason<span style="color: #666666">:</span><span style="color: #BA2121">&quot;the counts of the passed-in array (&quot;</span> <span style="color: #666666">+</span> objectsCount <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;) and index set (&quot;</span> <span style="color: #666666">+</span> indexesCount <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;) must be identical.&quot;</span>];
    
    <span style="color: #008000; font-weight: bold">var</span> lastIndex <span style="color: #666666">=</span> [indexes lastIndex];
    
    <span style="color: #008000; font-weight: bold">if</span>(lastIndex <span style="color: #666666">&gt;=</span> [<span style="color: #008000">self</span> count] <span style="color: #666666">+</span> indexesCount)
        [CPException raise<span style="color: #666666">:</span>CPRangeException reason<span style="color: #666666">:</span><span style="color: #BA2121">&quot;the last index (&quot;</span> <span style="color: #666666">+</span> lastIndex <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;) must be less than the sum of the original count (&quot;</span> <span style="color: #666666">+</span> [<span style="color: #008000">self</span> count] <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;) and the insertion count (&quot;</span> <span style="color: #666666">+</span> indexesCount <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;).&quot;</span>];    
    
    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
        currentIndex <span style="color: #666666">=</span> [indexes firstIndex];
 
    <span style="color: #008000; font-weight: bold">for</span> (; index <span style="color: #666666">&lt;</span> objectsCount; <span style="color: #666666">++</span>index, currentIndex <span style="color: #666666">=</span> [indexes indexGreaterThanIndex<span style="color: #666666">:</span>currentIndex])
        [<span style="color: #008000">self</span> insertObject<span style="color: #666666">:</span>objects[index] atIndex<span style="color: #666666">:</span>currentIndex];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Replaces the element at \c anIndex with \c anObject.</span>
<span style="color: #408080; font-style: italic">    The current element at position \c anIndex will be removed from the array.</span>
<span style="color: #408080; font-style: italic">    @param anIndex the position in the array to place \c anObject</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">replaceObjectAtIndex:</span>(<span style="color: #B00040">int</span>)anIndex <span style="color: #0000FF">withObject:</span>(<span style="color: #B00040">id</span>)anObject
{
    <span style="color: #008000">self</span>[anIndex] <span style="color: #666666">=</span> anObject;
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Replace the elements at the indices specified by \c anIndexSet with</span>
<span style="color: #408080; font-style: italic">    the objects in \c objects.</span>
<span style="color: #408080; font-style: italic">    @param anIndexSet the set of indices to array positions that will be replaced</span>
<span style="color: #408080; font-style: italic">    @param objects the array of objects to place in the specified indices</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">replaceObjectsAtIndexes:</span>(<span style="color: #B00040">CPIndexSet</span>)anIndexSet <span style="color: #0000FF">withObjects:</span>(<span style="color: #B00040">CPArray</span>)objects
{
    <span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">0</span>, 
        index <span style="color: #666666">=</span> [anIndexSet firstIndex];
   
    <span style="color: #008000; font-weight: bold">while</span>(index <span style="color: #666666">!=</span> CPNotFound)
    {
        [<span style="color: #008000">self</span> replaceObjectAtIndex<span style="color: #666666">:</span>index withObject<span style="color: #666666">:</span>objects[i<span style="color: #666666">++</span>]];
        index <span style="color: #666666">=</span> [anIndexSet indexGreaterThanIndex<span style="color: #666666">:</span>index];
    }
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Replaces some of the receiver&#39;s objects with objects from \c anArray. Specifically, the elements of the</span>
<span style="color: #408080; font-style: italic">    receiver in the range specified by \c aRange,</span>
<span style="color: #408080; font-style: italic">    with the elements of \c anArray in the range specified by \c otherRange.</span>
<span style="color: #408080; font-style: italic">    @param aRange the range of elements to be replaced in the receiver</span>
<span style="color: #408080; font-style: italic">    @param anArray the array to retrieve objects for placement into the receiver</span>
<span style="color: #408080; font-style: italic">    @param otherRange the range of objects in \c anArray to pull from for placement into the receiver</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">replaceObjectsInRange:</span>(<span style="color: #B00040">CPRange</span>)aRange <span style="color: #0000FF">withObjectsFromArray:</span>(<span style="color: #B00040">CPArray</span>)anArray <span style="color: #0000FF">range:</span>(<span style="color: #B00040">CPRange</span>)otherRange
{
    <span style="color: #008000; font-weight: bold">if</span> (<span style="color: #666666">!</span>otherRange.location <span style="color: #666666">&amp;&amp;</span> otherRange.length <span style="color: #666666">==</span> [anArray count])
        [<span style="color: #008000">self</span> replaceObjectsInRange<span style="color: #666666">:</span>aRange withObjectsFromArray<span style="color: #666666">:</span>anArray];
    <span style="color: #008000; font-weight: bold">else</span>
        splice.apply(<span style="color: #008000">self</span>, [aRange.location, aRange.length].concat([anArray subarrayWithRange<span style="color: #666666">:</span>otherRange]));
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Replaces some of the receiver&#39;s objects with the objects from</span>
<span style="color: #408080; font-style: italic">    \c anArray. Specifically, the elements of the</span>
<span style="color: #408080; font-style: italic">    receiver in the range specified by \c aRange.</span>
<span style="color: #408080; font-style: italic">    @param aRange the range of elements to be replaced in the receiver</span>
<span style="color: #408080; font-style: italic">    @param anArray the array to retrieve objects for placement into the receiver</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">replaceObjectsInRange:</span>(<span style="color: #B00040">CPRange</span>)aRange <span style="color: #0000FF">withObjectsFromArray:</span>(<span style="color: #B00040">CPArray</span>)anArray
{
    splice.apply(<span style="color: #008000">self</span>, [aRange.location, aRange.length].concat(anArray));
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sets the contents of the receiver to be identical to the contents of \c anArray.</span>
<span style="color: #408080; font-style: italic">    @param anArray the array of objects used to replace the receiver&#39;s objects</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">setArray:</span>(<span style="color: #B00040">CPArray</span>)anArray
{
    <span style="color: #008000; font-weight: bold">if</span>(<span style="color: #008000">self</span> <span style="color: #666666">==</span> anArray) <span style="color: #008000; font-weight: bold">return</span>;
    
    splice.apply(<span style="color: #008000">self</span>, [<span style="color: #666666">0</span>, length].concat(anArray));
}

<span style="color: #408080; font-style: italic">// Removing Objects</span>
<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Removes all objects from this array.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">removeAllObjects</span>
{
    splice(<span style="color: #666666">0</span>, length);
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Removes the last object from the array.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">removeLastObject</span>
{
    pop();
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Removes all entries of \c anObject from the array.</span>
<span style="color: #408080; font-style: italic">    @param anObject the object whose entries are to be removed</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">removeObject:</span>(<span style="color: #B00040">id</span>)anObject
{
    [<span style="color: #008000">self</span> removeObject<span style="color: #666666">:</span>anObject inRange<span style="color: #666666">:</span>CPMakeRange(<span style="color: #666666">0</span>, length)];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Removes all entries of \c anObject from the array, in the range specified by \c aRange.</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to remove</span>
<span style="color: #408080; font-style: italic">    @param aRange the range to search in the receiver for the object</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">removeObject:</span>(<span style="color: #B00040">id</span>)anObject <span style="color: #0000FF">inRange:</span>(<span style="color: #B00040">CPRange</span>)aRange
{
    <span style="color: #008000; font-weight: bold">var</span> index;
    
    <span style="color: #008000; font-weight: bold">while</span> ((index <span style="color: #666666">=</span> [<span style="color: #008000">self</span> indexOfObject<span style="color: #666666">:</span>anObject inRange<span style="color: #666666">:</span>aRange]) <span style="color: #666666">!=</span> CPNotFound)
    {
        [<span style="color: #008000">self</span> removeObjectAtIndex<span style="color: #666666">:</span>index];
        aRange <span style="color: #666666">=</span> CPIntersectionRange(CPMakeRange(index, length <span style="color: #666666">-</span> index), aRange);
    }
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Removes the object at \c anIndex.</span>
<span style="color: #408080; font-style: italic">    @param anIndex the location of the element to be removed</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">removeObjectAtIndex:</span>(<span style="color: #B00040">int</span>)anIndex
{
    splice(anIndex, <span style="color: #666666">1</span>);
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Removes the objects at the indices specified by \c CPIndexSet.</span>
<span style="color: #408080; font-style: italic">    @param anIndexSet the indices of the elements to be removed from the array</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">removeObjectsAtIndexes:</span>(<span style="color: #B00040">CPIndexSet</span>)anIndexSet
{
    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> [anIndexSet lastIndex];
   
    <span style="color: #008000; font-weight: bold">while</span> (index <span style="color: #666666">!=</span> CPNotFound)
    {
        [<span style="color: #008000">self</span> removeObjectAtIndex<span style="color: #666666">:</span>index];
        index <span style="color: #666666">=</span> [anIndexSet indexLessThanIndex<span style="color: #666666">:</span>index];
    }
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Remove the first instance of \c anObject from the array.</span>
<span style="color: #408080; font-style: italic">    The search for the object is done using \c ==.</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to remove</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">removeObjectIdenticalTo:</span>(<span style="color: #B00040">id</span>)anObject
{
    [<span style="color: #008000">self</span> removeObjectIdenticalTo<span style="color: #666666">:</span>anObject inRange<span style="color: #666666">:</span>CPMakeRange(<span style="color: #666666">0</span>, [<span style="color: #008000">self</span> count])];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Remove the first instance of \c anObject from the array,</span>
<span style="color: #408080; font-style: italic">    within the range specified by \c aRange.</span>
<span style="color: #408080; font-style: italic">    The search for the object is done using \c ==.</span>
<span style="color: #408080; font-style: italic">    @param anObject the object to remove</span>
<span style="color: #408080; font-style: italic">    @param aRange the range in the array to search for the object</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">removeObjectIdenticalTo:</span>(<span style="color: #B00040">id</span>)anObject <span style="color: #0000FF">inRange:</span>(<span style="color: #B00040">CPRange</span>)aRange
{
    <span style="color: #008000; font-weight: bold">var</span> index,
        count <span style="color: #666666">=</span> [<span style="color: #008000">self</span> count];
    
    <span style="color: #008000; font-weight: bold">while</span> ((index <span style="color: #666666">=</span> [<span style="color: #008000">self</span> indexOfObjectIdenticalTo<span style="color: #666666">:</span>anObject inRange<span style="color: #666666">:</span>aRange]) <span style="color: #666666">!==</span> CPNotFound)
    {
        [<span style="color: #008000">self</span> removeObjectAtIndex<span style="color: #666666">:</span>index];
        aRange <span style="color: #666666">=</span> CPIntersectionRange(CPMakeRange(index, (<span style="color: #666666">--</span>count) <span style="color: #666666">-</span> index), aRange);
    }
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Remove the objects in \c anArray from the receiver array.</span>
<span style="color: #408080; font-style: italic">    @param anArray the array of objects to remove from the receiver</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">removeObjectsInArray:</span>(<span style="color: #B00040">CPArray</span>)anArray
{
    <span style="color: #008000; font-weight: bold">var</span> index <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
        count <span style="color: #666666">=</span> [anArray count];
        
    <span style="color: #008000; font-weight: bold">for</span> (; index <span style="color: #666666">&lt;</span> count; <span style="color: #666666">++</span>index)
        [<span style="color: #008000">self</span> removeObject<span style="color: #666666">:</span>anArray[index]];
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Removes all the objects in the specified range from the receiver.</span>
<span style="color: #408080; font-style: italic">    @param aRange the range of objects to remove</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">removeObjectsInRange:</span>(<span style="color: #B00040">CPRange</span>)aRange
{
    splice(aRange.location, aRange.length);
}

<span style="color: #408080; font-style: italic">// Rearranging objects</span>
<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Swaps the elements at the two specified indices.</span>
<span style="color: #408080; font-style: italic">    @param anIndex the first index to swap from</span>
<span style="color: #408080; font-style: italic">    @param otherIndex the second index to swap from</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">exchangeObjectAtIndex:</span>(<span style="color: #B00040">unsigned</span>)anIndex <span style="color: #0000FF">withObjectAtIndex:</span>(<span style="color: #B00040">unsigned</span>)otherIndex
{
    <span style="color: #008000; font-weight: bold">var</span> temporary <span style="color: #666666">=</span> <span style="color: #008000">self</span>[anIndex];
    <span style="color: #008000">self</span>[anIndex] <span style="color: #666666">=</span> <span style="color: #008000">self</span>[otherIndex];
    <span style="color: #008000">self</span>[otherIndex] <span style="color: #666666">=</span> temporary;
}

<span style="color: #666666">-</span> (<span style="color: #B00040">CPArray</span>)<span style="color: #0000FF">sortUsingDescriptors:</span>(<span style="color: #B00040">CPArray</span>)descriptors
{
    sort(<span style="color: #008000; font-weight: bold">function</span>(lhs, rhs)
    {
        <span style="color: #008000; font-weight: bold">var</span> i <span style="color: #666666">=</span> <span style="color: #666666">0</span>,
            count <span style="color: #666666">=</span> [descriptors count],
            result <span style="color: #666666">=</span> CPOrderedSame;
        
        <span style="color: #008000; font-weight: bold">while</span>(i <span style="color: #666666">&lt;</span> count)
            <span style="color: #008000; font-weight: bold">if</span>((result <span style="color: #666666">=</span> [descriptors[i<span style="color: #666666">++</span>] compareObject<span style="color: #666666">:</span>lhs withObject<span style="color: #666666">:</span>rhs]) <span style="color: #666666">!=</span> CPOrderedSame)
                <span style="color: #008000; font-weight: bold">return</span> result;
        
        <span style="color: #008000; font-weight: bold">return</span> result;
    });
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sorts the receiver array using a JavaScript function as a comparator, and a specified context.</span>
<span style="color: #408080; font-style: italic">    @param aFunction a JavaScript function that will be called to compare objects</span>
<span style="color: #408080; font-style: italic">    @param aContext an object that will be passed to \c aFunction with comparison</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">sortUsingFunction:</span>(<span style="color: #B00040">Function</span>)aFunction <span style="color: #0000FF">context:</span>(<span style="color: #B00040">id</span>)aContext
{
    sort(<span style="color: #008000; font-weight: bold">function</span>(lhs, rhs) { <span style="color: #008000; font-weight: bold">return</span> aFunction(lhs, rhs, aContext); });
}

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    Sorts the receiver array using an Objective-J method as a comparator.</span>
<span style="color: #408080; font-style: italic">    @param aSelector the selector for the method to call for comparison</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">sortUsingSelector:</span>(<span style="color: #B00040">SEL</span>)aSelector
{
    sort(<span style="color: #008000; font-weight: bold">function</span>(lhs, rhs) { <span style="color: #008000; font-weight: bold">return</span> objj_msgSend(lhs, aSelector, rhs); });
}

<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">CPArray</span> (<span style="color: #A0A000">CPCoding</span>)

<span style="color: #666666">-</span> (<span style="color: #B00040">id</span>)<span style="color: #0000FF">initWithCoder:</span>(<span style="color: #B00040">CPCoder</span>)aCoder
{
    <span style="color: #008000; font-weight: bold">return</span> [aCoder decodeObjectForKey<span style="color: #666666">:</span><span style="color: #BA2121">@&quot;CP.objects&quot;</span>];
}

<span style="color: #666666">-</span> (<span style="color: #B00040">void</span>)<span style="color: #0000FF">encodeWithCoder:</span>(<span style="color: #B00040">CPCoder</span>)aCoder
{
    [aCoder _encodeArrayOfObjects<span style="color: #666666">:</span><span style="color: #008000">self</span> forKey<span style="color: #666666">:</span><span style="color: #BA2121">@&quot;CP.objects&quot;</span>];
}

<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #408080; font-style: italic">/*!</span>
<span style="color: #408080; font-style: italic">    @class CPMutableArray</span>
<span style="color: #408080; font-style: italic">    @ingroup compatability</span>

<span style="color: #408080; font-style: italic">    This class is just an empty subclass of CPArray.</span>
<span style="color: #408080; font-style: italic">    CPArray already implements mutable methods and</span>
<span style="color: #408080; font-style: italic">    this class only exists for source compatability.</span>
<span style="color: #408080; font-style: italic">*/</span>
<span style="color: #008000; font-weight: bold">@implementation</span> <span style="color: #0000FF; font-weight: bold">CPMutableArray</span> <span style="color: #666666">:</span> <span style="color: #0000FF; font-weight: bold">CPArray</span>

<span style="color: #008000; font-weight: bold">@end</span>

<span style="color: #008000">Array</span>.<span style="color: #008000; font-weight: bold">prototype</span>.isa <span style="color: #666666">=</span> CPArray;
[CPArray initialize];
</pre></div>
