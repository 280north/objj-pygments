<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=latin1">
  <style type="text/css">
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #808080 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0040D0 } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * preprocessor.js</span>
<span class="cm"> * Objective-J</span>
<span class="cm"> *</span>
<span class="cm"> * Created by Francisco Tolmasky.</span>
<span class="cm"> * Copyright 2008, 280 North, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This library is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU Lesser General Public</span>
<span class="cm"> * License as published by the Free Software Foundation; either</span>
<span class="cm"> * version 2.1 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This library is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<span class="cm"> * Lesser General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU Lesser General Public</span>
<span class="cm"> * License along with this library; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA</span>
<span class="cm"> */</span>

<span class="kd">var</span> <span class="nx">OBJJ_PREPROCESSOR_DEBUG_SYMBOLS</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">OBJJ_PREPROCESSOR_TYPE_SIGNATURES</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">objj_preprocess</span><span class="p">(</span><span class="cm">/*String*/</span> <span class="nx">aString</span><span class="p">,</span> <span class="cm">/*objj_bundle*/</span> <span class="nx">aBundle</span><span class="p">,</span> <span class="cm">/*objj_file*/</span> <span class="nx">aSourceFile</span><span class="p">,</span> <span class="cm">/*unsigned*/</span> <span class="nx">flags</span><span class="p">)</span> 
<span class="p">{</span>    
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">objj_preprocessor</span><span class="p">(</span><span class="nx">aString</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^#[^\n]+\n/</span><span class="p">,</span> <span class="s2">&quot;\n&quot;</span><span class="p">),</span> <span class="nx">aSourceFile</span><span class="p">,</span> <span class="nx">aBundle</span><span class="p">,</span> <span class="nx">flags</span><span class="p">).</span><span class="nx">fragments</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">anException</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">objj_exception_report</span><span class="p">(</span><span class="nx">anException</span><span class="p">,</span> <span class="nx">aSourceFile</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="p">[];</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">OBJJParseException</span>          <span class="o">=</span> <span class="s2">&quot;OBJJParseException&quot;</span><span class="p">,</span>
    <span class="nx">OBJJClassNotFoundException</span>  <span class="o">=</span> <span class="s2">&quot;OBJJClassNotFoundException&quot;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">TOKEN_ACCESSORS</span>         <span class="o">=</span> <span class="s2">&quot;accessors&quot;</span><span class="p">,</span>
    <span class="nx">TOKEN_CLASS</span>             <span class="o">=</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span>
    <span class="nx">TOKEN_END</span>               <span class="o">=</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
    <span class="nx">TOKEN_FUNCTION</span>          <span class="o">=</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
    <span class="nx">TOKEN_IMPLEMENTATION</span>    <span class="o">=</span> <span class="s2">&quot;implementation&quot;</span><span class="p">,</span>
    <span class="nx">TOKEN_IMPORT</span>            <span class="o">=</span> <span class="s2">&quot;import&quot;</span><span class="p">,</span>
    <span class="nx">TOKEN_NEW</span>               <span class="o">=</span> <span class="s2">&quot;new&quot;</span><span class="p">,</span>
    <span class="nx">TOKEN_SELECTOR</span>          <span class="o">=</span> <span class="s2">&quot;selector&quot;</span><span class="p">,</span>
    <span class="nx">TOKEN_SUPER</span>             <span class="o">=</span> <span class="s2">&quot;super&quot;</span><span class="p">,</span>
                            
    <span class="nx">TOKEN_EQUAL</span>             <span class="o">=</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_PLUS</span>              <span class="o">=</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_MINUS</span>             <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_COLON</span>             <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_COMMA</span>             <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_PERIOD</span>            <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_ASTERISK</span>          <span class="o">=</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_SEMICOLON</span>         <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_LESS_THAN</span>         <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_OPEN_BRACE</span>        <span class="o">=</span> <span class="s1">&#39;{&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_CLOSE_BRACE</span>       <span class="o">=</span> <span class="s1">&#39;}&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_GREATER_THAN</span>      <span class="o">=</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_OPEN_BRACKET</span>      <span class="o">=</span> <span class="s1">&#39;[&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_DOUBLE_QUOTE</span>      <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_PREPROCESSOR</span>      <span class="o">=</span> <span class="s1">&#39;@&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_CLOSE_BRACKET</span>     <span class="o">=</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_QUESTION_MARK</span>     <span class="o">=</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_OPEN_PARENTHESIS</span>  <span class="o">=</span> <span class="s1">&#39;(&#39;</span><span class="p">,</span>
    <span class="nx">TOKEN_CLOSE_PARENTHESIS</span> <span class="o">=</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span>
    
    <span class="nx">TOKEN_WHITESPACE</span>        <span class="o">=</span> <span class="sr">/^(?:(?:\s+$)|(?:\/(?:\/|\*)))/</span><span class="p">,</span>
    <span class="nx">TOKEN_NUMBER</span>            <span class="o">=</span> <span class="sr">/^[+-]?\d+(([.]\d+)*([eE][+-]?\d+))?$/</span><span class="p">,</span>
    <span class="nx">TOKEN_IDENTIFIER</span>        <span class="o">=</span> <span class="sr">/^[a-zA-Z_$](\w|$)*$/</span><span class="p">;</span>
    
<span class="err">#</span><span class="nx">define</span> <span class="nx">IS_WORD</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="o">/^</span><span class="err">\</span><span class="nx">w</span><span class="o">+</span><span class="nx">$</span><span class="o">/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span>

<span class="err">#</span><span class="nx">define</span> <span class="nx">IS_NOT_EMPTY</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">atoms</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span>
<span class="err">#</span><span class="nx">define</span> <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">atom</span><span class="p">)</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">atoms</span><span class="p">[</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">atoms</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">atom</span>

<span class="kd">var</span> <span class="nx">SUPER_CLASSES</span>           <span class="o">=</span> <span class="k">new</span> <span class="nx">objj_dictionary</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">OBJJ_CURRENT_BUNDLE</span>     <span class="o">=</span> <span class="nx">NULL</span><span class="p">;</span>

<span class="c1">// FIXME: Used fixed regex</span>
<span class="kd">var</span> <span class="nx">objj_lexer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aString</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_tokens</span> <span class="o">=</span> <span class="p">(</span><span class="nx">aString</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\/\/.*(\r|\n)?|\/\*(?:.|\n|\r)*?\*\/|\w+\b|[+-]?\d+(([.]\d+)*([eE][+-]?\d+))?|&quot;[^&quot;\\]*(\\[\s\S][^&quot;\\]*)*&quot;|&#39;[^&#39;\\]*(\\[\s\S][^&#39;\\]*)*&#39;|\s+|./g</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_context</span> <span class="o">=</span> <span class="p">[];</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">objj_lexer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_context</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">objj_lexer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_context</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">objj_lexer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peak</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">shouldSkipWhitespace</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">shouldSkipWhitespace</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
        
        <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_tokens</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="nx">objj_lexer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_tokens</span><span class="p">[</span><span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">_index</span><span class="p">];</span>
<span class="p">}</span>

<span class="nx">objj_lexer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">previous</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_tokens</span><span class="p">[</span><span class="o">--</span><span class="k">this</span><span class="p">.</span><span class="nx">_index</span><span class="p">];</span>
<span class="p">}</span>

<span class="nx">objj_lexer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">last</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">NULL</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_tokens</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="nx">objj_lexer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">shouldMoveBackwards</span><span class="p">)</span>
<span class="p">{</span>   
    <span class="kd">var</span> <span class="nx">token</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">shouldMoveBackwards</span><span class="p">)</span>
        <span class="k">while</span><span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">previous</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nx">TOKEN_WHITESPACE</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">token</span><span class="p">))</span> <span class="p">;</span>
    <span class="k">else</span>
        <span class="k">while</span><span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nx">TOKEN_WHITESPACE</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">token</span><span class="p">))</span> <span class="p">;</span>

    <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">objj_stringBuffer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">atoms</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>

<span class="nx">objj_stringBuffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">atoms</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">objj_stringBuffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">atoms</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>

<span class="nx">objj_stringBuffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">atoms</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">objj_preprocessor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aString</span><span class="p">,</span> <span class="nx">aSourceFile</span><span class="p">,</span> <span class="nx">aBundle</span><span class="p">,</span> <span class="nx">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_currentSelector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_currentClass</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_currentSuperClass</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_currentSuperMetaClass</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    
    <span class="k">this</span><span class="p">.</span><span class="nx">_file</span> <span class="o">=</span> <span class="nx">aSourceFile</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_fragments</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_preprocessed</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">objj_stringBuffer</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_tokens</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">objj_lexer</span><span class="p">(</span><span class="nx">aString</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_flags</span> <span class="o">=</span> <span class="nx">flags</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_bundle</span> <span class="o">=</span> <span class="nx">aBundle</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_classMethod</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    
    <span class="k">this</span><span class="p">.</span><span class="nx">preprocess</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_tokens</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preprocessed</span><span class="p">);</span>
    <span class="c1">//alert(this._preprocessed + &quot;&quot;);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fragment</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">objj_preprocessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fragments</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_fragments</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">objj_preprocessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">accessors</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tokens</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">(),</span>
        <span class="nx">attributes</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">!=</span> <span class="nx">TOKEN_OPEN_PARENTHESIS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">tokens</span><span class="p">.</span><span class="nx">previous</span><span class="p">();</span>
        
        <span class="k">return</span> <span class="nx">attributes</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">())</span> <span class="o">!=</span> <span class="nx">TOKEN_CLOSE_PARENTHESIS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">token</span><span class="p">,</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">IS_WORD</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
            <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** @property attribute name not valid.&quot;</span><span class="p">)));</span>

        <span class="k">if</span> <span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">())</span> <span class="o">==</span> <span class="nx">TOKEN_EQUAL</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">();</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">IS_WORD</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span>
                <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** @property attribute value not valid.&quot;</span><span class="p">)));</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;setter&quot;</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="o">!=</span> <span class="nx">TOKEN_COLON</span><span class="p">)</span>
                    <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** @property setter attribute requires argument with \&quot;:\&quot; at end of selector name.&quot;</span><span class="p">)));</span>
                
                <span class="nx">value</span> <span class="o">+=</span> <span class="s2">&quot;:&quot;</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nx">attributes</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_CLOSE_PARENTHESIS</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">!=</span> <span class="nx">TOKEN_COMMA</span><span class="p">)</span>
            <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Expected &#39;,&#39; or &#39;)&#39; in @property attribute list.&quot;</span><span class="p">)));</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="nx">attributes</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">objj_preprocessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">brackets</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="cm">/*objj_lexer*/</span> <span class="nx">tokens</span><span class="p">,</span> <span class="cm">/*objj_stringBuffer*/</span> <span class="nx">aStringBuffer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tuples</span> <span class="o">=</span> <span class="p">[];</span>
        
    <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">preprocess</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nx">tuples</span><span class="p">[</span><span class="nx">tuples</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]))</span> <span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">tuples</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">);</span>
        
        <span class="c1">// When we have an empty array literal ([]), tuples[0][0] will be an empty objj_stringBuffer</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="nx">tuples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
        
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">selector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">objj_stringBuffer</span><span class="p">();</span>
        <span class="c1">//alert(tuples[0][0].toString() + &quot;]&quot; );</span>
        <span class="c1">// The first two arguments are always the receiver and the selector.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tuples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">TOKEN_SUPER</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="s2">&quot;objj_msgSendSuper(&quot;</span><span class="p">);</span>
            <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="s2">&quot;{ receiver:self, super_class:&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_classMethod</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">_currentSuperMetaClass</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_currentSuperClass</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; }&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="s2">&quot;objj_msgSend(&quot;</span><span class="p">);</span>
            <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="nx">tuples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
        <span class="p">}</span>
        
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="nx">tuples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
        
        <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nx">count</span> <span class="o">=</span> <span class="nx">tuples</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
            <span class="nx">marg_list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">objj_stringBuffer</span><span class="p">();</span>
        
        <span class="k">for</span><span class="p">(;</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="o">++</span><span class="nx">index</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pair</span> <span class="o">=</span> <span class="nx">tuples</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
            
            <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">marg_list</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="p">}</span>
        
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="s2">&quot;, \&quot;&quot;</span><span class="p">);</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="nx">selector</span><span class="p">);</span> <span class="c1">// FIXME: sel_getUid(selector + &quot;&quot;) ?</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="s1">&#39;\&quot;&#39;</span><span class="p">);</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="nx">marg_list</span><span class="p">);</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">objj_preprocessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">directive</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">aStringBuffer</span><span class="p">,</span> <span class="nx">allowedDirectivesFlags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Grab the next token, preprocessor directives follow &#39;@&#39; immediately.</span>
    <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">aStringBuffer</span> <span class="o">?</span> <span class="nx">aStringBuffer</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">objj_stringBuffer</span><span class="p">(),</span>
        <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
            
    <span class="c1">// To provide compatibility with Objective-C files, we convert NSString literals into </span>
    <span class="c1">// toll-freed JavaScript/CPString strings.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="nx">TOKEN_DOUBLE_QUOTE</span><span class="p">)</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
    
    <span class="c1">// Currently we simply swallow forward declarations and only provide them to allow </span>
    <span class="c1">// compatibility with Objective-C files.</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_CLASS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">();</span>
        
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// @implementation Class implementations</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_IMPLEMENTATION</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">implementation</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span>

    <span class="c1">// @import</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_IMPORT</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_import</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>

    <span class="c1">// @selector</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_SELECTOR</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">selector</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span>
    
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_ACCESSORS</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">accessors</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">aStringBuffer</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">objj_preprocessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fragment</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">preprocessed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preprocessed</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
    
    <span class="c1">// But make sure it&#39;s not just all whitespace!</span>
    <span class="k">if</span> <span class="p">((</span><span class="sr">/[^\s]/</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">preprocessed</span><span class="p">))</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_fragments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fragment_create_code</span><span class="p">(</span><span class="nx">preprocessed</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bundle</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_file</span><span class="p">));</span>
    
    <span class="k">this</span><span class="p">.</span><span class="nx">_preprocessed</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">objj_preprocessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="cm">/*objj_stringBuffer*/</span> <span class="nx">aStringBuffer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">aStringBuffer</span><span class="p">,</span>
        <span class="nx">token</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="nx">category</span> <span class="o">=</span> <span class="nx">NO</span><span class="p">,</span>
        <span class="nx">class_name</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">(),</span>
        <span class="nx">superclass_name</span> <span class="o">=</span> <span class="s2">&quot;Nil&quot;</span><span class="p">,</span>

        <span class="nx">instance_methods</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">objj_stringBuffer</span><span class="p">(),</span>
        <span class="nx">class_methods</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">objj_stringBuffer</span><span class="p">();</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="sr">/^\w/</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">class_name</span><span class="p">))</span>
        <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Expected class name, found \&quot;&quot;</span> <span class="o">+</span> <span class="nx">class_name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;.&quot;</span><span class="p">)));</span>
    
    <span class="k">this</span><span class="p">.</span><span class="nx">_currentSuperClass</span> <span class="o">=</span> <span class="nx">NULL</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_currentSuperMetaClass</span> <span class="o">=</span> <span class="nx">NULL</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_currentClass</span> <span class="o">=</span> <span class="nx">class_name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_currentSelector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="c1">// If we reach an open parenthesis, we are declaring a category.</span>
    <span class="k">if</span><span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">())</span> <span class="o">==</span> <span class="nx">TOKEN_OPEN_PARENTHESIS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">();</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_CLOSE_PARENTHESIS</span><span class="p">)</span>
            <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Can&#39;t Have Empty Category Name for class \&quot;&quot;</span> <span class="o">+</span> <span class="nx">class_name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;.&quot;</span><span class="p">)));</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">TOKEN_CLOSE_PARENTHESIS</span><span class="p">)</span>
            <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Improper Category Definition for class \&quot;&quot;</span> <span class="o">+</span> <span class="nx">class_name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;.&quot;</span><span class="p">)));</span>
        
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;{\nvar the_class = objj_getClass(\&quot;&quot;</span> <span class="o">+</span> <span class="nx">class_name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;)\n&quot;</span><span class="p">);</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;if(!the_class) objj_exception_throw(new objj_exception(OBJJClassNotFoundException, \&quot;*** Could not find definition for class \\\&quot;&quot;</span> <span class="o">+</span> <span class="nx">class_name</span> <span class="o">+</span> <span class="s2">&quot;\\\&quot;\&quot;));\n&quot;</span><span class="p">);</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;var meta_class = the_class.isa;&quot;</span><span class="p">);</span>
        
        <span class="kd">var</span> <span class="nx">superclass_name</span> <span class="o">=</span> <span class="nx">dictionary_getValue</span><span class="p">(</span><span class="nx">SUPER_CLASSES</span><span class="p">,</span> <span class="nx">class_name</span><span class="p">);</span>

        <span class="c1">// FIXME: We should have a better solution for this case, although it&#39;s actually not much slower than the real case.</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">superclass_name</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_currentSuperClass</span> <span class="o">=</span> <span class="s2">&quot;objj_getClass(\&quot;&quot;</span> <span class="o">+</span> <span class="nx">class_name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;).super_class&quot;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_currentSuperMetaClass</span> <span class="o">=</span> <span class="s2">&quot;objj_getMetaClass(\&quot;&quot;</span> <span class="o">+</span> <span class="nx">class_name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;).super_class&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_currentSuperClass</span> <span class="o">=</span> <span class="s2">&quot;objj_getClass(\&quot;&quot;</span> <span class="o">+</span> <span class="nx">superclass_name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;)&quot;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_currentSuperMetaClass</span> <span class="o">=</span> <span class="s2">&quot;objj_getMeraClass(\&quot;&quot;</span> <span class="o">+</span> <span class="nx">superclass_name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;)&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">// If we reach a colon (&#39;:&#39;), then a superclass is being declared.</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_COLON</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">();</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">TOKEN_IDENTIFIER</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">token</span><span class="p">))</span>
                <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Expected class name, found \&quot;&quot;</span> <span class="o">+</span> <span class="nx">token</span> <span class="o">+</span> <span class="s2">&quot;\&quot;.&quot;</span><span class="p">)));</span>
            
            <span class="nx">superclass_name</span> <span class="o">=</span> <span class="nx">token</span><span class="p">;</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">_currentSuperClass</span> <span class="o">=</span> <span class="s2">&quot;objj_getClass(\&quot;&quot;</span> <span class="o">+</span> <span class="nx">superclass_name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;)&quot;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_currentSuperMetaClass</span> <span class="o">=</span> <span class="s2">&quot;objj_getMetaClass(\&quot;&quot;</span> <span class="o">+</span> <span class="nx">superclass_name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;)&quot;</span><span class="p">;</span>
            
            <span class="nx">dictionary_setValue</span><span class="p">(</span><span class="nx">SUPER_CLASSES</span><span class="p">,</span> <span class="nx">class_name</span><span class="p">,</span> <span class="nx">superclass_name</span><span class="p">);</span>

            <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;{var the_class = objj_allocateClassPair(&quot;</span> <span class="o">+</span> <span class="nx">superclass_name</span> <span class="o">+</span> <span class="s2">&quot;, \&quot;&quot;</span> <span class="o">+</span> <span class="nx">class_name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;),\nmeta_class = the_class.isa;&quot;</span><span class="p">);</span>
        
        <span class="c1">// If we are at an opening curly brace (&#39;{&#39;), then we have an ivar declaration.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_OPEN_BRACE</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ivar_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="nx">declaration</span> <span class="o">=</span> <span class="p">[],</span>
                
                <span class="nx">attributes</span><span class="p">,</span>
                <span class="nx">accessors</span> <span class="o">=</span> <span class="p">{};</span>
            
            <span class="k">while</span><span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span> <span class="o">!=</span> <span class="nx">TOKEN_CLOSE_BRACE</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_PREPROCESSOR</span><span class="p">)</span>
                    <span class="nx">attributes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>
                
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_SEMICOLON</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">ivar_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;class_addIvars(the_class, [&quot;</span><span class="p">);</span>
                    <span class="k">else</span>
                        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">);</span>
                    
                    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">declaration</span><span class="p">[</span><span class="nx">declaration</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
                    
                    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;new objj_ivar(\&quot;&quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;)&quot;</span><span class="p">);</span>
                    
                    <span class="nx">declaration</span> <span class="o">=</span> <span class="p">[];</span>
                    
                    <span class="k">if</span> <span class="p">(</span><span class="nx">attributes</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">accessors</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">;</span>
                        <span class="nx">attributes</span> <span class="o">=</span> <span class="nx">NULL</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span>
                    <span class="nx">declaration</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="c1">// If we have objects in our declaration, the user forgot a &#39;;&#39;.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">declaration</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
                <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Expected &#39;;&#39; in ivar declaration, found &#39;}&#39;.&quot;</span><span class="p">)));</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">ivar_count</span><span class="p">)</span>
                <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;]);\n&quot;</span><span class="p">);</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span>
                <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Expected &#39;}&#39;&quot;</span><span class="p">)));</span>
            
            <span class="k">for</span> <span class="p">(</span><span class="nx">ivar_name</span> <span class="k">in</span> <span class="nx">accessors</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">accessor</span> <span class="o">=</span> <span class="nx">accessors</span><span class="p">[</span><span class="nx">ivar_name</span><span class="p">],</span>
                    <span class="nx">property</span> <span class="o">=</span> <span class="nx">accessor</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">||</span> <span class="nx">ivar_name</span><span class="p">;</span>
                    
                <span class="c1">// getter</span>
                <span class="kd">var</span> <span class="nx">getterName</span> <span class="o">=</span> <span class="nx">accessor</span><span class="p">[</span><span class="s2">&quot;getter&quot;</span><span class="p">]</span> <span class="o">||</span> <span class="nx">property</span><span class="p">,</span>
                    <span class="nx">getterCode</span> <span class="o">=</span> <span class="s2">&quot;(id)&quot;</span> <span class="o">+</span> <span class="nx">getterName</span> <span class="o">+</span> <span class="s2">&quot;\n{\nreturn &quot;</span> <span class="o">+</span> <span class="nx">ivar_name</span> <span class="o">+</span> <span class="s2">&quot;;\n}&quot;</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">IS_NOT_EMPTY</span><span class="p">(</span><span class="nx">instance_methods</span><span class="p">))</span>
                    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">instance_methods</span><span class="p">,</span> <span class="s2">&quot;,\n&quot;</span><span class="p">);</span>
                
                <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">instance_methods</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_lexer</span><span class="p">(</span><span class="nx">getterCode</span><span class="p">)));</span>
                
                <span class="c1">// setter</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">accessor</span><span class="p">[</span><span class="s2">&quot;readonly&quot;</span><span class="p">])</span>
                    <span class="k">continue</span><span class="p">;</span>
                
                <span class="kd">var</span> <span class="nx">setterName</span> <span class="o">=</span> <span class="nx">accessor</span><span class="p">[</span><span class="s2">&quot;setter&quot;</span><span class="p">];</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">setterName</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">property</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="nx">setterName</span> <span class="o">=</span> <span class="p">(</span><span class="nx">start</span> <span class="o">?</span> <span class="s2">&quot;_&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;set&quot;</span> <span class="o">+</span> <span class="nx">property</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">property</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">;</span>
                <span class="p">}</span>
                
                <span class="kd">var</span> <span class="nx">setterCode</span> <span class="o">=</span> <span class="s2">&quot;(void)&quot;</span> <span class="o">+</span> <span class="nx">setterName</span> <span class="o">+</span> <span class="s2">&quot;(id)newValue\n{\n&quot;</span><span class="p">;</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="nx">accessor</span><span class="p">[</span><span class="s2">&quot;copy&quot;</span><span class="p">])</span>
                    <span class="nx">setterCode</span> <span class="o">+=</span> <span class="s2">&quot;if (&quot;</span> <span class="o">+</span> <span class="nx">ivar_name</span> <span class="o">+</span> <span class="s2">&quot; !== newValue)\n&quot;</span> <span class="o">+</span> <span class="nx">ivar_name</span> <span class="o">+</span> <span class="s2">&quot; = [newValue copy];\n}&quot;</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="nx">setterCode</span> <span class="o">+=</span> <span class="nx">ivar_name</span> <span class="o">+</span> <span class="s2">&quot; = newValue;\n}&quot;</span><span class="p">;</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="nx">IS_NOT_EMPTY</span><span class="p">(</span><span class="nx">instance_methods</span><span class="p">))</span>
                    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">instance_methods</span><span class="p">,</span> <span class="s2">&quot;,\n&quot;</span><span class="p">);</span>
                
                <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">instance_methods</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_lexer</span><span class="p">(</span><span class="nx">setterCode</span><span class="p">)));</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
            <span class="nx">tokens</span><span class="p">.</span><span class="nx">previous</span><span class="p">();</span>
        
        <span class="c1">// We must make a new class object for our class definition.</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;objj_registerClassPair(the_class);\n&quot;</span><span class="p">);</span>

        <span class="c1">// Add this class to the current bundle.</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;objj_addClassForBundle(the_class, objj_getBundleWithPath(OBJJ_CURRENT_BUNDLE.path));\n&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">while</span> <span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">()))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_PLUS</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_classMethod</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">IS_NOT_EMPTY</span><span class="p">(</span><span class="nx">class_methods</span><span class="p">))</span>
                <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">class_methods</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">);</span>
            
            <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">class_methods</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>
        <span class="p">}</span>
        
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_MINUS</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_classMethod</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">IS_NOT_EMPTY</span><span class="p">(</span><span class="nx">instance_methods</span><span class="p">))</span>
                <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">instance_methods</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">);</span>
            
            <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">instance_methods</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="nx">tokens</span><span class="p">));</span>
        <span class="p">}</span>
        
        <span class="c1">// Check if we&#39;ve reached @end...</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_PREPROCESSOR</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// The only preprocessor directive we should ever encounter at this point is @end.</span>
            <span class="k">if</span> <span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="o">==</span> <span class="nx">TOKEN_END</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
            
            <span class="k">else</span>
                <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Expected \&quot;@end\&quot;, found \&quot;@&quot;</span> <span class="o">+</span> <span class="nx">token</span> <span class="o">+</span> <span class="s2">&quot;\&quot;.&quot;</span><span class="p">)));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">IS_NOT_EMPTY</span><span class="p">(</span><span class="nx">instance_methods</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;class_addMethods(the_class, [&quot;</span><span class="p">);</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">instance_methods</span><span class="p">);</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;]);\n&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">IS_NOT_EMPTY</span><span class="p">(</span><span class="nx">class_methods</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;class_addMethods(meta_class, [&quot;</span><span class="p">);</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">class_methods</span><span class="p">);</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;]);\n&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_currentClass</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">objj_preprocessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_import</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tokens</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// The introduction of an import statement forces the creation of a code fragment.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fragment</span><span class="p">();</span>
    
    <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">(),</span>
        <span class="nx">isLocal</span> <span class="o">=</span> <span class="p">(</span><span class="nx">token</span> <span class="o">!=</span> <span class="nx">TOKEN_LESS_THAN</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_LESS_THAN</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span><span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span> <span class="o">!=</span> <span class="nx">TOKEN_GREATER_THAN</span><span class="p">)</span>
            <span class="nx">path</span> <span class="o">+=</span> <span class="nx">token</span><span class="p">;</span>
        
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span>
            <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Unterminated import statement.&quot;</span><span class="p">)));</span>
    <span class="p">}</span>
    
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="nx">TOKEN_DOUBLE_QUOTE</span><span class="p">)</span>
        <span class="nx">path</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">token</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
    
    <span class="k">else</span>
        <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Expecting &#39;&lt;&#39; or &#39;\&quot;&#39;, found \&quot;&quot;</span> <span class="o">+</span> <span class="nx">token</span> <span class="o">+</span> <span class="s2">&quot;\&quot;.&quot;</span><span class="p">)));</span>
    
    <span class="k">this</span><span class="p">.</span><span class="nx">_fragments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fragment_create_file</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nx">isLocal</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_file</span><span class="p">));</span>
<span class="p">}</span>

<span class="nx">objj_preprocessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tokens</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">objj_stringBuffer</span><span class="p">(),</span>
        <span class="nx">token</span><span class="p">,</span>
        <span class="nx">selector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="nx">parameters</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">types</span> <span class="o">=</span> <span class="p">[</span><span class="kc">null</span><span class="p">];</span>
    
    <span class="k">while</span><span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span> <span class="o">!=</span> <span class="nx">TOKEN_OPEN_BRACE</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_COLON</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

            <span class="c1">// Colons are part of the selector name</span>
            <span class="nx">selector</span> <span class="o">+=</span> <span class="nx">token</span><span class="p">;</span>
            
            <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">();</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_OPEN_PARENTHESIS</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Swallow parameter/return type.  Perhaps later we can use this for debugging?</span>
                <span class="k">while</span><span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span> <span class="o">!=</span> <span class="nx">TOKEN_CLOSE_PARENTHESIS</span><span class="p">)</span>
                    <span class="nx">type</span> <span class="o">+=</span> <span class="nx">token</span><span class="p">;</span>
    
                <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">();</span>
            <span class="p">}</span>
            
            <span class="c1">// Add the type. If it&#39;s empty, add null instead.</span>
            <span class="nx">types</span><span class="p">[</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>

            <span class="c1">// Since this follows a colon, this must be the parameter name.</span>
            <span class="nx">parameters</span><span class="p">[</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">token</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_OPEN_PARENTHESIS</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

            <span class="c1">// Since :( is handled above, this must be the return type, just swallow it.</span>
            <span class="k">while</span><span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span> <span class="o">!=</span> <span class="nx">TOKEN_CLOSE_PARENTHESIS</span><span class="p">)</span>
                <span class="nx">type</span> <span class="o">+=</span> <span class="nx">token</span><span class="p">;</span>

            <span class="c1">// types[0] is the return argument</span>
            <span class="nx">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="c1">// Argument list &quot;, ...&quot;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_COMMA</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// At this point, &quot;...&quot; MUST follow.</span>
            <span class="k">if</span> <span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">())</span> <span class="o">!=</span> <span class="nx">TOKEN_PERIOD</span> <span class="o">||</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">TOKEN_PERIOD</span> <span class="o">||</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">TOKEN_PERIOD</span><span class="p">)</span>
                <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Argument list expected after &#39;,&#39;.&quot;</span><span class="p">)));</span>
            
            <span class="c1">// FIXME: Shouldn&#39;t allow any more after this.</span>
        <span class="p">}</span>
        
        <span class="c1">// Build selector name.</span>
        <span class="k">else</span>
            <span class="nx">selector</span> <span class="o">+=</span> <span class="nx">token</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">count</span> <span class="o">=</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    
    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;new objj_method(sel_getUid(\&quot;&quot;</span><span class="p">);</span>
    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">selector</span><span class="p">);</span>
    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;\&quot;), function&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_currentSelector</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_flags</span> <span class="o">&amp;</span> <span class="nx">OBJJ_PREPROCESSOR_DEBUG_SYMBOLS</span><span class="p">)</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot; $&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">_currentClass</span> <span class="o">+</span> <span class="s2">&quot;__&quot;</span> <span class="o">+</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/:/g</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">));</span>
    
    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;(self, _cmd&quot;</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(;</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="o">++</span><span class="nx">index</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">);</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">[</span><span class="nx">index</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;)\n{ with(self)\n{&quot;</span><span class="p">);</span>
    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">preprocess</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nx">TOKEN_CLOSE_BRACE</span><span class="p">,</span> <span class="nx">TOKEN_OPEN_BRACE</span><span class="p">));</span>
    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;}\n}&quot;</span><span class="p">);</span>
    <span class="c1">// TODO: actually use OBJJ_PREPROCESSOR_TYPE_SIGNATURES flag instead of tying to OBJJ_PREPROCESSOR_DEBUG_SYMBOLS</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_flags</span> <span class="o">&amp;</span> <span class="nx">OBJJ_PREPROCESSOR_DEBUG_SYMBOLS</span><span class="p">)</span> <span class="c1">//OBJJ_PREPROCESSOR_TYPE_SIGNATURES)</span>
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">types</span><span class="p">));</span>
    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_currentSelector</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">objj_preprocessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">preprocess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="cm">/*objj_stringBuffer*/</span> <span class="nx">aStringBuffer</span><span class="p">,</span> <span class="nx">terminator</span><span class="p">,</span> <span class="nx">instigator</span><span class="p">,</span> <span class="nx">tuple</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">aStringBuffer</span> <span class="o">?</span> <span class="nx">aStringBuffer</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">objj_stringBuffer</span><span class="p">(),</span>
        <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">token</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">tuple</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">;</span>
        
        <span class="kd">var</span> <span class="nx">bracket</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">closures</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
    
    <span class="k">while</span> <span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">token</span> <span class="o">!=</span> <span class="nx">terminator</span><span class="p">)</span> <span class="o">||</span> <span class="nx">count</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">tuple</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Ignore :&#39;s the belong to tertiary operators (?:) </span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">TOKEN_QUESTION_MARK</span><span class="p">)</span>
                <span class="o">++</span><span class="nx">closures</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
            
            <span class="c1">// Ingore anything between { } and ()                </span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">TOKEN_OPEN_BRACE</span><span class="p">)</span>
                <span class="o">++</span><span class="nx">closures</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">TOKEN_CLOSE_BRACE</span><span class="p">)</span>
                <span class="o">--</span><span class="nx">closures</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">TOKEN_OPEN_PARENTHESIS</span><span class="p">)</span>
                <span class="o">++</span><span class="nx">closures</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">TOKEN_CLOSE_PARENTHESIS</span><span class="p">)</span>
                <span class="o">--</span><span class="nx">closures</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            
            <span class="c1">// If not in {} and not in () and this is a colon and we don&#39;t belong to a tertiary operator OR this is a closing bracket...</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">TOKEN_COLON</span> <span class="o">&amp;&amp;</span> <span class="nx">closures</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">--</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> 
                    <span class="p">(</span><span class="nx">bracket</span> <span class="o">=</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">TOKEN_CLOSE_BRACKET</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">closures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">closures</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">();</span> <span class="c1">// 1</span>
                
                <span class="c1">// If a bracket made us enter, go backwards skipping whitespace ([a b   ] allowed), </span>
                <span class="c1">// if not grab token immediately behind us ([a b  : c] not allowed</span>
                <span class="kd">var</span> <span class="nx">label</span> <span class="o">=</span> <span class="nx">bracket</span> <span class="o">?</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="o">:</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">previous</span><span class="p">(),</span>
                    <span class="nx">isEmptyLabel</span> <span class="o">=</span> <span class="nx">TOKEN_WHITESPACE</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">label</span><span class="p">);</span>
                
                <span class="c1">// The label must be an identifier, and preceded by whitespace, or whitespace itself (the &quot;empty label&quot;)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">isEmptyLabel</span> <span class="o">||</span> <span class="nx">TOKEN_IDENTIFIER</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">TOKEN_WHITESPACE</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">previous</span><span class="p">()))</span>
                <span class="p">{</span>
                    <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">();</span> <span class="c1">// 2</span>
                    
                    <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
                        <span class="nx">operatorCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
                        <span class="nx">isDoubleOperator</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    
                    <span class="c1">// unary or binary, still disables.</span>
                    <span class="c1">// + - + x is bad because it could be (+ - + x) or (a + - + x)</span>
                    <span class="c1">// the only good is unbroken chain</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">last</span> <span class="o">===</span> <span class="s1">&#39;+&#39;</span> <span class="o">||</span> <span class="nx">last</span> <span class="o">===</span> <span class="s1">&#39;-&#39;</span><span class="p">){</span><span class="c1">//alert(tokens.last())</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">previous</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">last</span><span class="p">)</span>
                            <span class="nx">operatorCheck</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                            <span class="nx">last</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
                            <span class="nx">isDoubleOperator</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">}}</span>
                        
                    <span class="nx">tokens</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span> <span class="c1">// 2</span>
                    
                    <span class="nx">tokens</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span> <span class="c1">// 1</span>
                    
                    <span class="c1">//alert(operatorCheck + &quot;operatorCheck for &quot; + label + &quot; and &quot; + last);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">operatorCheck</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
                    
                        <span class="c1">// &lt;)&gt; &lt;label&gt;&lt;:|]&gt;</span>
                        <span class="c1">// &lt;}&gt; &lt;label&gt;&lt;:|]&gt;</span>
                        <span class="c1">// &lt;]&gt; &lt;label&gt;&lt;:|]&gt;                        </span>
                        <span class="p">(</span><span class="o">!</span><span class="nx">isDoubleOperator</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">last</span> <span class="o">===</span> <span class="nx">TOKEN_CLOSE_BRACE</span><span class="p">))</span> <span class="o">||</span> 
                        
                        <span class="nx">last</span> <span class="o">===</span> <span class="nx">TOKEN_CLOSE_PARENTHESIS</span> <span class="o">||</span> <span class="nx">last</span> <span class="o">===</span> <span class="nx">TOKEN_CLOSE_BRACKET</span> <span class="o">||</span> 
                    
                    <span class="c1">// &lt;.&gt; label&lt;:|]&gt; --&gt; 5. label</span>
                    <span class="c1">// &lt;5&gt; label&lt;:|]&gt;</span>
                        <span class="nx">last</span> <span class="o">===</span> <span class="nx">TOKEN_PERIOD</span> <span class="o">||</span> <span class="nx">TOKEN_NUMBER</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">last</span><span class="p">)</span> <span class="o">||</span>
                        
                    <span class="c1">// &lt;string&gt; &lt;label&gt;&lt;:\]&gt;/</span>
                        <span class="nx">last</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">last</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;\&quot;&#39;</span> <span class="o">||</span> <span class="nx">last</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">last</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;\&#39;&#39;</span> <span class="o">||</span> 
                    
                    <span class="c1">// &lt;identifier-not&gt; &lt;label&gt;&lt;:|]&gt;</span>
                        <span class="nx">TOKEN_IDENTIFIER</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">last</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="sr">/^(new|return|case|var)$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">last</span><span class="p">)))</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">isEmptyLabel</span><span class="p">)</span>
                            <span class="nx">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">;</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                            <span class="nx">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">label</span><span class="p">;</span>
                        
                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bracket</span><span class="p">)</span>
                                <span class="nx">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span><span class="p">;</span>
                                
                            <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">atoms</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                    
                            <span class="k">while</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">atoms</span><span class="p">[</span><span class="nx">count</span><span class="o">--</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">label</span><span class="p">)</span> <span class="p">;</span>
                
                            <span class="nx">buffer</span><span class="p">.</span><span class="nx">atoms</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">count</span><span class="p">;</span>
                        <span class="p">}</span>
                        
                        <span class="k">return</span> <span class="o">!</span><span class="nx">bracket</span><span class="p">;</span>
                    <span class="p">}</span>
                
                    <span class="k">if</span> <span class="p">(</span><span class="nx">bracket</span><span class="p">)</span>
                        <span class="k">return</span> <span class="nx">NO</span><span class="p">;</span>
                <span class="p">}</span>
                
                <span class="nx">tokens</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span> <span class="c1">// 2</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="nx">bracket</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nx">NO</span><span class="p">;</span>    
            <span class="p">}</span>
            
            <span class="nx">closures</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MAX</span><span class="p">(</span><span class="nx">closures</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="nx">instigator</span><span class="p">)</span>
        <span class="p">{</span> 
            <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">instigator</span><span class="p">)</span>
                <span class="o">++</span><span class="nx">count</span><span class="p">;</span>
            
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">terminator</span><span class="p">)</span> 
                <span class="o">--</span><span class="nx">count</span><span class="p">;</span>    
        <span class="p">}</span>
        
        <span class="c1">// imports are deprecated in favor of @imort</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_IMPORT</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">objj_fprintf</span><span class="p">(</span><span class="nx">warning_stream</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_file</span><span class="p">.</span><span class="nx">path</span> <span class="o">+</span> <span class="s2">&quot;: import keyword is deprecated, use @import instead.&quot;</span><span class="p">);</span>
            
            <span class="k">this</span><span class="p">.</span><span class="nx">_import</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="c1">// Safari can&#39;t handle function declarations of the form function [name]([arguments]) { } </span>
        <span class="c1">// in evals.  It requires them to be in the form [name] = function([arguments]) { }.  So we </span>
        <span class="c1">// need to find these and fix them.</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">TOKEN_FUNCTION</span><span class="p">)</span>
        <span class="p">{</span><span class="c1">//if (window.p) alert(&quot;function&quot;);</span>
            <span class="kd">var</span> <span class="nx">accumulator</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        
            <span class="c1">// Following the function identifier we can either have an open parenthesis or an identifier:</span>
            <span class="k">while</span><span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span> <span class="o">!=</span> <span class="nx">TOKEN_OPEN_PARENTHESIS</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="sr">/^\w/</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">token</span><span class="p">))</span>
                <span class="nx">accumulator</span> <span class="o">+=</span> <span class="nx">token</span><span class="p">;</span>
            
            <span class="c1">// If the next token is an open parenthesis, we have a standard function and we don&#39;t have to </span>
            <span class="c1">// change it:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">TOKEN_OPEN_PARENTHESIS</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span> <span class="o">+</span> <span class="nx">accumulator</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span><span class="p">);</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="nx">tuple</span><span class="p">)</span>
                    <span class="o">++</span><span class="nx">closures</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="c1">// If it&#39;s not a parenthesis, we know we have a non-supported function declaration, so fix it:</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">token</span> <span class="o">+</span> <span class="s2">&quot;= function&quot;</span><span class="p">);</span>
            
<span class="err">#</span><span class="k">if</span> <span class="nx">FIREBUG</span>
                <span class="kd">var</span> <span class="nx">functionName</span> <span class="o">=</span> <span class="nx">token</span><span class="p">;</span>

                <span class="c1">// Skip everything until the next close parenthesis.</span>
                <span class="k">while</span><span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span> <span class="o">!=</span> <span class="nx">TOKEN_CLOSE_PARENTHESIS</span><span class="p">)</span>
                    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
                    
                <span class="c1">// Don&#39;t forget the last token!</span>
                <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
                
                <span class="c1">// Skip everything until the next open curly brace. </span>
                <span class="k">while</span><span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span> <span class="o">!=</span> <span class="nx">TOKEN_OPEN_BRACE</span><span class="p">)</span>
                    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="nx">tuple</span><span class="p">)</span>
                    <span class="o">++</span><span class="nx">closures</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                
                <span class="c1">// Place the open curly brace as well, and the function name</span>
                <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">token</span> <span class="o">+</span> <span class="s2">&quot;\n \&quot;__FIREBUG_FNAME__&quot;</span> <span class="o">+</span> <span class="nx">functionName</span> <span class="o">+</span> <span class="s2">&quot;\&quot;.length;\n&quot;</span><span class="p">);</span>
<span class="err">#</span><span class="nx">endif</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// If we reach an @ symbol, we are at a preprocessor directive.</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_PREPROCESSOR</span><span class="p">)</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span>
        
        <span class="c1">// If we reach a bracket, we will either be preprocessing a message send, a literal </span>
        <span class="c1">// array, or an array index.</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_OPEN_BRACKET</span><span class="p">)</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">brackets</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span>
                
        <span class="c1">// If not simply append the token.</span>
        <span class="k">else</span>
            <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// If we get this far and we&#39;re parsing an objj_msgSend (or array), then we have a problem.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tuple</span><span class="p">)</span>
        <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Expected &#39;]&#39; - Unterminated message send or array.&quot;</span><span class="p">)));</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">aStringBuffer</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">objj_preprocessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">selector</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">aStringBuffer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">aStringBuffer</span> <span class="o">?</span> <span class="nx">aStringBuffer</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">objj_stringBuffer</span><span class="p">();</span>
    
    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;sel_getUid(\&quot;&quot;</span><span class="p">);</span>
    
    <span class="c1">// Swallow open parenthesis.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">TOKEN_OPEN_PARENTHESIS</span><span class="p">)</span>
        <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Expected &#39;(&#39;&quot;</span><span class="p">)));</span>
    
    <span class="c1">// Eat leading whitespace</span>
    <span class="kd">var</span> <span class="nx">selector</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">();</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">selector</span> <span class="o">==</span> <span class="nx">TOKEN_CLOSE_PARENTHESIS</span><span class="p">)</span>
        <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Unexpected &#39;)&#39;, can&#39;t have empty @selector()&quot;</span><span class="p">)));</span>
    
    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">aStringBuffer</span><span class="p">,</span> <span class="nx">selector</span><span class="p">);</span>
    
    <span class="kd">var</span> <span class="nx">token</span><span class="p">,</span>
        <span class="nx">starting</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">((</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span> <span class="o">!=</span> <span class="nx">TOKEN_CLOSE_PARENTHESIS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">starting</span> <span class="o">&amp;&amp;</span> <span class="sr">/^\d+$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="sr">/^(\w|$|\:)/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">token</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="c1">// Only allow tail whitespace</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="sr">/\S/</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">token</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">skip_whitespace</span><span class="p">()</span> <span class="o">==</span> <span class="nx">TOKEN_CLOSE_PARENTHESIS</span><span class="p">)</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Unexpected whitespace in @selector().&quot;</span><span class="p">)));</span>
            <span class="k">else</span>
                <span class="nx">objj_exception_throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">objj_exception</span><span class="p">(</span><span class="nx">OBJJParseException</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error_message</span><span class="p">(</span><span class="s2">&quot;*** Illegal character &#39;&quot;</span> <span class="o">+</span> <span class="nx">token</span> <span class="o">+</span> <span class="s2">&quot;&#39; in @selector().&quot;</span><span class="p">)));</span>
        <span class="p">}</span>
        
        <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
        <span class="nx">starting</span> <span class="o">=</span> <span class="p">(</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">TOKEN_COLON</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="nx">CONCAT</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="s2">&quot;\&quot;)&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">aStringBuffer</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">objj_preprocessor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">error_message</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">errorMessage</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">errorMessage</span> <span class="o">+</span> <span class="s2">&quot; &lt;Context File: &quot;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">_file</span><span class="p">.</span><span class="nx">path</span> <span class="o">+</span>
                                <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_currentClass</span> <span class="o">?</span> <span class="s2">&quot; Class: &quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">_currentClass</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span>
                                <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_currentSelector</span> <span class="o">?</span> <span class="s2">&quot; Method: &quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">_currentSelector</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;&gt;&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</body>
</html>
