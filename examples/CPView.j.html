<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=latin1">
  <style type="text/css">
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #808080 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0040D0 } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * CPView.j</span>
<span class="cm"> * AppKit</span>
<span class="cm"> *</span>
<span class="cm"> * Created by Francisco Tolmasky.</span>
<span class="cm"> * Copyright 2008, 280 North, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This library is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU Lesser General Public</span>
<span class="cm"> * License as published by the Free Software Foundation; either</span>
<span class="cm"> * version 2.1 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This library is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<span class="cm"> * Lesser General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU Lesser General Public</span>
<span class="cm"> * License along with this library; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA</span>
<span class="cm"> */</span>

<span class="cp">@import</span> <span class="s2">&lt;Foundation/CPArray.j&gt;</span>
<span class="cp">@import</span> <span class="s2">&lt;Foundation/CPObjJRuntime.j&gt;</span>

<span class="cp">@import</span> <span class="s2">&quot;CGAffineTransform.j&quot;</span>
<span class="cp">@import</span> <span class="s2">&quot;CGGeometry.j&quot;</span>

<span class="cp">@import</span> <span class="s2">&quot;CPColor.j&quot;</span>
<span class="cp">@import</span> <span class="s2">&quot;CPGeometry.j&quot;</span>
<span class="cp">@import</span> <span class="s2">&quot;CPGraphicsContext.j&quot;</span>
<span class="cp">@import</span> <span class="s2">&quot;CPResponder.j&quot;</span>
<span class="cp">@import</span> <span class="s2">&quot;CPTheme.j&quot;</span>
<span class="cp">@import</span> <span class="s2">&quot;_CPDisplayServer.j&quot;</span>


<span class="cp">#include</span> <span class="s2">&quot;Platform/Platform.h&quot;</span>
<span class="cp">#include</span> <span class="s2">&quot;CoreGraphics/CGAffineTransform.h&quot;</span>
<span class="cp">#include</span> <span class="s2">&quot;CoreGraphics/CGGeometry.h&quot;</span>
<span class="cp">#include</span> <span class="s2">&quot;Platform/DOM/CPDOMDisplayServer.h&quot;</span>

<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    The default resizingMask, the view will not resize or reposition itself.</span>
<span class="cm">*/</span>
<span class="n">CPViewNotSizable</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    Allow for flexible space on the left hand side of the view.</span>
<span class="cm">*/</span>
<span class="n">CPViewMinXMargin</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    The view should grow and shrink horizontally with its parent view.</span>
<span class="cm">*/</span>
<span class="n">CPViewWidthSizable</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    Allow for flexible space to the right hand side of the view.</span>
<span class="cm">*/</span>
<span class="n">CPViewMaxXMargin</span>    <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    Allow for flexible space above the view.</span>
<span class="cm">*/</span>
<span class="n">CPViewMinYMargin</span>    <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    The view should grow and shrink vertically with its parent view.</span>
<span class="cm">*/</span>
<span class="n">CPViewHeightSizable</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    @global</span>
<span class="cm">    @group CPViewAutoresizingMasks</span>
<span class="cm">    Allow for flexible space below the view.</span>
<span class="cm">*/</span>
<span class="n">CPViewMaxYMargin</span>    <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="n">CPViewBoundsDidChangeNotification</span>   <span class="o">=</span> <span class="s">@&quot;CPViewBoundsDidChangeNotification&quot;</span><span class="p">;</span>
<span class="n">CPViewFrameDidChangeNotification</span>    <span class="o">=</span> <span class="s">@&quot;CPViewFrameDidChangeNotification&quot;</span><span class="p">;</span>

<span class="kd">var</span> <span class="n">CachedNotificationCenter</span>    <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
    <span class="n">CachedThemeAttributes</span>       <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>

<span class="cp">#if PLATFORM(DOM)</span>
<span class="kd">var</span> <span class="n">DOMElementPrototype</span>         <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
    
    <span class="n">BackgroundTrivialColor</span>              <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">BackgroundVerticalThreePartImage</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">BackgroundHorizontalThreePartImage</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">BackgroundNinePartImage</span>             <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="kd">var</span> <span class="n">CPViewFlags</span>                     <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
    <span class="n">CPViewHasCustomDrawRect</span>         <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">CPViewHasCustomLayoutSubviews</span>   <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/*! </span>
<span class="cm">    @ingroup appkit</span>
<span class="cm">    @class CPView</span>

<span class="cm">    &lt;p&gt;CPView is a class which provides facilities for drawing</span>
<span class="cm">    in a window and receiving events. It is the superclass of many of the visual</span>
<span class="cm">    elements of the GUI.&lt;/p&gt;</span>

<span class="cm">    &lt;p&gt;In order to display itself, a view must be placed in a window (represented by an</span>
<span class="cm">    CPWindow object). Within the window is a hierarchy of CPViews,</span>
<span class="cm">    headed by the window&#39;s content view. Every other view in a window is a descendant</span>
<span class="cm">    of this view.&lt;/p&gt;</span>

<span class="cm">    &lt;p&gt;Subclasses can override \c -drawRect: in order to implement their</span>
<span class="cm">    appearance. Other methods of CPView and CPResponder can</span>
<span class="cm">    also be overridden to handle user generated events.</span>
<span class="cm">*/</span>
<span class="k">@implementation</span> <span class="nc">CPView</span> <span class="o">:</span> <span class="nc">CPResponder</span>
<span class="p">{</span>
    <span class="n">CPWindow</span>            <span class="n">_window</span><span class="p">;</span>
    
    <span class="n">CPView</span>              <span class="n">_superview</span><span class="p">;</span>
    <span class="n">CPArray</span>             <span class="n">_subviews</span><span class="p">;</span>
    
    <span class="n">CPGraphicsContext</span>   <span class="n">_graphicsContext</span><span class="p">;</span>
    
    <span class="kt">int</span>                 <span class="n">_tag</span><span class="p">;</span>
    
    <span class="n">CGRect</span>              <span class="n">_frame</span><span class="p">;</span>
    <span class="n">CGRect</span>              <span class="n">_bounds</span><span class="p">;</span>
    <span class="n">CGAffineTransform</span>   <span class="n">_boundsTransform</span><span class="p">;</span>
    <span class="n">CGAffineTransform</span>   <span class="n">_inverseBoundsTransform</span><span class="p">;</span>
    
    <span class="n">CPSet</span>               <span class="n">_registeredDraggedTypes</span><span class="p">;</span>
    <span class="n">CPArray</span>             <span class="n">_registeredDraggedTypesArray</span><span class="p">;</span>
    
    <span class="kt">BOOL</span>                <span class="n">_isHidden</span><span class="p">;</span>
    <span class="kt">BOOL</span>                <span class="n">_hitTests</span><span class="p">;</span>
    
    <span class="kt">BOOL</span>                <span class="n">_postsFrameChangedNotifications</span><span class="p">;</span>
    <span class="kt">BOOL</span>                <span class="n">_postsBoundsChangedNotifications</span><span class="p">;</span>
    <span class="kt">BOOL</span>                <span class="n">_inhibitFrameAndBoundsChangedNotifications</span><span class="p">;</span>
    
<span class="cp">#if PLATFORM(DOM)</span>
    <span class="n">DOMElement</span>          <span class="n">_DOMElement</span><span class="p">;</span>
    <span class="n">DOMElement</span>          <span class="n">_DOMContentsElement</span><span class="p">;</span>
    
    <span class="n">CPArray</span>             <span class="n">_DOMImageParts</span><span class="p">;</span>
    <span class="n">CPArray</span>             <span class="n">_DOMImageSizes</span><span class="p">;</span>
    
    <span class="kt">unsigned</span>            <span class="n">_backgroundType</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="n">CGRect</span>              <span class="n">_dirtyRect</span><span class="p">;</span>

    <span class="kt">float</span>               <span class="n">_opacity</span><span class="p">;</span>
    <span class="n">CPColor</span>             <span class="n">_backgroundColor</span><span class="p">;</span>

    <span class="kt">BOOL</span>                <span class="n">_autoresizesSubviews</span><span class="p">;</span>
    <span class="kt">unsigned</span>            <span class="n">_autoresizingMask</span><span class="p">;</span>
    
    <span class="n">CALayer</span>             <span class="n">_layer</span><span class="p">;</span>
    <span class="kt">BOOL</span>                <span class="n">_wantsLayer</span><span class="p">;</span>
    
    <span class="c1">// Full Screen State</span>
    <span class="kt">BOOL</span>                <span class="n">_isInFullScreenMode</span><span class="p">;</span>
    
    <span class="n">_CPViewFullScreenModeState</span>  <span class="n">_fullScreenModeState</span><span class="p">;</span>
    
    <span class="c1">// Layout Support</span>
    <span class="kt">BOOL</span>                <span class="n">_needsLayout</span><span class="p">;</span>
    <span class="n">JSObject</span>            <span class="n">_ephemeralSubviews</span><span class="p">;</span>
    
    <span class="c1">// Theming Support</span>
    <span class="n">CPTheme</span>             <span class="n">_theme</span><span class="p">;</span>
    <span class="n">JSObject</span>            <span class="n">_themeAttributes</span><span class="p">;</span>
    <span class="kt">unsigned</span>            <span class="n">_themeState</span><span class="p">;</span>

    <span class="n">JSObject</span>            <span class="n">_ephemeralSubviewsForNames</span><span class="p">;</span>
    <span class="n">CPSet</span>               <span class="n">_ephereralSubviews</span><span class="p">;</span>

    <span class="c1">// Key View Support</span>
    <span class="n">CPView</span>              <span class="n">_nextKeyView</span><span class="p">;</span>
    <span class="n">CPView</span>              <span class="n">_previousKeyView</span><span class="p">;</span>

    <span class="kt">unsigned</span>            <span class="n">_viewClassFlags</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">    Private method for Objective-J.</span>
<span class="cm">    @ignore</span>
<span class="cm">*/</span><span class="o">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">initialize</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span> <span class="o">!==</span> <span class="p">[</span><span class="n">CPView</span> <span class="n">class</span><span class="p">])</span>
        <span class="k">return</span><span class="p">;</span>

<span class="cp">#if PLATFORM(DOM)</span>
    <span class="n">DOMElementPrototype</span> <span class="o">=</span>  <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="s">&quot;div&quot;</span><span class="p">);</span>
    
    <span class="kd">var</span> <span class="n">style</span> <span class="o">=</span> <span class="n">DOMElementPrototype</span><span class="p">.</span><span class="n">style</span><span class="p">;</span>
    
    <span class="n">style</span><span class="p">.</span><span class="n">overflow</span> <span class="o">=</span> <span class="s">&quot;hidden&quot;</span><span class="p">;</span>
    <span class="n">style</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="s">&quot;absolute&quot;</span><span class="p">;</span>
    <span class="n">style</span><span class="p">.</span><span class="n">visibility</span> <span class="o">=</span> <span class="s">&quot;visible&quot;</span><span class="p">;</span>
    <span class="n">style</span><span class="p">.</span><span class="n">zIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="n">CachedNotificationCenter</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setupViewFlags</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">theClass</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">class</span><span class="p">],</span>
        <span class="n">classUID</span> <span class="o">=</span> <span class="p">[</span><span class="n">theClass</span> <span class="n">UID</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">CPViewFlags</span><span class="p">[</span><span class="n">classUID</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">([</span><span class="n">theClass</span> <span class="n">instanceMethodForSelector</span><span class="o">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">drawRect</span><span class="o">:</span><span class="p">)]</span> <span class="o">!==</span> <span class="p">[</span><span class="n">CPView</span> <span class="n">instanceMethodForSelector</span><span class="o">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">drawRect</span><span class="o">:</span><span class="p">)])</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">CPViewHasCustomDrawRect</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">([</span><span class="n">theClass</span> <span class="n">instanceMethodForSelector</span><span class="o">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">layoutSubviews</span><span class="p">)]</span> <span class="o">!==</span> <span class="p">[</span><span class="n">CPView</span> <span class="n">instanceMethodForSelector</span><span class="o">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">layoutSubviews</span><span class="p">)])</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">CPViewHasCustomLayoutSubviews</span><span class="p">;</span>

        <span class="n">CPViewFlags</span><span class="p">[</span><span class="n">classUID</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">_viewClassFlags</span> <span class="o">=</span> <span class="n">CPViewFlags</span><span class="p">[</span><span class="n">classUID</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">+</span> <span class="p">(</span><span class="kt">CPSet</span><span class="p">)</span><span class="nf">keyPathsForValuesAffectingFrame</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">CPSet</span> <span class="n">setWithObjects</span><span class="o">:</span><span class="s">@&quot;frameOrigin&quot;</span><span class="p">,</span> <span class="s">@&quot;frameSize&quot;</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">+</span> <span class="p">(</span><span class="kt">CPSet</span><span class="p">)</span><span class="nf">keyPathsForValuesAffectingBounds</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">CPSet</span> <span class="n">setWithObjects</span><span class="o">:</span><span class="s">@&quot;boundsOrigin&quot;</span><span class="p">,</span> <span class="s">@&quot;boundsSize&quot;</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">init</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">self</span> <span class="n">initWithFrame</span><span class="o">:</span><span class="nf">CGRectMakeZero</span><span class="p">()];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Initializes the receiver for usage with the specified bounding rectangle</span>
<span class="cm">    @return the initialized view</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithFrame:</span><span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span>aFrame
<span class="p">{</span>
    <span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">width</span> <span class="o">=</span> <span class="nf">_CGRectGetWidth</span><span class="p">(</span><span class="n">aFrame</span><span class="p">),</span>
            <span class="n">height</span> <span class="o">=</span> <span class="nf">_CGRectGetHeight</span><span class="p">(</span><span class="n">aFrame</span><span class="p">);</span>
        
        <span class="n">_subviews</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="n">_registeredDraggedTypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPSet</span> <span class="n">set</span><span class="p">];</span>
        <span class="n">_registeredDraggedTypesArray</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="n">_tag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="n">_frame</span> <span class="o">=</span> <span class="nf">_CGRectMakeCopy</span><span class="p">(</span><span class="n">aFrame</span><span class="p">);</span>
        <span class="n">_bounds</span> <span class="o">=</span> <span class="nf">_CGRectMake</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

        <span class="n">_autoresizingMask</span> <span class="o">=</span> <span class="n">CPViewNotSizable</span><span class="p">;</span>
        <span class="n">_autoresizesSubviews</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">;</span>
    
        <span class="n">_opacity</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
        <span class="n">_isHidden</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>
        <span class="n">_hitTests</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">;</span>

<span class="cp">#if PLATFORM(DOM)</span>
        <span class="n">_DOMElement</span> <span class="o">=</span> <span class="n">DOMElementPrototype</span><span class="p">.</span><span class="nf">cloneNode</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

        <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="n">aFrame</span><span class="p">),</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="n">aFrame</span><span class="p">));</span>
        <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
        
        <span class="n">_DOMImageParts</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="n">_DOMImageSizes</span> <span class="o">=</span> <span class="p">[];</span>
<span class="cp">#endif</span>
        
        <span class="n">_theme</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPTheme</span> <span class="n">defaultTheme</span><span class="p">];</span>
        <span class="n">_themeState</span> <span class="o">=</span> <span class="n">CPThemeStateNormal</span><span class="p">;</span>

        <span class="p">[</span><span class="nb">self</span> <span class="n">setupViewFlags</span><span class="p">];</span>

        <span class="p">[</span><span class="nb">self</span> <span class="n">_loadThemeAttributes</span><span class="p">];</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the container view of the receiver</span>
<span class="cm">    @return the receiver&#39;s containing view</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CPView</span><span class="p">)</span><span class="nf">superview</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_superview</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns an array of all the views contained as direct children of the receiver</span>
<span class="cm">    @return an array of CPViews</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CPArray</span><span class="p">)</span><span class="nf">subviews</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">_subviews</span> <span class="n">copy</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the window containing this receiver</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CPWindow</span><span class="p">)</span><span class="nf">window</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_window</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Makes the argument a subview of the receiver.</span>
<span class="cm">    @param aSubview the CPView to make a subview</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addSubview:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aSubview
<span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">_insertSubview</span><span class="o">:</span><span class="n">aSubview</span> <span class="n">atIndex</span><span class="o">:</span><span class="n">CPNotFound</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Makes \c aSubview a subview of the receiver. It is positioned relative to \c anotherView</span>
<span class="cm">    @param aSubview the view to add as a subview</span>
<span class="cm">    @param anOrderingMode specifies \c aSubview&#39;s ordering relative to \c anotherView</span>
<span class="cm">    @param anotherView \c aSubview will be positioned relative to this argument</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addSubview:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aSubview <span class="nf">positioned:</span><span class="p">(</span><span class="kt">CPWindowOrderingMode</span><span class="p">)</span>anOrderingMode <span class="nf">relativeTo:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>anotherView
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">index</span> <span class="o">=</span> <span class="n">anotherView</span> <span class="o">?</span> <span class="p">[</span><span class="n">_subviews</span> <span class="n">indexOfObjectIdenticalTo</span><span class="o">:</span><span class="n">anotherView</span><span class="p">]</span> <span class="o">:</span> <span class="n">CPNotFound</span><span class="p">;</span>
    
    <span class="c1">// In other words, if no view, then either all the way at the bottom or all the way at the top.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">===</span> <span class="n">CPNotFound</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">anOrderingMode</span> <span class="o">===</span> <span class="n">CPWindowAbove</span><span class="p">)</span> <span class="o">?</span> <span class="p">[</span><span class="n">_subviews</span> <span class="n">count</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="c1">// else, if we have a view, above if above.</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">anOrderingMode</span> <span class="o">===</span> <span class="n">CPWindowAbove</span><span class="p">)</span>
        <span class="o">++</span><span class="n">index</span><span class="p">;</span>
        
    <span class="p">[</span><span class="nb">self</span> <span class="n">_insertSubview</span><span class="o">:</span><span class="n">aSubview</span> <span class="n">atIndex</span><span class="o">:</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* @ignore */</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">_insertSubview:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aSubview <span class="nf">atIndex:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>anIndex
<span class="p">{</span>
    <span class="c1">// We will have to adjust the z-index of all views starting at this index.</span>
    <span class="kd">var</span> <span class="n">count</span> <span class="o">=</span> <span class="n">_subviews</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

    <span class="c1">// dirty the key view loop, in case the window wants to auto recalculate it</span>
    <span class="p">[[</span><span class="nb">self</span> <span class="nb">window</span><span class="p">]</span> <span class="n">_dirtyKeyViewLoop</span><span class="p">];</span>

    <span class="c1">// If this is already one of our subviews, remove it.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aSubview</span><span class="p">.</span><span class="n">_superview</span> <span class="o">==</span> <span class="nb">self</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">_subviews</span> <span class="n">indexOfObjectIdenticalTo</span><span class="o">:</span><span class="n">aSubview</span><span class="p">];</span>
        
        <span class="c1">// FIXME: should this be anIndex &gt;= count? (last one)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">===</span> <span class="n">anIndex</span> <span class="o">||</span> <span class="n">index</span> <span class="o">===</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">anIndex</span> <span class="o">===</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>
        
        <span class="p">[</span><span class="n">_subviews</span> <span class="n">removeObjectAtIndex</span><span class="o">:</span><span class="n">index</span><span class="p">];</span>
        
<span class="cp">#if PLATFORM(DOM)</span>
        <span class="nf">CPDOMDisplayServerRemoveChild</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">aSubview</span><span class="p">.</span><span class="n">_DOMElement</span><span class="p">);</span>
<span class="cp">#endif</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">anIndex</span> <span class="o">&gt;</span> <span class="n">index</span><span class="p">)</span>
            <span class="o">--</span><span class="n">anIndex</span><span class="p">;</span>
        
        <span class="c1">//We&#39;ve effectively made the subviews array shorter, so represent that.</span>
        <span class="o">--</span><span class="n">count</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">// Remove the view from its previous superview.</span>
        <span class="p">[</span><span class="n">aSubview</span> <span class="n">removeFromSuperview</span><span class="p">];</span>

        <span class="c1">// Set the subview&#39;s window to our own. </span>
        <span class="p">[</span><span class="n">aSubview</span> <span class="n">_setWindow</span><span class="o">:</span><span class="n">_window</span><span class="p">];</span>

        <span class="c1">// Notify the subview that it will be moving.</span>
        <span class="p">[</span><span class="n">aSubview</span> <span class="n">viewWillMoveToSuperview</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
    
        <span class="c1">// Set ourselves as the superview.</span>
        <span class="n">aSubview</span><span class="p">.</span><span class="n">_superview</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">anIndex</span> <span class="o">===</span> <span class="n">CPNotFound</span> <span class="o">||</span> <span class="n">anIndex</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_subviews</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">aSubview</span><span class="p">);</span>

<span class="cp">#if PLATFORM(DOM)</span>
        <span class="c1">// Attach the actual node.</span>
        <span class="nf">CPDOMDisplayServerAppendChild</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">aSubview</span><span class="p">.</span><span class="n">_DOMElement</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">_subviews</span><span class="p">.</span><span class="nf">splice</span><span class="p">(</span><span class="n">anIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aSubview</span><span class="p">);</span>
    
<span class="cp">#if PLATFORM(DOM)</span>
        <span class="c1">// Attach the actual node.</span>
        <span class="nf">CPDOMDisplayServerInsertBefore</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">aSubview</span><span class="p">.</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">_subviews</span><span class="p">[</span><span class="n">anIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">_DOMElement</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
    
    <span class="p">[</span><span class="n">aSubview</span> <span class="n">setNextResponder</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
    <span class="p">[</span><span class="n">aSubview</span> <span class="n">viewDidMoveToSuperview</span><span class="p">];</span>
    
    <span class="p">[</span><span class="nb">self</span> <span class="n">didAddSubview</span><span class="o">:</span><span class="n">aSubview</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Called when the receiver has added \c aSubview to it&#39;s child views.</span>
<span class="cm">    @param aSubview the view that was added</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didAddSubview:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aSubview
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Removes the receiver from it&#39;s container view and window.</span>
<span class="cm">    Does nothing if there&#39;s no container view.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">removeFromSuperview</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_superview</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="c1">// dirty the key view loop, in case the window wants to auto recalculate it</span>
    <span class="p">[[</span><span class="nb">self</span> <span class="nb">window</span><span class="p">]</span> <span class="n">_dirtyKeyViewLoop</span><span class="p">];</span>

    <span class="p">[</span><span class="n">_superview</span> <span class="n">willRemoveSubview</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">_superview</span><span class="p">.</span><span class="n">_subviews</span> <span class="n">removeObject</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>

<span class="cp">#if PLATFORM(DOM)</span>
        <span class="nf">CPDOMDisplayServerRemoveChild</span><span class="p">(</span><span class="n">_superview</span><span class="p">.</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">_DOMElement</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="n">_superview</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>
    
    <span class="p">[</span><span class="nb">self</span> <span class="n">_setWindow</span><span class="o">:</span><span class="kc">nil</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Replaces the specified child view with another view</span>
<span class="cm">    @param aSubview the view to replace</span>
<span class="cm">    @param aView the replacement view</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">replaceSubview:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aSubview <span class="nf">with:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aView
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aSubview</span><span class="p">.</span><span class="n">_superview</span> <span class="o">!=</span> <span class="nb">self</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="kd">var</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">_subviews</span> <span class="n">indexOfObjectIdenticalTo</span><span class="o">:</span><span class="n">aSubview</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">aSubview</span> <span class="n">removeFromSuperview</span><span class="p">];</span>
    
    <span class="p">[</span><span class="nb">self</span> <span class="n">_insertSubview</span><span class="o">:</span><span class="n">aView</span> <span class="n">atIndex</span><span class="o">:</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setSubviews:</span><span class="p">(</span><span class="kt">CPArray</span><span class="p">)</span>newSubviews
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newSubviews</span><span class="p">)</span>
        <span class="p">[</span><span class="n">CPException</span> <span class="n">raise</span><span class="o">:</span><span class="n">CPInvalidArgumentException</span> <span class="n">reason</span><span class="o">:</span><span class="s">&quot;newSubviews cannot be nil in -[CPView setSubviews:]&quot;</span><span class="p">];</span>

    <span class="c1">// Trivial Case 0: Same array somehow</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">_subviews</span> <span class="n">isEqual</span><span class="o">:</span><span class="n">newSubviews</span><span class="p">])</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="c1">// Trivial Case 1: No current subviews, simply add all new subviews.</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">_subviews</span> <span class="n">count</span><span class="p">]</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">count</span> <span class="o">=</span> <span class="p">[</span><span class="n">newSubviews</span> <span class="n">count</span><span class="p">];</span>

        <span class="k">for</span> <span class="p">(;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">index</span><span class="p">)</span>
            <span class="p">[</span><span class="nb">self</span> <span class="n">addSubview</span><span class="o">:</span><span class="n">newSubviews</span><span class="p">[</span><span class="n">index</span><span class="p">]];</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Trivial Case 2: No new subviews, simply remove all current subviews.</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">newSubviews</span> <span class="n">count</span><span class="p">]</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">count</span> <span class="o">=</span> <span class="p">[</span><span class="n">_subviews</span> <span class="n">count</span><span class="p">];</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
            <span class="p">[</span><span class="n">_subviews</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="n">removeFromSuperview</span><span class="p">];</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Find out the views that were removed.</span>
    <span class="kd">var</span> <span class="n">removedSubviews</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPMutableSet</span> <span class="n">setWithArray</span><span class="o">:</span><span class="n">_subviews</span><span class="p">];</span>

    <span class="p">[</span><span class="n">removedSubviews</span> <span class="n">removeObjectsInArray</span><span class="o">:</span><span class="n">newSubviews</span><span class="p">];</span>
    <span class="p">[</span><span class="n">removedSubviews</span> <span class="n">makeObjectsPerformSelector</span><span class="o">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">removeFromSuperview</span><span class="p">)];</span>

    <span class="c1">// Find out which views need to be added.</span>
    <span class="kd">var</span> <span class="n">addedSubviews</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPMutableSet</span> <span class="n">setWithArray</span><span class="o">:</span><span class="n">newSubviews</span><span class="p">];</span>

    <span class="p">[</span><span class="n">addedSubviews</span> <span class="n">removeObjectsInArray</span><span class="o">:</span><span class="n">_subviews</span><span class="p">];</span>

    <span class="kd">var</span> <span class="n">addedSubview</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
        <span class="n">addedSubviewEnumerator</span> <span class="o">=</span> <span class="p">[</span><span class="n">addedSubviews</span> <span class="n">objectEnumerator</span><span class="p">];</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">addedSubview</span> <span class="o">=</span> <span class="p">[</span><span class="n">addedSubviewEnumerator</span> <span class="n">nextObject</span><span class="p">])</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">addSubview</span><span class="o">:</span><span class="n">addedSubview</span><span class="p">];</span>

    <span class="c1">// If the order is fine, no need to reorder.</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">_subviews</span> <span class="n">isEqual</span><span class="o">:</span><span class="n">newSubviews</span><span class="p">])</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">_subviews</span> <span class="o">=</span> <span class="p">[</span><span class="n">newSubviews</span> <span class="n">copy</span><span class="p">];</span>

    <span class="kd">var</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">count</span> <span class="o">=</span> <span class="p">[</span><span class="n">_subviews</span> <span class="n">count</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">index</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">subview</span> <span class="o">=</span> <span class="n">_subviews</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

        <span class="nf">CPDOMDisplayServerRemoveChild</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">subview</span><span class="p">.</span><span class="n">_DOMElement</span><span class="p">);</span>
        <span class="nf">CPDOMDisplayServerAppendChild</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">subview</span><span class="p">.</span><span class="n">_DOMElement</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* @ignore */</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">_setWindow:</span><span class="p">(</span><span class="kt">CPWindow</span><span class="p">)</span>aWindow
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_window</span> <span class="o">===</span> <span class="n">aWindow</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="p">[[</span><span class="nb">self</span> <span class="nb">window</span><span class="p">]</span> <span class="n">_dirtyKeyViewLoop</span><span class="p">];</span>

    <span class="c1">// Clear out first responder if we&#39;re the first responder and leaving.</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">_window</span> <span class="n">firstResponder</span><span class="p">]</span> <span class="o">===</span> <span class="nb">self</span><span class="p">)</span>
        <span class="p">[</span><span class="n">_window</span> <span class="n">makeFirstResponder</span><span class="o">:</span><span class="kc">nil</span><span class="p">];</span>

    <span class="c1">// Notify the view and its subviews</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">viewWillMoveToWindow</span><span class="o">:</span><span class="n">aWindow</span><span class="p">];</span>

    <span class="c1">// Unregister the drag events from the current window and register</span>
    <span class="c1">// them in the new window.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_registeredDraggedTypes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">_window</span> <span class="n">_noteUnregisteredDraggedTypes</span><span class="o">:</span><span class="n">_registeredDraggedTypes</span><span class="p">];</span>
        <span class="p">[</span><span class="n">aWindow</span> <span class="n">_noteRegisteredDraggedTypes</span><span class="o">:</span><span class="n">_registeredDraggedTypes</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="n">_window</span> <span class="o">=</span> <span class="n">aWindow</span><span class="p">;</span>

    <span class="kd">var</span> <span class="n">count</span> <span class="o">=</span> <span class="p">[</span><span class="n">_subviews</span> <span class="n">count</span><span class="p">];</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
        <span class="p">[</span><span class="n">_subviews</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="n">_setWindow</span><span class="o">:</span><span class="n">aWindow</span><span class="p">];</span>
    
    <span class="p">[</span><span class="nb">self</span> <span class="n">viewDidMoveToWindow</span><span class="p">];</span>

    <span class="p">[[</span><span class="nb">self</span> <span class="nb">window</span><span class="p">]</span> <span class="n">_dirtyKeyViewLoop</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver is, or is a descendant of, \c aView.</span>
<span class="cm">    @param aView the view to test for ancestry</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isDescendantOf:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aView
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">view</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
    
    <span class="k">do</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">view</span> <span class="o">==</span> <span class="n">aView</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">view</span> <span class="o">=</span> <span class="p">[</span><span class="n">view</span> <span class="n">superview</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Called when the receiver&#39;s superview has changed.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidMoveToSuperview</span>
<span class="p">{</span>
<span class="c1">//    if (_graphicsContext)</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsDisplay</span><span class="o">:</span><span class="kc">YES</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Called when the receiver has been moved to a new CPWindow.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidMoveToWindow</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Called when the receiver is about to be moved to a new view.</span>
<span class="cm">    @param aView the view to which the receiver will be moved</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewWillMoveToSuperview:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aView
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Called when the receiver is about to be moved to a new window.</span>
<span class="cm">    @param aWindow the window to which the receiver will be moved.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewWillMoveToWindow:</span><span class="p">(</span><span class="kt">CPWindow</span><span class="p">)</span>aWindow
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Called when the receiver is about to be remove one of its subviews.</span>
<span class="cm">    @param aView the view that will be removed</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">willRemoveSubview:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aView
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the menu item containing the receiver or one of its ancestor views.</span>
<span class="cm">    @return a menu item, or \c nil if the view or one of its ancestors wasn&#39;t found</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CPMenuItem</span><span class="p">)</span><span class="nf">enclosingMenuItem</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">view</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="n">view</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="n">view</span> <span class="n">isKindOfClass</span><span class="o">:</span><span class="p">[</span><span class="n">_CPMenuItemView</span> <span class="n">class</span><span class="p">]])</span>
        <span class="n">view</span> <span class="o">=</span> <span class="p">[</span><span class="n">view</span> <span class="n">superview</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">view</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">view</span><span class="p">.</span><span class="n">_menuItem</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="kc">nil</span><span class="p">;</span>
<span class="cm">/*    var view = self,</span>
<span class="cm">        enclosingMenuItem = _enclosingMenuItem;</span>
<span class="cm">    </span>
<span class="cm">    while (!enclosingMenuItem &amp;&amp; (view = view._enclosingMenuItem))</span>
<span class="cm">        view = [view superview];</span>
<span class="cm">    </span>
<span class="cm">    return enclosingMenuItem;*/</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setTag:</span><span class="p">(</span><span class="kt">CPInteger</span><span class="p">)</span>aTag
<span class="p">{</span>
    <span class="n">_tag</span> <span class="o">=</span> <span class="n">aTag</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CPInteger</span><span class="p">)</span><span class="nf">tag</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_tag</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewWithTag:</span><span class="p">(</span><span class="kt">CPInteger</span><span class="p">)</span>aTag
<span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="nb">self</span> <span class="n">tag</span><span class="p">]</span> <span class="o">==</span> <span class="n">aTag</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>

    <span class="kd">var</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">_subviews</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">index</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">view</span> <span class="o">=</span> <span class="p">[</span><span class="n">_subviews</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">viewWithTag</span><span class="o">:</span><span class="n">aTag</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">view</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">view</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns whether the view is flipped.</span>
<span class="cm">    @return \c YES if the view is flipped. \c NO, otherwise.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isFlipped</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the frame size of the receiver to the dimensions and origin of the provided rectangle in the coordinate system</span>
<span class="cm">    of the superview. The method also posts an CPViewFrameDidChangeNotification to the notification</span>
<span class="cm">    center if the receiver is configured to do so. If the frame is the same as the current frame, the method simply</span>
<span class="cm">    returns (and no notificaion is posted).</span>
<span class="cm">    @param aFrame the rectangle specifying the new origin and size  of the receiver</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setFrame:</span><span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span>aFrame
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectEqualToRect</span><span class="p">(</span><span class="n">_frame</span><span class="p">,</span> <span class="n">aFrame</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>
        
    <span class="n">_inhibitFrameAndBoundsChangedNotifications</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">;</span>
    
    <span class="p">[</span><span class="nb">self</span> <span class="n">setFrameOrigin</span><span class="o">:</span><span class="n">aFrame</span><span class="p">.</span><span class="n">origin</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">setFrameSize</span><span class="o">:</span><span class="n">aFrame</span><span class="p">.</span><span class="n">size</span><span class="p">];</span>

    <span class="n">_inhibitFrameAndBoundsChangedNotifications</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_postsFrameChangedNotifications</span><span class="p">)</span>
        <span class="p">[</span><span class="n">CachedNotificationCenter</span> <span class="n">postNotificationName</span><span class="o">:</span><span class="n">CPViewFrameDidChangeNotification</span> <span class="n">object</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the receiver&#39;s frame.</span>
<span class="cm">    @return a copy of the receiver&#39;s frame</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span><span class="nf">frame</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">_CGRectMakeCopy</span><span class="p">(</span><span class="n">_frame</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span><span class="nf">frameOrigin</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">_CGPointMakeCopy</span><span class="p">(</span><span class="n">_frame</span><span class="p">.</span><span class="n">origin</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CGSize</span><span class="p">)</span><span class="nf">frameSize</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">_CGSizeMakeCopy</span><span class="p">(</span><span class="n">_frame</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Moves the center of the receiver&#39;s frame to the provided point. The point is defined in the superview&#39;s coordinate system. </span>
<span class="cm">    The method posts a CPViewFrameDidChangeNotification to the default notification center if the receiver </span>
<span class="cm">    is configured to do so. If the specified origin is the same as the frame&#39;s current origin, the method will </span>
<span class="cm">    simply return (and no notification will be posted).</span>
<span class="cm">    @param aPoint the new origin point</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setCenter:</span><span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span>aPoint
<span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">setFrameOrigin</span><span class="o">:</span><span class="nf">CGPointMake</span><span class="p">(</span><span class="n">aPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">_frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">aPoint</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">_frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)];</span> 
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the center of the receiver&#39;s frame to the provided point. The point is defined in the superview&#39;s coordinate system. </span>
<span class="cm">    @return CGPoint the center point of the receiver&#39;s frame</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span><span class="nf">center</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGPointMake</span><span class="p">(</span><span class="n">_frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">_frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">_frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">_frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the receiver&#39;s frame origin to the provided point. The point is defined in the superview&#39;s coordinate system. </span>
<span class="cm">    The method posts a CPViewFrameDidChangeNotification to the default notification center if the receiver </span>
<span class="cm">    is configured to do so. If the specified origin is the same as the frame&#39;s current origin, the method will </span>
<span class="cm">    simply return (and no notification will be posted).</span>
<span class="cm">    @param aPoint the new origin point</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setFrameOrigin:</span><span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span>aPoint
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">origin</span> <span class="o">=</span> <span class="n">_frame</span><span class="p">.</span><span class="n">origin</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aPoint</span> <span class="o">||</span> <span class="nf">_CGPointEqualToPoint</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">aPoint</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">aPoint</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">aPoint</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_postsFrameChangedNotifications</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_inhibitFrameAndBoundsChangedNotifications</span><span class="p">)</span>
        <span class="p">[</span><span class="n">CachedNotificationCenter</span> <span class="n">postNotificationName</span><span class="o">:</span><span class="n">CPViewFrameDidChangeNotification</span> <span class="n">object</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>

<span class="cp">#if PLATFORM(DOM)</span>
    <span class="kd">var</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">_superview</span> <span class="o">?</span> <span class="n">_superview</span><span class="p">.</span><span class="n">_boundsTransform</span> <span class="o">:</span> <span class="kc">NULL</span><span class="p">;</span>

    <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the receiver&#39;s frame size. If \c aSize is the same as the frame&#39;s current dimensions, this</span>
<span class="cm">    method simply returns. The method posts a CPViewFrameDidChangeNotification to the</span>
<span class="cm">    default notification center if the receiver is configured to do so.</span>
<span class="cm">    @param aSize the new size for the frame</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setFrameSize:</span><span class="p">(</span><span class="kt">CGSize</span><span class="p">)</span>aSize
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">size</span> <span class="o">=</span> <span class="n">_frame</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aSize</span> <span class="o">||</span> <span class="nf">_CGSizeEqualToSize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">aSize</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="n">oldSize</span> <span class="o">=</span> <span class="nf">_CGSizeMakeCopy</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

    <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">aSize</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
    <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">aSize</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="kc">YES</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">aSize</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
        <span class="n">_bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">aSize</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_layer</span><span class="p">)</span>
        <span class="p">[</span><span class="n">_layer</span> <span class="n">_owningViewBoundsChanged</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_autoresizesSubviews</span><span class="p">)</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">resizeSubviewsWithOldSize</span><span class="o">:</span><span class="n">oldSize</span><span class="p">];</span>
    
    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsLayout</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsDisplay</span><span class="o">:</span><span class="kc">YES</span><span class="p">];</span>

<span class="cp">#if PLATFORM(DOM)</span>
    <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_DOMContentsElement</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">CPDOMDisplayServerSetSize</span><span class="p">(</span><span class="n">_DOMContentsElement</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
        <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMContentsElement</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_backgroundType</span> <span class="o">!==</span> <span class="n">BackgroundTrivialColor</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">images</span> <span class="o">=</span> <span class="p">[[</span><span class="n">_backgroundColor</span> <span class="n">patternImage</span><span class="p">]</span> <span class="n">imageSlices</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_backgroundType</span> <span class="o">===</span> <span class="n">BackgroundVerticalThreePartImage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">height</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_backgroundType</span> <span class="o">===</span> <span class="n">BackgroundHorizontalThreePartImage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">width</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">width</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_backgroundType</span> <span class="o">===</span> <span class="n">BackgroundNinePartImage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="n">width</span> <span class="o">=</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">width</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">width</span><span class="p">,</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">height</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>

            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_postsFrameChangedNotifications</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_inhibitFrameAndBoundsChangedNotifications</span><span class="p">)</span>
        <span class="p">[</span><span class="n">CachedNotificationCenter</span> <span class="n">postNotificationName</span><span class="o">:</span><span class="n">CPViewFrameDidChangeNotification</span> <span class="n">object</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the receiver&#39;s bounds. The bounds define the size and location of the receiver inside it&#39;s frame. Posts a </span>
<span class="cm">    CPViewBoundsDidChangeNotification to the default notification center if the receiver is configured to do so.</span>
<span class="cm">    @param bounds the new bounds</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setBounds:</span><span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span>bounds
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectEqualToRect</span><span class="p">(</span><span class="n">_bounds</span><span class="p">,</span> <span class="n">bounds</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>
        
    <span class="n">_inhibitFrameAndBoundsChangedNotifications</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">;</span>
    
    <span class="p">[</span><span class="nb">self</span> <span class="n">setBoundsOrigin</span><span class="o">:</span><span class="n">bounds</span><span class="p">.</span><span class="n">origin</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">setBoundsSize</span><span class="o">:</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">];</span>

    <span class="n">_inhibitFrameAndBoundsChangedNotifications</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_postsBoundsChangedNotifications</span><span class="p">)</span>
        <span class="p">[</span><span class="n">CachedNotificationCenter</span> <span class="n">postNotificationName</span><span class="o">:</span><span class="n">CPViewBoundsDidChangeNotification</span> <span class="n">object</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the receiver&#39;s bounds. The bounds define the size</span>
<span class="cm">    and location of the receiver inside its frame.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span><span class="nf">bounds</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">_CGRectMakeCopy</span><span class="p">(</span><span class="n">_bounds</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span><span class="nf">boundsOrigin</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">_CGPointMakeCopy</span><span class="p">(</span><span class="n">_bounds</span><span class="p">.</span><span class="n">origin</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CGSize</span><span class="p">)</span><span class="nf">boundsSize</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">_CGSizeMakeCopy</span><span class="p">(</span><span class="n">_bounds</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the location of the receiver inside its frame. The method</span>
<span class="cm">    posts a CPViewBoundsDidChangeNotification to the</span>
<span class="cm">    default notification center if the receiver is configured to do so.</span>
<span class="cm">    @param aPoint the new location for the receiver</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setBoundsOrigin:</span><span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span>aPoint
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">origin</span> <span class="o">=</span> <span class="n">_bounds</span><span class="p">.</span><span class="n">origin</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGPointEqualToPoint</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">aPoint</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>
        
    <span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">aPoint</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">aPoint</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_boundsTransform</span> <span class="o">=</span> <span class="nf">_CGAffineTransformMakeTranslation</span><span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
        <span class="n">_inverseBoundsTransform</span> <span class="o">=</span> <span class="nf">CGAffineTransformInvert</span><span class="p">(</span><span class="n">_boundsTransform</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">_boundsTransform</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>
        <span class="n">_inverseBoundsTransform</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>
    <span class="p">}</span>
    
<span class="cp">#if PLATFORM(DOM)</span>
    <span class="kd">var</span> <span class="n">index</span> <span class="o">=</span> <span class="n">_subviews</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="n">index</span><span class="o">--</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">view</span> <span class="o">=</span> <span class="n">_subviews</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">view</span><span class="p">.</span><span class="n">_frame</span><span class="p">.</span><span class="n">origin</span><span class="p">;</span>
        
        <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="n">view</span><span class="p">.</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">_boundsTransform</span><span class="p">,</span> <span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">_postsBoundsChangedNotifications</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_inhibitFrameAndBoundsChangedNotifications</span><span class="p">)</span>
        <span class="p">[</span><span class="n">CachedNotificationCenter</span> <span class="n">postNotificationName</span><span class="o">:</span><span class="n">CPViewBoundsDidChangeNotification</span> <span class="n">object</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the receiver&#39;s size inside its frame. The method posts a</span>
<span class="cm">    CPViewBoundsDidChangeNotification to the default</span>
<span class="cm">    notification center if the receiver is configured to do so.</span>
<span class="cm">    @param aSize the new size for the receiver</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setBoundsSize:</span><span class="p">(</span><span class="kt">CGSize</span><span class="p">)</span>aSize
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">size</span> <span class="o">=</span> <span class="n">_bounds</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGSizeEqualToSize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">aSize</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="n">frameSize</span> <span class="o">=</span> <span class="n">_frame</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">_CGSizeEqualToSize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">frameSize</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">origin</span> <span class="o">=</span> <span class="n">_bounds</span><span class="p">.</span><span class="n">origin</span><span class="p">;</span>
        
        <span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">/=</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">frameSize</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
        <span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">/=</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">frameSize</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">aSize</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
    <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">aSize</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">_CGSizeEqualToSize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">frameSize</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">origin</span> <span class="o">=</span> <span class="n">_bounds</span><span class="p">.</span><span class="n">origin</span><span class="p">;</span>
        
        <span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">frameSize</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
        <span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">*=</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">frameSize</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">_postsBoundsChangedNotifications</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_inhibitFrameAndBoundsChangedNotifications</span><span class="p">)</span>
        <span class="p">[</span><span class="n">CachedNotificationCenter</span> <span class="n">postNotificationName</span><span class="o">:</span><span class="n">CPViewBoundsDidChangeNotification</span> <span class="n">object</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
<span class="p">}</span>


<span class="cm">/*!</span>
<span class="cm">    Notifies subviews that the superview changed size.</span>
<span class="cm">    @param aSize the size of the old superview</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">resizeWithOldSuperviewSize:</span><span class="p">(</span><span class="kt">CGSize</span><span class="p">)</span>aSize
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">autoresizingMask</span><span class="p">];</span>
    
    <span class="k">if</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="n">CPViewNotSizable</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">_superview</span><span class="p">.</span><span class="n">_frame</span><span class="p">,</span>
        <span class="n">newFrame</span> <span class="o">=</span> <span class="nf">_CGRectMakeCopy</span><span class="p">(</span><span class="n">_frame</span><span class="p">),</span>
        <span class="n">dX</span> <span class="o">=</span> <span class="p">(</span><span class="nf">_CGRectGetWidth</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">-</span> <span class="n">aSize</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">/</span>
            <span class="p">(((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CPViewMinXMargin</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CPViewWidthSizable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CPViewMaxXMargin</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)),</span>
        <span class="n">dY</span> <span class="o">=</span> <span class="p">(</span><span class="nf">_CGRectGetHeight</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">-</span> <span class="n">aSize</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="o">/</span>
            <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CPViewMinYMargin</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CPViewHeightSizable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CPViewMaxYMargin</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CPViewMinXMargin</span><span class="p">)</span>
        <span class="n">newFrame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CPViewWidthSizable</span><span class="p">)</span>
        <span class="n">newFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CPViewMinYMargin</span><span class="p">)</span>
        <span class="n">newFrame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">dY</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">CPViewHeightSizable</span><span class="p">)</span>
        <span class="n">newFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">+=</span> <span class="n">dY</span><span class="p">;</span>

    <span class="p">[</span><span class="nb">self</span> <span class="n">setFrame</span><span class="o">:</span><span class="n">newFrame</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Initiates \c -superviewSizeChanged: messages to subviews.</span>
<span class="cm">    @param aSize the size for the subviews</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">resizeSubviewsWithOldSize:</span><span class="p">(</span><span class="kt">CGSize</span><span class="p">)</span>aSize
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">count</span> <span class="o">=</span> <span class="n">_subviews</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
        <span class="p">[</span><span class="n">_subviews</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="n">resizeWithOldSuperviewSize</span><span class="o">:</span><span class="n">aSize</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Specifies whether the receiver view should automatically resize its</span>
<span class="cm">    subviews when its \c -setFrameSize: method receives a change.</span>
<span class="cm">    @param aFlag If \c YES, then subviews will automatically be resized</span>
<span class="cm">    when this view is resized. \c NO means the views will not</span>
<span class="cm">    be resized automatically.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setAutoresizesSubviews:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span>aFlag
<span class="p">{</span>
    <span class="n">_autoresizesSubviews</span> <span class="o">=</span> <span class="o">!!</span><span class="n">aFlag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Reports whether the receiver automatically resizes its subviews when its frame size changes.</span>
<span class="cm">    @return \c YES means it resizes its subviews on a frame size change.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">autoresizesSubviews</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_autoresizesSubviews</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Determines automatic resizing behavior.</span>
<span class="cm">    @param aMask a bit mask with options</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setAutoresizingMask:</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span>aMask
<span class="p">{</span>
    <span class="n">_autoresizingMask</span> <span class="o">=</span> <span class="n">aMask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the bit mask options for resizing behavior</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="nf">autoresizingMask</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_autoresizingMask</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Fullscreen Mode</span>

<span class="cm">/*!</span>
<span class="cm">    Puts the receiver into full screen mode.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">enterFullScreenMode</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">self</span> <span class="n">enterFullScreenMode</span><span class="o">:</span><span class="kc">nil</span> <span class="n">withOptions</span><span class="o">:</span><span class="kc">nil</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Puts the receiver into full screen mode.</span>
<span class="cm">    @param aScreen the that should be used</span>
<span class="cm">    @param options configuration options</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">enterFullScreenMode:</span><span class="p">(</span><span class="kt">CPScreen</span><span class="p">)</span>aScreen <span class="nf">withOptions:</span><span class="p">(</span><span class="kt">CPDictionary</span><span class="p">)</span>options
<span class="p">{</span>
    <span class="n">_fullScreenModeState</span> <span class="o">=</span> <span class="nf">_CPViewFullScreenModeStateMake</span><span class="p">(</span><span class="nb">self</span><span class="p">);</span>
    
    <span class="kd">var</span> <span class="n">fullScreenWindow</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CPWindow</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithContentRect</span><span class="o">:</span><span class="p">[[</span><span class="n">CPPlatformWindow</span> <span class="n">primaryPlatformWindow</span><span class="p">]</span> <span class="n">contentBounds</span><span class="p">]</span> <span class="n">styleMask</span><span class="o">:</span><span class="n">CPBorderlessWindowMask</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">fullScreenWindow</span> <span class="n">setLevel</span><span class="o">:</span><span class="n">CPScreenSaverWindowLevel</span><span class="p">];</span>
    <span class="p">[</span><span class="n">fullScreenWindow</span> <span class="n">setAutoresizingMask</span><span class="o">:</span><span class="n">CPViewWidthSizable</span> <span class="o">|</span> <span class="n">CPViewHeightSizable</span><span class="p">];</span>
    
    <span class="kd">var</span> <span class="n">contentView</span> <span class="o">=</span> <span class="p">[</span><span class="n">fullScreenWindow</span> <span class="n">contentView</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">contentView</span> <span class="n">setBackgroundColor</span><span class="o">:</span><span class="p">[</span><span class="n">CPColor</span> <span class="n">blackColor</span><span class="p">]];</span>
    <span class="p">[</span><span class="n">contentView</span> <span class="n">addSubview</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>

    <span class="p">[</span><span class="nb">self</span> <span class="n">setAutoresizingMask</span><span class="o">:</span><span class="n">CPViewWidthSizable</span> <span class="o">|</span> <span class="n">CPViewHeightSizable</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">setFrame</span><span class="o">:</span><span class="nf">CGRectMakeCopy</span><span class="p">([</span><span class="n">contentView</span> <span class="n">bounds</span><span class="p">])];</span>

    <span class="p">[</span><span class="n">fullScreenWindow</span> <span class="n">makeKeyAndOrderFront</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">fullScreenWindow</span> <span class="n">makeFirstResponder</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
    
    <span class="n">_isInFullScreenMode</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    The receiver should exit full screen mode.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">exitFullScreenMode</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">exitFullScreenModeWithOptions</span><span class="o">:</span><span class="kc">nil</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    The receiver should exit full screen mode.</span>
<span class="cm">    @param options configurations options</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">exitFullScreenModeWithOptions:</span><span class="p">(</span><span class="kt">CPDictionary</span><span class="p">)</span>options
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_isInFullScreenMode</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">_isInFullScreenMode</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>

    <span class="p">[</span><span class="nb">self</span> <span class="n">setFrame</span><span class="o">:</span><span class="n">_fullScreenModeState</span><span class="p">.</span><span class="n">frame</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">setAutoresizingMask</span><span class="o">:</span><span class="n">_fullScreenModeState</span><span class="p">.</span><span class="n">autoresizingMask</span><span class="p">];</span>
    <span class="p">[</span><span class="n">_fullScreenModeState</span><span class="p">.</span><span class="n">superview</span> <span class="n">_insertSubview</span><span class="o">:</span><span class="nb">self</span> <span class="n">atIndex</span><span class="o">:</span><span class="n">_fullScreenModeState</span><span class="p">.</span><span class="n">index</span><span class="p">];</span>
    
    <span class="p">[[</span><span class="nb">self</span> <span class="nb">window</span><span class="p">]</span> <span class="n">orderOut</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver is currently in full screen mode.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isInFullScreenMode</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_isInFullScreenMode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets whether the receiver should be hidden.</span>
<span class="cm">    @param aFlag \c YES makes the receiver hidden.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setHidden:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span>aFlag
<span class="p">{</span>
    <span class="n">aFlag</span> <span class="o">=</span> <span class="o">!!</span><span class="n">aFlag</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">_isHidden</span> <span class="o">===</span> <span class="n">aFlag</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

<span class="c1">//  FIXME: Should we return to visibility?  This breaks in FireFox, Opera, and IE.</span>
<span class="c1">//    _DOMElement.style.visibility = (_isHidden = aFlag) ? &quot;hidden&quot; : &quot;visible&quot;;</span>
    <span class="n">_isHidden</span> <span class="o">=</span> <span class="n">aFlag</span><span class="p">;</span>
<span class="cp">#if PLATFORM(DOM)</span>
    <span class="n">_DOMElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">display</span> <span class="o">=</span> <span class="n">_isHidden</span> <span class="o">?</span> <span class="s">&quot;none&quot;</span> <span class="o">:</span> <span class="s">&quot;block&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">aFlag</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">view</span> <span class="o">=</span> <span class="p">[</span><span class="n">_window</span> <span class="n">firstResponder</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">([</span><span class="n">view</span> <span class="n">isKindOfClass</span><span class="o">:</span><span class="p">[</span><span class="n">CPView</span> <span class="n">class</span><span class="p">]])</span>
        <span class="p">{</span>
            <span class="k">do</span> 
            <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nb">self</span> <span class="o">==</span> <span class="n">view</span><span class="p">)</span>
               <span class="p">{</span>
                  <span class="p">[</span><span class="n">_window</span> <span class="n">makeFirstResponder</span><span class="o">:</span><span class="p">[</span><span class="nb">self</span> <span class="n">nextValidKeyView</span><span class="p">]];</span>
                  <span class="k">break</span><span class="p">;</span>
               <span class="p">}</span>   
            <span class="p">}</span> 
            <span class="k">while</span> <span class="p">(</span><span class="n">view</span> <span class="o">=</span> <span class="p">[</span><span class="n">view</span> <span class="n">superview</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver is hidden.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isHidden</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_isHidden</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the opacity of the receiver. The value must be in the range of 0.0 to 1.0, where 0.0 is </span>
<span class="cm">    completely transparent and 1.0 is completely opaque.</span>
<span class="cm">    @param anAlphaValue an alpha value ranging from 0.0 to 1.0.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setAlphaValue:</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span>anAlphaValue
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_opacity</span> <span class="o">==</span> <span class="n">anAlphaValue</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="n">_opacity</span> <span class="o">=</span> <span class="n">anAlphaValue</span><span class="p">;</span>
    
<span class="cp">#if PLATFORM(DOM)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nf">CPFeatureIsCompatible</span><span class="p">(</span><span class="n">CPOpacityRequiresFilterFeature</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">anAlphaValue</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">try</span> <span class="p">{</span> <span class="n">_DOMElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="nf">removeAttribute</span><span class="p">(</span><span class="s">&quot;filter&quot;</span><span class="p">)</span> <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">anException</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
        <span class="k">else</span>
            <span class="n">_DOMElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">filter</span> <span class="o">=</span> <span class="s">&quot;alpha(opacity=&quot;</span> <span class="o">+</span> <span class="n">anAlphaValue</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">_DOMElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">opacity</span> <span class="o">=</span> <span class="n">anAlphaValue</span><span class="p">;</span>

<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the alpha value of the receiver. Ranges from 0.0 to</span>
<span class="cm">    1.0, where 0.0 is completely transparent and 1.0 is completely opaque.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="nf">alphaValue</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_opacity</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver is hidden, or one</span>
<span class="cm">    of it&#39;s ancestor views is hidden. \c NO, otherwise.</span>
<span class="cm">*/</span>   
<span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="n">isHiddenOrHasHiddenAncestor</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">view</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="n">view</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="n">view</span> <span class="n">isHidden</span><span class="p">])</span>
        <span class="n">view</span> <span class="o">=</span> <span class="p">[</span><span class="n">view</span> <span class="n">superview</span><span class="p">];</span>
    
    <span class="k">return</span> <span class="n">view</span> <span class="o">!==</span> <span class="kc">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns whether the receiver should be sent a \c -mouseDown: message for \c anEvent.&lt;br/&gt;</span>
<span class="cm">    Returns \c YES by default.</span>
<span class="cm">    @return \c YES, if the view object accepts first mouse-down event. \c NO, otherwise.</span>
<span class="cm">*/</span>
<span class="c1">//FIXME: should be NO by default? </span>
<span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="n">acceptsFirstMouse</span><span class="o">:</span><span class="p">(</span><span class="n">CPEvent</span><span class="p">)</span><span class="n">anEvent</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns whether or not the view responds to hit tests.</span>
<span class="cm">    @return \c YES if this view listens to \c -hitTest messages, \c NO otherwise.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">hitTests</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_hitTests</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Set whether or not the view should respond to hit tests.</span>
<span class="cm">    @param shouldHitTest should be \c YES if this view should respond to hit tests, \c NO otherwise.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setHitTests:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span>shouldHitTest
<span class="p">{</span>
    <span class="n">_hitTests</span> <span class="o">=</span> <span class="o">!!</span><span class="n">shouldHitTest</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Tests whether a point is contained within this view, or one of its subviews.</span>
<span class="cm">    @param aPoint the point to test</span>
<span class="cm">    @return returns the containing view, or nil if the point is not contained</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CPView</span><span class="p">)</span><span class="nf">hitTest:</span><span class="p">(</span><span class="kt">CPPoint</span><span class="p">)</span>aPoint
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">_isHidden</span> <span class="o">||</span> <span class="o">!</span><span class="n">_hitTests</span> <span class="o">||</span> <span class="o">!</span><span class="nf">CPRectContainsPoint</span><span class="p">(</span><span class="n">_frame</span><span class="p">,</span> <span class="n">aPoint</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">;</span>
    
    <span class="kd">var</span> <span class="n">view</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">_subviews</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
        <span class="n">adjustedPoint</span> <span class="o">=</span> <span class="nf">_CGPointMake</span><span class="p">(</span><span class="n">aPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="n">_frame</span><span class="p">),</span> <span class="n">aPoint</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="n">_frame</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_inverseBoundsTransform</span><span class="p">)</span>
        <span class="n">adjustedPoint</span> <span class="o">=</span> <span class="nf">_CGPointApplyAffineTransform</span><span class="p">(</span><span class="n">adjustedPoint</span><span class="p">,</span> <span class="n">_inverseBoundsTransform</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">view</span> <span class="o">=</span> <span class="p">[</span><span class="n">_subviews</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="n">hitTest</span><span class="o">:</span><span class="n">adjustedPoint</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">view</span><span class="p">;</span>

    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if mouse events aren&#39;t needed by the receiver and can be sent to the superview. The</span>
<span class="cm">    default implementation returns \c NO if the view is opaque.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">mouseDownCanMoveWindow</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="p">[</span><span class="nb">self</span> <span class="n">isOpaque</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">mouseDown:</span><span class="p">(</span><span class="kt">CPEvent</span><span class="p">)</span>anEvent
<span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="nb">self</span> <span class="n">mouseDownCanMoveWindow</span><span class="p">])</span>
        <span class="p">[</span><span class="nb">super</span> <span class="n">mouseDown</span><span class="o">:</span><span class="n">anEvent</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the background color of the receiver.</span>
<span class="cm">    @param aColor the new color for the receiver&#39;s background</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setBackgroundColor:</span><span class="p">(</span><span class="kt">CPColor</span><span class="p">)</span>aColor
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_backgroundColor</span> <span class="o">==</span> <span class="n">aColor</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="n">_backgroundColor</span> <span class="o">=</span> <span class="n">aColor</span><span class="p">;</span>
    
<span class="cp">#if PLATFORM(DOM)</span>
    <span class="kd">var</span> <span class="n">patternImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">_backgroundColor</span> <span class="n">patternImage</span><span class="p">],</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">([</span><span class="n">patternImage</span> <span class="n">isThreePartImage</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="n">_backgroundType</span> <span class="o">=</span> <span class="p">[</span><span class="n">patternImage</span> <span class="n">isVertical</span><span class="p">]</span> <span class="o">?</span> <span class="n">BackgroundVerticalThreePartImage</span> <span class="o">:</span> <span class="n">BackgroundHorizontalThreePartImage</span><span class="p">;</span>
        
        <span class="n">amount</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">_DOMImageParts</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">([</span><span class="n">patternImage</span> <span class="n">isNinePartImage</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="n">_backgroundType</span> <span class="o">=</span> <span class="n">BackgroundNinePartImage</span><span class="p">;</span>
        
        <span class="n">amount</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">-</span> <span class="n">_DOMImageParts</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>   
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">_backgroundType</span> <span class="o">=</span> <span class="n">BackgroundTrivialColor</span><span class="p">;</span>

        <span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">_DOMImageParts</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">amount</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="n">DOMElement</span> <span class="o">=</span> <span class="n">DOMElementPrototype</span><span class="p">.</span><span class="nf">cloneNode</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
            
            <span class="n">DOMElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">zIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span><span class="p">;</span>
            
            <span class="n">_DOMImageParts</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">DOMElement</span><span class="p">);</span>
            <span class="n">_DOMElement</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="n">DOMElement</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="o">-</span><span class="n">amount</span><span class="p">;</span>
        
        <span class="k">while</span> <span class="p">(</span><span class="n">amount</span><span class="o">--</span><span class="p">)</span>
            <span class="n">_DOMElement</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">.</span><span class="nf">pop</span><span class="p">());</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">_backgroundType</span> <span class="o">==</span> <span class="n">BackgroundTrivialColor</span><span class="p">)</span>
    
        <span class="c1">// Opera doesn&#39;t like DOM properties set to nil.</span>
        <span class="c1">// https://trac.280north.com/ticket/7</span>
        <span class="n">_DOMElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">_backgroundColor</span> <span class="o">?</span> <span class="p">[</span><span class="n">_backgroundColor</span> <span class="n">cssString</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="n">patternImage</span> <span class="n">imageSlices</span><span class="p">],</span>
            <span class="n">count</span> <span class="o">=</span> <span class="kc">MIN</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">slices</span><span class="p">.</span><span class="n">length</span><span class="p">),</span>
            <span class="n">frameSize</span> <span class="o">=</span> <span class="n">_frame</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="n">image</span> <span class="o">=</span> <span class="n">slices</span><span class="p">[</span><span class="n">count</span><span class="p">],</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span> <span class="o">?</span> <span class="p">[</span><span class="n">image</span> <span class="n">size</span><span class="p">]</span> <span class="o">:</span> <span class="nf">_CGSizeMakeZero</span><span class="p">();</span>
            
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

            <span class="n">_DOMImageParts</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">style</span><span class="p">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">image</span> <span class="o">?</span> <span class="s">&quot;url(</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="p">[</span><span class="n">image</span> <span class="n">filename</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">_backgroundType</span> <span class="o">==</span> <span class="n">BackgroundNinePartImage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="n">width</span> <span class="o">=</span> <span class="n">frameSize</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">width</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">width</span><span class="p">,</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">frameSize</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">height</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>
            
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
                
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>            
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleRightTop</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">width</span><span class="p">,</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleRightTop</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleLeftBottom</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleLeftBottom</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleRightBottom</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>      
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_backgroundType</span> <span class="o">==</span> <span class="n">BackgroundVerticalThreePartImage</span><span class="p">)</span>
        <span class="p">{</span>    
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">frameSize</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">frameSize</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">height</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
            
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>        
            <span class="nf">CPDOMDisplayServerSetStyleLeftBottom</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_backgroundType</span> <span class="o">==</span> <span class="n">BackgroundHorizontalThreePartImage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">frameSize</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">width</span> <span class="o">-</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">width</span><span class="p">,</span> <span class="n">frameSize</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
        
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
            <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="n">_DOMImageSizes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>        
            <span class="nf">CPDOMDisplayServerSetStyleRightTop</span><span class="p">(</span><span class="n">_DOMImageParts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kc">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the background color of the receiver</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CPColor</span><span class="p">)</span><span class="nf">backgroundColor</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_backgroundColor</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Converting Coordinates</span>
<span class="cm">/*!</span>
<span class="cm">    Converts \c aPoint from the coordinate space of \c aView to the coordinate space of the receiver.</span>
<span class="cm">    @param aPoint the point to convert</span>
<span class="cm">    @param aView the view space to convert from</span>
<span class="cm">    @return the converted point</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span><span class="nf">convertPoint:</span><span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span>aPoint <span class="nf">fromView:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aView
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGPointApplyAffineTransform</span><span class="p">(</span><span class="n">aPoint</span><span class="p">,</span> <span class="nf">_CPViewGetTransform</span><span class="p">(</span><span class="n">aView</span><span class="p">,</span> <span class="nb">self</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Converts \c aPoint from the receiver&#39;s coordinate space to the coordinate space of \c aView.</span>
<span class="cm">    @param aPoint the point to convert</span>
<span class="cm">    @param aView the coordinate space to which the point will be converted</span>
<span class="cm">    @return the converted point</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span><span class="nf">convertPoint:</span><span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span>aPoint <span class="nf">toView:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aView
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGPointApplyAffineTransform</span><span class="p">(</span><span class="n">aPoint</span><span class="p">,</span> <span class="nf">_CPViewGetTransform</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">aView</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Convert&#39;s \c aSize from \c aView&#39;s coordinate space to the receiver&#39;s coordinate space.</span>
<span class="cm">    @param aSize the size to convert</span>
<span class="cm">    @param aView the coordinate space to convert from</span>
<span class="cm">    @return the converted size</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CGSize</span><span class="p">)</span><span class="nf">convertSize:</span><span class="p">(</span><span class="kt">CGSize</span><span class="p">)</span>aSize <span class="nf">fromView:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aView
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGSizeApplyAffineTransform</span><span class="p">(</span><span class="n">aSize</span><span class="p">,</span> <span class="nf">_CPViewGetTransform</span><span class="p">(</span><span class="n">aView</span><span class="p">,</span> <span class="nb">self</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Convert&#39;s \c aSize from the receiver&#39;s coordinate space to \c aView&#39;s coordinate space.</span>
<span class="cm">    @param aSize the size to convert</span>
<span class="cm">    @param the coordinate space to which the size will be converted</span>
<span class="cm">    @return the converted size</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CGSize</span><span class="p">)</span><span class="nf">convertSize:</span><span class="p">(</span><span class="kt">CGSize</span><span class="p">)</span>aSize <span class="nf">toView:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aView
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGSizeApplyAffineTransform</span><span class="p">(</span><span class="n">aSize</span><span class="p">,</span> <span class="nf">_CPViewGetTransform</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">aView</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Converts \c aRect from \c aView&#39;s coordinate space to the receiver&#39;s space.</span>
<span class="cm">    @param aRect the rectangle to convert</span>
<span class="cm">    @param aView the coordinate space from which to convert</span>
<span class="cm">    @return the converted rectangle</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span><span class="nf">convertRect:</span><span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span>aRect <span class="nf">fromView:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aView
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGRectApplyAffineTransform</span><span class="p">(</span><span class="n">aRect</span><span class="p">,</span> <span class="nf">_CPViewGetTransform</span><span class="p">(</span><span class="n">aView</span><span class="p">,</span> <span class="nb">self</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Converts \c aRect from the receiver&#39;s coordinate space to \c aView&#39;s coordinate space.</span>
<span class="cm">    @param aRect the rectangle to convert</span>
<span class="cm">    @param aView the coordinate space to which the rectangle will be converted</span>
<span class="cm">    @return the converted rectangle</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span><span class="nf">convertRect:</span><span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span>aRect <span class="nf">toView:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aView
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">CGRectApplyAffineTransform</span><span class="p">(</span><span class="n">aRect</span><span class="p">,</span> <span class="nf">_CPViewGetTransform</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">aView</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets whether the receiver posts a CPViewFrameDidChangeNotification notification</span>
<span class="cm">    to the default notification center when its frame is changed. The default is \c NO.</span>
<span class="cm">    Methods that could cause a frame change notification are:</span>
<span class="cm">&lt;pre&gt;</span>
<span class="cm">setFrame:</span>
<span class="cm">setFrameSize:</span>
<span class="cm">setFrameOrigin:</span>
<span class="cm">&lt;/pre&gt;</span>
<span class="cm">    @param shouldPostFrameChangedNotifications \c YES makes the receiver post</span>
<span class="cm">    notifications on frame changes (size or origin)</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setPostsFrameChangedNotifications:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span>shouldPostFrameChangedNotifications
<span class="p">{</span>
    <span class="n">shouldPostFrameChangedNotifications</span> <span class="o">=</span> <span class="o">!!</span><span class="n">shouldPostFrameChangedNotifications</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_postsFrameChangedNotifications</span> <span class="o">===</span> <span class="n">shouldPostFrameChangedNotifications</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">_postsFrameChangedNotifications</span> <span class="o">=</span> <span class="n">shouldPostFrameChangedNotifications</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_postsFrameChangedNotifications</span><span class="p">)</span>
        <span class="p">[</span><span class="n">CachedNotificationCenter</span> <span class="n">postNotificationName</span><span class="o">:</span><span class="n">CPViewFrameDidChangeNotification</span> <span class="n">object</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver posts a CPViewFrameDidChangeNotification if its frame is changed.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">postsFrameChangedNotifications</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_postsFrameChangedNotifications</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets whether the receiver posts a CPViewBoundsDidChangeNotification notification</span>
<span class="cm">    to the default notification center when its bounds is changed. The default is \c NO.</span>
<span class="cm">    Methods that could cause a bounds change notification are:</span>
<span class="cm">&lt;pre&gt;</span>
<span class="cm">setBounds:</span>
<span class="cm">setBoundsSize:</span>
<span class="cm">setBoundsOrigin:</span>
<span class="cm">&lt;/pre&gt;</span>
<span class="cm">    @param shouldPostBoundsChangedNotifications \c YES makes the receiver post</span>
<span class="cm">    notifications on bounds changes</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setPostsBoundsChangedNotifications:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span>shouldPostBoundsChangedNotifications
<span class="p">{</span>
    <span class="n">shouldPostBoundsChangedNotifications</span> <span class="o">=</span> <span class="o">!!</span><span class="n">shouldPostBoundsChangedNotifications</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_postsBoundsChangedNotifications</span> <span class="o">===</span> <span class="n">shouldPostBoundsChangedNotifications</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">_postsBoundsChangedNotifications</span> <span class="o">=</span> <span class="n">shouldPostBoundsChangedNotifications</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_postsBoundsChangedNotifications</span><span class="p">)</span>
        <span class="p">[</span><span class="n">CachedNotificationCenter</span> <span class="n">postNotificationName</span><span class="o">:</span><span class="n">CPViewBoundsDidChangeNotification</span> <span class="n">object</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver posts a</span>
<span class="cm">    CPViewBoundsDidChangeNotification when its</span>
<span class="cm">    bounds is changed.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">postsBoundsChangedNotifications</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_postsBoundsChangedNotifications</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Initiates a drag operation from the receiver to another view that accepts dragged data.</span>
<span class="cm">    @param anImage the image to be dragged</span>
<span class="cm">    @param aLocation the lower-left corner coordinate of \c anImage</span>
<span class="cm">    @param mouseOffset the distance from the \c -mouseDown: location and the current location</span>
<span class="cm">    @param anEvent the \c -mouseDown: that triggered the drag</span>
<span class="cm">    @param aPastebaord the pasteboard that holds the drag data</span>
<span class="cm">    @param aSourceObject the drag operation controller</span>
<span class="cm">    @param slideBack Whether the image should &#39;slide back&#39; if the drag is rejected</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">dragImage:</span><span class="p">(</span><span class="kt">CPImage</span><span class="p">)</span>anImage <span class="nf">at:</span><span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span>aLocation <span class="nf">offset:</span><span class="p">(</span><span class="kt">CGSize</span><span class="p">)</span>mouseOffset <span class="nf">event:</span><span class="p">(</span><span class="kt">CPEvent</span><span class="p">)</span>anEvent <span class="nf">pasteboard:</span><span class="p">(</span><span class="kt">CPPasteboard</span><span class="p">)</span>aPasteboard <span class="nf">source:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span>aSourceObject <span class="nf">slideBack:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span>slideBack
<span class="p">{</span>
    <span class="p">[</span><span class="n">_window</span> <span class="n">dragImage</span><span class="o">:</span><span class="n">anImage</span> <span class="n">at</span><span class="o">:</span><span class="p">[</span><span class="nb">self</span> <span class="n">convertPoint</span><span class="o">:</span><span class="n">aLocation</span> <span class="n">toView</span><span class="o">:</span><span class="kc">nil</span><span class="p">]</span> <span class="n">offset</span><span class="o">:</span><span class="n">mouseOffset</span> <span class="n">event</span><span class="o">:</span><span class="n">anEvent</span> <span class="n">pasteboard</span><span class="o">:</span><span class="n">aPasteboard</span> <span class="n">source</span><span class="o">:</span><span class="n">aSourceObject</span> <span class="n">slideBack</span><span class="o">:</span><span class="n">slideBack</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Initiates a drag operation from the receiver to another view that accepts dragged data.</span>
<span class="cm">    @param aView the view to be dragged</span>
<span class="cm">    @param aLocation the top-left corner coordinate of \c aView</span>
<span class="cm">    @param mouseOffset the distance from the \c -mouseDown: location and the current location</span>
<span class="cm">    @param anEvent the \c -mouseDown: that triggered the drag</span>
<span class="cm">    @param aPastebaord the pasteboard that holds the drag data</span>
<span class="cm">    @param aSourceObject the drag operation controller</span>
<span class="cm">    @param slideBack Whether the view should &#39;slide back&#39; if the drag is rejected</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">dragView:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>aView <span class="nf">at:</span><span class="p">(</span><span class="kt">CPPoint</span><span class="p">)</span>aLocation <span class="nf">offset:</span><span class="p">(</span><span class="kt">CPSize</span><span class="p">)</span>mouseOffset <span class="nf">event:</span><span class="p">(</span><span class="kt">CPEvent</span><span class="p">)</span>anEvent <span class="nf">pasteboard:</span><span class="p">(</span><span class="kt">CPPasteboard</span><span class="p">)</span>aPasteboard <span class="nf">source:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span>aSourceObject <span class="nf">slideBack:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span>slideBack
<span class="p">{</span>
    <span class="p">[</span><span class="n">_window</span> <span class="n">dragView</span><span class="o">:</span><span class="n">aView</span> <span class="n">at</span><span class="o">:</span><span class="p">[</span><span class="nb">self</span> <span class="n">convertPoint</span><span class="o">:</span><span class="n">aLocation</span> <span class="n">toView</span><span class="o">:</span><span class="kc">nil</span><span class="p">]</span> <span class="n">offset</span><span class="o">:</span><span class="n">mouseOffset</span> <span class="n">event</span><span class="o">:</span><span class="n">anEvent</span> <span class="n">pasteboard</span><span class="o">:</span><span class="n">aPasteboard</span> <span class="n">source</span><span class="o">:</span><span class="n">aSourceObject</span> <span class="n">slideBack</span><span class="o">:</span><span class="n">slideBack</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets the receiver&#39;s list of acceptable data types for a dragging operation.</span>
<span class="cm">    @param pasteboardTypes an array of CPPasteboards</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">registerForDraggedTypes:</span><span class="p">(</span><span class="kt">CPArray</span><span class="p">)</span>pasteboardTypes
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pasteboardTypes</span> <span class="o">||</span> <span class="o">!</span><span class="p">[</span><span class="n">pasteboardTypes</span> <span class="n">count</span><span class="p">])</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="n">theWindow</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nb">window</span><span class="p">];</span>

    <span class="p">[</span><span class="n">theWindow</span> <span class="n">_noteUnregisteredDraggedTypes</span><span class="o">:</span><span class="n">_registeredDraggedTypes</span><span class="p">];</span>
    <span class="p">[</span><span class="n">_registeredDraggedTypes</span> <span class="n">addObjectsFromArray</span><span class="o">:</span><span class="n">pasteboardTypes</span><span class="p">]</span>
    <span class="p">[</span><span class="n">theWindow</span> <span class="n">_noteRegisteredDraggedTypes</span><span class="o">:</span><span class="n">_registeredDraggedTypes</span><span class="p">];</span>

    <span class="n">_registeredDraggedTypesArray</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns an array of all types the receiver accepts for dragging operations.</span>
<span class="cm">    @return an array of CPPasteBoards</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CPArray</span><span class="p">)</span><span class="nf">registeredDraggedTypes</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_registeredDraggedTypesArray</span><span class="p">)</span>
        <span class="n">_registeredDraggedTypesArray</span> <span class="o">=</span> <span class="p">[</span><span class="n">_registeredDraggedTypes</span> <span class="n">allObjects</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">_registeredDraggedTypesArray</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Resets the array of acceptable data types for a dragging operation.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">unregisterDraggedTypes</span>
<span class="p">{</span>
    <span class="p">[[</span><span class="nb">self</span> <span class="nb">window</span><span class="p">]</span> <span class="n">_noteUnregisteredDraggedTypes</span><span class="o">:</span><span class="n">_registeredDraggedTypes</span><span class="p">];</span>

    <span class="n">_registeredDraggedTypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPSet</span> <span class="n">set</span><span class="p">];</span>
    <span class="n">_registeredDraggedTypesArray</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Draws the receiver into \c aRect. This method should be overridden by subclasses.</span>
<span class="cm">    @param aRect the area that should be drawn into</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">drawRect:</span><span class="p">(</span><span class="kt">CPRect</span><span class="p">)</span>aRect
<span class="p">{</span>

<span class="p">}</span>

<span class="c1">// Displaying</span>

<span class="cm">/*!</span>
<span class="cm">    Marks the entire view as dirty, and needing a redraw.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setNeedsDisplay:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span>aFlag
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aFlag</span><span class="p">)</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsDisplayInRect</span><span class="o">:</span><span class="p">[</span><span class="nb">self</span> <span class="n">bounds</span><span class="p">]];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Marks the area denoted by \c aRect as dirty, and initiates a redraw on it.</span>
<span class="cm">    @param aRect the area that needs to be redrawn</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setNeedsDisplayInRect:</span><span class="p">(</span><span class="kt">CPRect</span><span class="p">)</span>aRect
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">_viewClassFlags</span> <span class="o">&amp;</span> <span class="n">CPViewHasCustomDrawRect</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectIsEmpty</span><span class="p">(</span><span class="n">aRect</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_dirtyRect</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">_CGRectIsEmpty</span><span class="p">(</span><span class="n">_dirtyRect</span><span class="p">))</span>
        <span class="n">_dirtyRect</span> <span class="o">=</span> <span class="nf">CGRectUnion</span><span class="p">(</span><span class="n">aRect</span><span class="p">,</span> <span class="n">_dirtyRect</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">_dirtyRect</span> <span class="o">=</span> <span class="nf">_CGRectMakeCopy</span><span class="p">(</span><span class="n">aRect</span><span class="p">);</span>

    <span class="nf">_CPDisplayServerAddDisplayObject</span><span class="p">(</span><span class="nb">self</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">needsDisplay</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_dirtyRect</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">_CGRectIsEmpty</span><span class="p">(</span><span class="n">_dirtyRect</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Displays the receiver and any of its subviews that need to be displayed.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">displayIfNeeded</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="nb">self</span> <span class="n">needsDisplay</span><span class="p">])</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">displayRect</span><span class="o">:</span><span class="n">_dirtyRect</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Draws the entire area of the receiver as defined by its \c -bounds.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">display</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">displayRect</span><span class="o">:</span><span class="p">[</span><span class="nb">self</span> <span class="n">visibleRect</span><span class="p">]];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">displayIfNeededInRect:</span><span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span>aRect
<span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="nb">self</span> <span class="n">needsDisplay</span><span class="p">])</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">displayRect</span><span class="o">:</span><span class="n">aRect</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Draws the receiver into the area defined by \c aRect.</span>
<span class="cm">    @param aRect the area to be drawn</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">displayRect:</span><span class="p">(</span><span class="kt">CPRect</span><span class="p">)</span>aRect
<span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">viewWillDraw</span><span class="p">];</span>
    
    <span class="p">[</span><span class="nb">self</span> <span class="n">displayRectIgnoringOpacity</span><span class="o">:</span><span class="n">aRect</span> <span class="n">inContext</span><span class="o">:</span><span class="kc">nil</span><span class="p">];</span>
    
    <span class="n">_dirtyRect</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">displayRectIgnoringOpacity:</span><span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span>aRect <span class="nf">inContext:</span><span class="p">(</span><span class="kt">CPGraphicsContext</span><span class="p">)</span>aGraphicsContext
<span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">lockFocus</span><span class="p">];</span>
    
    <span class="nf">CGContextClearRect</span><span class="p">([[</span><span class="n">CPGraphicsContext</span> <span class="n">currentContext</span><span class="p">]</span> <span class="n">graphicsPort</span><span class="p">],</span> <span class="n">aRect</span><span class="p">);</span>
    
    <span class="p">[</span><span class="nb">self</span> <span class="n">drawRect</span><span class="o">:</span><span class="n">aRect</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">unlockFocus</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewWillDraw</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Locks focus on the receiver, so drawing commands apply to it.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">lockFocus</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_graphicsContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">graphicsPort</span> <span class="o">=</span> <span class="nf">CGBitmapGraphicsContextCreate</span><span class="p">();</span>
        
        <span class="n">_DOMContentsElement</span> <span class="o">=</span> <span class="n">graphicsPort</span><span class="p">.</span><span class="n">DOMElement</span><span class="p">;</span>
        
        <span class="n">_DOMContentsElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">zIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">;</span>

        <span class="n">_DOMContentsElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">overflow</span> <span class="o">=</span> <span class="s">&quot;hidden&quot;</span><span class="p">;</span>
        <span class="n">_DOMContentsElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="s">&quot;absolute&quot;</span><span class="p">;</span>
        <span class="n">_DOMContentsElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">visibility</span> <span class="o">=</span> <span class="s">&quot;visible&quot;</span><span class="p">;</span>
        
        <span class="n">_DOMContentsElement</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="kc">ROUND</span><span class="p">(</span><span class="nf">_CGRectGetWidth</span><span class="p">(</span><span class="n">_frame</span><span class="p">));</span>
        <span class="n">_DOMContentsElement</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="kc">ROUND</span><span class="p">(</span><span class="nf">_CGRectGetHeight</span><span class="p">(</span><span class="n">_frame</span><span class="p">));</span>
        
        <span class="n">_DOMContentsElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="s">&quot;0px&quot;</span><span class="p">;</span>
        <span class="n">_DOMContentsElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="s">&quot;0px&quot;</span><span class="p">;</span>
        <span class="n">_DOMContentsElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="kc">ROUND</span><span class="p">(</span><span class="nf">_CGRectGetWidth</span><span class="p">(</span><span class="n">_frame</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;px&quot;</span><span class="p">;</span>
        <span class="n">_DOMContentsElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="kc">ROUND</span><span class="p">(</span><span class="nf">_CGRectGetHeight</span><span class="p">(</span><span class="n">_frame</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;px&quot;</span><span class="p">;</span>

        <span class="nf">CPDOMDisplayServerAppendChild</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">_DOMContentsElement</span><span class="p">);</span>
        
        <span class="n">_graphicsContext</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPGraphicsContext</span> <span class="n">graphicsContextWithGraphicsPort</span><span class="o">:</span><span class="n">graphicsPort</span> <span class="n">flipped</span><span class="o">:</span><span class="kc">YES</span><span class="p">];</span>
    <span class="p">}</span>
    
    <span class="p">[</span><span class="n">CPGraphicsContext</span> <span class="n">setCurrentContext</span><span class="o">:</span><span class="n">_graphicsContext</span><span class="p">];</span>
    
    <span class="nf">CGContextSaveGState</span><span class="p">([</span><span class="n">_graphicsContext</span> <span class="n">graphicsPort</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Takes focus away from the receiver, and restores it to the previous view.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">unlockFocus</span>
<span class="p">{</span>
    <span class="nf">CGContextRestoreGState</span><span class="p">([</span><span class="n">_graphicsContext</span> <span class="n">graphicsPort</span><span class="p">]);</span>
    
    <span class="p">[</span><span class="n">CPGraphicsContext</span> <span class="n">setCurrentContext</span><span class="o">:</span><span class="kc">nil</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setNeedsLayout</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">_viewClassFlags</span> <span class="o">&amp;</span> <span class="n">CPViewHasCustomLayoutSubviews</span><span class="p">))</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">_needsLayout</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">;</span>

    <span class="nf">_CPDisplayServerAddLayoutObject</span><span class="p">(</span><span class="nb">self</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">layoutIfNeeded</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_needsLayout</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_needsLayout</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>
    
        <span class="p">[</span><span class="nb">self</span> <span class="n">layoutSubviews</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">layoutSubviews</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns whether the receiver is completely opaque. By default, returns \c NO.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isOpaque</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the rectangle of the receiver not clipped by its superview.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span><span class="nf">visibleRect</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_superview</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_bounds</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="nf">CGRectIntersection</span><span class="p">([</span><span class="nb">self</span> <span class="n">convertRect</span><span class="o">:</span><span class="p">[</span><span class="n">_superview</span> <span class="n">visibleRect</span><span class="p">]</span> <span class="n">fromView</span><span class="o">:</span><span class="n">_superview</span><span class="p">],</span> <span class="n">_bounds</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Scrolling</span>
<span class="cm">/* @ignore */</span><span class="o">-</span> <span class="p">(</span><span class="kt">CPScrollView</span><span class="p">)</span><span class="nf">_enclosingClipView</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">superview</span> <span class="o">=</span> <span class="n">_superview</span><span class="p">,</span>
        <span class="n">clipViewClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPClipView</span> <span class="n">class</span><span class="p">];</span>

    <span class="k">while</span><span class="p">(</span><span class="n">superview</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="n">superview</span> <span class="n">isKindOfClass</span><span class="o">:</span><span class="n">clipViewClass</span><span class="p">])</span> 
        <span class="n">superview</span> <span class="o">=</span> <span class="n">superview</span><span class="p">.</span><span class="n">_superview</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">superview</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Changes the receiver&#39;s frame origin to a &#39;constrained&#39; \c aPoint.</span>
<span class="cm">    @param aPoint the proposed frame origin</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">scrollPoint:</span><span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span>aPoint
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">clipView</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">_enclosingClipView</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clipView</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="p">[</span><span class="n">clipView</span> <span class="n">scrollToPoint</span><span class="o">:</span><span class="p">[</span><span class="nb">self</span> <span class="n">convertPoint</span><span class="o">:</span><span class="n">aPoint</span> <span class="n">toView</span><span class="o">:</span><span class="n">clipView</span><span class="p">]];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Scrolls the nearest ancestor CPClipView a minimum amount so \c aRect can become visible.</span>
<span class="cm">    @param aRect the area to become visible</span>
<span class="cm">    @return &lt;codeYES if any scrolling occurred, \c NO otherwise.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">scrollRectToVisible:</span><span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span>aRect
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">visibleRect</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">visibleRect</span><span class="p">];</span>
    
    <span class="c1">// Make sure we have a rect that exists.</span>
    <span class="n">aRect</span> <span class="o">=</span> <span class="nf">CGRectIntersection</span><span class="p">(</span><span class="n">aRect</span><span class="p">,</span> <span class="n">_bounds</span><span class="p">);</span>
    
    <span class="c1">// If aRect is empty or is already visible then no scrolling required.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectIsEmpty</span><span class="p">(</span><span class="n">aRect</span><span class="p">)</span> <span class="o">||</span> <span class="nf">CGRectContainsRect</span><span class="p">(</span><span class="n">visibleRect</span><span class="p">,</span> <span class="n">aRect</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>

    <span class="kd">var</span> <span class="n">enclosingClipView</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">_enclosingClipView</span><span class="p">];</span>
    
    <span class="c1">// If we&#39;re not in a clip view, then there isn&#39;t much we can do.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enclosingClipView</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>
    
    <span class="kd">var</span> <span class="n">scrollPoint</span> <span class="o">=</span> <span class="nf">_CGPointMakeCopy</span><span class="p">(</span><span class="n">visibleRect</span><span class="p">.</span><span class="n">origin</span><span class="p">);</span>
            
    <span class="c1">// One of the following has to be true since our current visible rect didn&#39;t contain aRect.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="n">aRect</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="n">visibleRect</span><span class="p">))</span>
        <span class="n">scrollPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="n">aRect</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectGetMaxX</span><span class="p">(</span><span class="n">aRect</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">_CGRectGetMaxX</span><span class="p">(</span><span class="n">visibleRect</span><span class="p">))</span>
        <span class="n">scrollPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="nf">_CGRectGetMaxX</span><span class="p">(</span><span class="n">aRect</span><span class="p">)</span> <span class="o">-</span> <span class="nf">_CGRectGetMaxX</span><span class="p">(</span><span class="n">visibleRect</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="n">aRect</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="n">visibleRect</span><span class="p">))</span>
        <span class="n">scrollPoint</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="nf">CGRectGetMinY</span><span class="p">(</span><span class="n">aRect</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">_CGRectGetMaxY</span><span class="p">(</span><span class="n">aRect</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">_CGRectGetMaxY</span><span class="p">(</span><span class="n">visibleRect</span><span class="p">))</span>
        <span class="n">scrollPoint</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="nf">_CGRectGetMaxY</span><span class="p">(</span><span class="n">aRect</span><span class="p">)</span> <span class="o">-</span> <span class="nf">_CGRectGetMaxY</span><span class="p">(</span><span class="n">visibleRect</span><span class="p">);</span>
    
    <span class="p">[</span><span class="n">enclosingClipView</span> <span class="n">scrollToPoint</span><span class="o">:</span><span class="nf">CGPointMake</span><span class="p">(</span><span class="n">scrollPoint</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">scrollPoint</span><span class="p">.</span><span class="n">y</span><span class="p">)];</span>
    
    <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">    FIXME Not yet implemented</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">autoscroll:</span><span class="p">(</span><span class="kt">CPEvent</span><span class="p">)</span>anEvent
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[[</span><span class="nb">self</span> <span class="n">superview</span><span class="p">]</span> <span class="n">autoscroll</span><span class="o">:</span><span class="n">anEvent</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Subclasses can override this to modify the visible rectangle after a</span>
<span class="cm">    scrolling operation. The default implementation simply returns the provided rectangle.</span>
<span class="cm">    @param proposedVisibleRect the rectangle to alter</span>
<span class="cm">    @return the same adjusted rectangle</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span><span class="nf">adjustScroll:</span><span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span>proposedVisibleRect
<span class="p">{</span>
    <span class="k">return</span> <span class="n">proposedVisibleRect</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Should be overridden by subclasses.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">scrollRect:</span><span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span>aRect <span class="nf">by:</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span>anAmount
<span class="p">{</span>

<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the CPScrollView containing the receiver.</span>
<span class="cm">    @return the CPScrollView containing the receiver.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CPScrollView</span><span class="p">)</span><span class="nf">enclosingScrollView</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">superview</span> <span class="o">=</span> <span class="n">_superview</span><span class="p">,</span>
        <span class="n">scrollViewClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPScrollView</span> <span class="n">class</span><span class="p">];</span>

    <span class="k">while</span><span class="p">(</span><span class="n">superview</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="n">superview</span> <span class="n">isKindOfClass</span><span class="o">:</span><span class="n">scrollViewClass</span><span class="p">])</span> 
        <span class="n">superview</span> <span class="o">=</span> <span class="n">superview</span><span class="p">.</span><span class="n">_superview</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">superview</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Scrolls the clip view to a specified point</span>
<span class="cm">    @param the clip view to scoll</span>
<span class="cm">    @param the point to scroll to</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">scrollClipView:</span><span class="p">(</span><span class="kt">CPClipView</span><span class="p">)</span>aClipView <span class="nf">toPoint:</span><span class="p">(</span><span class="kt">CGPoint</span><span class="p">)</span>aPoint
<span class="p">{</span>
    <span class="p">[</span><span class="n">aClipView</span> <span class="n">scrollToPoint</span><span class="o">:</span><span class="n">aPoint</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Notifies the receiver (superview of a CPClipView)</span>
<span class="cm">    that the clip view bounds or the document view bounds have changed.</span>
<span class="cm">    @param aClipView the clip view of the superview being notified</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">reflectScrolledClipView:</span><span class="p">(</span><span class="kt">CPClipView</span><span class="p">)</span>aClipView
<span class="p">{</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">CPView</span> <span class="p">(</span><span class="nl">KeyView</span>)
<span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">performKeyEquivalent:</span><span class="p">(</span><span class="kt">CPEvent</span><span class="p">)</span>anEvent
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">count</span> <span class="o">=</span> <span class="p">[</span><span class="n">_subviews</span> <span class="n">count</span><span class="p">];</span>

    <span class="c1">// Is reverse iteration correct here? It matches the other (correct) code like hit testing.</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">_subviews</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="n">performKeyEquivalent</span><span class="o">:</span><span class="n">anEvent</span><span class="p">])</span>
            <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>

    <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">canBecomeKeyView</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">self</span> <span class="n">acceptsFirstResponder</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="nb">self</span> <span class="n">isHiddenOrHasHiddenAncestor</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CPView</span><span class="p">)</span><span class="nf">nextKeyView</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_nextKeyView</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CPView</span><span class="p">)</span><span class="nf">nextValidKeyView</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">nextKeyView</span><span class="p">];</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="n">result</span> <span class="n">canBecomeKeyView</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span> <span class="n">nextKeyView</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CPView</span><span class="p">)</span><span class="nf">previousKeyView</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_previousKeyView</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CPView</span><span class="p">)</span><span class="nf">previousValidKeyView</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">previousKeyView</span><span class="p">];</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="n">result</span> <span class="n">canBecomeKeyView</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span> <span class="n">previousKeyView</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">_setPreviousKeyView:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>previous
<span class="p">{</span>
    <span class="n">_previousKeyView</span> <span class="o">=</span> <span class="n">previous</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setNextKeyView:</span><span class="p">(</span><span class="kt">CPView</span><span class="p">)</span>next
<span class="p">{</span>
    <span class="n">_nextKeyView</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">[</span><span class="n">_nextKeyView</span> <span class="n">_setPreviousKeyView</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">CPView</span> <span class="p">(</span><span class="nl">CoreAnimationAdditions</span>)

<span class="cm">/*!</span>
<span class="cm">    Sets the core animation layer to be used by this receiver.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setLayer:</span><span class="p">(</span><span class="kt">CALayer</span><span class="p">)</span>aLayer
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_layer</span> <span class="o">==</span> <span class="n">aLayer</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">_layer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_layer</span><span class="p">.</span><span class="n">_owningView</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>
<span class="cp">#if PLATFORM(DOM)</span>
        <span class="n">_DOMElement</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="n">_layer</span><span class="p">.</span><span class="n">_DOMElement</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
    
    <span class="n">_layer</span> <span class="o">=</span> <span class="n">aLayer</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">_layer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">bounds</span> <span class="o">=</span> <span class="nf">CGRectMakeCopy</span><span class="p">([</span><span class="nb">self</span> <span class="n">bounds</span><span class="p">]);</span>
        
        <span class="p">[</span><span class="n">_layer</span> <span class="n">_setOwningView</span><span class="o">:</span><span class="nb">self</span><span class="p">];</span>
        
<span class="cp">#if PLATFORM(DOM)</span>
        <span class="n">_layer</span><span class="p">.</span><span class="n">_DOMElement</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">zIndex</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
        
        <span class="n">_DOMElement</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="n">_layer</span><span class="p">.</span><span class="n">_DOMElement</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns the core animation layer used by the receiver.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">CALayer</span><span class="p">)</span><span class="nf">layer</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_layer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Sets whether the receiver wants a core animation layer.</span>
<span class="cm">    @param \c YES means the receiver wants a layer.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setWantsLayer:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span>aFlag
<span class="p">{</span>
    <span class="n">_wantsLayer</span> <span class="o">=</span> <span class="o">!!</span><span class="n">aFlag</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Returns \c YES if the receiver uses a CALayer</span>
<span class="cm">    @returns \c YES if the receiver uses a CALayer</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">wantsLayer</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_wantsLayer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">CPView</span> <span class="p">(</span><span class="nl">Theming</span>)
<span class="cp">#pragma mark Theme States</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="nf">themeState</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_themeState</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">hasThemeState:</span><span class="p">(</span><span class="kt">CPThemeState</span><span class="p">)</span>aState
<span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="n">_themeState</span> <span class="o">&amp;</span> <span class="p">((</span><span class="k">typeof</span> <span class="n">aState</span> <span class="o">===</span> <span class="s">&quot;string&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nf">CPThemeState</span><span class="p">(</span><span class="n">aState</span><span class="p">)</span> <span class="o">:</span> <span class="n">aState</span><span class="p">));</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">setThemeState:</span><span class="p">(</span><span class="kt">CPThemeState</span><span class="p">)</span>aState
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">newState</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="n">aState</span> <span class="o">===</span> <span class="s">&quot;string&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nf">CPThemeState</span><span class="p">(</span><span class="n">aState</span><span class="p">)</span> <span class="o">:</span> <span class="n">aState</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_themeState</span> <span class="o">&amp;</span> <span class="n">newState</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>

    <span class="n">_themeState</span> <span class="o">|=</span> <span class="n">newState</span><span class="p">;</span>

    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsLayout</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsDisplay</span><span class="o">:</span><span class="kc">YES</span><span class="p">];</span>

    <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">unsetThemeState:</span><span class="p">(</span><span class="kt">CPThemeState</span><span class="p">)</span>aState
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">newState</span> <span class="o">=</span> <span class="p">((</span><span class="k">typeof</span> <span class="n">aState</span> <span class="o">===</span> <span class="s">&quot;string&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nf">CPThemeState</span><span class="p">(</span><span class="n">aState</span><span class="p">)</span> <span class="o">:</span> <span class="n">aState</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">_themeState</span> <span class="o">&amp;</span> <span class="n">newState</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">NO</span><span class="p">;</span>

    <span class="n">_themeState</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">newState</span><span class="p">;</span>

    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsLayout</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsDisplay</span><span class="o">:</span><span class="kc">YES</span><span class="p">];</span>

    <span class="k">return</span> <span class="kc">YES</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#pragma mark Theme Attributes</span>
<span class="o">+</span> <span class="p">(</span><span class="kt">CPString</span><span class="p">)</span><span class="nf">themeClass</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">+</span> <span class="p">(</span><span class="kt">CPDictionary</span><span class="p">)</span><span class="nf">themeAttributes</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">+</span> <span class="p">(</span><span class="kt">CPArray</span><span class="p">)</span><span class="nf">_themeAttributes</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CachedThemeAttributes</span><span class="p">)</span>
        <span class="n">CachedThemeAttributes</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="kd">var</span> <span class="n">theClass</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">class</span><span class="p">],</span>
        <span class="n">CPViewClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPView</span> <span class="n">class</span><span class="p">],</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">for</span> <span class="p">(;</span> <span class="n">theClass</span> <span class="o">&amp;&amp;</span> <span class="n">theClass</span> <span class="o">!==</span> <span class="n">CPViewClass</span><span class="p">;</span> <span class="n">theClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">theClass</span> <span class="n">superclass</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">cachedAttributes</span> <span class="o">=</span> <span class="n">CachedThemeAttributes</span><span class="p">[</span><span class="nf">class_getName</span><span class="p">(</span><span class="n">theClass</span><span class="p">)];</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cachedAttributes</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">.</span><span class="n">length</span> <span class="o">?</span> <span class="n">attributes</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">cachedAttributes</span><span class="p">)</span> <span class="o">:</span> <span class="n">attributes</span><span class="p">;</span>
            <span class="n">CachedThemeAttributes</span><span class="p">[[</span><span class="nb">self</span> <span class="n">className</span><span class="p">]]</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">;</span>

            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="n">attributeDictionary</span> <span class="o">=</span> <span class="p">[</span><span class="n">theClass</span> <span class="n">themeAttributes</span><span class="p">];</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attributeDictionary</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="kd">var</span> <span class="n">attributeKeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">attributeDictionary</span> <span class="n">allKeys</span><span class="p">],</span>
            <span class="n">attributeCount</span> <span class="o">=</span> <span class="n">attributeKeys</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">attributeCount</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="n">attributeName</span> <span class="o">=</span> <span class="n">attributeKeys</span><span class="p">[</span><span class="n">attributeCount</span><span class="p">];</span>

            <span class="n">attributes</span><span class="p">.</span><span class="nf">push</span><span class="p">([</span><span class="n">attributeDictionary</span> <span class="n">objectForKey</span><span class="o">:</span><span class="n">attributeName</span><span class="p">]);</span>
            <span class="n">attributes</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">attributeName</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">attributes</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">_loadThemeAttributes</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">theClass</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">class</span><span class="p">],</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">theClass</span> <span class="n">_themeAttributes</span><span class="p">],</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="n">theme</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">theme</span><span class="p">],</span>
        <span class="n">themeClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">theClass</span> <span class="n">themeClass</span><span class="p">];</span>

    <span class="n">_themeAttributes</span> <span class="o">=</span> <span class="p">{};</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">attributeName</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">count</span><span class="o">--</span><span class="p">],</span>
            <span class="n">attribute</span> <span class="o">=</span> <span class="p">[[</span><span class="n">_CPThemeAttribute</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithName</span><span class="o">:</span><span class="n">attributeName</span> <span class="n">defaultValue</span><span class="o">:</span><span class="n">attributes</span><span class="p">[</span><span class="n">count</span><span class="p">]];</span>

        <span class="p">[</span><span class="n">attribute</span> <span class="n">setParentAttribute</span><span class="o">:</span><span class="p">[</span><span class="n">theme</span> <span class="n">_attributeWithName</span><span class="o">:</span><span class="n">attributeName</span> <span class="n">forClass</span><span class="o">:</span><span class="n">themeClass</span><span class="p">]];</span>
        
        <span class="n">_themeAttributes</span><span class="p">[</span><span class="n">attributeName</span><span class="p">]</span> <span class="o">=</span> <span class="n">attribute</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setTheme:</span><span class="p">(</span><span class="kt">CPTheme</span><span class="p">)</span>aTheme
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_theme</span> <span class="o">===</span> <span class="n">aTheme</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    
    <span class="n">_theme</span> <span class="o">=</span> <span class="n">aTheme</span><span class="p">;</span>
        
    <span class="p">[</span><span class="nb">self</span> <span class="n">viewDidChangeTheme</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CPTheme</span><span class="p">)</span><span class="nf">theme</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_theme</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidChangeTheme</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_themeAttributes</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="n">theme</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">theme</span><span class="p">],</span>
        <span class="n">themeClass</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">self</span> <span class="n">class</span><span class="p">]</span> <span class="n">themeClass</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="n">attributeName</span> <span class="k">in</span> <span class="n">_themeAttributes</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_themeAttributes</span><span class="p">.</span><span class="nf">hasOwnProperty</span><span class="p">(</span><span class="n">attributeName</span><span class="p">))</span>
            <span class="p">[</span><span class="n">_themeAttributes</span><span class="p">[</span><span class="n">attributeName</span><span class="p">]</span> <span class="n">setParentAttribute</span><span class="o">:</span><span class="p">[</span><span class="n">theme</span> <span class="n">_attributeWithName</span><span class="o">:</span><span class="n">attributeName</span> <span class="n">forClass</span><span class="o">:</span><span class="n">themeClass</span><span class="p">]];</span>

    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsLayout</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsDisplay</span><span class="o">:</span><span class="kc">YES</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CPDictionary</span><span class="p">)</span><span class="nf">_themeAttributeDictionary</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">dictionary</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPDictionary</span> <span class="n">dictionary</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_themeAttributes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">theme</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">theme</span><span class="p">];</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="n">attributeName</span> <span class="k">in</span> <span class="n">_themeAttributes</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_themeAttributes</span><span class="p">.</span><span class="nf">hasOwnProperty</span><span class="p">(</span><span class="n">attributeName</span><span class="p">))</span>
                <span class="p">[</span><span class="n">dictionary</span> <span class="n">setObject</span><span class="o">:</span><span class="n">_themeAttributes</span><span class="p">[</span><span class="n">attributeName</span><span class="p">]</span> <span class="n">forKey</span><span class="o">:</span><span class="n">attributeName</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">dictionary</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setValue:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span>aValue <span class="nf">forThemeAttribute:</span><span class="p">(</span><span class="kt">CPString</span><span class="p">)</span>aName <span class="nf">inState:</span><span class="p">(</span><span class="kt">CPThemeState</span><span class="p">)</span>aState
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_themeAttributes</span> <span class="o">||</span> <span class="o">!</span><span class="n">_themeAttributes</span><span class="p">[</span><span class="n">aName</span><span class="p">])</span>
        <span class="p">[</span><span class="n">CPException</span> <span class="n">raise</span><span class="o">:</span><span class="n">CPInvalidArgumentException</span> <span class="n">reason</span><span class="o">:</span><span class="p">[</span><span class="nb">self</span> <span class="n">className</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; does not contain theme attribute &#39;&quot;</span> <span class="o">+</span> <span class="n">aName</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">];</span>

    <span class="kd">var</span> <span class="n">currentValue</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">currentValueForThemeAttribute</span><span class="o">:</span><span class="n">aName</span><span class="p">];</span>

    <span class="p">[</span><span class="n">_themeAttributes</span><span class="p">[</span><span class="n">aName</span><span class="p">]</span> <span class="n">setValue</span><span class="o">:</span><span class="n">aValue</span> <span class="n">forState</span><span class="o">:</span><span class="n">aState</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">([</span><span class="nb">self</span> <span class="n">currentValueForThemeAttribute</span><span class="o">:</span><span class="n">aName</span><span class="p">]</span> <span class="o">===</span> <span class="n">currentValue</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsDisplay</span><span class="o">:</span><span class="kc">YES</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsLayout</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setValue:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span>aValue <span class="nf">forThemeAttribute:</span><span class="p">(</span><span class="kt">CPString</span><span class="p">)</span>aName
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_themeAttributes</span> <span class="o">||</span> <span class="o">!</span><span class="n">_themeAttributes</span><span class="p">[</span><span class="n">aName</span><span class="p">])</span>
        <span class="p">[</span><span class="n">CPException</span> <span class="n">raise</span><span class="o">:</span><span class="n">CPInvalidArgumentException</span> <span class="n">reason</span><span class="o">:</span><span class="p">[</span><span class="nb">self</span> <span class="n">className</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; does not contain theme attribute &#39;&quot;</span> <span class="o">+</span> <span class="n">aName</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">];</span>

    <span class="kd">var</span> <span class="n">currentValue</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">currentValueForThemeAttribute</span><span class="o">:</span><span class="n">aName</span><span class="p">];</span>

    <span class="p">[</span><span class="n">_themeAttributes</span><span class="p">[</span><span class="n">aName</span><span class="p">]</span> <span class="n">setValue</span><span class="o">:</span><span class="n">aValue</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">([</span><span class="nb">self</span> <span class="n">currentValueForThemeAttribute</span><span class="o">:</span><span class="n">aName</span><span class="p">]</span> <span class="o">===</span> <span class="n">currentValue</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsDisplay</span><span class="o">:</span><span class="kc">YES</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsLayout</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">valueForThemeAttribute:</span><span class="p">(</span><span class="kt">CPString</span><span class="p">)</span>aName <span class="nf">inState:</span><span class="p">(</span><span class="kt">CPThemeState</span><span class="p">)</span>aState
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_themeAttributes</span> <span class="o">||</span> <span class="o">!</span><span class="n">_themeAttributes</span><span class="p">[</span><span class="n">aName</span><span class="p">])</span>
        <span class="p">[</span><span class="n">CPException</span> <span class="n">raise</span><span class="o">:</span><span class="n">CPInvalidArgumentException</span> <span class="n">reason</span><span class="o">:</span><span class="p">[</span><span class="nb">self</span> <span class="n">className</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; does not contain theme attribute &#39;&quot;</span> <span class="o">+</span> <span class="n">aName</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">];</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">_themeAttributes</span><span class="p">[</span><span class="n">aName</span><span class="p">]</span> <span class="n">valueForState</span><span class="o">:</span><span class="n">aState</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">valueForThemeAttribute:</span><span class="p">(</span><span class="kt">CPString</span><span class="p">)</span>aName
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_themeAttributes</span> <span class="o">||</span> <span class="o">!</span><span class="n">_themeAttributes</span><span class="p">[</span><span class="n">aName</span><span class="p">])</span>
        <span class="p">[</span><span class="n">CPException</span> <span class="n">raise</span><span class="o">:</span><span class="n">CPInvalidArgumentException</span> <span class="n">reason</span><span class="o">:</span><span class="p">[</span><span class="nb">self</span> <span class="n">className</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; does not contain theme attribute &#39;&quot;</span> <span class="o">+</span> <span class="n">aName</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">];</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">_themeAttributes</span><span class="p">[</span><span class="n">aName</span><span class="p">]</span> <span class="n">value</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">currentValueForThemeAttribute:</span><span class="p">(</span><span class="kt">CPString</span><span class="p">)</span>aName
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_themeAttributes</span> <span class="o">||</span> <span class="o">!</span><span class="n">_themeAttributes</span><span class="p">[</span><span class="n">aName</span><span class="p">])</span>
        <span class="p">[</span><span class="n">CPException</span> <span class="n">raise</span><span class="o">:</span><span class="n">CPInvalidArgumentException</span> <span class="n">reason</span><span class="o">:</span><span class="p">[</span><span class="nb">self</span> <span class="n">className</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot; does not contain theme attribute &#39;&quot;</span> <span class="o">+</span> <span class="n">aName</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">];</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">_themeAttributes</span><span class="p">[</span><span class="n">aName</span><span class="p">]</span> <span class="n">valueForState</span><span class="o">:</span><span class="n">_themeState</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CPView</span><span class="p">)</span><span class="nf">createEphemeralSubviewNamed:</span><span class="p">(</span><span class="kt">CPString</span><span class="p">)</span>aViewName
<span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CGRect</span><span class="p">)</span><span class="nf">rectForEphemeralSubviewNamed:</span><span class="p">(</span><span class="kt">CPString</span><span class="p">)</span>aViewName
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">_CGRectMakeZero</span><span class="p">();</span>
<span class="p">}</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">CPView</span><span class="p">)</span><span class="nf">layoutEphemeralSubviewNamed:</span><span class="p">(</span><span class="kt">CPString</span><span class="p">)</span>aViewName 
                           <span class="nf">positioned:</span><span class="p">(</span><span class="kt">CPWindowOrderingMode</span><span class="p">)</span>anOrderingMode
      <span class="nf">relativeToEphemeralSubviewNamed:</span><span class="p">(</span><span class="kt">CPString</span><span class="p">)</span>relativeToViewName
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ephemeralSubviewsForNames</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_ephemeralSubviewsForNames</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="n">_ephemeralSubviews</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPSet</span> <span class="n">set</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">rectForEphemeralSubviewNamed</span><span class="o">:</span><span class="n">aViewName</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">_CGRectIsEmpty</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">aViewName</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">aViewName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">createEphemeralSubviewNamed</span><span class="o">:</span><span class="n">aViewName</span><span class="p">];</span>

            <span class="p">[</span><span class="n">_ephemeralSubviews</span> <span class="n">addObject</span><span class="o">:</span><span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">aViewName</span><span class="p">]];</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">aViewName</span><span class="p">])</span>
                <span class="p">[</span><span class="nb">self</span> <span class="n">addSubview</span><span class="o">:</span><span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">aViewName</span><span class="p">]</span> <span class="n">positioned</span><span class="o">:</span><span class="n">anOrderingMode</span> <span class="n">relativeTo</span><span class="o">:</span><span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">relativeToViewName</span><span class="p">]];</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">aViewName</span><span class="p">])</span>
            <span class="p">[</span><span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">aViewName</span><span class="p">]</span> <span class="n">setFrame</span><span class="o">:</span><span class="n">frame</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">aViewName</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">aViewName</span><span class="p">]</span> <span class="n">removeFromSuperview</span><span class="p">];</span>

        <span class="p">[</span><span class="n">_ephemeralSubviews</span> <span class="n">removeObject</span><span class="o">:</span><span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">aViewName</span><span class="p">]];</span>
        <span class="k">delete</span> <span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">aViewName</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">_ephemeralSubviewsForNames</span><span class="p">[</span><span class="n">aViewName</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="kd">var</span> <span class="n">CPViewAutoresizingMaskKey</span>       <span class="o">=</span> <span class="s">@&quot;CPViewAutoresizingMask&quot;</span><span class="p">,</span>
    <span class="n">CPViewAutoresizesSubviewsKey</span>    <span class="o">=</span> <span class="s">@&quot;CPViewAutoresizesSubviews&quot;</span><span class="p">,</span>
    <span class="n">CPViewBackgroundColorKey</span>        <span class="o">=</span> <span class="s">@&quot;CPViewBackgroundColor&quot;</span><span class="p">,</span>
    <span class="n">CPViewBoundsKey</span>                 <span class="o">=</span> <span class="s">@&quot;CPViewBoundsKey&quot;</span><span class="p">,</span>
    <span class="n">CPViewFrameKey</span>                  <span class="o">=</span> <span class="s">@&quot;CPViewFrameKey&quot;</span><span class="p">,</span>
    <span class="n">CPViewHitTestsKey</span>               <span class="o">=</span> <span class="s">@&quot;CPViewHitTestsKey&quot;</span><span class="p">,</span>
    <span class="n">CPViewIsHiddenKey</span>               <span class="o">=</span> <span class="s">@&quot;CPViewIsHiddenKey&quot;</span><span class="p">,</span>
    <span class="n">CPViewOpacityKey</span>                <span class="o">=</span> <span class="s">@&quot;CPViewOpacityKey&quot;</span><span class="p">,</span>
    <span class="n">CPViewSubviewsKey</span>               <span class="o">=</span> <span class="s">@&quot;CPViewSubviewsKey&quot;</span><span class="p">,</span>
    <span class="n">CPViewSuperviewKey</span>              <span class="o">=</span> <span class="s">@&quot;CPViewSuperviewKey&quot;</span><span class="p">,</span>
    <span class="n">CPViewTagKey</span>                    <span class="o">=</span> <span class="s">@&quot;CPViewTagKey&quot;</span><span class="p">,</span>
    <span class="n">CPViewThemeStateKey</span>             <span class="o">=</span> <span class="s">@&quot;CPViewThemeStateKey&quot;</span><span class="p">,</span>
    <span class="n">CPViewWindowKey</span>                 <span class="o">=</span> <span class="s">@&quot;CPViewWindowKey&quot;</span><span class="p">,</span>
    <span class="n">CPViewNextKeyViewKey</span>            <span class="o">=</span> <span class="s">@&quot;CPViewNextKeyViewKey&quot;</span><span class="p">,</span>
    <span class="n">CPViewPreviousKeyViewKey</span>        <span class="o">=</span> <span class="s">@&quot;CPViewPreviousKeyViewKey&quot;</span><span class="p">;</span>

<span class="k">@implementation</span> <span class="nc">CPView</span> <span class="p">(</span><span class="nl">CPCoding</span>)

<span class="cm">/*!</span>
<span class="cm">    Initializes the view from an archive.</span>
<span class="cm">    @param aCoder the coder from which to initialize</span>
<span class="cm">    @return the initialized view</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithCoder:</span><span class="p">(</span><span class="kt">CPCoder</span><span class="p">)</span>aCoder
<span class="p">{</span>
    <span class="c1">// We create the DOMElement &quot;early&quot; because there is a chance that we </span>
    <span class="c1">// will decode our superview before we are done decoding, at which point </span>
    <span class="c1">// we have to have an element to place in the tree.  Perhaps there is </span>
    <span class="c1">// a more &quot;elegant&quot; way to do this...?</span>
<span class="cp">#if PLATFORM(DOM)</span>
    <span class="n">_DOMElement</span> <span class="o">=</span> <span class="n">DOMElementPrototype</span><span class="p">.</span><span class="nf">cloneNode</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="c1">// Also decode these &quot;early&quot;.</span>
    <span class="n">_frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">aCoder</span> <span class="n">decodeRectForKey</span><span class="o">:</span><span class="n">CPViewFrameKey</span><span class="p">];</span>
    <span class="n">_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">aCoder</span> <span class="n">decodeRectForKey</span><span class="o">:</span><span class="n">CPViewBoundsKey</span><span class="p">];</span>

    <span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">initWithCoder</span><span class="o">:</span><span class="n">aCoder</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// We have to manually check because it may be 0, so we can&#39;t use ||</span>
        <span class="n">_tag</span> <span class="o">=</span> <span class="p">[</span><span class="n">aCoder</span> <span class="n">containsValueForKey</span><span class="o">:</span><span class="n">CPViewTagKey</span><span class="p">]</span> <span class="o">?</span> <span class="p">[</span><span class="n">aCoder</span> <span class="n">decodeIntForKey</span><span class="o">:</span><span class="n">CPViewTagKey</span><span class="p">]</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        
        <span class="n">_window</span> <span class="o">=</span> <span class="p">[</span><span class="n">aCoder</span> <span class="n">decodeObjectForKey</span><span class="o">:</span><span class="n">CPViewWindowKey</span><span class="p">];</span>
        <span class="n">_subviews</span> <span class="o">=</span> <span class="p">[</span><span class="n">aCoder</span> <span class="n">decodeObjectForKey</span><span class="o">:</span><span class="n">CPViewSubviewsKey</span><span class="p">]</span> <span class="o">||</span> <span class="p">[];</span>
        <span class="n">_superview</span> <span class="o">=</span> <span class="p">[</span><span class="n">aCoder</span> <span class="n">decodeObjectForKey</span><span class="o">:</span><span class="n">CPViewSuperviewKey</span><span class="p">];</span>
        
        <span class="c1">// FIXME: Should we encode/decode this?</span>
        <span class="n">_registeredDraggedTypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPSet</span> <span class="n">set</span><span class="p">];</span>
        <span class="n">_registeredDraggedTypesArray</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="n">_autoresizingMask</span> <span class="o">=</span> <span class="p">[</span><span class="n">aCoder</span> <span class="n">decodeIntForKey</span><span class="o">:</span><span class="n">CPViewAutoresizingMaskKey</span><span class="p">]</span> <span class="o">||</span> <span class="n">CPViewNotSizable</span><span class="p">;</span>
        <span class="n">_autoresizesSubviews</span> <span class="o">=</span> <span class="o">!</span><span class="p">[</span><span class="n">aCoder</span> <span class="n">containsValueForKey</span><span class="o">:</span><span class="n">CPViewAutoresizesSubviewsKey</span><span class="p">]</span> <span class="o">||</span> <span class="p">[</span><span class="n">aCoder</span> <span class="n">decodeBoolForKey</span><span class="o">:</span><span class="n">CPViewAutoresizesSubviewsKey</span><span class="p">];</span>

        <span class="n">_hitTests</span> <span class="o">=</span> <span class="o">!</span><span class="p">[</span><span class="n">aCoder</span> <span class="n">containsValueForKey</span><span class="o">:</span><span class="n">CPViewHitTestsKey</span><span class="p">]</span> <span class="o">||</span> <span class="p">[</span><span class="n">aCoder</span> <span class="n">decodeObjectForKey</span><span class="o">:</span><span class="n">CPViewHitTestsKey</span><span class="p">];</span>
    
        <span class="c1">// DOM SETUP</span>
<span class="cp">#if PLATFORM(DOM)</span>
        <span class="n">_DOMImageParts</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="n">_DOMImageSizes</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="nf">CPDOMDisplayServerSetStyleLeftTop</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">,</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="n">_frame</span><span class="p">),</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="n">_frame</span><span class="p">));</span>
        <span class="nf">CPDOMDisplayServerSetStyleSize</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="nf">_CGRectGetWidth</span><span class="p">(</span><span class="n">_frame</span><span class="p">),</span> <span class="nf">_CGRectGetHeight</span><span class="p">(</span><span class="n">_frame</span><span class="p">));</span>
        
        <span class="kd">var</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">_subviews</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
    
        <span class="k">for</span> <span class="p">(;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">index</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">CPDOMDisplayServerAppendChild</span><span class="p">(</span><span class="n">_DOMElement</span><span class="p">,</span> <span class="n">_subviews</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">_DOMElement</span><span class="p">);</span>
            <span class="c1">//_subviews[index]._superview = self;</span>
        <span class="p">}</span>
<span class="cp">#endif</span>

        <span class="k">if</span> <span class="p">([</span><span class="n">aCoder</span> <span class="n">containsValueForKey</span><span class="o">:</span><span class="n">CPViewIsHiddenKey</span><span class="p">])</span>
            <span class="p">[</span><span class="nb">self</span> <span class="n">setHidden</span><span class="o">:</span><span class="p">[</span><span class="n">aCoder</span> <span class="n">decodeBoolForKey</span><span class="o">:</span><span class="n">CPViewIsHiddenKey</span><span class="p">]];</span>
        <span class="k">else</span>
            <span class="n">_isHidden</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">([</span><span class="n">aCoder</span> <span class="n">containsValueForKey</span><span class="o">:</span><span class="n">CPViewOpacityKey</span><span class="p">])</span>
            <span class="p">[</span><span class="nb">self</span> <span class="n">setAlphaValue</span><span class="o">:</span><span class="p">[</span><span class="n">aCoder</span> <span class="n">decodeIntForKey</span><span class="o">:</span><span class="n">CPViewOpacityKey</span><span class="p">]];</span>
        <span class="k">else</span>
            <span class="n">_opacity</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

        <span class="p">[</span><span class="nb">self</span> <span class="n">setBackgroundColor</span><span class="o">:</span><span class="p">[</span><span class="n">aCoder</span> <span class="n">decodeObjectForKey</span><span class="o">:</span><span class="n">CPViewBackgroundColorKey</span><span class="p">]];</span>

        <span class="p">[</span><span class="nb">self</span> <span class="n">setupViewFlags</span><span class="p">];</span>

        <span class="n">_theme</span> <span class="o">=</span> <span class="p">[</span><span class="n">CPTheme</span> <span class="n">defaultTheme</span><span class="p">];</span>
        <span class="n">_themeState</span> <span class="o">=</span> <span class="nf">CPThemeState</span><span class="p">([</span><span class="n">aCoder</span> <span class="n">decodeIntForKey</span><span class="o">:</span><span class="n">CPViewThemeStateKey</span><span class="p">]);</span>
        <span class="n">_themeAttributes</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="kd">var</span> <span class="n">theClass</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">class</span><span class="p">],</span>
            <span class="n">themeClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">theClass</span> <span class="n">themeClass</span><span class="p">],</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">theClass</span> <span class="n">_themeAttributes</span><span class="p">],</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="n">attributeName</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">count</span><span class="o">--</span><span class="p">];</span>

            <span class="n">_themeAttributes</span><span class="p">[</span><span class="n">attributeName</span><span class="p">]</span> <span class="o">=</span> <span class="nf">CPThemeAttributeDecode</span><span class="p">(</span><span class="n">aCoder</span><span class="p">,</span> <span class="n">attributeName</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> <span class="n">_theme</span><span class="p">,</span> <span class="n">themeClass</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsDisplay</span><span class="o">:</span><span class="kc">YES</span><span class="p">];</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsLayout</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*!</span>
<span class="cm">    Archives the view to a coder.</span>
<span class="cm">    @param aCoder the object into which the view&#39;s data will be archived.</span>
<span class="cm">*/</span><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">encodeWithCoder:</span><span class="p">(</span><span class="kt">CPCoder</span><span class="p">)</span>aCoder
<span class="p">{</span>
    <span class="p">[</span><span class="nb">super</span> <span class="n">encodeWithCoder</span><span class="o">:</span><span class="n">aCoder</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">_tag</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeInt</span><span class="o">:</span><span class="n">_tag</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewTagKey</span><span class="p">];</span>

    <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeRect</span><span class="o">:</span><span class="n">_frame</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewFrameKey</span><span class="p">];</span>
    <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeRect</span><span class="o">:</span><span class="n">_bounds</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewBoundsKey</span><span class="p">];</span>

    <span class="c1">// This will come out nil on the other side with decodeObjectForKey:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_window</span> <span class="o">!==</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeConditionalObject</span><span class="o">:</span><span class="n">_window</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewWindowKey</span><span class="p">];</span>

    <span class="kd">var</span> <span class="n">count</span> <span class="o">=</span> <span class="p">[</span><span class="n">_subviews</span> <span class="n">count</span><span class="p">],</span>
        <span class="n">encodedSubviews</span> <span class="o">=</span> <span class="n">_subviews</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">_ephemeralSubviews</span> <span class="n">count</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">encodedSubviews</span> <span class="o">=</span> <span class="p">[</span><span class="n">encodedSubviews</span> <span class="n">copy</span><span class="p">];</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">([</span><span class="n">_ephemeralSubviews</span> <span class="n">containsObject</span><span class="o">:</span><span class="n">encodedSubviews</span><span class="p">[</span><span class="n">count</span><span class="p">]])</span>
                <span class="n">encodedSubviews</span><span class="p">.</span><span class="nf">splice</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">encodedSubviews</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeObject</span><span class="o">:</span><span class="n">encodedSubviews</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewSubviewsKey</span><span class="p">];</span>

    <span class="c1">// This will come out nil on the other side with decodeObjectForKey:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_superview</span> <span class="o">!==</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeConditionalObject</span><span class="o">:</span><span class="n">_superview</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewSuperviewKey</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_autoresizingMask</span> <span class="o">!==</span> <span class="n">CPViewNotSizable</span><span class="p">)</span>
        <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeInt</span><span class="o">:</span><span class="n">_autoresizingMask</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewAutoresizingMaskKey</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_autoresizesSubviews</span><span class="p">)</span>
        <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeBool</span><span class="o">:</span><span class="n">_autoresizesSubviews</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewAutoresizesSubviewsKey</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_backgroundColor</span> <span class="o">!==</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeObject</span><span class="o">:</span><span class="n">_backgroundColor</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewBackgroundColorKey</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_hitTests</span> <span class="o">!==</span> <span class="kc">YES</span><span class="p">)</span>
        <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeBool</span><span class="o">:</span><span class="n">_hitTests</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewHitTestsKey</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_opacity</span> <span class="o">!==</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeFloat</span><span class="o">:</span><span class="n">_opacity</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewOpacityKey</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_isHidden</span><span class="p">)</span>
        <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeBool</span><span class="o">:</span><span class="n">_isHidden</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewIsHiddenKey</span><span class="p">];</span>

    <span class="kd">var</span> <span class="n">nextKeyView</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">nextKeyView</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">nextKeyView</span> <span class="o">!==</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeConditionalObject</span><span class="o">:</span><span class="n">nextKeyView</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewNextKeyViewKey</span><span class="p">];</span>

    <span class="kd">var</span> <span class="n">previousKeyView</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">previousKeyView</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">previousKeyView</span> <span class="o">!==</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeConditionalObject</span><span class="o">:</span><span class="n">previousKeyView</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewPreviousKeyViewKey</span><span class="p">];</span>

    <span class="p">[</span><span class="n">aCoder</span> <span class="n">encodeInt</span><span class="o">:</span><span class="nf">CPThemeStateName</span><span class="p">(</span><span class="n">_themeState</span><span class="p">)</span> <span class="n">forKey</span><span class="o">:</span><span class="n">CPViewThemeStateKey</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="n">attributeName</span> <span class="k">in</span> <span class="n">_themeAttributes</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_themeAttributes</span><span class="p">.</span><span class="nf">hasOwnProperty</span><span class="p">(</span><span class="n">attributeName</span><span class="p">))</span>
            <span class="nf">CPThemeAttributeEncode</span><span class="p">(</span><span class="n">aCoder</span><span class="p">,</span> <span class="n">_themeAttributes</span><span class="p">[</span><span class="n">attributeName</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">@end</span>

<span class="kd">var</span> <span class="n">_CPViewFullScreenModeStateMake</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="n">aView</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">superview</span> <span class="o">=</span> <span class="n">aView</span><span class="p">.</span><span class="n">_superview</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="p">{</span> <span class="n">autoresizingMask</span><span class="o">:</span><span class="n">aView</span><span class="p">.</span><span class="n">_autoresizingMask</span><span class="p">,</span> <span class="n">frame</span><span class="o">:</span><span class="nf">CGRectMakeCopy</span><span class="p">(</span><span class="n">aView</span><span class="p">.</span><span class="n">_frame</span><span class="p">),</span> <span class="n">index</span><span class="o">:</span><span class="p">(</span><span class="n">superview</span> <span class="o">?</span> <span class="p">[</span><span class="n">superview</span><span class="p">.</span><span class="n">_subviews</span> <span class="n">indexOfObjectIdenticalTo</span><span class="o">:</span><span class="n">aView</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">superview</span><span class="o">:</span><span class="n">superview</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="n">_CPViewGetTransform</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="cm">/*CPView*/</span> <span class="n">fromView</span><span class="p">,</span> <span class="cm">/*CPView */</span> <span class="n">toView</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="n">transform</span> <span class="o">=</span> <span class="nf">CGAffineTransformMakeIdentity</span><span class="p">(),</span>
        <span class="n">sameWindow</span> <span class="o">=</span> <span class="kc">YES</span><span class="p">,</span>
        <span class="n">fromWindow</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
        <span class="n">toWindow</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">fromView</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">view</span> <span class="o">=</span> <span class="n">fromView</span><span class="p">;</span>
        
        <span class="c1">// FIXME: This doesn&#39;t handle the case when the outside views are equal.</span>
        <span class="c1">// If we have a fromView, &quot;climb up&quot; the view tree until </span>
        <span class="c1">// we hit the root node or we hit the toLayer.</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">view</span> <span class="o">&amp;&amp;</span> <span class="n">view</span> <span class="o">!=</span> <span class="n">toView</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">view</span><span class="p">.</span><span class="n">_frame</span><span class="p">;</span>
            
            <span class="n">transform</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
            <span class="n">transform</span><span class="p">.</span><span class="n">ty</span> <span class="o">+=</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">view</span><span class="p">.</span><span class="n">_boundsTransform</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nf">_CGAffineTransformConcatTo</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">view</span><span class="p">.</span><span class="n">_boundsTransform</span><span class="p">,</span> <span class="n">transform</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="n">view</span> <span class="o">=</span> <span class="n">view</span><span class="p">.</span><span class="n">_superview</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="c1">// If we hit toView, then we&#39;re done.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">view</span> <span class="o">===</span> <span class="n">toView</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">transform</span><span class="p">;</span>
        
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fromView</span> <span class="o">&amp;&amp;</span> <span class="n">toView</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">fromWindow</span> <span class="o">=</span> <span class="p">[</span><span class="n">fromView</span> <span class="nb">window</span><span class="p">];</span>
            <span class="n">toWindow</span> <span class="o">=</span> <span class="p">[</span><span class="n">toView</span> <span class="nb">window</span><span class="p">];</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">fromWindow</span> <span class="o">&amp;&amp;</span> <span class="n">toWindow</span> <span class="o">&amp;&amp;</span> <span class="n">fromWindow</span> <span class="o">!==</span> <span class="n">toWindow</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">sameWindow</span> <span class="o">=</span> <span class="kc">NO</span><span class="p">;</span>
                
                <span class="kd">var</span> <span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">fromWindow</span> <span class="n">frame</span><span class="p">];</span>
                
                <span class="n">transform</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
                <span class="n">transform</span><span class="p">.</span><span class="n">ty</span> <span class="o">+=</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// FIXME: For now we can do things this way, but eventually we need to do them the &quot;hard&quot; way.</span>
    <span class="kd">var</span> <span class="n">view</span> <span class="o">=</span> <span class="n">toView</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="n">view</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">view</span><span class="p">.</span><span class="n">_frame</span><span class="p">;</span>
            
        <span class="n">transform</span><span class="p">.</span><span class="n">tx</span> <span class="o">-=</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
        <span class="n">transform</span><span class="p">.</span><span class="n">ty</span> <span class="o">-=</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">view</span><span class="p">.</span><span class="n">_boundsTransform</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">_CGAffineTransformConcatTo</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">view</span><span class="p">.</span><span class="n">_inverseBoundsTransform</span><span class="p">,</span> <span class="n">transform</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="n">view</span> <span class="o">=</span> <span class="n">view</span><span class="p">.</span><span class="n">_superview</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sameWindow</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">toWindow</span> <span class="n">frame</span><span class="p">];</span>
            
        <span class="n">transform</span><span class="p">.</span><span class="n">tx</span> <span class="o">-=</span> <span class="nf">_CGRectGetMinX</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
        <span class="n">transform</span><span class="p">.</span><span class="n">ty</span> <span class="o">-=</span> <span class="nf">_CGRectGetMinY</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cm">/*    var views = [],</span>
<span class="cm">        view = toView;</span>
<span class="cm">    </span>
<span class="cm">    while (view)</span>
<span class="cm">    {</span>
<span class="cm">        views.push(view);</span>
<span class="cm">        view = view._superview;</span>
<span class="cm">    }</span>
<span class="cm">    </span>
<span class="cm">    var index = views.length;</span>
<span class="cm">    </span>
<span class="cm">    while (index--)</span>
<span class="cm">    {</span>
<span class="cm">        var frame = views[index]._frame;</span>
<span class="cm">            </span>
<span class="cm">        transform.tx -= _CGRectGetMinX(frame);</span>
<span class="cm">        transform.ty -= _CGRectGetMinY(frame);</span>
<span class="cm">    }*/</span>
    
    <span class="k">return</span> <span class="n">transform</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</body>
</html>
